<!--
EXEMPLO DE TEMPLATE JINJA2 CORRIGIDO
Arquivo: template_email_exemplo_corrigido.html

Este template demonstra como exibir corretamente apenas e-mails ativos em um projeto,
seguindo as correções implementadas no sistema de gestão de obras.
-->

{% extends "base.html" %}

{% block title %}E-mails Ativos do Projeto - {{ projeto.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>
                        <i class="fas fa-envelope me-2"></i>
                        E-mails Ativos do Projeto: {{ projeto.nome }}
                    </h4>
                    <p class="text-muted mb-0">
                        Exibindo apenas e-mails ativos (ativo=True)
                    </p>
                </div>
                <div class="card-body">
                    
                    <!-- Estatísticas Corrigidas - Usando len() da query já filtrada -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <h5>Total de E-mails Ativos</h5>
                                    <h2>{{ emails|length }}</h2>
                                    <small>Contagem correta usando len(emails)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <h5>E-mail Principal Ativo</h5>
                                    <h2>{{ emails|selectattr("is_principal")|selectattr("ativo")|list|length }}</h2>
                                    <small>Apenas e-mails principais ativos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <h5>Recebem Relatórios</h5>
                                    <h2>{{ emails|selectattr("receber_relatorios")|selectattr("ativo")|list|length }}</h2>
                                    <small>Ativos que recebem relatórios</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <h5>Notificações Ativas</h5>
                                    <h2>{{ emails|selectattr("receber_notificacoes")|selectattr("ativo")|list|length }}</h2>
                                    <small>Ativos com notificações</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de E-mails - Apenas Ativos -->
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Nome do Contato</th>
                                    <th>E-mail</th>
                                    <th>Empresa/Cargo</th>
                                    <th>Status</th>
                                    <th>Configurações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Loop Jinja2 Corrigido: itera apenas sobre e-mails ativos -->
                                {% for email in emails %}
                                    <!-- 
                                    IMPORTANTE: A variável 'emails' já vem filtrada pela query:
                                    emails = EmailCliente.query.filter_by(projeto_id=projeto_id, ativo=True).all()
                                    -->
                                    <tr{% if email.is_principal %} class="table-warning"{% endif %}>
                                        <td>
                                            <strong>{{ email.nome_contato }}</strong>
                                            {% if email.is_principal %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-star"></i> Principal
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="mailto:{{ email.email }}">{{ email.email }}</a>
                                        </td>
                                        <td>
                                            {% if email.empresa %}
                                                <strong>{{ email.empresa }}</strong>
                                                {% if email.cargo %}<br><small>{{ email.cargo }}</small>{% endif %}
                                            {% elif email.cargo %}
                                                {{ email.cargo }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <!-- Como só exibimos ativos, todos têm status ativo -->
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> Ativo
                                            </span>
                                        </td>
                                        <td>
                                            {% if email.receber_relatorios %}
                                                <span class="badge bg-info me-1">
                                                    <i class="fas fa-file-pdf"></i> Relatórios
                                                </span>
                                            {% endif %}
                                            {% if email.receber_notificacoes %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-bell"></i> Notificações
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% else %}
                                    <!-- Caso não existam e-mails ativos -->
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-envelope-slash fa-2x mb-2"></i>
                                            <p class="mb-0">Nenhum e-mail ativo encontrado para este projeto.</p>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Exemplo de Dropdown para Seleção em Relatórios -->
                    <div class="mt-4">
                        <h5>Exemplo: Seleção de E-mails para Relatórios</h5>
                        <select class="form-select" name="email_destinatario">
                            <option value="">Selecione um e-mail ativo...</option>
                            {% for email in emails %}
                                {% if email.receber_relatorios %}
                                    <option value="{{ email.id }}">
                                        {{ email.nome_contato }} - {{ email.email }}
                                        {% if email.is_principal %}(Principal){% endif %}
                                    </option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <small class="text-muted">
                            Apenas e-mails ativos que recebem relatórios são exibidos.
                        </small>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- 
RESUMO DAS CORREÇÕES IMPLEMENTADAS:

1. QUERY SQLALCHEMY CORRIGIDA:
   - EmailCliente.query.filter_by(projeto_id=projeto_id, ativo=True)
   - FuncionarioProjeto.query.filter_by(projeto_id=projeto_id, ativo=True)
   - Todos os checks de duplicatas agora incluem ativo=True

2. TEMPLATE JINJA2 CORRIGIDO:
   - Loop {% for email in emails %} usa dados já filtrados
   - Contagens usando {{ emails|length }} da query filtrada
   - Filtros duplos para estatísticas: |selectattr("ativo")|selectattr("campo")

3. CONTAGEM CORRIGIDA:
   - len(emails) onde emails já vem filtrado por ativo=True
   - Evita mostrar contagens incorretas de registros inativos
-->

{% endblock %}