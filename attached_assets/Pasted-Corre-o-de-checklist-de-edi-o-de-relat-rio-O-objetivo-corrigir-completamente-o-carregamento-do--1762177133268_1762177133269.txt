Corre√ß√£o de checklist de edi√ß√£o de relat√≥rio

O objetivo √© corrigir completamente o carregamento do checklist na tela de edi√ß√£o de relat√≥rios, garantindo que:

A API /api/checklist-padrao n√£o entre em conflito com outra rota.

O backend envie corretamente os itens de checklist associados ao projeto e os marcados no relat√≥rio.

O frontend exiba todos os itens com descri√ß√£o e marca os selecionados.

O problema de ‚ÄúSem descri√ß√£o‚Äù e da necessidade de reselecionar o projeto desapare√ßa.

üß© 1Ô∏è‚É£ ‚Äî Corrigir rota duplicada no backend

Problema:
O log mostra que o Flask levantou:

AssertionError: View function mapping is overwriting an existing endpoint function: api_checklist_padrao


Isso significa que h√° duas rotas com o mesmo endpoint (@app.route('/api/checklist-padrao') ou com endpoint='api_checklist_padrao').

Corre√ß√£o imediata:
Procure no routes.py e mantenha apenas uma das duas fun√ß√µes com esse decorator.

Exemplo de ajuste:

# ERRO: rotas duplicadas
@app.route('/api/checklist-padrao')
def api_checklist_padrao():
    ...

@app.route('/api/checklist-padrao')  # duplicada!
def checklist_padrao_duplicada():
    ...


‚úÖ Solu√ß√£o:

Remova ou renomeie uma delas (por exemplo, api_checklist_padrao_v2),
ou adicione par√¢metro endpoint='api_checklist_padrao_v2'.

@app.route('/api/checklist-padrao', endpoint='api_checklist_padrao_v2')
def checklist_padrao_v2():
    ...


Depois reinicie o servidor Gunicorn.
Se o erro sumir, o backend voltar√° a responder corretamente.

‚öôÔ∏è 2Ô∏è‚É£ ‚Äî Corrigir retorno de checklist no backend da edi√ß√£o

Atualmente, o checklist do relat√≥rio n√£o vem com o campo descricao nem o status concluido, resultando em ‚ÄúSem descri√ß√£o‚Äù.

Garanta que a rota /reports/<id>/editarrel (ou a fun√ß√£o report_edit_complete) envie o checklist no formato correto:

def report_to_dict(relatorio):
    ...
    # Ajuste para checklist
    checklist_itens = []
    for item in getattr(relatorio, "checklist_itens", []):  # nome pode ser checklist_relatorio
        checklist_itens.append({
            "id": item.id,
            "texto": getattr(item, "texto", None) or getattr(item, "descricao", "Sem descri√ß√£o"),
            "observacao": getattr(item, "observacao", ""),
            "checked": bool(getattr(item, "concluido", False)),
        })

    return {
        ...
        "checklist": checklist_itens,
    }


Se o checklist estiver em outra tabela (checklist_obra, checklist_items etc.), ajuste o relacionamento para carregar os itens correspondentes ao projeto_id.

üñ•Ô∏è 3Ô∏è‚É£ ‚Äî Corrigir carregamento do checklist no frontend

Atualmente, o front apenas insere placeholders.
Precisamos garantir que ele renderize os textos e estados marcados corretamente no carregamento inicial, sem depender de re-selecionar o projeto.

Substitua a l√≥gica atual de renderiza√ß√£o do checklist por este trecho:

<script>
document.addEventListener("DOMContentLoaded", () => {
  if (!window.REPORT_DATA) return console.warn("Sem dados de relat√≥rio");

  const checklistContainer = document.querySelector('#checklist-container');
  if (!checklistContainer) return;

  checklistContainer.innerHTML = "";

  if (Array.isArray(REPORT_DATA.checklist) && REPORT_DATA.checklist.length > 0) {
    REPORT_DATA.checklist.forEach(item => {
      const div = document.createElement("div");
      div.classList.add("check-item");
      div.innerHTML = `
        <label class="d-block mb-2">
          <input type="checkbox" data-id="${item.id}" ${item.checked ? "checked" : ""}>
          <span class="ms-2">${item.texto || "Sem descri√ß√£o"}</span>
        </label>
        <textarea class="form-control form-control-sm" placeholder="Observa√ß√µes sobre este item..." data-id="${item.id}">${item.observacao || ""}</textarea>
      `;
      checklistContainer.appendChild(div);
    });
  } else {
    checklistContainer.innerHTML = `<div class="text-muted">Nenhum item de checklist dispon√≠vel.</div>`;
  }

  console.info(`Checklist carregado com ${REPORT_DATA.checklist?.length || 0} itens.`);
});
</script>


‚úÖ Com isso, o checklist:

√© renderizado imediatamente ao abrir o modo de edi√ß√£o;

exibe os textos originais;

marca os j√° conclu√≠dos (checked);

mant√©m o textarea com observa√ß√µes j√° salvas.

üîÑ 4Ô∏è‚É£ ‚Äî Sincronizar checklist com o projeto selecionado (sem perder os marcados)

Quando o usu√°rio troca o projeto manualmente, o front deve recarregar o checklist, mas preservando os j√° marcados.

Inclua o seguinte dentro do listener select[name="projeto_id"].addEventListener('change', ...):

// Armazenar checkboxes marcados antes de trocar o projeto
const currentCheckedIds = Array.from(document.querySelectorAll('#checklist-container input[type=checkbox]:checked'))
  .map(cb => cb.dataset.id);

// Depois que a nova lista for carregada do backend via /api/checklist-padrao?projeto=ID
fetch(`/api/checklist-padrao?projeto=${projetoId}`)
  .then(r => r.json())
  .then(novoChecklist => {
    checklistContainer.innerHTML = "";
    novoChecklist.forEach(item => {
      const div = document.createElement("div");
      const checked = currentCheckedIds.includes(String(item.id)) ? "checked" : "";
      div.innerHTML = `
        <label><input type="checkbox" data-id="${item.id}" ${checked}> ${item.texto}</label>
      `;
      checklistContainer.appendChild(div);
    });
  });

üßæ 5Ô∏è‚É£ ‚Äî Testes que devem passar ap√≥s corre√ß√£o
Caso de teste	Resultado esperado
Abrir /reports/<id>/editarrel	Checklist carrega com texto e checkboxes marcados corretamente
Trocar o projeto manualmente	Checklist atualiza com os itens do novo projeto
Reselecionar o mesmo projeto	Mant√©m os marcados
Backend loga ‚úÖ Dados enviados ao template	Contagem correta de checklist, fotos e acompanhantes
Nenhum erro JS classList ou tojson	‚úÖ sem erro no console
‚úÖ Resumo do que o prompt deve executar

Corrigir rota duplicada /api/checklist-padrao.

Garantir que report_edit_complete serialize corretamente o checklist com texto, observacao e checked.

Corrigir JS de renderiza√ß√£o para preencher corretamente sem depender de re-selecionar o projeto.

Implementar persist√™ncia de sele√ß√£o de checklist ao trocar o projeto.

Confirmar no console/logs que REPORT_DATA.checklist vem preenchido e renderizado.