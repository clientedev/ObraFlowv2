PROMPT ABSOLUTO PARA CORRE√á√ÉO TOTAL DA EDI√á√ÉO DE RELAT√ìRIOS
"""
OBJETIVO:
Corrigir completamente a rota /reports/<int:report_id>/editarrel e o template form_complete.html
para que todos os dados do relat√≥rio sejam carregados e exibidos corretamente.
"""

# routes.py

from flask import render_template
from flask_login import login_required
from sqlalchemy.orm import joinedload
from app import app, db
from models import Relatorio, Projeto, FotosRelatorio, ChecklistObra, FuncionariosProjetos


@app.route("/reports/<int:report_id>/editarrel", methods=["GET"])
@login_required
def report_edit_complete(report_id):
    try:
        app.logger.info(f"üß© Iniciando carregamento completo do relat√≥rio {report_id}")

        rel = (
            db.session.query(Relatorio)
            .options(joinedload(Relatorio.projeto))
            .filter(Relatorio.id == report_id)
            .first()
        )

        if not rel:
            app.logger.error(f"‚ùå Relat√≥rio {report_id} n√£o encontrado.")
            return render_template("reports/error_report.html", message="Relat√≥rio n√£o encontrado."), 404

        # Buscar rela√ß√µes
        projeto = Projeto.query.get(rel.projeto_id)
        fotos = FotosRelatorio.query.filter_by(relatorio_id=report_id).all()
        checklist = ChecklistObra.query.filter_by(relatorio_id=report_id).all()
        acompanhantes = FuncionariosProjetos.query.filter_by(projeto_id=rel.projeto_id).all()

        app.logger.info(f"‚úÖ Dados carregados: projeto={bool(projeto)}, fotos={len(fotos)}, checklist={len(checklist)}, acompanhantes={len(acompanhantes)}")

        # Estruturar dicion√°rio JSON serializ√°vel
        report_data = {
            "id": rel.id,
            "data_relatorio": rel.data_relatorio.strftime("%Y-%m-%d") if rel.data_relatorio else "",
            "titulo": rel.titulo or "",
            "numero": rel.numero_relatorio or "",
            "observacoes": rel.observacoes or "",
            "lembrete": rel.lembrete or "",
            "projeto": {
                "id": projeto.id if projeto else "",
                "nome": projeto.nome if projeto else "",
                "codigo": projeto.codigo if projeto else "",
                "endereco": projeto.endereco if projeto else "",
                "responsavel": getattr(projeto, "responsavel", ""),
            } if projeto else None,
            "fotos": [
                {
                    "id": f.id,
                    "url": getattr(f, "url", None) or getattr(f, "public_url", None),
                    "legenda": getattr(f, "legenda", ""),
                }
                for f in fotos
            ],
            "checklist": [
                {"id": c.id, "descricao": c.descricao, "concluido": c.concluido}
                for c in checklist
            ],
            "acompanhantes": [
                {"id": a.id, "nome": a.nome_funcionario, "funcao": getattr(a, "funcao", "N√£o informado")}
                for a in acompanhantes
            ],
        }

        return render_template(
            "reports/form_complete.html",
            report_data=report_data,
            edit_mode=True,
        )

    except Exception as e:
        app.logger.error(f"‚ùå ERRO ao carregar relat√≥rio {report_id}: {e}", exc_info=True)
        return render_template("reports/error_report.html", message=str(e)), 500

üß© ADAPTA√á√ÉO NO form_complete.html

No in√≠cio do arquivo (logo ap√≥s {% extends "base.html" %} e antes do formul√°rio):

{% block content %}
<script>
    // Dados vindos do Flask
    const reportData = {{ report_data | tojson | safe }};
    const isEditMode = {{ 'true' if edit_mode else 'false' }};
</script>
{% endblock %}


Em seguida, no final do mesmo arquivo (antes de </body>):

<script>
document.addEventListener("DOMContentLoaded", () => {
    if (!isEditMode || !reportData) return;
    console.log("‚úèÔ∏è Modo edi√ß√£o ativo:", reportData);

    // Preencher campos principais
    document.querySelector('input[name="data_relatorio"]').value = reportData.data_relatorio || "";
    document.querySelector('input[name="titulo"]').value = reportData.titulo || "";
    document.querySelector('input[name="numero"]').value = reportData.numero || "";

    // Preencher projeto
    if (reportData.projeto && reportData.projeto.nome) {
        const projetoSelect = document.querySelector('select[name="projeto_id"]');
        if (projetoSelect) {
            const opt = document.createElement("option");
            opt.value = reportData.projeto.id;
            opt.textContent = `${reportData.projeto.codigo} - ${reportData.projeto.nome}`;
            projetoSelect.appendChild(opt);
            projetoSelect.value = reportData.projeto.id;
        }
    }

    // Preencher observa√ß√µes
    const obs = document.querySelector('textarea[name="observacoes"]');
    if (obs) obs.value = reportData.observacoes || "";

    // Lembrete
    const lembrete = document.querySelector('textarea[name="lembrete"]');
    if (lembrete) lembrete.value = reportData.lembrete || "";

    // Acompanhantes
    if (reportData.acompanhantes?.length) {
        const cont = document.querySelector("#acompanhantes-container");
        cont.innerHTML = "";
        reportData.acompanhantes.forEach(a => {
            const div = document.createElement("div");
            div.className = "acompanhante-item";
            div.innerHTML = `<span>üë§ ${a.nome}</span> <small>${a.funcao}</small>`;
            cont.appendChild(div);
        });
    }

    // Fotos
    if (reportData.fotos?.length) updatePhotoGallery(reportData.fotos);

    // Checklist
    if (reportData.checklist?.length) {
        const chk = document.querySelector("#checklist-container");
        chk.innerHTML = "";
        reportData.checklist.forEach(i => {
            const item = document.createElement("div");
            item.className = "checklist-item";
            item.innerHTML = `<input type="checkbox" ${i.concluido ? "checked" : ""}> ${i.descricao}`;
            chk.appendChild(item);
        });
    }

    console.log("‚úÖ Relat√≥rio carregado e campos preenchidos.");
});

function updatePhotoGallery(fotos) {
    const gallery = document.querySelector("#photo-gallery");
    if (!gallery) return;
    gallery.innerHTML = "";
    fotos.forEach(f => {
        const img = document.createElement("img");
        img.src = f.url;
        img.alt = f.legenda;
        img.title = f.legenda;
        img.style = "width:100px;height:100px;margin:4px;border-radius:8px;object-fit:cover;";
        gallery.appendChild(img);
    });
    console.log(`üì∏ ${fotos.length} fotos exibidas na galeria.`);
}
</script>

üöÄ O que isso faz

‚úÖ Corrige completamente o n√£o carregamento dos dados.
‚úÖ O Flask envia tudo em JSON (report_data).
‚úÖ O JavaScript preenche todos os campos do formul√°rio, inclusive selects, textarea e fotos.
‚úÖ O erro updatePhotoGallery is not defined desaparece ‚Äî ela √© definida no pr√≥prio template.
‚úÖ Se o backend falhar, o log exc_info=True mostra exatamente o ponto.
‚úÖ Nenhum dado fica invis√≠vel, pois o console.log confirma campo a campo.