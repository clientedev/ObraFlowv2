Corre√ß√£o Erro 500 ao Editar Obra
üß† Resumo do erro

O traceback indica:

TypeError: Object of type CategoriaObra is not JSON serializable


no trecho:

const categoriasExistentes = {{ categorias|tojson }};


üìå Causa:
O Flask tenta converter objetos ORM (CategoriaObra) diretamente para JSON, mas isso n√£o √© poss√≠vel sem antes transform√°-los em um dicion√°rio (dict) serializ√°vel.

‚úÖ Objetivo

Corrigir o carregamento das categorias na rota /projects/<id>/edit, garantindo que:

As categorias sejam convertidas corretamente para JSON.

A tela de edi√ß√£o carregue sem erro 500.

O usu√°rio consiga visualizar, editar e excluir categorias normalmente.

O JavaScript receba os dados via categoriasExistentes sem quebrar o template.

üõ†Ô∏è Etapas de Corre√ß√£o
1Ô∏è‚É£ Atualize a rota /projects/<id>/edit no routes.py

Localize a fun√ß√£o semelhante a esta:

@app.route('/projects/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def project_edit(id):
    project = Project.query.get_or_404(id)
    form = ProjectForm(obj=project)
    categorias_existentes = CategoriaObra.query.filter_by(project_id=id).all()
    return render_template('projects/form.html', form=form, project=project, categorias=categorias_existentes)


‚û°Ô∏è Substitua pela vers√£o corrigida abaixo:

@app.route('/projects/<int:id>/edit', methods=['GET', 'POST'])
@login_required
def project_edit(id):
    project = Project.query.get_or_404(id)
    form = ProjectForm(obj=project)

    # Buscar categorias vinculadas ao projeto
    categorias_existentes = CategoriaObra.query.filter_by(project_id=id).order_by(CategoriaObra.ordem.asc()).all()

    # Converter cada categoria para dicion√°rio serializ√°vel
    categorias_serializadas = [
        {
            "id": c.id,
            "nome": c.nome,
            "ordem": c.ordem,
            "project_id": c.project_id
        }
        for c in categorias_existentes
    ]

    return render_template(
        'projects/form.html',
        form=form,
        project=project,
        categorias=categorias_serializadas
    )


üß© Isso garante que categorias agora √© uma lista de dicts JSON-serializ√°veis, permitindo que {{ categorias|tojson }} funcione normalmente.

2Ô∏è‚É£ Confirme o trecho do template projects/form.html

Verifique se o trecho onde √© injetado o JSON est√° assim:

<script>
    const categoriasExistentes = {{ categorias|tojson }};
</script>


‚û°Ô∏è Este trecho agora funcionar√° sem gerar erro, pois categorias j√° vem serializado corretamente.

3Ô∏è‚É£ Verifique o modelo CategoriaObra

Garanta que possui os campos necess√°rios e coerentes:

class CategoriaObra(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    nome = db.Column(db.String(255), nullable=False)
    ordem = db.Column(db.Integer, default=0)
    project_id = db.Column(db.Integer, db.ForeignKey('project.id'), nullable=False)


‚ö†Ô∏è Se faltar o campo project_id, crie uma migra√ß√£o Alembic:

alembic revision --autogenerate -m "Add project_id to CategoriaObra"
alembic upgrade head

4Ô∏è‚É£ (Opcional, mas recomendado)

Adicione um m√©todo helper no modelo para facilitar futuras serializa√ß√µes:

class CategoriaObra(db.Model):
    ...
    def to_dict(self):
        return {
            "id": self.id,
            "nome": self.nome,
            "ordem": self.ordem,
            "project_id": self.project_id
        }


E use na rota:

categorias_serializadas = [c.to_dict() for c in categorias_existentes]

5Ô∏è‚É£ Testes

Ap√≥s aplicar as mudan√ßas:

Reinicie o Replit (Ctrl+C e python main.py ou flask run).

Acesse novamente:
üëâ https://elpconsultoria.pro/projects/1/edit

Verifique:

A p√°gina carrega sem erro 500.

As categorias s√£o exibidas no painel.

√â poss√≠vel adicionar, editar e excluir.

As mudan√ßas persistem ap√≥s salvar.

‚úÖ Checklist Final
Item	Resultado Esperado
Erro 500	‚ùå Corrigido
P√°gina de edi√ß√£o	‚úÖ Carrega normalmente
Categorias aparecem	‚úÖ Sim
JSON no template	‚úÖ Renderizado corretamente
Migra√ß√£o BD	‚öôÔ∏è Confirmada se project_id faltar