Prompt T√©cnico Profissional ‚Äî Reestrutura√ß√£o Completa de Salvamento Autom√°tico, Edi√ß√£o e Sincroniza√ß√£o de Relat√≥rios com Imagens

Reestruture completamente o fluxo de cria√ß√£o, edi√ß√£o e salvamento de relat√≥rios para corrigir falhas no salvamento autom√°tico, carregamento, edi√ß√£o e exclus√£o de imagens, garantindo que todos os novos campos da estrutura de relat√≥rios sejam corretamente persistidos no banco de dados e sincronizados entre backend e frontend.
Caso sejam necess√°rias altera√ß√µes no banco, gerar automaticamente um novo arquivo Alembic compat√≠vel com a vers√£o mais recente do sistema, contendo todas as migra√ß√µes necess√°rias para manter a consist√™ncia da base de dados.

üéØ Objetivo

Implementar um sistema s√≥lido e inteligente de salvamento autom√°tico e gerenciamento de relat√≥rios, que:

Salve automaticamente todos os campos e imagens do relat√≥rio em tempo real, sem necessidade de a√ß√£o manual do usu√°rio.

Carregue corretamente as imagens associadas a cada relat√≥rio ao abrir para edi√ß√£o.

Permita editar, reordenar e excluir imagens sem afetar o restante dos dados.

Inclua as imagens no processo de salvamento autom√°tico.

Garanta a persist√™ncia de todos os novos campos da estrutura de relat√≥rio (incluindo data, local, categoria, lembrete, observa√ß√µes e metadados).

Mantenha sincroniza√ß√£o completa entre frontend, backend e banco de dados.

Caso necess√°rio, gere automaticamente o arquivo de migra√ß√£o Alembic, atualizando o banco sem quebra de compatibilidade.

‚öôÔ∏è Requisitos T√©cnicos ‚Äî Backend
Endpoints a serem revisados ou criados

POST /api/relatorios

Cria um novo relat√≥rio e retorna o id.

Suporte a upload inicial de imagens (multipart/form-data).

Persiste metadados e estrutura completa conforme o novo modelo.

PUT /api/relatorios/<id>

Atualiza todos os campos do relat√≥rio existente.

Sincroniza imagens: adiciona novas, atualiza legendas/ordem e remove as exclu√≠das.

Suporta salvamento autom√°tico incremental (via timestamps).

Deve tratar corretamente tanto payload JSON quanto multipart.

GET /api/relatorios/<id>

Retorna todos os campos do relat√≥rio e as imagens associadas em formato estruturado.

DELETE /api/relatorios/<id>/imagens/<imagem_id>

Remove uma imagem do relat√≥rio, tanto no banco quanto no armazenamento f√≠sico.

üóÇÔ∏è Modelo de Dados ‚Äî Banco de Dados
relatorios

Deve conter os campos da nova estrutura:

CREATE TABLE relatorios (
    id SERIAL PRIMARY KEY,
    titulo VARCHAR(255),
    descricao TEXT,
    categoria VARCHAR(100),
    local VARCHAR(255),
    lembrete_proxima_visita TIMESTAMP NULL,
    observacoes_finais TEXT,
    criado_por INTEGER REFERENCES usuarios(id),
    atualizado_por INTEGER REFERENCES usuarios(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    status VARCHAR(50) DEFAULT 'em_andamento'
);

relatorio_imagens

Tabela de v√≠nculo das imagens:

CREATE TABLE relatorio_imagens (
    id SERIAL PRIMARY KEY,
    relatorio_id INTEGER REFERENCES relatorios(id) ON DELETE CASCADE,
    url TEXT NOT NULL,
    legenda TEXT NULL,
    ordem INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT NOW()
);

‚öôÔ∏è Migra√ß√£o com Alembic

Se a estrutura do banco de dados n√£o estiver alinhada com os modelos acima,
gerar automaticamente um novo arquivo de migra√ß√£o Alembic, garantindo compatibilidade com a vers√£o mais recente.

Instru√ß√µes t√©cnicas para o desenvolvedor:

Verificar se todas as colunas (categoria, local, lembrete_proxima_visita, observacoes_finais, status, etc.) est√£o presentes.

Caso alguma esteja ausente, rodar:

alembic revision --autogenerate -m "Atualiza√ß√£o estrutura de relat√≥rios e imagens"
alembic upgrade head


Garantir que o arquivo Alembic gerado seja armazenado corretamente em /migrations/versions e versionado junto ao c√≥digo.

üñ•Ô∏è Fluxo no Frontend
Cria√ß√£o e Edi√ß√£o

Salvamento autom√°tico (autosave) com debounce de 3 segundos.

Toda altera√ß√£o em campos textuais ou imagens dispara o autosave.

O autosave deve enviar apenas campos e imagens alterados.

Carregamento de imagens

Ao abrir um relat√≥rio, carregar as imagens via /api/relatorios/<id>.

Exibir previews com op√ß√£o de:

Alterar legenda.

Excluir imagem.

Reordenar visualmente (drag and drop).

Sincroniza√ß√£o

O estado local do relat√≥rio deve conter:

{
  id,
  titulo,
  descricao,
  categoria,
  local,
  lembrete_proxima_visita,
  observacoes_finais,
  imagens: [
    { id, url, legenda, ordem, novo: bool, excluir: bool }
  ],
  atualizado_em
}


E o backend deve garantir:

Upload e remo√ß√£o de imagens corretamente sincronizados.

Atualiza√ß√£o autom√°tica dos campos updated_at e created_at.

Persist√™ncia completa das rela√ß√µes.

üß© Boas Pr√°ticas e Garantias

Transa√ß√µes at√¥micas para sincronizar relatorios e relatorio_imagens.

Rollback autom√°tico em caso de erro parcial.

Valida√ß√£o de tipo e tamanho de imagem no upload.

Logs detalhados para falhas de sincroniza√ß√£o.

Feedback visual no frontend (‚ÄúSalvando...‚Äù, ‚ÄúSalvo com sucesso‚Äù, ‚ÄúErro ao salvar‚Äù).

Controle de versionamento Alembic ativo e sincronizado com o c√≥digo backend.

‚úÖ Crit√©rios de Aceita√ß√£o

 Salvamento autom√°tico inclui campos e imagens.

 Edi√ß√£o carrega corretamente todas as imagens.

 Exclus√£o e atualiza√ß√£o refletem em tempo real.

 Banco atualizado com todas as novas colunas.

 Alembic gera e aplica migra√ß√£o automaticamente se necess√°rio.

 Nenhum dado perdido ou sobrescrito durante autosave.