Corre√ß√£o de Geolocaliza√ß√£o e Integra√ß√£o Railway

Implemente as seguintes corre√ß√µes para o sistema de relat√≥rios em Flask + Railway:

Corre√ß√£o do Erro "User denied Geolocation"

Atualmente, mesmo com permiss√µes concedidas no mobile, o navegador retorna erro de geolocaliza√ß√£o.

Ajustar o c√≥digo para usar corretamente a API de geolocaliza√ß√£o do navegador:

if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
        (position) => {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            console.log("Localiza√ß√£o capturada:", latitude, longitude);
            // enviar para backend
            fetch("/save_location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lat: latitude, lng: longitude })
            });
        },
        (error) => {
            console.error("Erro ao capturar localiza√ß√£o:", error);
            alert("N√£o foi poss√≠vel capturar sua localiza√ß√£o. Verifique se a permiss√£o est√° ativa.");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
} else {
    alert("Geolocaliza√ß√£o n√£o suportada neste dispositivo.");
}


Importante: incluir enableHighAccuracy: true e timeout para garantir captura em Android/iOS.

Tratar erros de PERMISSION_DENIED, POSITION_UNAVAILABLE e TIMEOUT.

Corre√ß√£o CORS e HTTPS no Railway

Garantir que chamadas √† geolocaliza√ß√£o sejam feitas em conex√µes seguras (HTTPS).

Adicionar no backend Flask:

from flask_cors import CORS
CORS(app, supports_credentials=True)


For√ßar HTTPS em produ√ß√£o no Railway.

Integra√ß√£o com Railway

No main.py, criar rota para salvar localiza√ß√£o:

@app.route('/save_location', methods=['POST'])
def save_location():
    data = request.get_json()
    lat, lng = data.get("lat"), data.get("lng")
    if not lat or not lng:
        return {"status": "error", "message": "Localiza√ß√£o inv√°lida"}, 400
    # salvar em banco ou log
    print(f"üìç Localiza√ß√£o recebida: {lat}, {lng}")
    return {"status": "success", "lat": lat, "lng": lng}, 200


Valida√ß√£o no Railway

Usar navigator.permissions.query({ name: 'geolocation' }) para verificar se a permiss√£o est√° realmente concedida e, caso contr√°rio, solicitar novamente ao usu√°rio.

Teste no Mobile

Testar em Android Chrome e iOS Safari, garantindo que a permiss√£o solicitada apare√ßa apenas 1 vez e, ap√≥s concedida, n√£o retorne mais User denied Geolocation.

‚úÖ Objetivo final:

Usu√°rio clica em Localizar ‚Üí Captura localiza√ß√£o corretamente em mobile.

Dados s√£o enviados para /save_location e vinculados ao relat√≥rio/obra.

Nenhum erro "User denied Geolocation" deve aparecer se a permiss√£o foi concedida.