INTEGRA√á√ÉO RESEND

üö® Este prompt substitui completamente a fun√ß√£o de envio de e-mails ao aprovar relat√≥rios,
garantindo que o PDF seja anexado e enviado via Resend para todos os envolvidos.

Voc√™ deve revisar todo o projeto Flask atual e substituir **qualquer uso de Flask-Mail** pela integra√ß√£o com **Resend**, garantindo que o envio de e-mails ao aprovar relat√≥rios funcione corretamente.

üß© 1. CONFIGURA√á√ÉO
O sistema j√° possui as seguintes vari√°veis de ambiente:
RESEND_API_KEY = "re_gY6c2vnb_CXhLes2MewUuq4BY85G8stDQ"
RESEND_FROM_EMAIL = "relatorios@elpconsultoria.eng.br"

üì° O dom√≠nio elpconsultoria.eng.br j√° est√° verificado no Resend, regi√£o S√£o Paulo (sa-east-1), e com os seguintes registros DNS configurados:
- TXT resend._domainkey ‚Üí p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDfj29U1POcJiJGv0kg/JzQPZAjDj8Usa9y8qYhZFcu7w5gYopGtuthUV3Em0Alen0wgx7ATgFkLZOrVtWAdSGJq42TqEDcONIxFsxyk4+n3b+UlvZr0u51sTL8jzc+0WoSA2PbleH6ElCXljLTmEyaTbRyr/RDhtWEFZVFJQd9PwIDAQAB
- MX send ‚Üí feedback-smtp.sa-east-1.amazonses.com
- TXT send ‚Üí v=spf1 include:amazonses.com ~all
- TXT _dmarc (opcional) ‚Üí v=DMARC1; p=none;

üß© 2. IMPLEMENTA√á√ÉO ‚Äî NOVO SERVI√áO DE EMAIL

Crie um arquivo chamado `email_service.py` (ou substitua o existente) com o seguinte conte√∫do:

```python
import os
import requests

class EmailServiceRelatorio:
    def __init__(self):
        self.api_key = os.getenv("RESEND_API_KEY")
        self.from_email = os.getenv("RESEND_FROM_EMAIL", "relatorios@elpconsultoria.eng.br")
        self.api_url = "https://api.resend.com/emails"

    def enviar_relatorio_por_email(self, relatorio_id, destinatarios, assunto, corpo_html, pdf_path):
        """Envia e-mail via Resend com anexo PDF."""
        headers = {
            "Authorization": f"Bearer {self.api_key}",
        }

        with open(pdf_path, "rb") as f:
            pdf_bytes = f.read()

        files = {
            "from": (None, f"ELP Consultoria <{self.from_email}>"),
            "to": (None, ", ".join(destinatarios)),
            "subject": (None, assunto),
            "html": (None, corpo_html),
            "attachments[0]": (f"relatorio_{relatorio_id}.pdf", pdf_bytes, "application/pdf")
        }

        response = requests.post(self.api_url, headers=headers, files=files)
        if response.status_code == 200:
            print(f"‚úÖ E-mail enviado com sucesso para {destinatarios}")
            return True
        else:
            print(f"‚ùå Erro ao enviar e-mail: {response.text}")
            return False


üß© 3. AJUSTE NA ROTA DE APROVA√á√ÉO DO RELAT√ìRIO

No arquivo routes.py, localize a rota /reports/<int:report_id>/approve e substitua o c√≥digo atual pelo seguinte:

from email_service import EmailServiceRelatorio

@app.route("/reports/<int:report_id>/approve", methods=["POST"])
@login_required
def approve_report(report_id):
    """Aprova o relat√≥rio, gera o PDF e envia e-mail via Resend."""
    relatorio = db.session.get(Relatorio, report_id)
    if not relatorio:
        return jsonify({"error": "Relat√≥rio n√£o encontrado"}), 404

    pdf_path = f"/app/static/reports/relatorio_{relatorio.numero}.pdf"

    destinatarios = []
    if relatorio.responsavel and relatorio.responsavel.email:
        destinatarios.append(relatorio.responsavel.email)
    for acomp in relatorio.acompanhantes:
        if acomp.email:
            destinatarios.append(acomp.email)
    if current_user.email:
        destinatarios.append(current_user.email)

    assunto = f"RELAT√ìRIO-{relatorio.numero}"
    corpo_html = f"""
    <p>Ol√°,</p>
    <p>Este √© o relat√≥rio da obra <b>{relatorio.projeto.nome}</b>.</p>
    <p>Qualquer d√∫vida, entre em contato com <b>{relatorio.responsavel.email}</b>.</p>
    <p>Atenciosamente,<br>Equipe ELP Consultoria</p>
    """

    email_service = EmailServiceRelatorio()
    sucesso = email_service.enviar_relatorio_por_email(
        relatorio.id, destinatarios, assunto, corpo_html, pdf_path
    )

    if sucesso:
        relatorio.status = "Aprovado"
        db.session.commit()
        print(f"‚úÖ Relat√≥rio {relatorio.numero} aprovado e e-mail enviado.")
        return jsonify({"success": True, "message": "Relat√≥rio aprovado e e-mail enviado com sucesso"})
    else:
        print(f"‚ùå Falha ao enviar e-mail para relat√≥rio {relatorio.numero}")
        return jsonify({"error": "Falha ao enviar e-mail"}), 500


üß© 4. VERIFICA√á√ÉO FINAL

Certifique-se de que o PDF existe antes de enviar.

Verifique se o dom√≠nio elpconsultoria.eng.br aparece como ‚ÄúVerified‚Äù no painel Resend.

Teste aprovando um relat√≥rio real.

Verifique no console do Replit:
‚Üí ‚úÖ E-mail enviado com sucesso para [...]

üì© O e-mail deve chegar a todos os destinat√°rios (respons√°vel, acompanhantes e autor).

üéØ OBJETIVO FINAL:

Remover completamente depend√™ncias SMTP e Flask-Mail.

Integrar envio 100% via HTTPS com Resend.

Garantir aprova√ß√£o de relat√≥rio com envio imediato e seguro.