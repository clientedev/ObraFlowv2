PROMPT T√âCNICO COMPLETO E PROFISSIONAL

(Corrige definitivamente o erro 400 e garante o upload correto das imagens tempor√°rias no AutoSave)

üßæ Prompt para ajuste de c√≥digo

‚öôÔ∏è Instru√ß√µes para corrigir o upload de imagens no AutoSave (reports_autosave.js)

üîπ 1. Atualizar fun√ß√£o de upload tempor√°rio

Substitua completamente o m√©todo uploadImageTemp por esta vers√£o robusta e compat√≠vel com FastAPI + Railway:

/**
 * Faz upload da imagem tempor√°ria com multipart/form-data
 * Retorna o ID tempor√°rio salvo no backend
 */
async uploadImageTemp(image) {
  try {
    if (!image || !image.blob) {
      console.warn("‚ö†Ô∏è Imagem inv√°lida ou blob ausente:", image);
      return null;
    }

    console.log("üì§ AutoSave - Preparando upload da imagem:", image.filename);

    const formData = new FormData();
    formData.append("file", image.blob, image.filename || "imagem.jpg");
    formData.append("category", image.category || "");
    formData.append("local", image.local || "");
    formData.append("caption", image.caption || "");

    const response = await fetch("https://elpconsultoria.pro/api/uploads/temp", {
      method: "POST",
      body: formData,
      // ‚ö†Ô∏è N√ÉO adicionar 'Content-Type' manualmente ‚Äî o browser define o boundary
    });

    if (!response.ok) {
      const msg = await response.text();
      console.error("‚ùå Erro HTTP no upload:", response.status, msg);
      throw new Error(`Upload falhou: ${response.status}`);
    }

    const data = await response.json();
    console.log("‚úÖ Upload tempor√°rio bem-sucedido:", data);

    return data.temp_id || data.id || null;
  } catch (err) {
    console.error("‚ùå Erro no upload tempor√°rio:", err);
    throw err;
  }
}

üîπ 2. Ajustar coleta de imagens para chamar o upload corretamente

Substitua o trecho em getImageData() por:

async getImageData() {
  const imgs = window.mobilePhotoData || [];
  const uploaded = [];

  for (let i = 0; i < imgs.length; i++) {
    const img = imgs[i];
    console.log(`üì∏ Imagem ${i}:`, img);

    try {
      const tempId = await this.uploadImageTemp(img);
      uploaded.push({
        temp_id: tempId,
        filename: img.filename,
        category: img.category,
        local: img.local,
        caption: img.caption,
      });
    } catch (err) {
      console.error(`‚ùå AutoSave - Erro no upload da imagem ${i}:`, err);
    }
  }

  console.log(`üì∏ AutoSave - Total de ${uploaded.length} imagens enviadas`);
  return uploaded;
}

üîπ 3. Garantir coleta completa antes do envio do relat√≥rio

Substitua no performSave():

const fotos = await this.getImageData();
payload.fotos = fotos;

üîπ 4. Backend (FastAPI / Railway) ‚Äî Endpoint /api/uploads/temp

Garanta que o endpoint aceite multipart/form-data corretamente:

@router.post("/uploads/temp")
async def upload_temp_image(file: UploadFile = File(...), category: str = Form(""), local: str = Form(""), caption: str = Form("")):
    try:
        # Valida√ß√£o b√°sica
        if not file:
            raise HTTPException(status_code=400, detail="Arquivo n√£o recebido")

        file_path = f"temp/{uuid.uuid4()}_{file.filename}"
        with open(file_path, "wb") as buffer:
            buffer.write(await file.read())

        return {
            "success": True,
            "temp_id": str(uuid.uuid4()),
            "filename": file.filename,
            "path": file_path,
            "category": category,
            "local": local,
            "caption": caption,
        }
    except Exception as e:
        raise HTTPException(status_code=400, detail=f"Erro ao salvar arquivo: {e}")

üîπ 5. Teste completo

Capture 2 fotos ou envie pela galeria.

Confira no console:

üì§ AutoSave - Preparando upload da imagem: Captura_1.png
‚úÖ Upload tempor√°rio bem-sucedido: { temp_id: "...", filename: "Captura_1.png" }
üì∏ AutoSave - Total de 2 imagens enviadas


No backend, os arquivos devem ser salvos em /temp e o relat√≥rio deve conter fotos: [{ temp_id, filename, ... }].

üöÄ Resultado Esperado

‚úÖ Nenhum erro 400.
‚úÖ Upload de imagens com multipart/form-data.
‚úÖ Logs de sucesso vis√≠veis apenas no console.
‚úÖ AutoSave funcional com imagens, checklist, acompanhantes e observa√ß√µes.
‚úÖ Compat√≠vel com PostgreSQL e Railway.