CorreÃ§Ã£o do AutoSave (Erro 400 / Dados Incompletos)

Objetivo:
Corrigir o sistema de salvamento automÃ¡tico de relatÃ³rios (/api/relatorios/autosave), garantindo que todos os campos necessÃ¡rios sejam coletados, validados e enviados corretamente ao backend, incluindo checklist, observaÃ§Ãµes, lembretes e imagens â€” sem exibir nada na interface, apenas logs tÃ©cnicos no console.

âš™ï¸ Problema Atual

O AutoSave coleta parcialmente os dados:

{ titulo: null, numero: null, data_relatorio: '2025-11-02', projeto_id: '29', observacoes_finais: null, ... }


O backend recebe campos obrigatÃ³rios nulos e retorna HTTP 400 Bad Request.

Campos opcionais (como imagens, lembrete, checklist) tambÃ©m nÃ£o sÃ£o serializados corretamente.

Falta padronizaÃ§Ã£o no corpo JSON enviado.

ðŸŽ¯ Meta TÃ©cnica

Garantir que todos os campos obrigatÃ³rios sejam coletados e enviados corretamente.

Permitir o envio parcial e incremental (AutoSave nÃ£o deve exigir todos os campos preenchidos de uma vez).

Adicionar tratamento de erros detalhado no console para diagnÃ³stico.

Garantir salvamento temporÃ¡rio no localStorage se o servidor nÃ£o responder.

Manter o sistema totalmente silencioso na interface (sem alertas ou popups).

ðŸ§© IMPLEMENTAÃ‡ÃƒO DETALHADA
ðŸ”¹ 1. Frontend â€” reports_autosave.js
âœ… Coleta completa e segura de dados:

Substituir o mÃ©todo collectFormData() atual por:

collectFormData() {
  try {
    const data = {
      id: window.currentReportId || null,
      titulo: document.querySelector("#titulo_relatorio")?.value?.trim() || null,
      numero: document.querySelector("#numero_relatorio")?.value?.trim() || null,
      data_relatorio: document.querySelector("#data_relatorio")?.value || null,
      projeto_id: document.querySelector("#projeto_id")?.value || null,
      observacoes_finais: document.querySelector("#observacoes")?.value?.trim() || null,
      lembrete_proxima_visita: document.querySelector("#lembrete")?.value?.trim() || null,
      categoria: document.querySelector("#categoria")?.value || null,
      local: document.querySelector("#local")?.value?.trim() || null,
      descricao: document.querySelector("#descricao")?.value?.trim() || null,
      checklist_data: this.getChecklistData(),
      fotos: this.getImageData(),
    };

    console.log("ðŸŸ¦ AutoSave - Dados coletados:", data);
    return data;

  } catch (err) {
    console.error("âŒ Erro ao coletar dados do formulÃ¡rio:", err);
    return {};
  }
}

âœ… Coleta de checklist corrigida:
getChecklistData() {
  return Array.from(document.querySelectorAll(".checklist-item")).map(item => ({
    nome: item.querySelector("label")?.textContent?.trim() || "",
    status: item.querySelector("input[type='checkbox']")?.checked || false,
    observacao: item.querySelector("textarea")?.value?.trim() || ""
  }));
}

âœ… Coleta de imagens corrigida:
getImageData() {
  const imgs = window.attachedImages || [];
  return imgs.map(img => ({
    nome: img.name || null,
    categoria: img.category || null,
    local: img.location || null,
    legenda: img.caption || null
  }));
}

âœ… Envio de dados seguro (tratando erro 400):
async performSave() {
  const payload = this.collectFormData();

  if (!payload.projeto_id) {
    console.warn("âš ï¸ AutoSave ignorado: projeto nÃ£o selecionado.");
    return;
  }

  try {
    const response = await fetch("/api/relatorios/autosave", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      console.error(`âŒ AutoSave erro HTTP ${response.status}:`, err);
      throw new Error(err.detail || "Falha no autosave");
    }

    const result = await response.json();
    console.log("âœ… AutoSave concluÃ­do:", result);

  } catch (error) {
    console.warn("âš ï¸ AutoSave falhou:", error.message);
    console.info("ðŸ’¾ Salvando temporariamente no localStorage...");
    localStorage.setItem("autosave_draft", JSON.stringify(payload));
  }
}

âœ… Agendamento automÃ¡tico e discreto:
startAutoSave() {
  let timer;
  const handler = () => {
    clearTimeout(timer);
    timer = setTimeout(() => this.performSave(), 2500);
  };

  document.querySelectorAll("input, textarea, select").forEach(el => {
    el.addEventListener("input", handler);
    el.addEventListener("change", handler);
  });

  console.log("ðŸ•’ AutoSave ativado (sem notificaÃ§Ãµes visuais).");
}

ðŸ”¹ 2. Backend â€” FastAPI /api/relatorios/autosave

Corrigir endpoint para aceitar atualizaÃ§Ãµes parciais e validar campos dinamicamente:

@router.post("/api/relatorios/autosave")
async def autosave_relatorio(payload: dict, db: Session = Depends(get_db)):
    try:
        relatorio_id = payload.get("id")
        if relatorio_id:
            relatorio = db.query(Relatorio).filter_by(id=relatorio_id).first()
            if not relatorio:
                raise HTTPException(status_code=404, detail="RelatÃ³rio nÃ£o encontrado")
        else:
            relatorio = Relatorio()
            db.add(relato...