Corre√ß√£o do AutoSave (Erro 400 / Dados Incompletos)

Objetivo:
Corrigir o sistema de salvamento autom√°tico de relat√≥rios (/api/relatorios/autosave), garantindo que todos os campos necess√°rios sejam coletados, validados e enviados corretamente ao backend, incluindo checklist, observa√ß√µes, lembretes e imagens ‚Äî sem exibir nada na interface, apenas logs t√©cnicos no console.

‚öôÔ∏è Problema Atual

O AutoSave coleta parcialmente os dados:

{ titulo: null, numero: null, data_relatorio: '2025-11-02', projeto_id: '29', observacoes_finais: null, ... }


O backend recebe campos obrigat√≥rios nulos e retorna HTTP 400 Bad Request.

Campos opcionais (como imagens, lembrete, checklist) tamb√©m n√£o s√£o serializados corretamente.

Falta padroniza√ß√£o no corpo JSON enviado.

üéØ Meta T√©cnica

Garantir que todos os campos obrigat√≥rios sejam coletados e enviados corretamente.

Permitir o envio parcial e incremental (AutoSave n√£o deve exigir todos os campos preenchidos de uma vez).

Adicionar tratamento de erros detalhado no console para diagn√≥stico.

Garantir salvamento tempor√°rio no localStorage se o servidor n√£o responder.

Manter o sistema totalmente silencioso na interface (sem alertas ou popups).

üß© IMPLEMENTA√á√ÉO DETALHADA
üîπ 1. Frontend ‚Äî reports_autosave.js
‚úÖ Coleta completa e segura de dados:

Substituir o m√©todo collectFormData() atual por:

collectFormData() {
  try {
    const data = {
      id: window.currentReportId || null,
      titulo: document.querySelector("#titulo_relatorio")?.value?.trim() || null,
      numero: document.querySelector("#numero_relatorio")?.value?.trim() || null,
      data_relatorio: document.querySelector("#data_relatorio")?.value || null,
      projeto_id: document.querySelector("#projeto_id")?.value || null,
      observacoes_finais: document.querySelector("#observacoes")?.value?.trim() || null,
      lembrete_proxima_visita: document.querySelector("#lembrete")?.value?.trim() || null,
      categoria: document.querySelector("#categoria")?.value || null,
      local: document.querySelector("#local")?.value?.trim() || null,
      descricao: document.querySelector("#descricao")?.value?.trim() || null,
      checklist_data: this.getChecklistData(),
      fotos: this.getImageData(),
    };

    console.log("üü¶ AutoSave - Dados coletados:", data);
    return data;

  } catch (err) {
    console.error("‚ùå Erro ao coletar dados do formul√°rio:", err);
    return {};
  }
}

‚úÖ Coleta de checklist corrigida:
getChecklistData() {
  return Array.from(document.querySelectorAll(".checklist-item")).map(item => ({
    nome: item.querySelector("label")?.textContent?.trim() || "",
    status: item.querySelector("input[type='checkbox']")?.checked || false,
    observacao: item.querySelector("textarea")?.value?.trim() || ""
  }));
}

‚úÖ Coleta de imagens corrigida:
getImageData() {
  const imgs = window.attachedImages || [];
  return imgs.map(img => ({
    nome: img.name || null,
    categoria: img.category || null,
    local: img.location || null,
    legenda: img.caption || null
  }));
}

‚úÖ Envio de dados seguro (tratando erro 400):
async performSave() {
  const payload = this.collectFormData();

  if (!payload.projeto_id) {
    console.warn("‚ö†Ô∏è AutoSave ignorado: projeto n√£o selecionado.");
    return;
  }

  try {
    const response = await fetch("/api/relatorios/autosave", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      console.error(`‚ùå AutoSave erro HTTP ${response.status}:`, err);
      throw new Error(err.detail || "Falha no autosave");
    }

    const result = await response.json();
    console.log("‚úÖ AutoSave conclu√≠do:", result);

  } catch (error) {
    console.warn("‚ö†Ô∏è AutoSave falhou:", error.message);
    console.info("üíæ Salvando temporariamente no localStorage...");
    localStorage.setItem("autosave_draft", JSON.stringify(payload));
  }
}

‚úÖ Agendamento autom√°tico e discreto:
startAutoSave() {
  let timer;
  const handler = () => {
    clearTimeout(timer);
    timer = setTimeout(() => this.performSave(), 2500);
  };

  document.querySelectorAll("input, textarea, select").forEach(el => {
    el.addEventListener("input", handler);
    el.addEventListener("change", handler);
  });

  console.log("üïí AutoSave ativado (sem notifica√ß√µes visuais).");
}

üîπ 2. Backend ‚Äî FastAPI /api/relatorios/autosave

Corrigir endpoint para aceitar atualiza√ß√µes parciais e validar campos dinamicamente:

@router.post("/api/relatorios/autosave")
async def autosave_relatorio(payload: dict, db: Session = Depends(get_db)):
    try:
        relatorio_id = payload.get("id")
        if relatorio_id:
            relatorio = db.query(Relatorio).filter_by(id=relatorio_id).first()
            if not relatorio:
                raise HTTPException(status_code=404, detail="Relat√≥rio n√£o encontrado")
        else:
            relatorio = Relatorio()
            db.add(relatorio)

        # Atualiza apenas campos v√°lidos
        for key, value in payload.items():
            if hasattr(relatorio, key):
                setattr(relatorio, key, value)

        db.commit()
        db.refresh(relatorio)
        print(f"‚úÖ AutoSave atualizado: relat√≥rio {relatorio.id}")
        return {"status": "ok", "id": relatorio.id}

    except Exception as e:
        db.rollback()
        print("‚ùå Erro no autosave:", str(e))
        raise HTTPException(status_code=400, detail=str(e))

üîπ 3. Banco de Dados (se necess√°rio)

Garantir que a tabela relatorios tenha os campos esperados:

ALTER TABLE relatorios
ADD COLUMN IF NOT EXISTS descricao TEXT,
ADD COLUMN IF NOT EXISTS categoria VARCHAR(255),
ADD COLUMN IF NOT EXISTS local VARCHAR(255),
ADD COLUMN IF NOT EXISTS lembrete_proxima_visita TEXT,
ADD COLUMN IF NOT EXISTS observacoes_finais TEXT;

üîç Logs Esperados no Console

Sucesso:

üü¶ AutoSave - Dados coletados: { titulo: "Relat√≥rio de visita", projeto_id: "29", ... }
‚úÖ AutoSave conclu√≠do: { id: 177, status: "ok" }


Falha:

‚ùå AutoSave erro HTTP 400: { detail: "Campo obrigat√≥rio ausente" }
‚ö†Ô∏è AutoSave falhou: Falha no autosave
üíæ Salvando temporariamente no localStorage...

‚úÖ Resultado Esperado

Nenhum erro 400.

Todos os dados (texto, checklist, imagens) salvos corretamente.

AutoSave completamente silencioso na UI.

Logs detalhados apenas no console para depura√ß√£o.

Continuidade garantida: o usu√°rio pode sair e retornar sem perder progresso.