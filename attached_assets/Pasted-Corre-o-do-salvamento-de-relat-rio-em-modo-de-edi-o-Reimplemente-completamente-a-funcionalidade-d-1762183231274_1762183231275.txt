Corre√ß√£o do salvamento de relat√≥rio em modo de edi√ß√£o

Reimplemente completamente a funcionalidade de ‚ÄúConcluir Relat√≥rio‚Äù para a rota /reports/<id>/editarrel garantindo que os dados editados sejam atualizados corretamente no relat√≥rio existente (n√£o criar novo).
Corrija tamb√©m o formato de resposta para sempre retornar JSON v√°lido (sem DOCTYPE nem HTML).

Comportamentos obrigat√≥rios:

O bot√£o Concluir Relat√≥rio deve enviar um PUT ou POST para /api/reports/<id>/update.

O backend deve fazer UPDATE de todos os campos (titulo, observacoes_finais, data_relatorio, acompanhantes, checklist, imagens, etc.).

As imagens devem ser mantidas se j√° existirem e novas devem ser adicionadas corretamente.

O retorno deve ser um JSON: { "success": true, "message": "Relat√≥rio atualizado com sucesso", "relatorio_id": id }.

Nenhuma resposta deve conter HTML ‚Äî apenas JSON.

No frontend, ap√≥s o retorno success, o sistema deve exibir uma mensagem de confirma√ß√£o e atualizar a p√°gina com os dados mais recentes.

üîß BACKEND ‚Äî rota de atualiza√ß√£o

Substituir ou criar rota /api/reports/<int:report_id>/update:

@app.route('/api/reports/<int:report_id>/update', methods=['POST'])
@login_required
def update_report(report_id):
    try:
        relatorio = db.session.get(Relatorio, report_id)
        if not relatorio:
            return jsonify({"success": False, "message": "Relat√≥rio n√£o encontrado"}), 404

        data = request.form or request.json or {}
        relatorio.titulo = data.get("titulo", relatorio.titulo)
        relatorio.observacoes_finais = data.get("observacoes_finais", relatorio.observacoes_finais)
        relatorio.data_relatorio = data.get("data_relatorio", relatorio.data_relatorio)
        relatorio.lembrete_proxima_visita = data.get("lembrete_proxima_visita")

        # Atualizar acompanhantes
        if "acompanhantes" in data:
            relatorio.acompanhantes.clear()
            for ac in data["acompanhantes"]:
                relatorio.acompanhantes.append(Funcionario.query.get(ac["id"]))

        # Atualizar checklist
        if "checklist" in data:
            relatorio.checklist = json.dumps(data["checklist"])  # armazenar lista em JSON

        # Atualizar imagens
        imagens_existentes = data.get("imagens_existentes", [])
        novas_imagens = request.files.getlist("imagens")

        # Mant√©m apenas as imagens listadas
        relatorio.imagens_relatorio = [
            img for img in relatorio.imagens_relatorio if str(img.id) in imagens_existentes
        ]

        # Adiciona novas imagens
        for arquivo in novas_imagens:
            if arquivo.filename:
                nome_arquivo = secure_filename(arquivo.filename)
                caminho = os.path.join(app.config['UPLOAD_FOLDER'], nome_arquivo)
                arquivo.save(caminho)
                nova = ImagemRelatorio(caminho=nome_arquivo, relatorio_id=relatorio.id)
                db.session.add(nova)

        db.session.commit()
        return jsonify({"success": True, "message": "Relat√≥rio atualizado com sucesso", "relatorio_id": relatorio.id})

    except Exception as e:
        db.session.rollback()
        app.logger.error(f"‚ùå Erro ao atualizar relat√≥rio {report_id}: {e}")
        return jsonify({"success": False, "message": str(e)}), 500

üß† FRONTEND ‚Äî envio correto dos dados

O bot√£o ‚ÄúConcluir Relat√≥rio‚Äù deve enviar via fetch JSON + arquivos, e n√£o tentar interpretar HTML.

async function concluirRelatorio(reportId) {
  try {
    const formData = new FormData(document.getElementById("formRelatorio"));
    const response = await fetch(`/api/reports/${reportId}/update`, {
      method: "POST",
      body: formData
    });

    const data = await response.json();

    if (!data.success) {
      alert("Erro ao atualizar relat√≥rio: " + data.message);
      return;
    }

    alert("‚úÖ Relat√≥rio atualizado com sucesso!");
    window.location.href = `/reports/${reportId}/editarrel`;
  } catch (err) {
    console.error("Erro ao concluir relat√≥rio:", err);
    alert("Erro inesperado ao salvar relat√≥rio.");
  }
}


‚ö†Ô∏è Evite interpretar HTML como JSON.
O erro Unexpected token '<' indica que a rota estava retornando um template (render_template) em vez de jsonify.

‚úÖ Checklist de corre√ß√£o final
Item	Deve fazer
üß± Backend	Retornar apenas JSON, nunca render_template
üß© Formul√°rio	Enviar via FormData para /api/reports/<id>/update
üñºÔ∏è Imagens	Carregar no mesmo layout e salvar corretamente
üë• Acompanhantes	Apenas os selecionados devem ser salvos
üìã Checklist	Deve carregar e sobrescrever corretamente
üíæ Salvamento	Atualiza o mesmo registro (UPDATE), sem criar outro
üí¨ Retorno	JSON: { success: true, message, relatorio_id }