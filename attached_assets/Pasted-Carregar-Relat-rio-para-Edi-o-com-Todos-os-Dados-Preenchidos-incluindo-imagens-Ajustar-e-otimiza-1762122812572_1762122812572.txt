Carregar Relat√≥rio para Edi√ß√£o com Todos os Dados Preenchidos (incluindo imagens)

Ajustar e otimizar completamente a tela de edi√ß√£o de relat√≥rio para garantir que, ao clicar em ‚ÄúEditar relat√≥rio‚Äù, todos os dados relacionados ao relat√≥rio sejam carregados e exibidos corretamente:

Todos os campos de texto (t√≠tulo, n√∫mero, data, observa√ß√µes, etc.) devem vir pr√©-preenchidos.

O projeto associado deve ser carregado e selecionado corretamente no campo do projeto.

O checklist, acompanhantes e lembrete de pr√≥xima visita devem ser exibidos no mesmo estado em que foram salvos.

As imagens associadas ao relat√≥rio devem ser carregadas corretamente, com suas respectivas legendas, categoria e local.

A exibi√ß√£o deve ser fluida e sem delay percept√≠vel, exibindo placeholders enquanto os dados s√£o carregados.

O sistema est√° hospedado no Railway, com o banco PostgreSQL j√° sincronizado.

üß© 1Ô∏è‚É£ BACKEND ‚Äî Endpoint /api/relatorios/{id}
‚úÖ Ajustar endpoint para retornar todos os dados do relat√≥rio (com relacionamentos)
@router.get("/relatorios/{relatorio_id}")
async def get_relatorio(relatorio_id: int, db: Session = Depends(get_db)):
    """
    Retorna todos os dados de um relat√≥rio para edi√ß√£o:
    informa√ß√µes principais, projeto vinculado, imagens, checklist e acompanhantes.
    """
    relatorio = (
        db.query(Relatorio)
        .filter(Relatorio.id == relatorio_id)
        .first()
    )
    if not relatorio:
        raise HTTPException(status_code=404, detail="Relat√≥rio n√£o encontrado")

    fotos = (
        db.query(FotoRelatorio)
        .filter(FotoRelatorio.relatorio_id == relatorio_id)
        .order_by(FotoRelatorio.id.asc())
        .all()
    )

    checklist = (
        db.query(ChecklistItem)
        .filter(ChecklistItem.relatorio_id == relatorio_id)
        .order_by(ChecklistItem.id.asc())
        .all()
    )

    acompanhantes = (
        db.query(Acompanhante)
        .filter(Acompanhante.relatorio_id == relatorio_id)
        .order_by(Acompanhante.id.asc())
        .all()
    )

    projeto = db.query(Projeto).filter(Projeto.id == relatorio.projeto_id).first()

    return {
        "success": True,
        "relatorio": relatorio.to_dict(),
        "projeto": projeto.to_dict() if projeto else None,
        "imagens": [foto.to_dict() for foto in fotos],
        "checklist": [item.to_dict() for item in checklist],
        "acompanhantes": [p.to_dict() for p in acompanhantes],
    }

‚úÖ Exemplo de to_dict() em models.py
class FotoRelatorio(Base):
    __tablename__ = "foto_relatorio"

    id = Column(Integer, primary_key=True)
    relatorio_id = Column(Integer, ForeignKey("relatorios.id"))
    filename = Column(String)
    caption = Column(Text)
    category = Column(String)
    local = Column(String)
    path = Column(Text)

    def to_dict(self):
        return {
            "id": self.id,
            "filename": self.filename,
            "caption": self.caption,
            "category": self.category,
            "local": self.local,
            "path": self.path,
        }

üíª 2Ô∏è‚É£ FRONTEND ‚Äî reports_edit.js
‚úÖ L√≥gica para carregar automaticamente o relat√≥rio e preencher o formul√°rio
document.addEventListener("DOMContentLoaded", async () => {
  const relatorioId = getRelatorioIdFromURL(); // üîç obt√©m o ID via query string
  if (!relatorioId) {
    console.error("‚ùå Nenhum ID de relat√≥rio informado.");
    return;
  }

  console.log("üîÑ Carregando relat√≥rio ID:", relatorioId);
  try {
    const response = await fetch(`/api/relatorios/${relatorioId}`);
    if (!response.ok) throw new Error("Erro ao carregar relat√≥rio");

    const data = await response.json();
    const { relatorio, projeto, imagens, checklist, acompanhantes } = data;

    // üîπ Preenche os campos principais
    document.querySelector("#titulo").value = relatorio.titulo || "";
    document.querySelector("#numero").value = relatorio.numero || "";
    document.querySelector("#data_relatorio").value = relatorio.data_relatorio || "";
    document.querySelector("#observacoes_finais").value = relatorio.observacoes_finais || "";

    // üîπ Seleciona o projeto
    if (projeto) {
      const select = document.querySelector("#projeto_id");
      const option = new Option(projeto.nome, projeto.id, true, true);
      select.appendChild(option);
    }

    // üîπ Preenche checklist
    preencherChecklist(checklist);

    // üîπ Preenche acompanhantes
    preencherAcompanhantes(acompanhantes);

    // üîπ Exibe imagens
    exibirImagens(imagens);

    console.log("‚úÖ Relat√≥rio carregado e pr√©-preenchido com sucesso.");
  } catch (err) {
    console.error("‚ùå Erro ao carregar relat√≥rio:", err);
  }
});

function exibirImagens(imagens) {
  const container = document.querySelector("#imagens-container");
  container.innerHTML = "";

  imagens.forEach((img) => {
    const imgElement = document.createElement("div");
    imgElement.classList.add("foto-relatorio");

    imgElement.innerHTML = `
      <img src="${img.path}" alt="${img.caption || "Foto"}" class="preview-imagem" />
      <div class="foto-info">
        <input type="text" value="${img.caption || ""}" placeholder="Legenda" class="foto-legenda" data-id="${img.id}" />
        <input type="text" value="${img.category || ""}" placeholder="Categoria" class="foto-categoria" />
        <input type="text" value="${img.local || ""}" placeholder="Local" class="foto-local" />
      </div>
    `;

    container.appendChild(imgElement);
  });

  console.log(`üì∏ ${imagens.length} imagens carregadas na tela.`);
}

function preencherChecklist(itens) {
  const checklistContainer = document.querySelector("#checklist");
  checklistContainer.innerHTML = "";
  itens.forEach(item => {
    const row = document.createElement("div");
    row.classList.add("checklist-item");
    row.innerHTML = `
      <label>${item.pergunta}</label>
      <input type="checkbox" ${item.resposta ? "checked" : ""}>
    `;
    checklistContainer.appendChild(row);
  });
}

function preencherAcompanhantes(acompanhantes) {
  const container = document.querySelector("#acompanhantes");
  container.innerHTML = "";
  acompanhantes.forEach(a => {
    const div = document.createElement("div");
    div.classList.add("acompanhante-item");
    div.textContent = `${a.nome} - ${a.funcao}`;
    container.appendChild(div);
  });
}

üß† 3Ô∏è‚É£ EXPERI√äNCIA DO USU√ÅRIO

Exibir loader / skeletons leves enquanto os dados s√£o buscados.

Atualizar o estado do bot√£o "Salvar" ‚Üí ‚Äú‚úîÔ∏è Tudo carregado‚Äù ao finalizar.

Garantir compatibilidade com o AutoSave existente, sem interferir nele.

‚úÖ Comportamento Esperado

Ao clicar em Editar Relat√≥rio, a p√°gina √© carregada e faz GET /api/relatorios/{id}.

Todos os dados do relat√≥rio aparecem automaticamente preenchidos.

As imagens s√£o exibidas com legendas, categorias e local corretos.

O usu√°rio pode alterar qualquer campo e o AutoSave existente continua ativo.

Nenhum campo √© perdido ou sobrescrito indevidamente.