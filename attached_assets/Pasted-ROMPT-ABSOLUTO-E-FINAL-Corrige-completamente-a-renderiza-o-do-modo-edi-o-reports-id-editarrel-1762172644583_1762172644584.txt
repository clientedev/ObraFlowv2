ROMPT ABSOLUTO E FINAL

Corrige completamente a renderiza√ß√£o do modo edi√ß√£o (/reports/<id>/editarrel)
‚úÖ Mant√©m o backend 100% funcional.
‚úÖ Garante preenchimento autom√°tico de todos os campos, acompanhantes, checklist e fotos.
‚úÖ Exibi√ß√£o fluida e imediata (sem depender de autosave, fetch, ou fun√ß√µes externas).
‚úÖ Profissional e compat√≠vel com ambiente Replit + Railway (sem bloqueios de CSP).

üîß FLASK ‚Äì ROTA DE EDI√á√ÉO CORRIGIDA (routes.py)
from flask import render_template
from flask_login import login_required
from sqlalchemy.orm import joinedload
from app import app, db
from models import Relatorio, Projeto, FotosRelatorio, ChecklistObra, FuncionariosProjetos

@app.route("/reports/<int:report_id>/editarrel", methods=["GET"])
@login_required
def report_edit_complete(report_id):
    try:
        app.logger.info(f"üìù Carregando relat√≥rio completo ID={report_id}")

        relatorio = (
            db.session.query(Relatorio)
            .options(joinedload(Relatorio.projeto))
            .filter(Relatorio.id == report_id)
            .first()
        )

        if not relatorio:
            return render_template("reports/error_report.html", message="Relat√≥rio n√£o encontrado"), 404

        projeto = Projeto.query.get(relatorio.projeto_id)
        fotos = FotosRelatorio.query.filter_by(relatorio_id=report_id).all()
        checklist = ChecklistObra.query.filter_by(relatorio_id=report_id).all()
        acompanhantes = FuncionariosProjetos.query.filter_by(projeto_id=relatorio.projeto_id).all()

        report_data = {
            "id": relatorio.id,
            "data_relatorio": relatorio.data_relatorio.strftime("%Y-%m-%d") if relatorio.data_relatorio else "",
            "titulo": relatorio.titulo or "",
            "numero": relatorio.numero_relatorio or "",
            "observacoes": relatorio.observacoes or "",
            "lembrete": relatorio.lembrete or "",
            "projeto": {
                "id": projeto.id if projeto else "",
                "codigo": projeto.codigo if projeto else "",
                "nome": projeto.nome if projeto else "",
                "endereco": projeto.endereco if projeto else "",
                "responsavel": getattr(projeto, "responsavel", ""),
            } if projeto else None,
            "fotos": [
                {
                    "id": f.id,
                    "url": getattr(f, "url", "") or getattr(f, "public_url", ""),
                    "legenda": getattr(f, "legenda", "")
                } for f in fotos
            ],
            "checklist": [
                {"id": c.id, "descricao": c.descricao, "concluido": c.concluido}
                for c in checklist
            ],
            "acompanhantes": [
                {"id": a.id, "nome": a.nome_funcionario, "funcao": getattr(a, "funcao", "N√£o informado")}
                for a in acompanhantes
            ],
        }

        app.logger.info(f"‚úÖ Dados enviados ao template ({len(fotos)} fotos, {len(acompanhantes)} acompanhantes)")

        return render_template(
            "reports/form_complete.html",
            report_data=report_data,
            edit_mode=True
        )

    except Exception as e:
        app.logger.error(f"‚ùå Erro ao carregar relat√≥rio: {e}", exc_info=True)
        return render_template("reports/error_report.html", message=str(e)), 500

üé® TEMPLATE form_complete.html (ADICIONAR AO FINAL)

No final do HTML, logo antes do </body> ou antes de fechar {% block content %}, cole este script:

<script>
window.addEventListener("load", function() {
    if (!{{ 'true' if edit_mode else 'false' }} || !{{ report_data | tojson | safe }}) return;
    const report = {{ report_data | tojson | safe }};
    console.log("‚úèÔ∏è Carregando dados do relat√≥rio:", report);

    // Campos principais
    document.querySelector('input[name="data_relatorio"]').value = report.data_relatorio || "";
    document.querySelector('input[name="titulo"]').value = report.titulo || "";
    document.querySelector('input[name="numero"]').value = report.numero || "";

    // Projeto
    if (report.projeto) {
        const select = document.querySelector('select[name="projeto_id"]');
        if (select) {
            select.innerHTML = `<option value="${report.projeto.id}" selected>${report.projeto.codigo} - ${report.projeto.nome}</option>`;
        }
    }

    // Observa√ß√µes e lembrete
    const obs = document.querySelector('textarea[name="observacoes"]');
    if (obs) obs.value = report.observacoes || "";

    const lembrete = document.querySelector('textarea[name="lembrete"]');
    if (lembrete) lembrete.value = report.lembrete || "";

    // Acompanhantes
    if (report.acompanhantes?.length) {
        const cont = document.querySelector("#acompanhantes-container");
        if (cont) {
            cont.innerHTML = "";
            report.acompanhantes.forEach(a => {
                const div = document.createElement("div");
                div.className = "acompanhante-item";
                div.innerHTML = `
                    <div class="card p-2 mb-2 shadow-sm rounded bg-light">
                        <strong>${a.nome}</strong><br>
                        <small>${a.funcao}</small>
                    </div>`;
                cont.appendChild(div);
            });
        }
    }

    // Checklist
    if (report.checklist?.length) {
        const chk = document.querySelector("#checklist-container");
        if (chk) {
            chk.innerHTML = "";
            report.checklist.forEach(i => {
                const li = document.createElement("div");
                li.className = "form-check mb-1";
                li.innerHTML = `
                    <input class="form-check-input" type="checkbox" ${i.concluido ? "checked" : ""}>
                    <label class="form-check-label">${i.descricao}</label>`;
                chk.appendChild(li);
            });
        }
    }

    // Fotos
    updatePhotoGallery(report.fotos || []);
});


function updatePhotoGallery(fotos) {
    const gallery = document.querySelector("#photo-gallery");
    if (!gallery) return;
    gallery.innerHTML = "";
    if (!fotos.length) {
        gallery.innerHTML = `<p class="text-muted">Nenhuma foto registrada neste relat√≥rio.</p>`;
        return;
    }
    fotos.forEach(f => {
        const card = document.createElement("div");
        card.className = "photo-card";
        card.style = "display:inline-block;margin:5px;text-align:center";
        card.innerHTML = `
            <img src="${f.url}" alt="${f.legenda}" style="width:110px;height:110px;object-fit:cover;border-radius:8px;display:block;">
            <small>${f.legenda}</small>`;
        gallery.appendChild(card);
    });
    console.log(`üì∏ ${fotos.length} fotos renderizadas.`);
}
</script>

üß© RESULTADO FINAL ESPERADO

‚úÖ /reports/<id>/editarrel carrega todos os campos pr√©-preenchidos (data, t√≠tulo, n√∫mero, observa√ß√µes).
‚úÖ O projeto correto aparece selecionado no <select>.
‚úÖ Os acompanhantes aparecem automaticamente em blocos de card.
‚úÖ O checklist √© renderizado com checkboxes.
‚úÖ A galeria de fotos √© exibida em miniaturas com legenda.
‚úÖ Nenhum erro de updatePhotoGallery ou undefined.
‚úÖ O template √© totalmente din√¢mico ‚Äî n√£o depende mais de vari√°veis inline antigas do Flask.