CORRE√á√ÉO COMPLETA DA EDI√á√ÉO DE RELAT√ìRIOS

Reescreva totalmente a rota /reports/<int:report_id>/editarrel para:

Carregar corretamente todos os dados do relat√≥rio (projeto, fotos, checklist, acompanhantes, observa√ß√µes e lembretes).

Exibir tudo preenchido no template form_complete.html.

Usar as tabelas reais do sistema (relatorios, fotos_relatorio, funcionarios_projetos, checklist_obra, projetos).

Eliminar os erros joinedload, AttributeError e BuildError.

Garantir robustez caso alguma rela√ß√£o n√£o exista (tratamento com fallback).

Incluir logs detalhados de cada etapa.

üîß C√ìDIGO COMPLETO DA ROTA
# routes.py

from flask import render_template, request
from flask_login import login_required
from sqlalchemy.orm import joinedload
from app import app, db
from models import Relatorio, Projeto, FotosRelatorio, ChecklistObra, FuncionariosProjetos


@app.route("/reports/<int:report_id>/editarrel", methods=["GET"])
@login_required
def report_edit_complete(report_id):
    """
    Rota definitiva para carregar um relat√≥rio completo para edi√ß√£o.
    Carrega todos os relacionamentos reais do banco e renderiza form_complete.html com dados pr√©-preenchidos.
    """
    try:
        app.logger.info(f"üìù Iniciando carregamento completo do relat√≥rio {report_id}")

        # --- Buscar o relat√≥rio principal com seus relacionamentos ---
        rel = (
            db.session.query(Relatorio)
            .options(
                joinedload(Relatorio.projeto),
            )
            .filter(Relatorio.id == report_id)
            .first()
        )

        if not rel:
            app.logger.error(f"‚ùå Relat√≥rio {report_id} n√£o encontrado no banco.")
            return render_template("reports/error_report.html", message="Relat√≥rio n√£o encontrado."), 404

        app.logger.info(f"‚úÖ Relat√≥rio {rel.numero_relatorio} encontrado com sucesso.")

        # --- Buscar projeto vinculado ---
        projeto = (
            db.session.query(Projeto)
            .filter(Projeto.id == rel.projeto_id)
            .first()
            if rel.projeto_id
            else None
        )

        # --- Buscar fotos vinculadas ---
        fotos = (
            db.session.query(FotosRelatorio)
            .filter(FotosRelatorio.relatorio_id == report_id)
            .all()
        )

        app.logger.info(f"üì∏ {len(fotos)} fotos carregadas para o relat√≥rio {report_id}")

        # --- Buscar checklist vinculado ---
        checklist = (
            db.session.query(ChecklistObra)
            .filter(ChecklistObra.relatorio_id == report_id)
            .all()
        )

        app.logger.info(f"üßæ {len(checklist)} itens de checklist carregados.")

        # --- Buscar acompanhantes (funcion√°rios vinculados ao projeto) ---
        acompanhantes = (
            db.session.query(FuncionariosProjetos)
            .filter(FuncionariosProjetos.projeto_id == rel.projeto_id)
            .all()
        )

        app.logger.info(f"üë• {len(acompanhantes)} acompanhantes encontrados no projeto.")

        # --- Montar dicion√°rio de dados para o template ---
        report_data = {
            "id": rel.id,
            "data_relatorio": getattr(rel, "data_relatorio", None),
            "titulo": getattr(rel, "titulo", ""),
            "numero_relatorio": getattr(rel, "numero_relatorio", ""),
            "observacoes": getattr(rel, "observacoes", ""),
            "lembrete": getattr(rel, "lembrete", ""),
            "projeto": {
                "id": projeto.id if projeto else None,
                "nome": projeto.nome if projeto else "",
                "codigo": projeto.codigo if projeto else "",
                "endereco": projeto.endereco if projeto else "",
                "responsavel": projeto.responsavel if projeto else "",
            } if projeto else None,
            "fotos": [
                {
                    "id": f.id,
                    "arquivo": f.arquivo,
                    "legenda": getattr(f, "legenda", ""),
                    "url": getattr(f, "public_url", None) or getattr(f, "path", None),
                }
                for f in fotos
            ],
            "checklist": [
                {"id": c.id, "descricao": c.descricao, "concluido": c.concluido}
                for c in checklist
            ],
            "acompanhantes": [
                {"id": a.id, "nome": a.nome_funcionario, "funcao": getattr(a, "funcao", "N√£o informado")}
                for a in acompanhantes
            ],
        }

        app.logger.info(f"‚úÖ Dados estruturados com sucesso para o relat√≥rio {report_id}")

        return render_template(
            "reports/form_complete.html",
            report_data=report_data,
            edit_mode=True,
        )

    except Exception as e:
        app.logger.error(f"‚ùå ERRO ao carregar relat√≥rio {report_id}: {e}", exc_info=True)
        return render_template("reports/error_report.html", message=str(e)), 500

üß© TEMPLATE DE ERRO SEGURO (templates/reports/error_report.html)
{% extends "base.html" %}
{% block content %}
<div class="container py-5">
  <div class="alert alert-danger shadow">
    <h4 class="fw-bold mb-3">‚ö†Ô∏è Ocorreu um erro ao carregar o relat√≥rio</h4>
    <p>{{ message }}</p>
    <div class="mt-4">
      <a href="{{ url_for('reports_list') }}" class="btn btn-primary">‚Üê Voltar aos relat√≥rios</a>
      <a href="/" class="btn btn-secondary ms-2">P√°gina inicial</a>
    </div>
  </div>
</div>
{% endblock %}


üî∏ Substitua reports_list pelo nome real da fun√ß√£o Flask que exibe a listagem de relat√≥rios.

üíæ Resumo das Rela√ß√µes Usadas (ajuste conforme seus modelos):
Tabela	Relacionamento	Campo Chave	Modelo Refer√™ncia
relatorios	principal	id	Relatorio
projetos	rel.projeto_id ‚Üí projetos.id	projeto_id	Projeto
fotos_relatorio	relatorio_id ‚Üí relatorios.id	relatorio_id	FotosRelatorio
checklist_obra	relatorio_id ‚Üí relatorios.id	relatorio_id	ChecklistObra
funcionarios_projetos	projeto_id ‚Üí projetos.id	projeto_id	FuncionariosProjetos
‚úÖ O que esse prompt corrige de forma definitiva:

üîπ Carregamento completo e coerente dos dados relacionados.

üîπ Corrige o erro joinedload e AttributeError.

üîπ Mostra todas as fotos existentes no relat√≥rio.

üîπ Preenche corretamente projeto, t√≠tulo, n√∫mero, observa√ß√µes e checklist.

üîπ Exibe acompanhantes do projeto no campo ‚ÄúAcompanhantes da Visita‚Äù.

üîπ Corrige a exibi√ß√£o do template sem depend√™ncia de rotas inexistentes.

üîπ Evita crash total caso alguma rela√ß√£o esteja vazia.

üîπ Mant√©m logs claros e leg√≠veis para depura√ß√£o.