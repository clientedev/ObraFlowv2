Corre√ß√£o Completa do Sistema de Notifica√ß√µes e Envio de E-mail (Item 23)

Prompt:
Corrigir e reestruturar completamente o sistema de notifica√ß√µes e envio autom√°tico de e-mails relacionados √† aprova√ß√£o de relat√≥rios, garantindo estabilidade total e funcionamento cont√≠nuo.

üîß Corre√ß√µes e Melhorias Obrigat√≥rias:

Resolver o erro de transa√ß√£o SQL (psycopg2.errors.InFailedSqlTransaction)

O erro indica que h√° uma falha na transa√ß√£o ativa antes da execu√ß√£o do SELECT.

Implementar controle de transa√ß√µes adequado (commit / rollback) para evitar bloqueio de opera√ß√µes subsequentes.

Garantir que o SELECT ou INSERT seja executado ap√≥s o commit da altera√ß√£o de status do relat√≥rio.

Fluxo correto da notifica√ß√£o:

Quando o relat√≥rio for enviado para aprova√ß√£o ou aprovado, o sistema deve:

Criar uma notifica√ß√£o interna para o usu√°rio respons√°vel pela pr√≥xima a√ß√£o (ex: o aprovador).

Enviar automaticamente um e-mail com o mesmo conte√∫do da notifica√ß√£o.

Estrutura da notifica√ß√£o:

T√≠tulo: ‚ÄúRelat√≥rio [N√öMERO] enviado para aprova√ß√£o‚Äù ou ‚ÄúRelat√≥rio [N√öMERO] aprovado‚Äù.

Mensagem:

Ol√° [NOME DESTINAT√ÅRIO],
O relat√≥rio [N√öMERO] referente √† obra [NOME DA OBRA] foi [enviado para aprova√ß√£o/aprovado] por [NOME DO USU√ÅRIO].  
Clique abaixo para acessar o relat√≥rio:  
[LINK DIRETO PARA O RELAT√ìRIO]


Registro no banco: Deve incluir id_relatorio, id_usuario_origem, id_usuario_destino, mensagem, tipo, status, timestamp.

Envio de e-mail autom√°tico:

Utilizar as credenciais de e-mail do usu√°rio logado (ou do e-mail configurado no painel administrativo).

Caso o e-mail do usu√°rio n√£o esteja configurado, o sistema deve usar o e-mail padr√£o do sistema como fallback.

Confirmar que o e-mail cont√©m:

Assunto: mesmo t√≠tulo da notifica√ß√£o.

Corpo: mesma mensagem da notifica√ß√£o.

Anexo: PDF do relat√≥rio (gerado e anexado automaticamente).

Logs e seguran√ßa:

Registrar logs de sucesso/falha no envio de e-mail e cria√ß√£o de notifica√ß√£o.

Exibir mensagens claras no painel administrativo, evitando expor erros SQL brutos ao usu√°rio.

Teste funcional esperado:

Luciana envia o relat√≥rio ‚Üí Leopoldo recebe notifica√ß√£o e e-mail.

Leopoldo aprova ‚Üí Luciana recebe notifica√ß√£o e e-mail de confirma√ß√£o.

Nenhum erro de transa√ß√£o ou bloqueio deve ocorrer durante o fluxo.

üìçImportante:
Modificar exclusivamente o fluxo de notifica√ß√µes e envio de e-mails, mantendo todas as outras funcionalidades e templates do sistema exatamente como est√£o.