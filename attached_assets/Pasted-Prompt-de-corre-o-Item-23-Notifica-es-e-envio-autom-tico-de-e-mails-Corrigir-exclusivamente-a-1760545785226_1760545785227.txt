Prompt de corre√ß√£o ‚Äì Item 23 (Notifica√ß√µes e envio autom√°tico de e-mails)

Corrigir exclusivamente as funcionalidades de notifica√ß√£o e envio de e-mail ap√≥s aprova√ß√£o de relat√≥rio, garantindo que:

o envio ocorra com sucesso,

a transa√ß√£o SQL n√£o seja abortada,

a exclus√£o de relat√≥rios volte a funcionar,

e a notifica√ß√£o e o e-mail sejam enviados corretamente.

‚öôÔ∏è Contexto do erro atual

O erro exibido indica:

psycopg2.errors.InFailedSqlTransaction: current transaction is aborted, commands ignored until end of transaction block


Isso significa que a opera√ß√£o de envio do e-mail est√° sendo executada dentro de uma transa√ß√£o aberta, e ao falhar, bloqueia o restante das queries.

üõ†Ô∏è Tarefas a serem executadas

Isolar o envio de notifica√ß√µes e e-mails fora da transa√ß√£o principal.

O envio do e-mail e da notifica√ß√£o deve ocorrer ap√≥s o commit do relat√≥rio aprovado, usando uma fun√ß√£o ass√≠ncrona ou chamada segura fora do session.commit() do SQLAlchemy.

Utilizar after_commit event listener ou um bloco separado com nova sess√£o.

Corrigir a l√≥gica de envio autom√°tico:

Quando um relat√≥rio √© aprovado, enviar:

Notifica√ß√£o interna para o respons√°vel (ex.: Leopoldo).

E-mail autom√°tico para todos os destinat√°rios vinculados ao projeto, com:

Assunto: Relat√≥rio [C√ìDIGO] aprovado - [NOME DA OBRA]

Corpo: mensagem padr√£o de aprova√ß√£o

Anexo: PDF do relat√≥rio

Caso o envio falhe, registrar log, mas n√£o quebrar a transa√ß√£o.

Garantir que o relat√≥rio possa ser exclu√≠do normalmente.

Revisar depend√™ncias de chaves estrangeiras (ondelete=CASCADE).

Caso o erro ocorra por bloqueio de transa√ß√£o anterior, adicionar rollback seguro (session.rollback()) em exce√ß√µes do envio de e-mail.

Revisar a ordem de execu√ß√£o:

Primeiro ‚Üí salvar e aprovar relat√≥rio.

Segundo ‚Üí efetuar commit.

Terceiro ‚Üí enviar notifica√ß√µes e e-mails.

Quarto ‚Üí registrar status ‚Äúnotifica√ß√£o enviada‚Äù (opcional).

üìß Envio de E-mail

Usar o e-mail configurado do usu√°rio logado no momento da aprova√ß√£o.

Se n√£o existir configura√ß√£o personalizada, usar o e-mail padr√£o do sistema.

Adicionar c√≥pia (CC) para o aprovador.

Garantir que os e-mails de todos os funcion√°rios vinculados √† obra sejam inclu√≠dos automaticamente.

‚úÖ Crit√©rios de sucesso

O relat√≥rio pode ser criado, aprovado e exclu√≠do sem erro.

As notifica√ß√µes s√£o geradas para o respons√°vel correto.

O e-mail √© enviado com o PDF anexo.

Nenhum erro InFailedSqlTransaction aparece no log.