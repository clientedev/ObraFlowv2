Remover â€œObras PrÃ³ximasâ€ do Dashboard e Reordenar Listagem por Proximidade
ğŸ¯ Objetivo

Corrigir o erro de conexÃ£o e simplificar o fluxo:

Remover a seÃ§Ã£o Obras PrÃ³ximas do Dashboard.

Exibir todas as obras diretamente na rota /projects, ordenadas pela distÃ¢ncia do usuÃ¡rio e depois pelo status (Ativo antes de ConcluÃ­do).

âš™ï¸ Etapa 1 â€” Remover â€œObras PrÃ³ximasâ€ do Dashboard

No arquivo routes.py, localize o trecho responsÃ¡vel pelo carregamento da rota do dashboard (geralmente /dashboard, /, ou /home).

Exemplo atual:

@app.route('/dashboard')
@login_required
def dashboard():
    obras_proximas = get_obras_proximas(current_user)
    return render_template('dashboard.html', obras_proximas=obras_proximas)


Substitua inteiro por:

@app.route('/dashboard')
@login_required
def dashboard():
    # Remove a funcionalidade de obras prÃ³ximas
    return render_template('dashboard.html')


No arquivo templates/dashboard.html, remova o bloco que exibe a seÃ§Ã£o de obras prÃ³ximas.
Procure algo como:

{% if obras_proximas %}
<div class="card mt-3">
  <div class="card-header">
    <i class="fa fa-map-marker-alt"></i> Obras PrÃ³ximas
  </div>
  <div class="card-body">
    {% for obra in obras_proximas %}
      ...
    {% endfor %}
  </div>
</div>
{% endif %}


E exclua completamente esse trecho do HTML.
Isso remove o componente â€œObras PrÃ³ximasâ€ (inclusive os erros de conexÃ£o).

âš™ï¸ Etapa 2 â€” Ordenar Listagem /projects por Proximidade

No mesmo routes.py, localize a funÃ§Ã£o responsÃ¡vel por listar as obras (geralmente chamada project_list() ou similar):

Exemplo original:

@app.route('/projects')
@login_required
def project_list():
    projects = Project.query.all()
    return render_template('projects/list.html', projects=projects)


Substitua por:

from geopy.distance import geodesic

@app.route('/projects')
@login_required
def project_list():
    # ObtÃ©m a localizaÃ§Ã£o atual do usuÃ¡rio (caso exista)
    user_location = get_user_location(current_user)

    projects = Project.query.all()
    projetos_com_distancia = []

    for project in projects:
        if project.latitude and project.longitude and user_location:
            distancia = geodesic(
                (user_location.lat, user_location.lon),
                (project.latitude, project.longitude)
            ).km
        else:
            distancia = float('inf')  # Se nÃ£o tiver localizaÃ§Ã£o, joga para o final

        projetos_com_distancia.append((project, distancia))

    # Ordena:
    # 1ï¸âƒ£ Obras ativas primeiro
    # 2ï¸âƒ£ Dentro delas, por distÃ¢ncia menor
    # 3ï¸âƒ£ ConcluÃ­das por Ãºltimo
    projetos_com_distancia.sort(
        key=lambda x: (
            0 if x[0].status.lower() == "ativo" else 1,
            x[1]
        )
    )

    projetos_ordenados = [p[0] for p in projetos_com_distancia]

    return render_template('projects/list.html', projects=projetos_ordenados)

ğŸ§© Etapa 3 â€” Ajustar Template /templates/projects/list.html

Remova quaisquer mensagens de erro ou botÃµes redundantes e deixe o card clicÃ¡vel:

{% for project in projects %}
<div class="project-card"
     onclick="window.location.href='{{ url_for('project_view', id=project.id) }}'">
  <div class="d-flex justify-content-between align-items-center">
    <span class="fw-bold text-primary">{{ project.codigo }}</span>
    <span class="badge {{ 'bg-success' if project.status == 'Ativo' else 'bg-secondary' }}">
      {{ project.status }}
    </span>
  </div>
  <div>
    <h5 class="mb-1">{{ project.nome }}</h5>
    <p class="text-muted small mb-0">{{ project.empresa or '' }}</p>
  </div>
</div>
{% endfor %}

ğŸ’… Etapa 4 â€” Estilizar os Cards (CSS)

Adicione ao CSS do projeto:

.project-card {
  background: #fff;
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}
.project-card:hover {
  background-color: #f7faff;
  transform: translateY(-2px);
}

ğŸ” Etapa 5 â€” Controle de PermissÃ£o

Dentro da tela de visualizaÃ§Ã£o da obra, garanta que somente o usuÃ¡rio master veja o botÃ£o de editar:

{% if current_user.role == 'master' %}
  <a href="{{ url_for('project_edit', id=project.id) }}" class="btn btn-primary">
    Editar Obra
  </a>
{% endif %}

âœ… Resultado Final Esperado
Item	Resultado
Dashboard	Nenhuma seÃ§Ã£o de â€œObras PrÃ³ximasâ€ (nem erro de conexÃ£o)
/projects	Listagem de todas as obras
OrdenaÃ§Ã£o	1ï¸âƒ£ Obras ativas por proximidade â†’ 2ï¸âƒ£ Obras concluÃ­das
Cards	Inteiros clicÃ¡veis (sem botÃ£o de â€œVerâ€ ou â€œEditarâ€)
BotÃ£o â€œEditarâ€	Somente dentro da visualizaÃ§Ã£o, e apenas para usuÃ¡rio master
Erro de conexÃ£o	Eliminado completamente
ğŸ§¾ Resumo TÃ©cnico
âœ” Remove o bloco de â€œObras PrÃ³ximasâ€ e a funÃ§Ã£o que o gera.
âœ” Corrige erro de conexÃ£o causado por API de localizaÃ§Ã£o.
âœ” Usa lÃ³gica de distÃ¢ncia (geopy.distance) para ordenar na rota /projects.
âœ” Ordena obras ativas antes das concluÃ­das.
âœ” Layout simplificado e interativo.