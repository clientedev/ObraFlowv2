üîπ 2. Backend ‚Äî FastAPI /api/relatorios/autosave

Corrigir endpoint para aceitar atualiza√ß√µes parciais e validar campos dinamicamente:

@router.post("/api/relatorios/autosave")
async def autosave_relatorio(payload: dict, db: Session = Depends(get_db)):
    try:
        relatorio_id = payload.get("id")
        if relatorio_id:
            relatorio = db.query(Relatorio).filter_by(id=relatorio_id).first()
            if not relatorio:
                raise HTTPException(status_code=404, detail="Relat√≥rio n√£o encontrado")
        else:
            relatorio = Relatorio()
            db.add(relatorio)

        # Atualiza apenas campos v√°lidos
        for key, value in payload.items():
            if hasattr(relatorio, key):
                setattr(relatorio, key, value)

        db.commit()
        db.refresh(relatorio)
        print(f"‚úÖ AutoSave atualizado: relat√≥rio {relatorio.id}")
        return {"status": "ok", "id": relatorio.id}

    except Exception as e:
        db.rollback()
        print("‚ùå Erro no autosave:", str(e))
        raise HTTPException(status_code=400, detail=str(e))

üîπ 3. Banco de Dados (se necess√°rio)

Garantir que a tabela relatorios tenha os campos esperados:

ALTER TABLE relatorios
ADD COLUMN IF NOT EXISTS descricao TEXT,
ADD COLUMN IF NOT EXISTS categoria VARCHAR(255),
ADD COLUMN IF NOT EXISTS local VARCHAR(255),
ADD COLUMN IF NOT EXISTS lembrete_proxima_visita TEXT,
ADD COLUMN IF NOT EXISTS observacoes_finais TEXT;

üîç Logs Esperados no Console

Sucesso:

üü¶ AutoSave - Dados coletados: { titulo: "Relat√≥rio de visita", projeto_id: "29", ... }
‚úÖ AutoSave conclu√≠do: { id: 177, status: "ok" }


Falha:

‚ùå AutoSave erro HTTP 400: { detail: "Campo obrigat√≥rio ausente" }
‚ö†Ô∏è AutoSave falhou: Falha no autosave
üíæ Salvando temporariamente no localStorage...

‚úÖ Resultado Esperado

Nenhum erro 400.

Todos os dados (texto, checklist, imagens) salvos corretamente.

AutoSave completamente silencioso na UI.

Logs detalhados apenas no console para depura√ß√£o.

Continuidade garantida: o usu√°rio pode sair e retornar sem perder progresso.