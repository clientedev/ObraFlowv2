Prompt t√©cnico para implementa√ß√£o

Objetivo: Recriar totalmente o sistema de envio de e-mails de aprova√ß√£o de relat√≥rios.
Nova regra: Ao aprovar um relat√≥rio, enviar e-mail padronizado com PDF anexo a todos os envolvidos (autor, respons√°veis, acompanhantes e funcion√°rios da obra).

üîß Prompt

‚öôÔ∏è Instru√ß√µes para o Replit (ou ambiente Flask atual):

Apague completamente a l√≥gica anterior de envio de e-mails relacionada √† aprova√ß√£o de relat√≥rios e implemente do zero a seguinte estrutura:

1. Fun√ß√£o de envio de e-mail

Crie uma nova fun√ß√£o send_report_approval_email(relatorio_id) no backend Flask, respons√°vel por:

Localizar no banco de dados todas as informa√ß√µes do relat√≥rio (Relatorio, Projeto, User e tabelas relacionadas).

Gerar o PDF do relat√≥rio (caso ainda n√£o exista um arquivo final gerado).

Coletar todos os destinat√°rios relacionados:

Autor do relat√≥rio (autor.email);

Respons√°vel pela obra (projeto.responsavel.email);

Funcion√°rios da obra (funcionarios vinculados ao projeto);

Acompanhantes da visita (relatorio.acompanhantes);

Garantir que n√£o haja duplica√ß√£o de e-mails.

2. Configura√ß√£o do servidor de e-mail

Configure o envio utilizando a conta:

SMTP_HOST = "smtp.gmail.com"
SMTP_PORT = 587
SMTP_USER = "relatorios@elpconsultoria.eng.br"
SMTP_PASS = "ugZ32b9ayCgu5uK="


Utilize smtplib com starttls() e autentica√ß√£o segura.
Adicione controle de erros com logs em caso de falha de envio.

3. Estrutura do e-mail

Assunto:
"RELATORIO-{relatorio.numero}"
(Exemplo: RELATORIO-0001)

Corpo do e-mail (texto simples e HTML):

{email_destinatario}, este √© o relat√≥rio da obra "{nome_obra}".
Qualquer d√∫vida, entre em contato com {email_responsavel_relatorio}.

<p><strong>{email_destinatario}</strong>, este √© o relat√≥rio da obra <b>{nome_obra}</b>.</p>
<p>Qualquer d√∫vida, entre em contato com <a href="mailto:{email_responsavel_relatorio}">{email_responsavel_relatorio}</a>.</p>


Anexo: PDF do relat√≥rio (RELATORIO-{id}.pdf), carregado do diret√≥rio onde os relat√≥rios s√£o exportados.

4. Integra√ß√£o com aprova√ß√£o

No endpoint de aprova√ß√£o de relat√≥rios (exemplo: /api/relatorios/<id>/aprovar), ap√≥s a atualiza√ß√£o do status para ‚ÄúAprovado‚Äù, chame:

send_report_approval_email(relatorio_id)


O sistema deve registrar em log (INFO:app) cada envio, listando quantos e-mails foram enviados e a quem.

5. Boas pr√°ticas e seguran√ßa

Use email.message.EmailMessage para anexar o PDF corretamente (MIME).

Valide que o anexo existe antes de tentar enviar.

Trate exce√ß√µes com mensagens claras no log (ex: ‚ÄúErro ao enviar e-mail para X: Y‚Äù).

Crie um retorno HTTP 200/500 informando o sucesso ou falha no envio.

6. Estrutura resumida sugerida:

import smtplib
from email.message import EmailMessage
from models import Relatorio, Projeto, User

def send_report_approval_email(relatorio_id):
    relatorio = Relatorio.query.get(relatorio_id)
    if not relatorio:
        app.logger.error(f"Relat√≥rio {relatorio_id} n√£o encontrado.")
        return

    projeto = relatorio.projeto
    responsavel_email = relatorio.autor.email

    destinatarios = set()
    destinatarios.add(responsavel_email)
    if projeto and projeto.responsavel:
        destinatarios.add(projeto.responsavel.email)

    # Acompanhantes e funcion√°rios
    for a in relatorio.acompanhantes:
        destinatarios.add(a.email)
    for f in projeto.funcionarios:
        destinatarios.add(f.email)

    msg = EmailMessage()
    msg["From"] = SMTP_USER
    msg["Subject"] = f"RELATORIO-{relatorio.numero}"
    msg.set_content(f"{responsavel_email}, este √© o relat√≥rio da obra '{projeto.nome}'. Qualquer d√∫vida, entre em contato com {responsavel_email}.")

    pdf_path = f"/app/reports/RELATORIO-{relatorio.id}.pdf"
    with open(pdf_path, "rb") as f:
        msg.add_attachment(f.read(), maintype="application", subtype="pdf", filename=f"RELATORIO-{relatorio.numero}.pdf")

    with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as smtp:
        smtp.starttls()
        smtp.login(SMTP_USER, SMTP_PASS)
        for dest in destinatarios:
            msg["To"] = dest
            smtp.send_message(msg)
            app.logger.info(f"E-mail enviado para {dest}")


7. Resultado esperado

Ao aprovar um relat√≥rio, todos os envolvidos recebem o e-mail.

O anexo chega corretamente.

O corpo do e-mail segue o padr√£o definido.

Nenhum e-mail duplicado √© enviado.

Logs registram cada envio de forma limpa e audit√°vel.