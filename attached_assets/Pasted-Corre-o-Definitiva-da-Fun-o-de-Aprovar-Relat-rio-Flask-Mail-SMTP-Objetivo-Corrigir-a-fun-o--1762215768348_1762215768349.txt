Corre√ß√£o Definitiva da Fun√ß√£o de Aprovar Relat√≥rio (Flask-Mail + SMTP)

Objetivo:
Corrigir a fun√ß√£o /reports/<id>/approve para que o envio de e-mails com o PDF do relat√≥rio funcione corretamente via relatorios@elpconsultoria.eng.br, sem causar timeout ou erro 500.

üîß Passo 1 ‚Äì Corrigir configura√ß√£o SMTP (em config.py ou equivalente)

Substitua completamente o bloco de configura√ß√£o do Flask-Mail por este:

import os

class Config:
    MAIL_SERVER = 'smtp.hostinger.com'        # Servidor SMTP correto da Hostinger
    MAIL_PORT = 465                           # Porta SSL
    MAIL_USE_TLS = False
    MAIL_USE_SSL = True                       # Hostinger usa SSL, n√£o TLS
    MAIL_USERNAME = os.getenv('SMTP_USER', 'relatorios@elpconsultoria.eng.br')
    MAIL_PASSWORD = os.getenv('SMTP_PASS', 'ugZ32b9ayCgu5uK=')
    MAIL_DEFAULT_SENDER = ('ELP Consultoria', MAIL_USERNAME)
    MAIL_MAX_EMAILS = 10
    MAIL_ASCII_ATTACHMENTS = False


‚ö†Ô∏è Importante:

smtp.hostinger.com √© o host SMTP correto para dom√≠nios Hostinger.

Porta 465 com MAIL_USE_SSL=True √© obrigat√≥ria.

MAIL_USE_TLS deve estar desativado, pois conflita com SSL.

üì® Passo 2 ‚Äì Ajustar servi√ßo de envio de email (email_service.py)

Substitua a fun√ß√£o atual de envio por esta, garantindo que a conex√£o seja segura e o PDF seja anexado corretamente:

from flask_mail import Message
from app import mail
import traceback

def enviar_relatorio_por_email(destinatarios, assunto, corpo, caminho_pdf):
    try:
        with mail.connect() as conn:
            for destinatario in destinatarios:
                msg = Message(
                    subject=assunto,
                    recipients=[destinatario],
                    body=corpo
                )
                with open(caminho_pdf, 'rb') as pdf:
                    msg.attach("relatorio.pdf", "application/pdf", pdf.read())
                conn.send(msg)
        print("‚úÖ E-mails enviados com sucesso.")
        return True
    except Exception as e:
        print(f"‚ùå Erro ao enviar email: {e}")
        print(traceback.format_exc())
        return False

‚úÖ Passo 3 ‚Äì Corrigir a rota /reports/<id>/approve

Garanta que o relat√≥rio s√≥ √© aprovado ap√≥s envio bem-sucedido:

@app.route('/reports/<int:report_id>/approve', methods=['POST'])
@login_required
def approve_report(report_id):
    report = Report.query.get_or_404(report_id)

    # Gera PDF
    pdf_path = gerar_pdf_relatorio(report)  # Use sua fun√ß√£o existente

    # Monta lista de destinat√°rios (respons√°vel, acompanhantes, criador, etc.)
    destinatarios = set()
    if report.responsavel_email:
        destinatarios.add(report.responsavel_email)
    for acomp in report.acompanhantes:
        destinatarios.add(acomp.email)
    destinatarios.add(current_user.email)

    # Monta email
    assunto = f"RELATORIO-{report.codigo}"
    corpo = (
        f"{', '.join(destinatarios)}\n\n"
        f"Este √© o relat√≥rio da obra '{report.projeto.nome}'.\n"
        f"Qualquer d√∫vida, entre em contato com {report.usuario.email}."
    )

    # Envia email
    sucesso = enviar_relatorio_por_email(list(destinatarios), assunto, corpo, pdf_path)

    if sucesso:
        report.status = 'Aprovado'
        db.session.commit()
        flash('‚úÖ Relat√≥rio aprovado e e-mails enviados com sucesso!', 'success')
    else:
        flash('‚ùå Falha ao enviar e-mails. Relat√≥rio n√£o aprovado.', 'danger')

    return redirect(url_for('reports_list'))

üß™ Teste Final

Verifique as vari√°veis no ambiente do Replit:

SMTP_USER=relatorios@elpconsultoria.eng.br
SMTP_PASS=ugZ32b9ayCgu5uK=


Reinicie o servidor.

Aprove um relat√≥rio ‚Äî o PDF deve ser enviado a todos e o relat√≥rio aprovado.

Se o log mostrar algo como Connection refused ou Timeout, use:

ping smtp.hostinger.com


para testar se o servidor SMTP √© acess√≠vel do host.