{% extends "base.html" %}

{% block title %}{{ "Editar" if is_edit else "Novo" }} Aprovador Padrão{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-{{ 'edit' if is_edit else 'plus' }}"></i>
                {{ "Editar" if is_edit else "Novo" }} Aprovador Padrão
            </h1>
            <p class="text-muted">
                {% if is_edit %}
                    Editando configuração de aprovador padrão
                {% else %}
                    Configurar novo aprovador padrão para projetos específicos ou global
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-lg-8 col-12 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs"></i> Configuração do Aprovador Padrão
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="aprovadorForm">
                        <!-- Tipo de Configuração -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-layer-group"></i> Tipo de Configuração
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check form-check-lg">
                                        <input class="form-check-input" type="radio" name="config_type" 
                                               id="config_global" value="global" 
                                               {% if not is_edit or not aprovador_padrao.projeto_id %}checked{% endif %}>
                                        <label class="form-check-label fw-medium" for="config_global">
                                            <i class="fas fa-globe text-primary"></i> Aprovador Global
                                            <br><small class="text-muted">Para todos os projetos</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-check-lg">
                                        <input class="form-check-input" type="radio" name="config_type" 
                                               id="config_projeto" value="projeto"
                                               {% if is_edit and aprovador_padrao.projeto_id %}checked{% endif %}>
                                        <label class="form-check-label fw-medium" for="config_projeto">
                                            <i class="fas fa-project-diagram text-success"></i> Projeto Específico
                                            <br><small class="text-muted">Para um projeto específico</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Seleção de Projeto (aparece apenas se projeto específico) -->
                        <div class="mb-3" id="projeto-selection" 
                             style="display: {% if is_edit and aprovador_padrao.projeto_id %}block{% else %}none{% endif %};">
                            <label for="projeto_id" class="form-label fw-bold">
                                <i class="fas fa-folder"></i> Projeto *
                            </label>
                            <select class="form-select form-select-lg" id="projeto_id" name="projeto_id">
                                <option value="">Selecione um projeto...</option>
                                {% for projeto in projetos_ativos %}
                                    <option value="{{ projeto.id }}"
                                            {% if is_edit and aprovador_padrao.projeto_id == projeto.id %}selected{% endif %}>
                                        {{ projeto.numero }} - {{ projeto.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> Este aprovador será aplicado apenas aos relatórios deste projeto
                            </div>
                        </div>

                        <!-- Seleção de Aprovador -->
                        <div class="mb-3">
                            <label for="aprovador_id" class="form-label fw-bold">
                                <i class="fas fa-user-check"></i> Aprovador Padrão *
                            </label>
                            <select class="form-select form-select-lg" id="aprovador_id" name="aprovador_id" required>
                                <option value="">Selecione um aprovador...</option>
                                {% for usuario in usuarios_master %}
                                    <option value="{{ usuario.id }}"
                                            {% if is_edit and aprovador_padrao.aprovador_id == usuario.id %}selected{% endif %}>
                                        {{ usuario.nome }} - {{ usuario.username }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i> Apenas usuários com privilégios de master podem ser aprovadores
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="mb-4">
                            <label for="observacoes" class="form-label fw-bold">
                                <i class="fas fa-comment"></i> Observações (Opcional)
                            </label>
                            <textarea class="form-control" id="observacoes" name="observacoes" 
                                      rows="3" placeholder="Digite observações sobre esta configuração...">{% if is_edit %}{{ aprovador_padrao.observacoes or '' }}{% endif %}</textarea>
                            <div class="form-text">
                                <i class="fas fa-lightbulb"></i> Adicione notas sobre quando ou por que usar este aprovador
                            </div>
                        </div>

                        <!-- Informações adicionais -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle"></i> Como funciona:
                            </h6>
                            <ul class="mb-0 small">
                                <li><strong>Aprovador Global:</strong> Será aplicado a todos os projetos que não possuem aprovador específico</li>
                                <li><strong>Aprovador Específico:</strong> Sobrescreve o aprovador global para o projeto selecionado</li>
                                <li><strong>Pré-seleção:</strong> O aprovador será automaticamente selecionado nos formulários de relatório</li>
                                <li><strong>Alteração:</strong> Usuários ainda podem alterar o aprovador no momento da criação do relatório</li>
                            </ul>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin_aprovadores_padrao') }}" class="btn btn-outline-secondary btn-lg me-md-2">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> {{ "Atualizar" if is_edit else "Criar" }} Aprovador Padrão
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const configGlobal = document.getElementById('config_global');
    const configProjeto = document.getElementById('config_projeto');
    const projetoSelection = document.getElementById('projeto-selection');
    const projetoSelect = document.getElementById('projeto_id');
    
    // Função para mostrar/ocultar seleção de projeto
    function toggleProjetoSelection() {
        if (configProjeto.checked) {
            projetoSelection.style.display = 'block';
            projetoSelect.required = true;
        } else {
            projetoSelection.style.display = 'none';
            projetoSelect.required = false;
            projetoSelect.value = ''; // Limpar seleção
        }
    }
    
    // Event listeners
    configGlobal.addEventListener('change', toggleProjetoSelection);
    configProjeto.addEventListener('change', toggleProjetoSelection);
    
    // Validação do formulário
    document.getElementById('aprovadorForm').addEventListener('submit', function(e) {
        const aprovadorId = document.getElementById('aprovador_id').value;
        
        if (!aprovadorId) {
            e.preventDefault();
            alert('Por favor, selecione um aprovador.');
            return false;
        }
        
        if (configProjeto.checked && !projetoSelect.value) {
            e.preventDefault();
            alert('Por favor, selecione um projeto para configuração específica.');
            return false;
        }
    });
});
</script>

<style>
.form-check-lg {
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.2s;
}

.form-check-lg:hover {
    border-color: #20c1e8;
    background-color: #f8f9fa;
}

.form-check-lg .form-check-input {
    margin-top: 0.25rem;
}

.form-check-lg .form-check-input:checked + .form-check-label {
    color: #20c1e8;
}

.btn-lg {
    min-height: 44px;
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 10px;
    }
    
    .d-grid.gap-2.d-md-flex {
        display: grid !important;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
}
</style>
{% endblock %}