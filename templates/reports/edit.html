{% extends "base.html" %}

{% block title %}Editar Relatório - {{ relatorio.numero }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-edit"></i> Editar Relatório {{ relatorio.numero }}</h3>
                <div>
                    <a href="{{ url_for('generate_pdf_report', id=relatorio.id) }}" class="btn btn-danger me-2">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </a>
                    <a href="{{ url_for('reports') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>Informações do Relatório</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Número:</strong> {{ relatorio.numero }}</p>
                                    <p><strong>Título:</strong> {{ relatorio.titulo }}</p>
                                    <p><strong>Projeto:</strong> {{ relatorio.projeto.nome if relatorio.projeto else '-' }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Autor:</strong> {{ relatorio.autor.nome_completo if relatorio.autor else '-' }}</p>
                                    <p><strong>Data:</strong> {{ relatorio.data_relatorio.strftime('%d/%m/%Y') if relatorio.data_relatorio else '-' }}</p>
                                    <p><strong>Status:</strong> 
                                        <span class="badge 
                                            {% if relatorio.status == 'Aprovado' %}bg-success
                                            {% elif relatorio.status == 'Rejeitado' %}bg-danger
                                            {% elif relatorio.status == 'Aguardando Aprovacao' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ relatorio.status }}
                                        </span>
                                    </p>
                                </div>
                            </div>
                            
                            {% if relatorio.conteudo %}
                            <div class="mt-3">
                                <strong>Conteúdo:</strong>
                                <div class="border p-3 mt-2">
                                    {{ relatorio.conteudo|safe }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>Ações</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-primary" onclick="editReport()">
                                    <i class="fas fa-edit"></i> Editar Dados
                                </button>
                                <button class="btn btn-success" onclick="addPhoto()">
                                    <i class="fas fa-camera"></i> Adicionar Foto
                                </button>
                                <button class="btn btn-info" onclick="changeStatus()">
                                    <i class="fas fa-check-circle"></i> Mudar Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-images"></i> Fotos do Relatório ({{ fotos|length }})</h5>
                            <button class="btn btn-sm btn-primary" onclick="addPhoto()">
                                <i class="fas fa-plus"></i> Adicionar Foto
                            </button>
                        </div>
                        <div class="card-body">
                            {% if fotos %}
                                <div class="row">
                                    {% for foto in fotos %}
                                    <div class="col-md-4 col-lg-3 mb-4">
                                        <div class="card h-100">
                                            <div class="position-relative">
                                                <img src="{{ url_for('static', filename='uploads/' + foto.filename) }}" 
                                                     class="card-img-top" 
                                                     style="height: 200px; object-fit: cover;"
                                                     alt="{{ foto.legenda }}"
                                                     onerror="this.src='/static/img/no-image.png'">
                                                <div class="position-absolute top-0 end-0 p-2">
                                                    <button class="btn btn-sm btn-warning me-1" 
                                                            onclick="editPhoto({{ foto.id }}, '{{ foto.filename }}')"
                                                            title="Editar foto">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger" 
                                                            onclick="deletePhoto({{ foto.id }})"
                                                            title="Excluir foto">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body p-2">
                                                <h6 class="card-title small">{{ foto.legenda }}</h6>
                                                <p class="card-text small text-muted">
                                                    Categoria: {{ foto.tipo_servico }}<br>
                                                    Ordem: {{ foto.ordem }}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-images fa-3x text-muted mb-3"></i>
                                    <h5>Nenhuma foto adicionada</h5>
                                    <p class="text-muted">Clique no botão acima para adicionar fotos ao relatório.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Editor Modal -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div id="canvasContainer" class="text-center">
                            <canvas id="photoCanvas" style="border: 1px solid #ccc; max-width: 100%;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="tools-panel">
                            <h6>Ferramentas de Desenho</h6>
                            <div class="btn-group-vertical d-grid gap-2 mb-3">
                                <button class="btn btn-outline-primary tool-btn" data-tool="pen">
                                    <i class="fas fa-pen"></i> Caneta
                                </button>
                                <button class="btn btn-outline-success tool-btn" data-tool="arrow">
                                    <i class="fas fa-arrow-right"></i> Seta
                                </button>
                                <button class="btn btn-outline-info tool-btn" data-tool="rectangle">
                                    <i class="fas fa-square"></i> Retângulo
                                </button>
                                <button class="btn btn-outline-warning tool-btn" data-tool="circle">
                                    <i class="fas fa-circle"></i> Círculo
                                </button>
                                <button class="btn btn-outline-secondary tool-btn" data-tool="text">
                                    <i class="fas fa-font"></i> Texto
                                </button>
                                <button class="btn btn-outline-danger" onclick="clearCanvas()">
                                    <i class="fas fa-eraser"></i> Limpar
                                </button>
                            </div>
                            
                            <h6>Cores</h6>
                            <div class="color-palette mb-3">
                                <div class="color-box" style="background: red" onclick="setColor('red')"></div>
                                <div class="color-box" style="background: blue" onclick="setColor('blue')"></div>
                                <div class="color-box" style="background: green" onclick="setColor('green')"></div>
                                <div class="color-box" style="background: yellow" onclick="setColor('yellow')"></div>
                                <div class="color-box" style="background: orange" onclick="setColor('orange')"></div>
                                <div class="color-box" style="background: purple" onclick="setColor('purple')"></div>
                                <div class="color-box" style="background: black" onclick="setColor('black')"></div>
                                <div class="color-box" style="background: white; border: 1px solid #ccc" onclick="setColor('white')"></div>
                            </div>
                            
                            <h6>Tamanho do Traço</h6>
                            <input type="range" class="form-range" min="1" max="20" value="3" id="strokeWidth" onchange="setStrokeWidth(this.value)">
                            <span id="strokeValue">3px</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveAnnotatedPhoto()">Salvar Anotações</button>
            </div>
        </div>
    </div>
</div>

<style>
.color-box {
    width: 30px;
    height: 30px;
    display: inline-block;
    margin: 2px;
    cursor: pointer;
    border-radius: 3px;
    border: 2px solid transparent;
}
.color-box:hover {
    border-color: #007bff;
}
.tool-btn.active {
    background-color: var(--bs-primary);
    color: white;
}
</style>

<script>
let canvas, ctx, currentTool = 'pen', currentColor = 'red', currentStrokeWidth = 3;
let isDrawing = false, startX, startY;
let currentPhotoId = null;

function editPhoto(photoId, filename) {
    currentPhotoId = photoId;
    const modal = new bootstrap.Modal(document.getElementById('photoEditorModal'));
    modal.show();
    
    // Load image into canvas
    setTimeout(() => {
        canvas = document.getElementById('photoCanvas');
        ctx = canvas.getContext('2d');
        
        const img = new Image();
        img.onload = function() {
            canvas.width = this.width;
            canvas.height = this.height;
            ctx.drawImage(this, 0, 0);
        };
        img.src = `/static/uploads/${filename}`;
        
        setupCanvasEvents();
    }, 500);
}

function setupCanvasEvents() {
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
}

function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    startX = e.clientX - rect.left;
    startY = e.clientY - rect.top;
    
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentStrokeWidth;
    ctx.lineCap = 'round';
    
    if (currentTool === 'pen') {
        ctx.lineTo(x, y);
        ctx.stroke();
    }
}

function stopDrawing() {
    if (!isDrawing) return;
    isDrawing = false;
    
    const rect = canvas.getBoundingClientRect();
    const endX = event.clientX - rect.left;
    const endY = event.clientY - rect.top;
    
    if (currentTool === 'arrow') {
        drawArrow(startX, startY, endX, endY);
    } else if (currentTool === 'rectangle') {
        drawRectangle(startX, startY, endX, endY);
    } else if (currentTool === 'circle') {
        drawCircle(startX, startY, endX, endY);
    }
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const angle = Math.atan2(toY - fromY, toX - fromX);
    
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentStrokeWidth;
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function drawRectangle(x1, y1, x2, y2) {
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentStrokeWidth;
    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
}

function drawCircle(x1, y1, x2, y2) {
    const radius = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentStrokeWidth;
    ctx.beginPath();
    ctx.arc(x1, y1, radius, 0, 2 * Math.PI);
    ctx.stroke();
}

function setColor(color) {
    currentColor = color;
}

function setStrokeWidth(width) {
    currentStrokeWidth = width;
    document.getElementById('strokeValue').textContent = width + 'px';
}

function clearCanvas() {
    if (confirm('Tem certeza que deseja limpar todas as anotações?')) {
        // Reload original image
        const img = new Image();
        img.onload = function() {
            canvas.width = this.width;
            canvas.height = this.height;
            ctx.drawImage(this, 0, 0);
        };
        img.src = canvas.toDataURL();
    }
}

function saveAnnotatedPhoto() {
    if (!currentPhotoId) return;
    
    const annotatedImageData = canvas.toDataURL('image/jpeg', 0.8);
    
    fetch(`/reports/photos/${currentPhotoId}/annotate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            image_data: annotatedImageData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Anotações salvas com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('photoEditorModal')).hide();
            location.reload();
        } else {
            alert('Erro ao salvar anotações: ' + data.error);
        }
    })
    .catch(error => {
        alert('Erro ao salvar anotações: ' + error);
    });
}

// Tool selection
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;
        });
    });
});

function addPhoto() {
    // Redirect to report form with edit mode
    window.location.href = "{{ url_for('create_report') }}?edit={{ relatorio.id }}";
}

function editReport() {
    // Redirect to edit form
    window.location.href = "{{ url_for('create_report') }}?edit={{ relatorio.id }}";
}

function changeStatus() {
    const newStatus = prompt('Novo status (Rascunho, Aguardando Aprovacao, Aprovado, Rejeitado):');
    if (newStatus) {
        fetch(`/reports/{{ relatorio.id }}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Status atualizado com sucesso!');
                location.reload();
            } else {
                alert('Erro ao atualizar status: ' + data.error);
            }
        });
    }
}

function deletePhoto(photoId) {
    if (confirm('Tem certeza que deseja excluir esta foto?')) {
        fetch(`/reports/photos/${photoId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Foto excluída com sucesso!');
                location.reload();
            } else {
                alert('Erro ao excluir foto: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}