{% extends "base.html" %}

{% block title %}Relatório de Obra{% endblock %}

{% block head %}
<!-- Meta tag CSRF para auto-save -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}

/* Mobile Touch - Sistema inteligente igual ao Express */
    @media (max-width: 768px) {
        /* Categorias de fotos - touch otimizado */
        .photo-category {
            min-height: 60px;
            min-width: 60px;
            touch-action: auto !important;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            pointer-events: auto !important;
            transition: all 0.15s ease;
        }

        /* Feedback visual do touch - igual Express */
        .photo-category.touching {
            transform: scale(0.95);
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* Todos os inputs e controles - interação normal */
        input[type="text"],
        input[type="date"],
        input[type="file"],
        textarea,
        select,
        .form-control {
            touch-action: auto !important;
            -webkit-user-select: auto;
            user-select: auto;
        }

        /* Containers - scroll completamente livre */
        .container-fluid,
        .row,
        .card-body,
        body,
        html {
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overflow: auto !important;
        }

        /* Data do Relatório - Design padrão */
        .alert.border-primary {
            border-width: 1px !important;
            background: #f8f9fa;
        }

        #data_relatorio {
            font-size: 16px;
            font-weight: 400;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: none;
        }

        #data_relatorio:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    }

    @media (max-width: 768px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
            padding: 12px !important;
        }

        .form-label {
            font-size: 14px !important;
            margin-bottom: 0.5rem !important;
        }

        .alert.border-primary {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            border-radius: 0.375rem !important;
        }
    }

    @media (max-width: 576px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
        }
    }

    /* Mobile-First Photo System Styles */
    .mobile-photo-btn {
        border-radius: 12px !important;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mobile-photo-btn:hover, .mobile-photo-btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .mobile-photo-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .mobile-photo-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .photo-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .photo-card-content {
        padding: 16px;
    }

    .caption-input {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        transition: all 0.3s ease;
    }

    .caption-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .caption-select {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        background: white;
        transition: all 0.3s ease;
    }

    .caption-select:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
    }

    .photo-card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
    }

    .photo-card-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        min-height: 42px;
        border: 2px solid;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .photo-card-btn.edit {
        background: white;
        color: #007bff;
        border-color: #007bff;
    }

    .photo-card-btn.edit:hover {
        background: #007bff;
        color: white;
    }

    .photo-card-btn.delete {
        background: white;
        color: #dc3545;
        border-color: #dc3545;
    }

    .photo-card-btn.delete:hover {
        background: #dc3545;
        color: white;
    }

    .category-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .photo-count-badge {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .caption-status {
        font-size: 12px;
        margin-top: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        text-align: center;
    }

    .caption-status.complete {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .caption-status.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .fixed-photo-buttons {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .mobile-photo-card {
            margin-bottom: 20px;
        }

        .photo-card-image {
            height: 160px;
        }

        .photo-card-content {
            padding: 12px;
        }

        .caption-input, .caption-select {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Relatório de Obra</h3>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-warning">
                                <i class="fas fa-edit me-1"></i>Em preenchimento
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_report') }}" enctype="multipart/form-data" id="reportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        {% if existing_report %}
                        <input type="hidden" name="edit_report_id" value="{{ existing_report.id }}">
                        {% endif %}
                        {% if selected_project %}
                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                        {% endif %}

                        <!-- Data do Relatório -->
                        <div class="mb-3">
                            <label class="form-label" for="data_relatorio">
                                Data do Relatório *
                            </label>
                            <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}" required>
                        </div>
                        <!-- Auto-preenchimento do Projeto (se selecionado) -->
                        {% if selected_project %}
                        <div class="alert alert-info mobile-project-info" role="alert">
                            <div class="row align-items-center">
                                <div class="col-md-1 col-2 text-center">
                                    <i class="fas fa-info-circle fa-2x"></i>
                                </div>
                                <div class="col-md-11 col-10">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="fas fa-building me-2"></i>Projeto Pré-selecionado
                                    </h6>
                                    <div class="project-auto-info">
                                        <p class="mb-1"><strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong></p>
                                        {% if selected_project.endereco %}
                                        <p class="mb-1"><small class="text-success">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ selected_project.endereco }}
                                        </small></p>
                                        {% else %}
                                        <p class="mb-1"><small class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Endereço não cadastrado — preencha para continuar
                                        </small></p>
                                        {% endif %}
                                        <p class="mb-0"><small class="text-muted">
                                            <i class="fas fa-building me-1"></i>{{ selected_project.construtora }} - {{ selected_project.nome_funcionario }}
                                        </small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Informações Básicas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">Título do Relatório *</label>
                                    {% if disable_fields %}
                                        <input type="text" name="titulo" id="titulo" class="form-control"
                                               value="Relatório - {{ selected_project.nome }}" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>Título gerado automaticamente a partir do projeto selecionado
                                        </small>
                                    {% else %}
                                        <input type="text" name="titulo" id="titulo" class="form-control"
                                               value="{% if selected_project %}Relatório - {{ selected_project.nome }}{% else %}Relatório de visita{% endif %}" required>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    {% if disable_fields %}
                                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                                        <div class="form-control-plaintext bg-light border rounded p-2">
                                            <strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>Projeto pré-selecionado - não editável
                                        </small>
                                    {% else %}
                                        <select name="projeto_id" id="projeto_id" class="form-control" required onchange="carregarFuncionariosEmails(this.value)">
                                            <option value="">Selecione um projeto</option>
                                            {% for projeto in projetos %}
                                            <option value="{{ projeto.id }}"
                                                    {% if selected_project and selected_project.id == projeto.id %}selected{% endif %}>
                                                {{ projeto.numero }} - {{ projeto.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Seleção de Funcionários e E-mails (SEMPRE RENDERIZADO) -->
                        <div class="row mb-4" id="funcionarios-emails-section">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-users me-2"></i>Funcionários do Projeto
                                        </h6>
                                    </div>
                                    <div class="card-body" style="min-height: 150px;">
                                        <div id="funcionarios-projeto">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Carregando funcionários...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-envelope me-2"></i>E-mails para Envio
                                        </h6>
                                    </div>
                                    <div class="card-body" style="min-height: 150px;">
                                        <div id="emails-projeto">
                                            <div class="alert alert-info mb-0">
                                                <i class="fas fa-spinner fa-spin me-2"></i>
                                                Carregando e-mails...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="aprovador_id">Aprovador do Relatório</label>
                                    <select name="aprovador_id" id="aprovador_id" class="form-control">
                                        <option value="">Selecione o aprovador</option>
                                        {% for admin in admin_users %}
                                        <option value="{{ admin.id }}" {% if selected_aprovador and admin.id == selected_aprovador.id %}selected{% endif %}>{{ admin.nome_completo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Fundação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observações sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Vedação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observações sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instalações (Elétrica/Hidráulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observações sobre instalações..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observações sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organização
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observações sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Observações Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observações Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4"
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Captura de Localização -->
                        <div class="mb-4">
                            <h5><i class="fas fa-map-marker-alt"></i> Localização</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <button type="button" class="btn btn-outline-primary" onclick="capturarLocalizacao()">
                                        <i class="fas fa-crosshairs"></i> Capturar Localização Atual
                                    </button>
                                    <div id="localizacao-info" class="mt-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Fotos Mobile-First -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (Até 200 fotos) <span id="photoCount" class="badge bg-primary ms-2">0</span></h5>

                            <!-- Botões Fixos de Câmera e Galeria (Mobile-First) - CORRIGIDO -->
        <div class="fixed-photo-buttons sticky-top bg-white p-3 mb-3 border rounded" style="z-index: 10;">
            <div class="row g-2">
                <div class="col-6">
                    <button type="button" class="btn btn-outline-primary w-100 mobile-photo-btn"
                            id="mobileCameraBtn" onclick="openPhotoPicker('mobile-camera')" style="min-height: 56px;">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-camera fa-lg mb-1"></i>
                            <small>Câmera</small>
                        </div>
                    </button>
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-outline-success w-100 mobile-photo-btn"
                            id="mobileGalleryBtn" onclick="openPhotoPicker('mobile-gallery')" style="min-height: 56px;">
                        <div class="d-flex flex-column align-items-center">
                            <i class="fas fa-images fa-lg mb-1"></i>
                            <small>Galeria</small>
                        </div>
                    </button>
                </div>
            </div>
            <!-- Hidden file inputs for unified upload system -->
            <input type="file" id="photoInput" name="imagens[]" multiple accept="image/*" style="display: none;">
            <input type="file" id="mobilePhotoInput" name="imagens[]" class="form-control" multiple accept="image/*" style="display: none;">
            <input type="file" id="mobileCameraInput" name="imagens[]" class="form-control" accept="image/*" capture="environment" style="display: none;">
            <div class="text-center mt-2">
                <small class="text-muted"><strong>Máximo 200 fotos - Limite total: 3GB</strong></small>
            </div>
        </div>

                            <!-- Seleção de Categoria (Simplificada) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Categoria padrão para novas fotos:</label>
                                <select id="defaultCategory" class="form-select" style="min-height: 48px;">
                                    <option value="Torre 1">Torre 1</option>
                                    <option value="Torre 2">Torre 2</option>
                                    <option value="Área Comum">Área Comum</option>
                                    <option value="Piscina">Piscina</option>
                                </select>
                            </div>

                            <!-- Preview das Fotos com Cards Mobile-First -->
                            <div id="mobilePhotoCards" class="row g-3"></div>

                            <!-- Quick Action Bar para adicionar mais fotos -->
                            <div id="quickPhotoActions" class="text-center mt-3 p-3 bg-light rounded" style="display: none;">
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <button type="button" class="btn btn-success" onclick="mobileCaptureFromCamera()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-camera me-2"></i>Adicionar da Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="mobileSelectFromGallery()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-images me-2"></i>Adicionar da Galeria
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">Total: <span id="quickPhotoCount">0</span> fotos (máximo 200)</small>
                            </div>

                            <!-- Novo sistema unificado de preview de fotos -->
                            <div id="photosPreview" class="row g-3 mt-3"></div>
                            
                            <!-- Fotos antigas (desabilitado - sistema legacy) -->
                            <div id="photoPreview" class="row" style="display: none;"></div>
                            <div id="mobilePhotoCards" class="row g-3" style="display: none;"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Concluir relatório
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Retângulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> Círculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>

                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>

                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>

                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edição</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let selectedCategory = '';
let selectedPhotos = []; // For old photo upload system
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;
let reportId = null; // Variable to store the report ID

// Initialize Fabric.js editor modal
function initFabricPhotoEditorModal() {
    const modalElement = document.getElementById('fabricPhotoEditorModal');
    if (!modalElement) {
        console.error('❌ Fabric Photo Editor Modal element not found.');
        return;
    }

    const modal = new bootstrap.Modal(modalElement);
    const canvasElement = document.getElementById('fabricModalCanvas');
    const colorPicker = document.getElementById('modal-color-picker');
    const strokeWidthInput = document.getElementById('modal-stroke-width');
    const customLegendInput = document.getElementById('modal-custom-legend');
    const saveButton = document.getElementById('modal-save-btn');
    const cancelButton = document.getElementById('modal-cancel-btn');
    const clearButton = modalElement.querySelector('button[onclick*="window.fabricPhotoEditorModal?.clear()"]');
    const undoButton = modalElement.querySelector('button[onclick*="window.fabricPhotoEditorModal?.undo()"]');

    let fabricCanvas = null;
    let currentImageSrc = '';
    let currentPhotoId = null;
    let onSaveCallback = null;
    let history = []; // For undo functionality
    let historyIndex = -1;

    const updateHistory = () => {
        const data = JSON.stringify(fabricCanvas.toJSON());
        history = history.slice(0, historyIndex + 1); // Remove future history if undoing
        history.push(data);
        historyIndex++;
        undoButton.disabled = false;
        console.log('History updated:', historyIndex);
    };

    const undo = () => {
        if (historyIndex > 0) {
            historyIndex--;
            fabricCanvas.loadFromJSON(history[historyIndex], fabricCanvas.renderAll.bind(fabricCanvas), (o, object) => {
                console.log('Undo loaded:', object);
            });
            undoButton.disabled = historyIndex === 0;
            console.log('Undo performed:', historyIndex);
        }
    };

    const clearCanvas = () => {
        if (confirm('Tem certeza que deseja limpar todas as anotações desta foto?')) {
            fabricCanvas.clear();
            // Reload original image
            fabric.Image.fromURL(currentImageSrc, (img) => {
                fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
                    scaleX: fabricCanvas.width / img.width,
                    scaleY: fabricCanvas.height / img.height
                });
                history = []; // Clear history after clear
                historyIndex = -1;
                undoButton.disabled = true;
                console.log('Canvas cleared and reloaded.');
            });
        }
    };

    const selectTool = (toolName) => {
        // Remove active class from all tools
        modalElement.querySelectorAll('.fabric-tool-btn').forEach(btn => btn.classList.remove('active'));
        // Add active class to the selected tool
        modalElement.querySelector(`.fabric-tool-btn[data-modal-tool="${toolName}"]`)?.classList.add('active');
        console.log('Tool selected:', toolName);
    };

    const updateModalState = () => {
        // Enable/disable buttons based on state
        saveButton.disabled = !fabricCanvas || fabricCanvas.backgroundImage === null;
        clearButton.disabled = !fabricCanvas || fabricCanvas.backgroundImage === null;
        undoButton.disabled = historyIndex <= 0;
    };

    const openEditor = (imageSrc, photoId, callback) => {
        console.log('Opening editor for:', photoId, 'from URL:', imageSrc.substring(0, 50) + '...');
        currentImageSrc = imageSrc;
        currentPhotoId = photoId;
        onSaveCallback = callback;
        history = []; // Reset history for new image
        historyIndex = -1;

        modal.show();

        // Adjust canvas size to modal
        const container = modalElement.querySelector('.canvas-wrapper');
        const modalBody = modalElement.querySelector('.modal-body');
        const toolbarHeight = modalElement.querySelector('.fabric-toolbar').offsetHeight;

        const maxHeight = modalBody.offsetHeight - toolbarHeight - 40; // Subtract padding/margins
        const maxWidth = container.offsetWidth - 40; // Subtract padding

        fabricCanvas = new fabric.Canvas(canvasElement, {
            width: maxWidth,
            height: maxHeight,
            backgroundColor: '#ffffff'
        });

        fabric.Image.fromURL(imageSrc, (img) => {
            // Scale image to fit container while maintaining aspect ratio
            const imgRatio = img.width / img.height;
            const containerRatio = maxWidth / maxHeight;

            let scaleFactor;
            if (imgRatio > containerRatio) {
                scaleFactor = maxWidth / img.width;
            } else {
                scaleFactor = maxHeight / img.height;
            }

            img.scale(scaleFactor);
            img.set({ left: (maxWidth - img.getScaledWidth()) / 2, top: (maxHeight - img.getScaledHeight()) / 2 });

            fabricCanvas.setBackgroundImage(img, fabricCanvas.renderAll.bind(fabricCanvas), {
                scaleX: fabricCanvas.width / img.width,
                scaleY: fabricCanvas.height / img.height
            });

            fabricCanvas.renderAll();
            updateModalState();
            selectTool('select'); // Set default tool
            updateHistory(); // Initial state for undo
        }, { crossOrigin: 'anonymous' }); // Important for data URLs

        // Set initial values for controls
        colorPicker.value = '#FF0000';
        strokeWidthInput.value = '3';
        customLegendInput.value = '';

        // Attach event listeners to controls
        colorPicker.oninput = () => fabricCanvas.freeDrawingBrush.color = colorPicker.value;
        strokeWidthInput.oninput = () => fabricCanvas.freeDrawingBrush.width = parseInt(strokeWidthInput.value, 10);

        // Tool selection logic
        modalElement.querySelectorAll('.fabric-tool-btn').forEach(btn => {
            btn.onclick = () => {
                const tool = btn.dataset.modalTool;
                selectTool(tool);
                switch (tool) {
                    case 'select':
                        fabricCanvas.isDrawingMode = false;
                        break;
                    case 'brush':
                        fabricCanvas.isDrawingMode = true;
                        fabricCanvas.freeDrawingBrush = new fabric.PencilBrush(fabricCanvas);
                        fabricCanvas.freeDrawingBrush.color = colorPicker.value;
                        fabricCanvas.freeDrawingBrush.width = parseInt(strokeWidthInput.value, 10);
                        break;
                    case 'arrow':
                    case 'circle':
                    case 'rectangle':
                    case 'text':
                        fabricCanvas.isDrawingMode = false;
                        // Logic to draw shapes will be handled in a separate function
                        break;
                    default:
                        fabricCanvas.isDrawingMode = false;
                }
            };
        });

        // Handle shape drawing
        let isDown = false;
        let startCoords = { x: 0, y: 0 };
        let currentShape = null;

        fabricCanvas.on('mouse:down', (options) => {
            if (!options.target && fabricCanvas.isDrawingMode) return; // Ignore clicks on canvas if not drawing mode

            const pointer = fabricCanvas.getPointer(options.e);
            startCoords = { x: pointer.x, y: pointer.y };
            isDown = true;

            const tool = modalElement.querySelector('.fabric-tool-btn.active')?.dataset.modalTool;

            if (tool === 'arrow' || tool === 'rectangle' || tool === 'circle') {
                if (currentShape) {
                    fabricCanvas.remove(currentShape);
                }
                const options = {
                    stroke: colorPicker.value,
                    strokeWidth: parseInt(strokeWidthInput.value, 10),
                    fill: 'transparent',
                    originX: 'left',
                    originY: 'top'
                };
                switch (tool) {
                    case 'rectangle':
                        currentShape = new fabric.Rect(options);
                        break;
                    case 'circle':
                        currentShape = new fabric.Circle(options);
                        break;
                    case 'arrow':
                        currentShape = new fabric.Path(`M ${startCoords.x} ${startCoords.y}`, options);
                        break;
                }
                if (currentShape) {
                    fabricCanvas.add(currentShape);
                }
            } else if (tool === 'text') {
                const textValue = customLegendInput.value.trim();
                if (textValue) {
                    const text = new fabric.Textbox(textValue, {
                        left: pointer.x,
                        top: pointer.y,
                        width: 150,
                        fontSize: 20,
                        fill: colorPicker.value,
                        fontFamily: 'Arial'
                    });
                    fabricCanvas.add(text);
                    customLegendInput.value = ''; // Clear input after adding
                }
            }
        });

        fabricCanvas.on('mouse:move', (options) => {
            if (!isDown) return;

            const pointer = fabricCanvas.getPointer(options.e);
            const dx = pointer.x - startCoords.x;
            const dy = pointer.y - startCoords.y;

            const tool = modalElement.querySelector('.fabric-tool-btn.active')?.dataset.modalTool;

            if (currentShape) {
                switch (tool) {
                    case 'rectangle':
                        currentShape.set({ left: startCoords.x, top: startCoords.y, width: dx, height: dy });
                        break;
                    case 'circle':
                        currentShape.set({ left: startCoords.x, top: startCoords.y, radius: Math.sqrt(dx * dx + dy * dy) / 2, originX: 'left', originY: 'top' });
                        break;
                    case 'arrow':
                        const angle = Math.atan2(dy, dx);
                        const headlen = 15; // Arrowhead length
                        const arrowPath = `M ${startCoords.x} ${startCoords.y} L ${pointer.x} ${pointer.y} L ${pointer.x - headlen * Math.cos(angle - Math.PI / 6)} ${pointer.y - headlen * Math.sin(angle - Math.PI / 6)} M ${pointer.x} ${pointer.y} L ${pointer.x - headlen * Math.cos(angle + Math.PI / 6)} ${pointer.y - headlen * Math.sin(angle + Math.PI / 6)}`;
                        currentShape.set({ path: arrowPath });
                        break;
                }
                fabricCanvas.renderAll();
            }
        });

        fabricCanvas.on('mouse:up', () => {
            if (!isDown) return;
            isDown = false;
            if (currentShape) {
                updateHistory(); // Add shape to history
                currentShape = null;
            }
            updateModalState();
        });

        // Mouse Wheel for zooming (optional)
        fabricCanvas.on('mouse:wheel', (options) => {
            const delta = options.e.deltaY > 0 ? -1 : 1;
            const zoom = fabricCanvas.getZoom();
            const pointer = fabricCanvas.getPointer(options.e);

            fabricCanvas.zoomToPoint({ x: pointer.x, y: pointer.y }, zoom + delta * 0.1);
            options.e.preventDefault();
        });

        // Event listener for modal close
        modalElement.addEventListener('hidden.bs.modal', () => {
            if (fabricCanvas) {
                fabricCanvas.dispose(); // Clean up canvas
                fabricCanvas = null;
            }
            onSaveCallback = null;
            currentImageSrc = '';
            currentPhotoId = null;
            history = [];
            historyIndex = -1;
        });

        // Save button functionality
        saveButton.onclick = () => {
            if (onSaveCallback && fabricCanvas) {
                const imageData = fabricCanvas.toDataURL({ format: 'jpeg', quality: 0.9 });
                const legend = customLegendInput.value.trim();
                onSaveCallback({ imageData, legend });
                modal.hide();
            }
        };

        // Cancel button functionality
        cancelButton.onclick = () => {
            modal.hide();
        };

        // Clear button functionality
        clearButton.onclick = clearCanvas;

        // Undo button functionality
        undoButton.onclick = undo;

        // Update initial state
        updateModalState();
    };

    window.fabricPhotoEditorModal = {
        openEditor: openEditor,
        clear: clearCanvas,
        undo: undo
    };
}

// Initialize the modal when the DOM is ready
document.addEventListener('DOMContentLoaded', initFabricPhotoEditorModal);


// Initializing reportId
let reportId = null;

// Initialization
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');

    // Event listener for global function
    document.addEventListener('selectCategory', function(e) {
        const { category, element } = e.detail;

        // Remove previous selection
        document.querySelectorAll('.photo-category').forEach(cat => {
            if (cat && cat.classList) cat.classList.remove('selected');
        });

        // Add current selection
        if (element && element.classList) element.classList.add('selected');

        // Update global category
        selectedCategory = category;

        // Enable upload buttons
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;

        // Update photo input
        updatePhotoInput();

        // Global category selected
    });

    // Event listeners for photo upload with error handling
    const photoInput = document.getElementById('photoInput');
    const cameraInput = document.getElementById('cameraInput');

    if (photoInput) {
        photoInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Photo input element not found');
    }

    if (cameraInput) {
        cameraInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Camera input element not found');
    }

    // Event listeners for tools - OPTIMIZED FOR MOBILE
    document.querySelectorAll('.tool-btn').forEach(btn => {
        // Use touchstart for faster response on mobile
        const isMobile = window.innerWidth <= 768;
        const eventType = isMobile ? 'touchstart' : 'click';

        btn.addEventListener(eventType, function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Immediate visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);

            // Update tools
            document.querySelectorAll('.tool-btn').forEach(b => { if (b && b.classList) b.classList.remove('active'); });
            if (this && this.classList) this.classList.add('active');
            currentTool = this.dataset.tool;

            console.log('🔧 Tool selected:', currentTool);
        });

        // Prevent duplicate events on mobile
        if (isMobile) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });

    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

// The carregarFuncionariosEmails function is defined in static/js/main.js

// UNIQUE Initialization of the staff/email system
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, initializing staff/email system');

    // FIRST CHECK: Hidden input (disabled pre-selected project)
    const projetoHidden = document.querySelector('input[name="projeto_id"][type="hidden"]');
    if (projetoHidden && projetoHidden.value) {
        console.log('✅ Project pre-selected via hidden input:', projetoHidden.value);
        setTimeout(() => {
            carregarFuncionariosEmails(parseInt(projetoHidden.value));
        }, 300);
        return; // No need to configure select
    }

    // SECOND CHECK: Normal project select
    const projetoSelect = document.getElementById('projeto_id');

    if (!projetoSelect) {
        console.warn('⚠️ No project field found (neither select nor hidden)');
        return;
    }

    console.log('✅ Project select found:', projetoSelect.id);

    // Check if a project is already selected in the select
    if (projetoSelect.value && projetoSelect.value !== '') {
        console.log('🔄 Project already selected in select:', projetoSelect.value);
        setTimeout(() => {
            carregarFuncionariosEmails(parseInt(projetoSelect.value));
        }, 300);
    }

    // Add change event to the select (ONLY ONCE)
    projetoSelect.addEventListener('change', function(e) {
        console.log('🔄 Project select changed to:', e.target.value);
        if (e.target.value) {
            carregarFuncionariosEmails(parseInt(e.target.value));
        }
    });

    console.log('✅ Event listener added to project select');
});


function handlePhotoUpload(event) {
    // Photo upload initiated

    if (!selectedCategory) {
        alert('Please select a category before adding photos.');
        event.target.value = '';
        return;
    }

    const files = event.target.files;
    // Processing selected files

    if (files.length + selectedPhotos.length > 200) {
        alert('Maximum of 200 photos allowed.');
        return;
    }

    // Process each file
    for (let file of files) {
        if (selectedPhotos.length >= 200) {
            // Photo limit reached
            break;
        }
        // Processing file
        addPhotoPreview(file, selectedCategory);
    }

    event.target.value = ''; // Reset input
    // Photo upload completed
}

// Camera and gallery functions with error handling
function selectFromGallery() {
    if (!selectedCategory) {
        alert('Please select a category before adding photos.');
        return;
    }
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    } else {
        console.warn('Photo input element not found');
    }
}

function captureFromCamera() {
    if (!selectedCategory) {
        alert('Please select a category before adding photos.');
        return;
    }
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
        cameraInput.click();
    } else {
        console.warn('Camera input element not found');
    }
}

// Remove duplicate updatePhotoInput function (already exists below)

function addPhotoPreview(file, category) {
    // Adding photo preview

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;

        // Creating photo element

        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.setAttribute('data-photo-id', photoId);
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" data-category="${category}">
                <div class="card-body p-2">
                    <!-- Caption Selector -->
                    <select class="form-control form-control-sm mb-2" id="predefined_${photoId}" name="photo_caption_${photoId}" required>
                        <option value="">Select a caption...</option>
                    </select>
                    <small class="text-muted d-block">Category: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openPhotoEditor('${photoId}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('photoPreview').appendChild(photoDiv);

        selectedPhotos.push({
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src
        });

        // Photo added to array

        loadPredefinedCaptionsForPhoto(photoId, category);
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    }
}

function loadPredefinedCaptionsForPhoto(photoId, category) {
    const select = document.getElementById(`predefined_${photoId}`);
    if (!select) return;

    select.innerHTML = '<option value="">Loading captions...</option>';

    // Load directly from API (PostgreSQL)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/legendas?categoria=all', true);
    xhr.timeout = 10000;

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.legendas && data.legendas.length > 0) {
                    select.innerHTML = '<option value="">Select a caption...</option>';

                    const cats = {
                        'Acabamentos': [],
                        'Estrutural': [],
                        'Geral': [],
                        'Segurança': []
                    };

                    data.legendas.forEach(leg => {
                        if (cats[leg.categoria]) {
                            cats[leg.categoria].push(leg);
                        }
                    });

                    Object.keys(cats).forEach(cat => {
                        if (cats[cat].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = cat + ' (' + cats[cat].length + ' items)';

                            cats[cat].forEach(legenda => {
                                const option = document.createElement('option');
                                option.value = legenda.texto;
                                option.textContent = legenda.texto;
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">Error: no captions found</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="">Error: invalid format</option>';
            }
        } else {
            select.innerHTML = '<option value="">Error: server unavailable</option>';
        }
    };

    xhr.onerror = function() {
        select.innerHTML = '<option value="">Error: network failure</option>';
    };

    xhr.ontimeout = function() {
        select.innerHTML = '<option value="">Error: timeout</option>';
    };

    xhr.send();
}

// Map photo category to legend category
function mapCategoryToLegenda(photoCategory) {
    const mapping = {
        'Geral': 'Geral',
        'Estrutura': 'Estrutural',
        'Acabamento': 'Acabamentos',
        'Instalações': 'Elétrica',
        'Problema': 'Segurança'
    };
    return mapping[photoCategory] || 'Geral';
}

function updatePhotoInput() {
    const input = document.getElementById('photoInput');
    // Updating photo input

    if (selectedCategory) {
        input.disabled = false;
        input.style.opacity = '1';
        input.style.pointerEvents = 'auto';

        // Enable camera and gallery buttons with null checks
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;

        // Photo input enabled
    } else {
        input.disabled = true;

        // Disable camera and gallery buttons with null checks
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = true;
        if (cameraBtn) cameraBtn.disabled = true;
        input.style.opacity = '0.5';
        input.style.pointerEvents = 'none';
        // Photo input disabled
    }
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();

    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;"
                   name="custom_item_${itemId}" placeholder="Enter checklist item..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end"
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observations..." rows="2"></textarea>
    `;

    checklistItems.appendChild(itemDiv);
}

// Mark checklist as completed
document.addEventListener('change', function(e) {
    if (e.target && e.target.classList && e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            if (item && item.classList) item.classList.add('completed');
        } else {
            if (item && item.classList) item.classList.remove('completed');
        }
    }
});

// Fabric.js Photo Editor system - Exactly like Express
function openPhotoEditor(photoId) {
    try {
        // Opening editor for photo

        const card = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (!card) {
            console.error(`❌ Card not found for photo: ${photoId}`);
            return;
        }

        const img = card.querySelector('img');
        if (!img || !img.src) {
            console.error(`❌ Image not found for photo: ${photoId}`);
            return;
        }

        // Callback to save the edited photo (define first)
        const saveCallback = async (data) => {
            // Saving edited photo

            // Update photo preview in the card
            img.src = data.imageData;
            img.dataset.edited = 'true';
            img.dataset.legend = data.legend;

            // Visually mark as edited
            if (card && card.classList) card.classList.add('edited');

            // Add edited badge if it doesn't exist
            if (!card.querySelector('.edited-badge')) {
                const badge = document.createElement('div');
                badge.className = 'edited-badge';
                badge.innerHTML = '<i class="fas fa-edit"></i> Edited';
                card.appendChild(badge);
            }

            // Photo saved successfully
        };

        // Check if the editor modal is available
        if (!window.fabricPhotoEditorModal) {
            console.error('❌ Editor modal not initialized');

            // Check if dependencies are loaded
            if (typeof fabric === 'undefined') {
                alert('Fabric.js is not loaded. Please reload the page.');
                return;
            }

            if (typeof bootstrap === 'undefined') {
                alert('Bootstrap is not loaded. Please reload the page.');
                return;
            }

            if (typeof FabricPhotoEditor === 'undefined') {
                alert('Photo editor script is not loaded. Please reload the page.');
                return;
            }

            // Attempt to initialize the editor modal
            if (typeof initFabricPhotoEditorModal === 'function') {
                // Attempting to initialize editor modal
                initFabricPhotoEditorModal();

                // Wait a moment for the editor to initialize
                setTimeout(() => {
                    if (window.fabricPhotoEditorModal) {
                        console.log('✅ Editor initialized successfully');
                        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
                    } else {
                        console.error('❌ Failed to initialize editor after attempt');
                        alert('Photo editor could not be loaded. Please reload the page.');
                    }
                }, 500);
                return;
            }
        }

        // Editor is available, open directly
        console.log('✅ Opening editor');
        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);

    } catch (error) {
        console.error('❌ Error opening editor:', error);
        alert('An error occurred while opening the photo editor. Please try again.');
    }
}

// Function for centered auto-scroll
function scrollToEditorCenter() {
    console.log('🎨 Executing auto-scroll to editor center');

    const modal = document.getElementById('fabricPhotoEditorModal');
    if (!modal) {
        console.log('⚠️ Modal not found');
        return;
    }

    const canvasContainer = modal.querySelector('.canvas-container');
    if (!canvasContainer) {
        console.log('⚠️ Canvas container not found');
        return;
    }

    try {
        // Smooth scroll to the center of the canvas
        canvasContainer.scrollIntoView({
            behavior: 'smooth',
            block: 'center',
            inline: 'center'
        });

        // Also center the scroll in the window
        window.scrollTo({
            top: window.innerHeight / 4,
            behavior: 'smooth'
        });

        console.log('✅ Auto-scroll executed successfully');
    } catch (error) {
        console.error('❌ Error during auto-scroll:', error);
    }
}

// New function to update photo from Fabric Editor
function updatePhotoFromFabricEditor(photoId, editedImageData) {
    console.log('💾 Updating edited photo:', photoId);

    // Find photo element directly by ID
    const photoElement = document.getElementById(photoId);
    if (!photoElement) {
        console.error('❌ Photo element not found:', photoId);
        return;
    }

    // Update image in preview
    const img = photoElement.querySelector('.photo-preview');
    if (img && editedImageData.imageData) {
        img.src = editedImageData.imageData;
        console.log('✅ Preview image updated');

        // Also update onclick to maintain functionality
        img.setAttribute('onclick', `editPhoto('${photoId}', '${editedImageData.imageData}', '${img.getAttribute('data-category') || 'Geral'}')`);
    }

    // Also update in selectedPhotos if it exists
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.annotatedSrc = editedImageData.imageData;
        console.log('✅ Photo data updated in selectedPhotos');
    }

    // Add visual indicator for edited photo
    const card = photoElement.querySelector('.card');
    if (card && card.classList && !card.classList.contains('border-success')) {
        card.classList.add('border-success', 'border-2');

        // Remove previous indicator if it exists
        const oldIndicator = card.querySelector('.edit-indicator');
        if (oldIndicator) oldIndicator.remove();

        const indicator = document.createElement('small');
        indicator.className = 'text-success fw-bold edit-indicator d-block mt-1';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Edited';
        photoElement.querySelector('.card-body').appendChild(indicator);
        console.log('✅ Visual indicator added');
    }

    console.log('✅ Photo updated successfully');
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;

    if (currentTool === 'text') {
        const text = prompt('Enter text:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }

    // For pen, start the path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';

    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;

    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }

    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;

        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version

        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        if (editButton) {
            editButton.innerHTML = '<i class="fas fa-check"></i> Edited';
            if (editButton.classList) {
                editButton.classList.remove('btn-primary');
                editButton.classList.add('btn-success');
            }
        }
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Function to create initial report in progress
async function createInitialReport() {
    const formData = new FormData(document.getElementById('reportForm'));

    try {
        const response = await fetch('{{ url_for("create_report") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success && result.report_id) {
            console.log('✅ Initial report created:', result.report_id);
            return result.report_id;
        } else {
            throw new Error(result.error || 'Error creating report');
        }
    } catch (error) {
        console.error('❌ Error creating initial report:', error);
        throw error;
    }
}

// REMOVED - Duplicate listener caused conflict. Only the main listener at lines 2768-2806 remains

// Function to capture location
function capturarLocalizacao() {
    const infoDiv = document.getElementById('localizacao-info');

    if (!navigator.geolocation) {
        infoDiv.innerHTML = '<div class="alert alert-danger">Geolocation is not supported by your browser.</div>';
        return;
    }

    infoDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Capturing location...</div>';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Location captured successfully!<br>
                    <small id="addressDisplay">Getting address... (accuracy: ${Math.round(accuracy)}m)</small>
                </div>
            `;

            // Get formatted address via API
            fetch('/get_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.endereco) {
                    document.getElementById('addressDisplay').innerHTML = `<strong>📍 ${data.endereco}</strong> (accuracy: ${Math.round(accuracy)}m)`;
                } else {
                    document.getElementById('addressDisplay').innerHTML = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)} (accuracy: ${Math.round(accuracy)}m)`;
                }
            })
            .catch(error => {
                console.error('Error getting address:', error);
                document.getElementById('addressDisplay').innerHTML = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)} (accuracy: ${Math.round(accuracy)}m)`;
            });
        },
        function(error) {
            let errorMsg = 'Error capturing location.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permission denied to access location.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Location unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Timeout for capturing location.';
                    break;
            }
            infoDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</div>`;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}

// DUPLICATE FUNCTION REMOVED - use the optimized mobile version only

// DUPLICATE FUNCTION REMOVED - use the version at the start of the file

// Function to toggle checkbox and show/hide observations field
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsField = document.getElementById(`obs_${itemId}`);
    const parentItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        if (obsField) {
            obsField.style.display = 'block';
        }
        if (parentItem && parentItem.classList) {
            parentItem.classList.add('completed');
        }
    } else {
        if (obsField) {
            obsField.style.display = 'none';
        }
        if (parentItem && parentItem.classList) {
            parentItem.classList.remove('completed');
        }
    }
}

// Function to toggle checklist item state
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsSection = document.getElementById(`obs_${itemId}`);
    const checklistItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        // Mark as completed
        if (checklistItem && checklistItem.classList) checklistItem.classList.add('completed');
        // Show observations field
        if (obsSection) {
            obsSection.style.display = 'block';
        }
    } else {
        // Unmark as completed
        if (checklistItem && checklistItem.classList) checklistItem.classList.remove('completed');
        // Hide observations field
        if (obsSection) {
            obsSection.style.display = 'none';
            // Clear observations if desired
            const textarea = obsSection.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }
}

// Load default checklist from the system
function carregarChecklistPadrao() {
    fetch('/api/checklist-padrao')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.checklist.length > 0) {
                const container = document.getElementById('checklistItems');
                container.innerHTML = ''; // Clear current content

                data.checklist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item mb-3';
                    itemDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="check_${item.id}" onchange="toggleChecklistItem(this)">
                                <label class="form-check-label" for="check_${item.id}">
                                    ${item.texto}
                                </label>
                            </div>
                        </div>
                        <div class="mt-2" style="display: none;" id="obs_${item.id}">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="Optional observations..." name="obs_${item.id}"></textarea>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                console.log(`${data.checklist.length} default checklist items loaded`);
            } else {
                const container = document.getElementById('checklistItems');
                container.innerHTML = '<p class="text-muted">No default checklist items. <a href="/admin/checklist-padrao">Configure checklist</a></p>';
            }
        })
        .catch(error => {
            console.error('Error loading default checklist:', error);
            const container = document.getElementById('checklistItems');
            container.innerHTML = '<p class="text-danger">Error loading checklist. <a href="#" onclick="carregarChecklistPadrao()">Try again</a></p>';
        });
}

// Helper function to load by ID directly
function carregarFuncionariosEmails(projetoId) {
    if (!projetoId) {
        console.log('⚠️ Invalid project ID');
        return;
    }

    const funcionariosDiv = document.getElementById('funcionarios-projeto');
    const emailsDiv = document.getElementById('emails-projeto');

    if (!funcionariosDiv || !emailsDiv) {
        console.error('❌ Staff or email divs not found');
        return;
    }

    console.log('🔄 Loading staff and emails for project ID:', projetoId);

    funcionariosDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading staff...</p>';
    emailsDiv.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin me-2"></i>Loading emails...</p>';

    // Fetch project staff and emails via AJAX
    const apiUrl = `/api/projeto/${projetoId}/funcionarios-emails`;
    console.log('📡 Calling API:', apiUrl);

    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('📡 API Response:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📦 Received data:', data);

        if (data.success) {
            // Render staff
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                console.log(`✅ ${data.funcionarios.length} staff found`);
                data.funcionarios.forEach(func => {
                    const checked = func.is_responsavel_principal ? 'checked' : '';
                    funcionariosHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="func_${func.id}"
                                   name="funcionarios_selecionados[]" value="${func.id}" ${checked}>
                            <label class="form-check-label" for="func_${func.id}">
                                <strong>${func.nome_funcionario}</strong><br>
                                <small class="text-muted">${func.cargo || 'No position'} - ${func.empresa || 'No company'}</small>
                                ${func.is_responsavel_principal ? '<span class="badge bg-primary">Primary</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                funcionariosHtml = '<p class="text-muted">No staff found for this project</p>';
                console.log('⚠️ No staff found');
            }
            funcionariosDiv.innerHTML = funcionariosHtml;

            // Render emails
            let emailsHtml = '';
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    const checked = email.is_principal ? 'checked' : '';
                    emailsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_${email.id}"
                                   name="emails_selecionados[]" value="${email.id}" ${checked}>
                            <label class="form-check-label" for="email_${email.id}">
                                <strong>${email.email}</strong><br>
                                <small class="text-muted">${email.nome_contato} - ${email.cargo || 'No position'}</small>
                                ${email.is_principal ? '<span class="badge bg-success">Primary</span>' : ''}
                            </label>
                        </div>
                    `;
                });
                console.log(`✅ ${data.emails.length} emails loaded`);
            } else {
                emailsHtml = '<p class="text-muted">No emails found for this project</p>';
                console.log('⚠️ No emails found');
            }
            emailsDiv.innerHTML = emailsHtml;
        } else {
            console.error('❌ API returned error:', data.error || 'Unknown error');
            funcionariosDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error || 'Error loading staff'}</p>`;
            emailsDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.error || 'Error loading emails'}</p>`;
        }
    })
    .catch(error => {
        console.error('❌ Error loading staff and emails:', error);
        funcionariosDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error loading staff</strong><br>
                <small>${error.message}</small><br>
                <small>URL: /api/projeto/${projetoId}/funcionarios-emails</small>
            </div>
        `;
        emailsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error loading emails</strong><br>
                <small>${error.message}</small>
            </div>
        `;
    });
}

// Initialize system on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load default checklist automatically
    carregarChecklistPadrao();

    // Auto-load project data if pre-selected
    {% if disable_fields and preselected_project_id %}
    // For pre-selected project with disabled fields
    console.log('🏗️ Pre-selected project detected (disabled fields):', {{ preselected_project_id }});
    carregarFuncionariosEmails({{ preselected_project_id }});
    {% elif selected_project and selected_project.id %}
    // For pre-selected project (selected_project exists in template)
    console.log('🏗️ selected_project detected:', {{ selected_project.id }});
    carregarFuncionariosEmails({{ selected_project.id }});
    {% else %}
    // For project selected normally via dropdown
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value && !isNaN(parseInt(projetoSelect.value))) {
        console.log('🏗️ Project via select detected:', projetoSelect.value);
        carregarFuncionariosEmails(parseInt(projetoSelect.value));
    } else {
        console.log('ℹ️ No pre-selected project - awaiting user selection');
    }
    {% endif %}

    // Initialize Fabric.js modal editor
    if (typeof initFabricPhotoEditorModal === 'function') {
        initFabricPhotoEditorModal();
        console.log('✅ Modal editor initialized');
    } else {
        console.error('❌ Modal editor not available');
    }

    // Create initial report and activate auto save after basic data is filled
    let autoSaveInitialized = false;

    // Function to initialize auto save when sufficient data is available
    function tryInitializeAutoSave() {
        if (autoSaveInitialized) return;

        const titulo = document.getElementById('titulo').value;
        const projetoId = document.getElementById('projeto_id').value;

        if (titulo && projetoId) {
            console.log('📝 Basic data filled, creating initial report...');

            // Create initial report
            createInitialReport().then(reportId => {
                window.currentReportId = reportId;

                // Initialize auto save
                if (typeof initAutoSave === 'function') {
                    window.autoSaveInstance = initAutoSave(reportId, {
                        interval: 10000, // 10 seconds
                        statusElement: document.getElementById('autosave-status'),
                        form: document.getElementById('reportForm')
                    });

                    autoSaveInitialized = true;
                    console.log('✅ Auto save activated for report', reportId);
                } else {
                    console.error('❌ initAutoSave function not found');
                }
            }).catch(error => {
                console.error('❌ Error creating initial report:', error);
            });
        }
    }

    // Observe changes in basic fields
    const tituloField = document.getElementById('titulo');
    const projetoField = document.getElementById('projeto_id');

    if (tituloField) {
        tituloField.addEventListener('blur', tryInitializeAutoSave);
    }

    if (projetoField) {
        projetoField.addEventListener('change', tryInitializeAutoSave);
    }
});

</script>

<!-- Fabric.js CDN - Exactly like Express -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Editor Scripts - Exactly like Express -->
<script src="{{ url_for('static', filename='js/fabric-photo-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/fabric-photo-editor-modal.js') }}"></script>

<!-- Professional Photo Editor Modal - Exactly like Express -->
<div class="modal fade" id="fabricPhotoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Professional Photo Editor
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-0" style="height: calc(100vh - 160px);">
                <div class="fabric-editor-container" style="height: 100%;">
                    <!-- Main editor area -->
                    <div class="fabric-editor-main" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Canvas container -->
                        <div class="canvas-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa;">
                            <div class="canvas-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); overflow: hidden;">
                                <canvas id="fabricModalCanvas"></canvas>
                            </div>
                        </div>

                        <!-- Toolbar -->
                        <div class="fabric-toolbar" style="background: white; border-top: 1px solid #e1e5e9; padding: 16px;">
                            <!-- Main tools -->
                            <div class="tool-group mb-3">
                                <h6 class="text-muted mb-2">Tools</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="fabric-tool-btn active" data-modal-tool="select" title="Select">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="brush" title="Brush">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="arrow" title="Arrow">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="circle" title="Circle">
                                        <i class="far fa-circle"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="rectangle" title="Rectangle">
                                        <i class="far fa-square"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="text" title="Text">
                                        <i class="fas fa-font"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Properties -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Color:</label>
                                    <input type="color" id="modal-color-picker" class="form-control form-control-color" value="#FF0000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Thickness:</label>
                                    <input type="range" id="modal-stroke-width" class="form-range" min="1" max="20" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Caption:</label>
                                    <input type="text" id="modal-custom-legend" class="form-control" placeholder="Enter a caption...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" onclick="window.fabricPhotoEditorModal?.clear()">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <button type="button" class="btn btn-warning" onclick="window.fabricPhotoEditorModal?.undo()">
                    <i class="fas fa-undo"></i> Undo
                </button>
                <button type="button" class="btn btn-success" id="modal-save-btn">
                    <i class="fas fa-check"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Modal editor styles - Exactly like Express */
.fabric-tool-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 8px;
    color: #4b5563;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fabric-tool-btn:hover {
    background: #e5e7eb;
}

.fabric-tool-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
}

/* Visual indicator for edited photo */
.photo-container.edited {
    position: relative;
}

.edited-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    z-index: 10;
}

.edit-photo-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    border: none;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.edit-photo-btn:hover {
    background: #3b82f6;
    transform: scale(1.1);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .fabric-toolbar {
        max-height: 40vh;
        overflow-y: auto;
    }

    .fabric-tool-btn {
        min-width: 40px;
        min-height: 40px;
    }

    /* MOBILE: Specific optimizations for predefined captions */
    select[name^="photo_caption_"],
    select[id^="predefined_"] {
        font-size: 16px !important;
        min-height: 48px !important;
        padding: 12px !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        background: white !important;
        display: block !important;
        width: 100% !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
        appearance: menulist !important;
    }

    /* Visible option groups */
    optgroup {
        font-weight: bold !important;
        color: #007bff !important;
        font-size: 15px !important;
        padding: 4px !important;
    }

    option {
        font-size: 14px !important;
        padding: 8px !important;
        color: #333 !important;
        background: white !important;
    }

    /* Optimized photo cards */
    .card-body.p-2 {
        padding: 16px !important;
    }

    /* More visible category text */
    .text-muted {
        font-size: 14px !important;
        color: #555 !important;
        font-weight: 600 !important;
    }
}
</style>

<!-- Auto-populate project coordinates script -->
<script>
// Auto-populate project coordinates and location info when coming from project view
{% if selected_project %}
document.addEventListener('DOMContentLoaded', function() {
    // Ensure required elements exist
    const latitudeEl = document.getElementById('latitude');
    const longitudeEl = document.getElementById('longitude');
    const localizacaoInfo = document.getElementById('localizacao-info');

    if (!latitudeEl || !longitudeEl || !localizacaoInfo) {
        console.warn('Required form elements not found for auto-population');
        return;
    }

    {% if selected_project.latitude and selected_project.longitude %}
    // Auto-populate coordinates if available from project (using tojson for safety)
    latitudeEl.value = {{ selected_project.latitude | tojson }};
    longitudeEl.value = {{ selected_project.longitude | tojson }};

    // Display project location info (escaped properly)
    const endereco = {{ selected_project.endereco | tojson or "'Project coordinates'" }};
    localizacaoInfo.innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Project location pre-loaded!<br>
            <strong>📍 ${endereco}</strong>
            <br><small class="text-muted">You can capture a new location if needed</small>
        </div>
    `;
    {% else %}
    // Show message that project has no coordinates
    localizacaoInfo.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> This project does not have coordinates registered.<br>
            <small>Use the "Capture Current Location" button to set the visit location.</small>
        </div>
    `;
    {% endif %}
});
{% endif %}

// Smart touch system EQUAL TO EXPRESS - 100% functional
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Smart touch system loaded (equal to express)');

    // EXACT Express Settings
    const TOUCH_THRESHOLD = 10; // pixels
    const TOUCH_TIME_LIMIT = 500; // ms

    let touchData = {
        startX: 0,
        startY: 0,
        startTime: 0,
        isDragging: false,
        element: null
    };

    // Function for category selection IDENTICAL TO Express
    function selectPhotoCategory(category, element) {
        // Remove previous selection
        document.querySelectorAll('.photo-category').forEach(cat => {
            if (cat && cat.classList) cat.classList.remove('selected');
        });

        // Add current selection
        if (element && element.classList) element.classList.add('selected');

        // Haptic feedback
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }

        console.log('📷 Category selected:', category);

        // Update global category
        selectedCategory = category;

        // Enable upload buttons
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;

        // Update photo input
        updatePhotoInput();
    }

    // Event listeners for categories - EXACT EXPRESS CODE
    document.querySelectorAll('.photo-category').forEach(categoryElement => {

        // Touch Start
        categoryElement.addEventListener('touchstart', function(e) {
            console.log('👆 TouchStart category');

            const touch = e.touches[0];
            touchData.startX = touch.clientX;
            touchData.startY = touch.clientY;
            touchData.startTime = Date.now();
            touchData.isDragging = false;
            touchData.element = categoryElement;

            // Immediate visual feedback
            if (categoryElement && categoryElement.classList) categoryElement.classList.add('touching');
        }, { passive: true });

        // Touch Move
        categoryElement.addEventListener('touchmove', function(e) {
            if (!touchData.element) return;

            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchData.startX);
            const deltaY = Math.abs(touch.clientY - touchData.startY);
            const totalDelta = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // If movement exceeds threshold, mark as drag
            if (totalDelta > TOUCH_THRESHOLD) {
                touchData.isDragging = true;
                if (categoryElement && categoryElement.classList) categoryElement.classList.remove('touching');
                console.log('🔄 Movement detected - drag mode activated');
            }
        }, { passive: true });

        // Touch End
        categoryElement.addEventListener('touchend', function(e) {
            console.log('👆 TouchEnd category');

            // Remove visual feedback
            if (categoryElement && categoryElement.classList) categoryElement.classList.remove('touching');

            if (!touchData.element) return;

            const touchDuration = Date.now() - touchData.startTime;

            // Only select if it was a quick tap without movement
            if (!touchData.isDragging && touchDuration < TOUCH_TIME_LIMIT) {
                e.preventDefault();
                e.stopPropagation();

                const category = categoryElement.getAttribute('data-category');
                selectPhotoCategory(category, categoryElement);

                console.log('✅ Valid tap - category selected');
            } else {
                console.log('❌ Drag detected - do not select category');
            }

            // Reset
            touchData.element = null;
            touchData.isDragging = false;
        }, { passive: false });

        // Mouse events for desktop (fallback)
        categoryElement.addEventListener('click', function(e) {
            // Only process if there was no recent touch
            if (touchData.startTime && (Date.now() - touchData.startTime) < 300) {
                return; // Ignore click after touch
            }

            e.preventDefault();
            e.stopPropagation();

            const category = categoryElement.getAttribute('data-category');
            selectPhotoCategory(category, categoryElement);

            console.log('🖱️ Desktop click - category selected');
        });
    });

    console.log('✅ Smart touch system active for', document.querySelectorAll('.photo-category').length, 'categories');
});

// Global function for compatibility - integrated with touch system
window.selectPhotoCategory = function(category, element) {
    if (!element) {
        element = document.querySelector(`[data-category="${category}"]`);
    }

    if (element) {
        // Use the internal function that already has all the logic
        const selectEvent = new CustomEvent('selectCategory', {
            detail: { category: category, element: element }
        });
        document.dispatchEvent(selectEvent);
    }
};
</script>

<!-- Auto Save Script -->
<!-- Auto-managed autosave system by reports_autosave.js -->
{% if existing_report and existing_report.id %}
<div data-report-id="{{ existing_report.id }}" style="display:none;"></div>
{% endif %}

<!-- Mobile-First Photo System JavaScript -->
<script>
// Global variables for mobile photo system
let mobilePhotoCounter = 0;
let predefinedLegendas = [];
let mobilePhotoData = [];

// Load predefined captions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPredefinedLegendas();
    setupMobilePhotoSystem();
});

// Load predefined captions from API
async function loadPredefinedLegendas() {
    try {
        console.log('📋 Loading predefined captions...');
        const response = await fetch('/api/legendas?categoria=all');
        const data = await response.json();

        if (data.success) {
            predefinedLegendas = data.legendas;
            console.log(`✅ ${predefinedLegendas.length} captions loaded`);
        }
    } catch (error) {
        console.error('❌ Error loading captions:', error);
    }
}

// Setup mobile photo system
function setupMobilePhotoSystem() {
    console.log('📱 Setting up mobile-first photo system...');

    // Setup file input event listeners
    const mobilePhotoInput = document.getElementById('mobilePhotoInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');

    if (mobilePhotoInput) {
        mobilePhotoInput.addEventListener('change', handleMobilePhotoSelection);
    }

    if (mobileCameraInput) {
        mobileCameraInput.addEventListener('change', handleMobilePhotoSelection);
    }
});

// Mobile gallery selection
function mobileSelectFromGallery() {
    console.log('📸 Selecting from gallery (mobile)...');
    const input = document.getElementById('mobilePhotoInput');
    if (input) {
        input.click();
    }
}

// Mobile camera capture
function mobileCaptureFromCamera() {
    console.log('📷 Capturing from camera (mobile)...');
    const input = document.getElementById('mobileCameraInput');
    if (input) {
        input.click();
    }
}

// Handle photo selection from mobile inputs
function handleMobilePhotoSelection(event) {
    console.log('📋 Processing selected photos...');
    const files = event.target.files;
    const defaultCategory = document.getElementById('defaultCategory').value;

    if (files.length === 0) return;

    Array.from(files).forEach(file => {
        createMobilePhotoCard(file, defaultCategory);
    });

    // Clear input for next selection
    event.target.value = '';

    updatePhotoCounter();
}

// Create mobile photo card with immediate display
function createMobilePhotoCard(file, category) {
    const photoId = 'mobile_photo_' + (++mobilePhotoCounter);
    const reader = new FileReader();

    reader.onload = function(e) {
        const photoCard = createPhotoCardHTML(photoId, e.target.result, category, file.name);

        // Add to DOM
        const container = document.getElementById('mobilePhotoCards');
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-lg-4';
        cardCol.innerHTML = photoCard;
        container.appendChild(cardCol);

        // Store photo data
        mobilePhotoData.push({
            id: photoId,
            file: file,
            category: category,
            manualCaption: '',
            predefinedCaption: '',
            filename: file.name
        });

        // Setup event listeners for this card
        setupPhotoCardEvents(photoId);

        // Immediately scroll to the new photo and focus on caption for better UX
        setTimeout(() => {
            const newCard = cardCol.querySelector('.mobile-photo-card');
            if (newCard) {
                newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Auto-focus on caption input for immediate editing
                const captionInput = newCard.querySelector('.caption-input');
                if (captionInput) {
                    setTimeout(() => {
                        captionInput.focus();
                        captionInput.select();
                    }, 600);
                }
            }
        }, 300);

        console.log(`📷 Photo added: ${file.name} (${category})`);
    };

    reader.readAsDataURL(file);
}

// Create photo card HTML
function createPhotoCardHTML(photoId, imageSrc, category, filename) {
    const legendaSelectHTML = createLegendaSelectHTML(photoId);

    return `
        <div class="mobile-photo-card enhanced" data-photo-id="${photoId}" style="border: 2px solid #007bff; border-radius: 12px; padding: 12px; background: white; box-shadow: 0 4px 12px rgba(0,123,255,0.15); margin-bottom: 16px;">
            <!-- Vertical Layout: IMAGE ON TOP -->
            <div class="text-center mb-3">
                <img src="${imageSrc}"
                     alt="${filename}"
                     data-photo-id="${photoId}"
                     style="width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef; cursor: pointer;">
            </div>

            <!-- Category (WITHOUT filename) -->
            <div class="text-center mb-2">
                <span class="badge bg-primary">${category}</span>
            </div>

            <!-- CAPTION BELOW -->
            <div class="mb-2">
                <input type="text"
                       class="form-control caption-input"
                       id="manual_caption_${photoId}"
                       placeholder="✏️ Enter a caption (required)..."
                       data-photo-id="${photoId}"
                       style="border: 2px solid #28a745; font-size: 14px; padding: 8px; background-color: #f8fff9;">
            </div>

            <!-- Predefined Caption -->
            <div class="mb-2">
                <select class="form-select form-select-sm caption-select"
                        id="predefined_caption_${photoId}"
                        data-photo-id="${photoId}"
                        style="font-size: 12px;">
                    <option value="">📋 Or choose a predefined caption...</option>
                    ${legendaSelectHTML}
                </select>
            </div>

            <!-- Caption Status -->
            <div class="caption-status pending alert alert-warning py-1 px-2 mb-2" id="caption_status_${photoId}" style="font-size: 12px; margin: 0;">
                ⚠️ Caption required - fill at least one field
            </div>

            <!-- Actions -->
            <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editMobilePhoto('${photoId}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMobilePhoto('${photoId}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    `;
}

// Create legend select HTML
function createLegendaSelectHTML(photoId) {
    let html = '';

    // Group legends by category
    const legendsByCategory = {};
    predefinedLegendas.forEach(legenda => {
        if (!legendsByCategory[legenda.categoria]) {
            legendsByCategory[legenda.categoria] = [];
        }
        legendsByCategory[legenda.categoria].push(legenda);
    });

    // Create optgroups
    Object.keys(legendsByCategory).forEach(categoria => {
        html += `<optgroup label="${categoria}">`;
        legendsByCategory[categoria].forEach(legenda => {
            html += `<option value="${legenda.texto}">${legenda.texto}</option>`;
        });
        html += `</optgroup>`;
    });

    return html;
}

// Setup event listeners for photo card
function setupPhotoCardEvents(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);

    if (manualInput) {
        manualInput.addEventListener('input', () => saveCaptionData(photoId));
        manualInput.addEventListener('blur', () => saveCaptionData(photoId));
    }

    if (predefinedSelect) {
        predefinedSelect.addEventListener('change', function() {
            if (this.value) {
                // Copy predefined to manual field
                manualInput.value = this.value;
                saveCaptionData(photoId);

                // Reset select for next use
                setTimeout(() => {
                    this.selectedIndex = 0;
                }, 500);
            }
        });
    }
}

// Save caption data via AJAX
async function saveCaptionData(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const statusDiv = document.getElementById(`caption_status_${photoId}`);

    const manualCaption = manualInput.value.trim();
    const predefinedCaption = predefinedSelect.value.trim();

    // Update local data
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (photoData) {
        photoData.manualCaption = manualCaption;
        photoData.predefinedCaption = predefinedCaption;
    }

    // Update status
    const hasCaption = manualCaption || predefinedCaption;
    if (hasCaption) {
        statusDiv.className = 'caption-status complete';
        statusDiv.innerHTML = '✅ Caption set';
    } else {
        statusDiv.className = 'caption-status pending';
        statusDiv.innerHTML = '⚠️ Caption required - fill at least one field';
    }

    console.log(`💾 Caption saved for ${photoId}: "${manualCaption}"`);
}

// Edit mobile photo - RESTORED as it worked before
function editMobilePhoto(photoId) {
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (!photoData) return;

    // Find the photo's img element
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    const imgElement = photoCard.querySelector('img');

    if (!imgElement) {
        console.error('Image not found for editing');
        return;
    }

    // Open the modal editor as before
    openPhotoEditorFromElement(imgElement);
}

// Delete mobile photo
function deleteMobilePhoto(photoId) {
    if (!confirm('Do you want to delete this photo?')) return;

    // Remove from data array
    mobilePhotoData = mobilePhotoData.filter(p => p.id !== photoId);

    // Remove from DOM
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (photoCard) {
        photoCard.closest('.col-12, .col-md-6, .col-lg-4').remove();
    }

    updatePhotoCounter();
    console.log(`🗑️ Photo ${photoId} deleted`);
}

// Update photo counter and show quick actions
function updatePhotoCounter() {
    const count = mobilePhotoData.length;

    // Update main counter
    const counter = document.getElementById('photoCount');
    if (counter) {
        counter.textContent = count;
    }

    // Update quick action counter
    const quickCounter = document.getElementById('quickPhotoCount');
    if (quickCounter) {
        quickCounter.textContent = count;
    }

    // Show quick action bar after first photo
    const quickActionBar = document.getElementById('quickPhotoActions');
    if (quickActionBar) {
        if (count > 0) {
            quickActionBar.style.display = 'block';
        } else {
            quickActionBar.style.display = 'none';
        }
    }
}

// Validate captions before form submission
function validateCaptions() {
    let hasInvalidPhotos = false;

    mobilePhotoData.forEach(photoData => {
        const hasCaption = photoData.manualCaption || photoData.predefinedCaption;
        if (!hasCaption) {
            hasInvalidPhotos = true;

            // Highlight invalid photo
            const statusDiv = document.getElementById(`caption_status_${photoData.id}`);
            if (statusDiv) {
                statusDiv.className = 'caption-status pending';
                statusDiv.innerHTML = '❌ REQUIRED: Add a caption';
                statusDiv.style.animation = 'pulse 2s infinite';
            }
        }
    });

    return !hasInvalidPhotos;
}

// Prepare form data for submission
async function prepareMobilePhotoFormData() {
    console.log('📱 Preparing mobile photo data...');

    // Convert files to base64 data
    const photosWithData = await Promise.all(
        mobilePhotoData.map(async (photoData) => {
            let imageBase64 = null;

            try {
                // Convert file to base64
                imageBase64 = await fileToBase64(photoData.file);
                console.log(`✅ Photo ${photoData.id} converted: ${imageBase64.length} chars`);
            } catch (error) {
                console.error(`❌ Error converting photo ${photoData.id}:`, error);
            }

            return {
                id: photoData.id,
                filename: photoData.filename,
                category: photoData.category,
                caption: photoData.manualCaption || photoData.predefinedCaption,
                description: '',
                data: imageBase64 // CORRECTED: Now sends base64
            };
        })
    );

    // Create form data for mobile photos
    const formData = {
        photos: photosWithData
    };

    // Add hidden input with photo data
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'mobile_photos_data';
    hiddenInput.value = JSON.stringify(formData);

    const form = document.getElementById('reportForm');
    if (form) {
        form.appendChild(hiddenInput);
    }

    console.log(`📤 Prepared ${mobilePhotoData.length} photos with binary data for submission`);
}

// Helper function to convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// OLD SUBMIT HANDLER - DESABILITADO (substituído pelo sistema unificado em reports-upload.js)
// Form submission validation
/*
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault(); // Always prevent default

            // If we already have a reportId, just finalize
            if (window.currentReportId) {
                this.submit();
                return;
            }

            // Validate captions
            if (!validateCaptions()) {
                alert('⚠️ ATTENTION: All photos must have at least one caption (manual or predefined). Please check the photos marked in red.');

                // Scroll to the first invalid photo
                const firstInvalid = document.querySelector('.caption-status.pending');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }

            // Prepare mobile photo data if any exist
            if (mobilePhotoData.length > 0) {
                console.log('📸 Processing photos...');
                try {
                    await prepareMobilePhotoFormData();
                    console.log('✅ Photos processed with base64');
                } catch (error) {
                    console.error('❌ Error processing photos:', error);
                    alert('Error processing photos. Please try again.');
                    return;
                }
            }

            // Submit form
            console.log('📤 Submitting form...');
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;

            const formData = new FormData(form);

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    alert('Report saved successfully!');
                    window.location.href = data.redirect || '/reports';
                } else {
                    throw new Error(data.error || 'Error saving report');
                }
            } catch (error) {
                console.error('❌ Error:', error);
                alert('Error saving report. Please try again.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
    }
});
*/

console.log('📱 Mobile-first photo system loaded');
</script>

<!-- Auto Save Script -->
<script src="{{ url_for('static', filename='js/reports_autosave.js') }}"></script>

<!-- Unified Photo Upload System (NEW - Fixes image upload to database) -->
<script src="{{ url_for('static', filename='js/reports-upload.js') }}"></script>

{% endblock %}