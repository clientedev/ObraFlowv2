{% extends "base.html" %}

{% block title %}Relat√≥rio de Obra{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}

/* Mobile Touch - Sistema inteligente igual ao Express */
    @media (max-width: 768px) {
        /* Categorias de fotos - touch otimizado */
        .photo-category {
            min-height: 60px;
            min-width: 60px;
            touch-action: auto !important;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            pointer-events: auto !important;
            transition: all 0.15s ease;
        }
        
        /* Feedback visual do touch - igual Express */
        .photo-category.touching {
            transform: scale(0.95);
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* Todos os inputs e controles - intera√ß√£o normal */
        input[type="text"],
        input[type="date"], 
        input[type="file"],
        textarea,
        select,
        .form-control {
            touch-action: auto !important;
            -webkit-user-select: auto;
            user-select: auto;
        }

        /* Containers - scroll completamente livre */
        .container-fluid,
        .row,
        .card-body,
        body,
        html {
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overflow: auto !important;
        }

        /* Data do Relat√≥rio - Design padr√£o */
        .alert.border-primary {
            border-width: 1px !important;
            background: #f8f9fa;
        }
        
        #data_relatorio {
            font-size: 16px;
            font-weight: 400;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: none;
        }
        
        #data_relatorio:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    }
    
    @media (max-width: 768px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
            padding: 12px !important;
        }
        
        .form-label {
            font-size: 14px !important;
            margin-bottom: 0.5rem !important;
        }
        
        .alert.border-primary {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            border-radius: 0.375rem !important;
        }
    }
    
    @media (max-width: 576px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
        }
    }

    /* Mobile-First Photo System Styles */
    .mobile-photo-btn {
        border-radius: 12px !important;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mobile-photo-btn:hover, .mobile-photo-btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .mobile-photo-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .mobile-photo-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .photo-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .photo-card-content {
        padding: 16px;
    }

    .caption-input {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        transition: all 0.3s ease;
    }

    .caption-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .caption-select {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        background: white;
        transition: all 0.3s ease;
    }

    .caption-select:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
    }

    .photo-card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
    }

    .photo-card-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        min-height: 42px;
        border: 2px solid;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .photo-card-btn.edit {
        background: white;
        color: #007bff;
        border-color: #007bff;
    }

    .photo-card-btn.edit:hover {
        background: #007bff;
        color: white;
    }

    .photo-card-btn.delete {
        background: white;
        color: #dc3545;
        border-color: #dc3545;
    }

    .photo-card-btn.delete:hover {
        background: #dc3545;
        color: white;
    }

    .category-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .photo-count-badge {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .caption-status {
        font-size: 12px;
        margin-top: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        text-align: center;
    }

    .caption-status.complete {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .caption-status.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .fixed-photo-buttons {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .mobile-photo-card {
            margin-bottom: 20px;
        }
        
        .photo-card-image {
            height: 160px;
        }
        
        .photo-card-content {
            padding: 12px;
        }
        
        .caption-input, .caption-select {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Relat√≥rio de Obra</h3>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-warning">
                                <i class="fas fa-edit me-1"></i>Em preenchimento
                            </span>
                            <div id="autosave-status"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_report') }}" enctype="multipart/form-data" id="reportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        {% if selected_project %}
                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                        {% endif %}
                        
                        <!-- Data do Relat√≥rio -->
                        <div class="mb-3">
                            <label class="form-label" for="data_relatorio">
                                Data do Relat√≥rio *
                            </label>
                            <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}" required>
                        </div>
                        <!-- Auto-preenchimento do Projeto (se selecionado) -->
                        {% if selected_project %}
                        <div class="alert alert-info mobile-project-info" role="alert">
                            <div class="row align-items-center">
                                <div class="col-md-1 col-2 text-center">
                                    <i class="fas fa-info-circle fa-2x"></i>
                                </div>
                                <div class="col-md-11 col-10">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="fas fa-building me-2"></i>Projeto Pr√©-selecionado
                                    </h6>
                                    <div class="project-auto-info">
                                        <p class="mb-1"><strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong></p>
                                        {% if selected_project.endereco %}
                                        <p class="mb-1"><small class="text-success">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ selected_project.endereco }}
                                        </small></p>
                                        {% else %}
                                        <p class="mb-1"><small class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Endere√ßo n√£o cadastrado ‚Äî preencha para continuar
                                        </small></p>
                                        {% endif %}
                                        <p class="mb-0"><small class="text-muted">
                                            <i class="fas fa-building me-1"></i>{{ selected_project.construtora }} - {{ selected_project.nome_funcionario }}
                                        </small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">T√≠tulo do Relat√≥rio *</label>
                                    {% if disable_fields %}
                                        <input type="text" name="titulo" id="titulo" class="form-control" 
                                               value="Relat√≥rio - {{ selected_project.nome }}" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>T√≠tulo gerado automaticamente a partir do projeto selecionado
                                        </small>
                                    {% else %}
                                        <input type="text" name="titulo" id="titulo" class="form-control" 
                                               value="{% if selected_project %}Relat√≥rio - {{ selected_project.nome }}{% else %}Relat√≥rio de visita{% endif %}" required>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    {% if disable_fields %}
                                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                                        <div class="form-control-plaintext bg-light border rounded p-2">
                                            <strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>Projeto pr√©-selecionado - n√£o edit√°vel
                                        </small>
                                    {% else %}
                                        <select name="projeto_id" id="projeto_id" class="form-control" required onchange="carregarFuncionariosEmails()">
                                            <option value="">Selecione um projeto</option>
                                            {% for projeto in projetos %}
                                            <option value="{{ projeto.id }}" 
                                                    {% if selected_project and selected_project.id == projeto.id %}selected{% endif %}>
                                                {{ projeto.numero }} - {{ projeto.nome }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Sele√ß√£o de Funcion√°rios e E-mails -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-users me-2"></i>Funcion√°rios do Projeto
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="funcionarios-projeto">
                                            <p class="text-muted">Selecione um projeto para ver os funcion√°rios dispon√≠veis</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-envelope me-2"></i>E-mails para Envio
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="emails-projeto">
                                            <p class="text-muted">Selecione um projeto para ver os e-mails dispon√≠veis</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="aprovador_id">Aprovador do Relat√≥rio</label>
                                    <select name="aprovador_id" id="aprovador_id" class="form-control">
                                        <option value="">Selecione o aprovador</option>
                                        {% for admin in admin_users %}
                                        <option value="{{ admin.id }}" {% if selected_aprovador and admin.id == selected_aprovador.id %}selected{% endif %}>{{ admin.nome_completo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Funda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observa√ß√µes sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Veda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observa√ß√µes sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instala√ß√µes (El√©trica/Hidr√°ulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observa√ß√µes sobre instala√ß√µes..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observa√ß√µes sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organiza√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observa√ß√µes sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Observa√ß√µes Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observa√ß√µes Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4" 
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Captura de Localiza√ß√£o -->
                        <div class="mb-4">
                            <h5><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <button type="button" class="btn btn-outline-primary" onclick="capturarLocalizacao()">
                                        <i class="fas fa-crosshairs"></i> Capturar Localiza√ß√£o Atual
                                    </button>
                                    <div id="localizacao-info" class="mt-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Fotos Mobile-First -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (At√© 200 fotos) <span id="photoCount" class="badge bg-primary ms-2">0</span></h5>

                            <!-- Bot√µes Fixos de C√¢mera e Galeria (Mobile-First) -->
                            <div class="fixed-photo-buttons sticky-top bg-white p-3 mb-3 border rounded" style="z-index: 10;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-primary w-100 mobile-photo-btn" 
                                                id="mobileCameraBtn" onclick="mobileCaptureFromCamera()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-camera fa-lg mb-1"></i>
                                                <small>C√¢mera</small>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-success w-100 mobile-photo-btn" 
                                                id="mobileGalleryBtn" onclick="mobileSelectFromGallery()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-images fa-lg mb-1"></i>
                                                <small>Galeria</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="mobilePhotoInput" class="form-control" multiple accept="image/*" style="display: none;">
                                <input type="file" id="mobileCameraInput" class="form-control" accept="image/*" capture="environment" style="display: none;">
                                <div class="text-center mt-2">
                                    <small class="text-muted"><strong>M√°ximo 200 fotos - Limite total: 3GB</strong></small>
                                </div>
                            </div>

                            <!-- Sele√ß√£o de Categoria (Simplificada) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Categoria padr√£o para novas fotos:</label>
                                <select id="defaultCategory" class="form-select" style="min-height: 48px;">
                                    <option value="Torre 1">Torre 1</option>
                                    <option value="Torre 2">Torre 2</option>
                                    <option value="√Årea Comum">√Årea Comum</option>
                                    <option value="Piscina">Piscina</option>
                                </select>
                            </div>

                            <!-- Preview das Fotos com Cards Mobile-First -->
                            <div id="mobilePhotoCards" class="row g-3"></div>
                            
                            <!-- Fotos antigas (mantido para compatibilidade) -->
                            <div id="photoPreview" class="row" style="display: none;"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Relat√≥rio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Ret√¢ngulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> C√≠rculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>

                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>

                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>

                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edi√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let selectedCategory = '';
let selectedPhotos = [];
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');

    // Event listener para fun√ß√£o global
    document.addEventListener('selectCategory', function(e) {
        const { category, element } = e.detail;
        
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.photo-category').forEach(cat => {
            cat.classList.remove('selected');
        });
        
        // Adicionar sele√ß√£o atual
        element.classList.add('selected');
        
        // Atualizar categoria global
        selectedCategory = category;
        
        // Habilitar bot√µes de upload
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;
        
        // Atualizar input de fotos
        updatePhotoInput();
        
        console.log('üì∑ Categoria global selecionada:', category);
    });

    // Event listeners para upload de fotos com error handling
    const photoInput = document.getElementById('photoInput');
    const cameraInput = document.getElementById('cameraInput');

    if (photoInput) {
        photoInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Photo input element not found');
    }

    if (cameraInput) {
        cameraInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Camera input element not found');
    }

    // Event listeners para ferramentas - OTIMIZADO PARA MOBILE
    document.querySelectorAll('.tool-btn').forEach(btn => {
        // Usar touchstart para resposta mais r√°pida no mobile
        const isMobile = window.innerWidth <= 768;
        const eventType = isMobile ? 'touchstart' : 'click';

        btn.addEventListener(eventType, function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Feedback visual imediato
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);

            // Atualizar ferramentas
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;

            console.log('üîß Ferramenta selecionada:', currentTool);
        });

        // Prevenir eventos duplicados no mobile
        if (isMobile) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });

    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

// Fun√ß√£o para carregar funcion√°rios e e-mails do projeto selecionado
function carregarFuncionariosEmails() {
    const projetoId = document.getElementById('projeto_id').value;
    carregarFuncionariosEmailsPorId(projetoId);
}

function carregarFuncionariosEmailsPorId(projetoId) {
    const funcionariosDiv = document.getElementById('funcionarios-projeto');
    const emailsDiv = document.getElementById('emails-projeto');

    if (!projetoId) {
        funcionariosDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os funcion√°rios dispon√≠veis</p>';
        emailsDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os e-mails dispon√≠veis</p>';
        return;
    }

    // Buscar funcion√°rios e e-mails do projeto via AJAX
    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Renderizar funcion√°rios
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                data.funcionarios.forEach(func => {
                    const checked = func.is_responsavel_principal ? 'checked' : '';
                    funcionariosHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="func_${func.id}" 
                                   name="funcionarios_selecionados[]" value="${func.id}" ${checked}>
                            <label class="form-check-label" for="func_${func.id}">
                                <strong>${func.nome_funcionario}</strong><br>
                                <small class="text-muted">${func.cargo || 'Sem cargo'} - ${func.empresa || 'Sem empresa'}</small>
                                ${func.is_responsavel_principal ? '<span class="badge bg-primary">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                funcionariosHtml = '<p class="text-muted">Nenhum funcion√°rio encontrado para este projeto</p>';
            }
            funcionariosDiv.innerHTML = funcionariosHtml;

            // Renderizar e-mails
            let emailsHtml = '';
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    const checked = email.is_principal ? 'checked' : '';
                    emailsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_${email.id}" 
                                   name="emails_selecionados[]" value="${email.id}" ${checked}>
                            <label class="form-check-label" for="email_${email.id}">
                                <strong>${email.email}</strong><br>
                                <small class="text-muted">${email.nome_contato} - ${email.cargo || 'Sem cargo'}</small>
                                ${email.is_principal ? '<span class="badge bg-success">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                emailsHtml = '<p class="text-muted">Nenhum e-mail encontrado para este projeto</p>';
            }
            emailsDiv.innerHTML = emailsHtml;
        } else {
            funcionariosDiv.innerHTML = '<p class="text-danger">Erro ao carregar funcion√°rios</p>';
            emailsDiv.innerHTML = '<p class="text-danger">Erro ao carregar e-mails</p>';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        funcionariosDiv.innerHTML = '<p class="text-danger">Erro de conex√£o</p>';
        emailsDiv.innerHTML = '<p class="text-danger">Erro de conex√£o</p>';
    });
}

function handlePhotoUpload(event) {
    console.log('üì∑ Upload de fotos iniciado');
    console.log('Categoria selecionada:', selectedCategory);

    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        event.target.value = '';
        return;
    }

    const files = event.target.files;
    console.log('Arquivos selecionados:', files.length);

    if (files.length + selectedPhotos.length > 200) {
        alert('M√°ximo de 200 fotos permitido.');
        return;
    }

    // Processar cada arquivo
    for (let file of files) {
        if (selectedPhotos.length >= 200) {
            console.log('‚ö†Ô∏è Limite de 200 fotos atingido');
            break;
        }
        console.log('Processando arquivo:', file.name);
        addPhotoPreview(file, selectedCategory);
    }

    event.target.value = ''; // Reset input
    console.log('‚úÖ Upload conclu√≠do. Total de fotos:', selectedPhotos.length);
}

// Camera and gallery functions with error handling
function selectFromGallery() {
    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        return;
    }
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    } else {
        console.warn('Photo input element not found');
    }
}

function captureFromCamera() {
    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        return;
    }
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
        cameraInput.click();
    } else {
        console.warn('Camera input element not found');
    }
}

// Remove duplicate updatePhotoInput function (already exists below)

function addPhotoPreview(file, category) {
    console.log('üñºÔ∏è Adicionando preview da foto:', file.name, 'Categoria:', category);

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;

        console.log('‚ú® Criando elemento da foto com ID:', photoId);

        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.setAttribute('data-photo-id', photoId);
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" data-category="${category}">
                <div class="card-body p-2">
                    <!-- Seletor de Legendas -->
                    <select class="form-control form-control-sm mb-2" id="predefined_${photoId}" name="photo_caption_${photoId}" required>
                        <option value="">Selecione uma legenda...</option>
                    </select>
                    <small class="text-muted d-block">Categoria: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openPhotoEditor('${photoId}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('photoPreview').appendChild(photoDiv);

        selectedPhotos.push({
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src
        });

        console.log('‚úÖ Foto adicionada ao array. Total:', selectedPhotos.length);

        loadPredefinedCaptionsForPhoto(photoId, category);
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    }
}

function loadPredefinedCaptionsForPhoto(photoId, category) {
    const select = document.getElementById(`predefined_${photoId}`);
    if (!select) return;

    select.innerHTML = '<option value="">Carregando legendas...</option>';

    // Carregar direto da API (PostgreSQL)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/legendas?categoria=all', true);
    xhr.timeout = 10000;

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.legendas && data.legendas.length > 0) {
                    select.innerHTML = '<option value="">Selecione uma legenda...</option>';

                    const cats = {
                        'Acabamentos': [],
                        'Estrutural': [],
                        'Geral': [],
                        'Seguran√ßa': []
                    };

                    data.legendas.forEach(leg => {
                        if (cats[leg.categoria]) {
                            cats[leg.categoria].push(leg);
                        }
                    });

                    Object.keys(cats).forEach(cat => {
                        if (cats[cat].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = cat + ' (' + cats[cat].length + ' itens)';

                            cats[cat].forEach(legenda => {
                                const option = document.createElement('option');
                                option.value = legenda.texto;
                                option.textContent = legenda.texto;
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">Erro: nenhuma legenda encontrada</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="">Erro: formato inv√°lido</option>';
            }
        } else {
            select.innerHTML = '<option value="">Erro: servidor indispon√≠vel</option>';
        }
    };

    xhr.onerror = function() {
        select.innerHTML = '<option value="">Erro: falha de rede</option>';
    };

    xhr.ontimeout = function() {
        select.innerHTML = '<option value="">Erro: tempo esgotado</option>';
    };

    xhr.send();
}

// Mapear categoria da foto para categoria da legenda
function mapCategoryToLegenda(photoCategory) {
    const mapping = {
        'Geral': 'Geral',
        'Estrutura': 'Estrutural', 
        'Acabamento': 'Acabamentos',
        'Instala√ß√µes': 'El√©trica',
        'Problema': 'Seguran√ßa'
    };
    return mapping[photoCategory] || 'Geral';
}

function updatePhotoInput() {
    const input = document.getElementById('photoInput');
    console.log('üîÑ Atualizando input de fotos. Categoria:', selectedCategory);

    if (selectedCategory) {
        input.disabled = false;
        input.style.opacity = '1';
        input.style.pointerEvents = 'auto';

        // Enable camera and gallery buttons with null checks
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;

        console.log('‚úÖ Input de fotos e bot√µes habilitados');
    } else {
        input.disabled = true;

        // Disable camera and gallery buttons with null checks
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = true;
        if (cameraBtn) cameraBtn.disabled = true;
        input.style.opacity = '0.5';
        input.style.pointerEvents = 'none';
        console.log('‚ö†Ô∏è Input de fotos desabilitado');
    }
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();

    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;" 
                   name="custom_item_${itemId}" placeholder="Digite o item do checklist..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end" 
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observa√ß√µes..." rows="2"></textarea>
    `;

    checklistItems.appendChild(itemDiv);
}

// Marcar checklist como conclu√≠do
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    }
});

// Sistema Fabric.js Photo Editor - Exatamente como no Express
function openPhotoEditor(photoId) {
    try {
        console.log(`üé® Abrindo editor para foto: ${photoId}`);

        const card = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (!card) {
            console.error(`‚ùå Card n√£o encontrado para foto: ${photoId}`);
            return;
        }

        const img = card.querySelector('img');
        if (!img || !img.src) {
            console.error(`‚ùå Imagem n√£o encontrada para foto: ${photoId}`);
            return;
        }

        // Callback para salvar a foto editada (definir primeiro)
        const saveCallback = async (data) => {
            console.log('üíæ Salvando foto editada:', data.photoId);

            // Atualizar preview da foto no card
            img.src = data.imageData;
            img.dataset.edited = 'true';
            img.dataset.legend = data.legend;

            // Marcar visualmente como editada
            card.classList.add('edited');

            // Adicionar badge de editado se n√£o existir
            if (!card.querySelector('.edited-badge')) {
                const badge = document.createElement('div');
                badge.className = 'edited-badge';
                badge.innerHTML = '<i class="fas fa-edit"></i> Editado';
                card.appendChild(badge);
            }

            console.log('‚úÖ Foto salva com sucesso');
        };

        // Verificar se o editor modal est√° dispon√≠vel  
        if (!window.fabricPhotoEditorModal) {
            console.error('‚ùå Editor modal n√£o inicializado');

            // Verificar se as depend√™ncias est√£o carregadas
            if (typeof fabric === 'undefined') {
                alert('Fabric.js n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            if (typeof bootstrap === 'undefined') {
                alert('Bootstrap n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            if (typeof FabricPhotoEditor === 'undefined') {
                alert('Editor de fotos n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            // Tentar inicializar o editor modal
            if (typeof initFabricPhotoEditorModal === 'function') {
                console.log('üîÑ Tentando inicializar editor modal...');
                initFabricPhotoEditorModal();

                // Aguardar um momento para o editor ser inicializado
                setTimeout(() => {
                    if (window.fabricPhotoEditorModal) {
                        console.log('‚úÖ Editor inicializado com sucesso');
                        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
                    } else {
                        console.error('‚ùå Falha ao inicializar editor ap√≥s tentativa');
                        alert('Editor de fotos n√£o pode ser carregado. Recarregue a p√°gina.');
                    }
                }, 500);
                return;
            }
        }

        // Editor dispon√≠vel, abrir diretamente
        console.log('‚úÖ Abrindo editor');
        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);

    } catch (error) {
        console.error('‚ùå Erro ao abrir editor:', error);
        alert('Erro ao abrir editor de fotos. Tente novamente.');
    }
}

// Fun√ß√£o para auto-scroll centralizado
function scrollToEditorCenter() {
    console.log('üé® Executando auto-scroll para centro do editor');

    const modal = document.getElementById('fabricPhotoEditorModal');
    if (!modal) {
        console.log('‚ö†Ô∏è Modal n√£o encontrado');
        return;
    }

    const canvasContainer = modal.querySelector('.canvas-container');
    if (!canvasContainer) {
        console.log('‚ö†Ô∏è Canvas container n√£o encontrado');
        return;
    }

    try {
        // Scroll suave para o centro do canvas
        canvasContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });

        // Centralizar o scroll na janela tamb√©m
        window.scrollTo({
            top: window.innerHeight / 4,
            behavior: 'smooth'
        });

        console.log('‚úÖ Auto-scroll executado com sucesso');
    } catch (error) {
        console.error('‚ùå Erro no auto-scroll:', error);
    }
}

// Nova fun√ß√£o para atualizar foto do Fabric Editor
function updatePhotoFromFabricEditor(photoId, editedImageData) {
    console.log('üíæ Atualizando foto editada:', photoId);

    // Buscar elemento da foto diretamente pelo ID
    const photoElement = document.getElementById(photoId);
    if (!photoElement) {
        console.error('‚ùå Elemento da foto n√£o encontrado:', photoId);
        return;
    }

    // Atualizar imagem no preview
    const img = photoElement.querySelector('.photo-preview');
    if (img && editedImageData.imageData) {
        img.src = editedImageData.imageData;
        console.log('‚úÖ Imagem do preview atualizada');

        // Tamb√©m atualizar onclick para manter funcionalidade
        img.setAttribute('onclick', `editPhoto('${photoId}', '${editedImageData.imageData}', '${img.getAttribute('data-category') || 'Geral'}')`);
    }

    // Atualizar tamb√©m em selectedPhotos se existir
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.annotatedSrc = editedImageData.imageData;
        console.log('‚úÖ Dados da foto atualizados em selectedPhotos');
    }

    // Adicionar indicador visual de foto editada
    const card = photoElement.querySelector('.card');
    if (card && !card.classList.contains('border-success')) {
        card.classList.add('border-success', 'border-2');

        // Remover indicador anterior se existir
        const oldIndicator = card.querySelector('.edit-indicator');
        if (oldIndicator) oldIndicator.remove();

        const indicator = document.createElement('small');
        indicator.className = 'text-success fw-bold edit-indicator d-block mt-1';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Editada';
        photoElement.querySelector('.card-body').appendChild(indicator);
        console.log('‚úÖ Indicador visual adicionado');
    }

    console.log('‚úÖ Foto atualizada com sucesso');
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;

    if (currentTool === 'text') {
        const text = prompt('Digite o texto:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }

    // Para caneta, come√ßar o path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';

    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;

    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }

    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;

        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version

        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        editButton.innerHTML = '<i class="fas fa-check"></i> Editada';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Fun√ß√£o para criar relat√≥rio inicial em preenchimento
async function createInitialReport() {
    const formData = new FormData(document.getElementById('reportForm'));
    
    try {
        const response = await fetch('{{ url_for("create_report") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.report_id) {
            console.log('‚úÖ Relat√≥rio inicial criado:', result.report_id);
            return result.report_id;
        } else {
            throw new Error(result.error || 'Erro ao criar relat√≥rio');
        }
    } catch (error) {
        console.error('‚ùå Erro ao criar relat√≥rio inicial:', error);
        throw error;
    }
}

// Submiss√£o do formul√°rio
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission

    // Se h√° um reportId global, finalizar o relat√≥rio
    if (window.currentReportId) {
        fetch(`/reports/${window.currentReportId}/finalize`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Relat√≥rio finalizado com sucesso!');
                window.location.href = data.redirect;
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            console.error('Erro ao finalizar:', error);
            alert('Erro ao finalizar relat√≥rio: ' + error.message);
        });
        
        return;
    }

    // Create FormData object for proper file handling
    const formData = new FormData(this);

    // Coletar dados do checklist
    const checklistData = [];
    document.querySelectorAll('.checklist-item').forEach(item => {
        const checkbox = item.querySelector('.form-check-input[type="checkbox"]');
        const label = item.querySelector('.form-check-label');
        const customInput = item.querySelector('input[type="text"]');
        const textarea = item.querySelector('textarea');

        if (checkbox) {
            const itemText = label ? label.textContent.trim() : (customInput ? customInput.value : '');
            if (itemText) {
                checklistData.push({
                    item: itemText,
                    completed: checkbox.checked,
                    observations: textarea ? textarea.value : ''
                });
            }
        }
    });

    // Add checklist data
    formData.append('checklist_data', JSON.stringify(checklistData));

    // Add photo files and metadata
    selectedPhotos.forEach((photo, index) => {
        // Add the actual file
        formData.append(`photo_${index}`, photo.file);

        // Add photo metadata
        formData.append(`photo_category_${index}`, photo.category);

        const caption = document.querySelector(`select[name="photo_caption_${photo.id}"]`);
        if (caption && caption.value) {
            formData.append(`photo_caption_${index}`, caption.value);
        }

        // Add edited photo data if exists
        if (photo.editedSrc) {
            formData.append(`edited_photo_${index}`, photo.editedSrc);
        }
    });

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitBtn.disabled = true;

    // Submit via fetch
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => Promise.reject(err));
        }
    })
    .then(data => {
        if (data.success) {
            alert('Relat√≥rio salvo com sucesso!');
            window.location.href = data.redirect || '/reports';
        } else {
            throw new Error(data.error || 'Erro ao salvar relat√≥rio');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar relat√≥rio. Tente novamente.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Fun√ß√£o para capturar localiza√ß√£o
function capturarLocalizacao() {
    const infoDiv = document.getElementById('localizacao-info');

    if (!navigator.geolocation) {
        infoDiv.innerHTML = '<div class="alert alert-danger">Geolocaliza√ß√£o n√£o √© suportada pelo navegador.</div>';
        return;
    }

    infoDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Capturando localiza√ß√£o...</div>';

    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Localiza√ß√£o capturada com sucesso!<br>
                    <small id="addressDisplay">Obtendo endere√ßo... (precis√£o: ${Math.round(accuracy)}m)</small>
                </div>
            `;

            // Obter endere√ßo formatado via API
            fetch('/get_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.endereco) {
                    document.getElementById('addressDisplay').innerHTML = `<strong>üìç ${data.endereco}</strong> (precis√£o: ${Math.round(accuracy)}m)`;
                } else {
                    document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precis√£o: ${Math.round(accuracy)}m)`;
                }
            })
            .catch(error => {
                console.error('Erro ao obter endere√ßo:', error);
                document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precis√£o: ${Math.round(accuracy)}m)`;
            });
        },
        function(error) {
            let errorMsg = 'Erro ao capturar localiza√ß√£o.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permiss√£o negada para acessar localiza√ß√£o.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Localiza√ß√£o indispon√≠vel.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tempo limite para capturar localiza√ß√£o.';
                    break;
            }
            infoDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</div>`;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}

// FUN√á√ÉO DUPLICADA REMOVIDA - usar apenas a vers√£o otimizada para mobile

// FUN√á√ÉO DUPLICADA REMOVIDA - usar apenas a vers√£o do in√≠cio do arquivo

// Fun√ß√£o para alternar checkbox e mostrar/ocultar campo de observa√ß√µes
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsField = document.getElementById(`obs_${itemId}`);
    const parentItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        if (obsField) {
            obsField.style.display = 'block';
        }
        if (parentItem) {
            parentItem.classList.add('completed');
        }
    } else {
        if (obsField) {
            obsField.style.display = 'none';
        }
        if (parentItem) {
            parentItem.classList.remove('completed');
        }
    }
}

// Fun√ß√£o para alternar estado do checklist item
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsSection = document.getElementById(`obs_${itemId}`);
    const checklistItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        // Marcar como completo
        checklistItem.classList.add('completed');
        // Mostrar campo de observa√ß√µes
        if (obsSection) {
            obsSection.style.display = 'block';
        }
    } else {
        // Desmarcar como completo
        checklistItem.classList.remove('completed');
        // Ocultar campo de observa√ß√µes
        if (obsSection) {
            obsSection.style.display = 'none';
            // Limpar observa√ß√µes se desejar
            const textarea = obsSection.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }
}

// Carregar checklist padr√£o do sistema
function carregarChecklistPadrao() {
    fetch('/api/checklist-padrao')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.checklist.length > 0) {
                const container = document.getElementById('checklistItems');
                container.innerHTML = ''; // Limpar conte√∫do atual

                data.checklist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item mb-3';
                    itemDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="check_${item.id}" onchange="toggleChecklistItem(this)">
                                <label class="form-check-label" for="check_${item.id}">
                                    ${item.texto}
                                </label>
                            </div>
                        </div>
                        <div class="mt-2" style="display: none;" id="obs_${item.id}">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="Observa√ß√µes (opcional)..." name="obs_${item.id}"></textarea>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                console.log(`${data.checklist.length} itens do checklist padr√£o carregados`);
            } else {
                const container = document.getElementById('checklistItems');
                container.innerHTML = '<p class="text-muted">Nenhum item no checklist padr√£o. <a href="/admin/checklist-padrao">Configurar checklist</a></p>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar checklist padr√£o:', error);
            const container = document.getElementById('checklistItems');
            container.innerHTML = '<p class="text-danger">Erro ao carregar checklist. <a href="#" onclick="carregarChecklistPadrao()">Tentar novamente</a></p>';
        });
}

// Inicializar sistema ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Carregar checklist padr√£o automaticamente
    carregarChecklistPadrao();

    // Auto-carregar dados do projeto se pre-selecionado
    {% if disable_fields and preselected_project_id %}
    // Para projeto pr√©-selecionado com campos desabilitados
    console.log('üèóÔ∏è Projeto pr√©-selecionado detectado (campos desabilitados):', {{ preselected_project_id }});
    carregarFuncionariosEmailsPorId({{ preselected_project_id }});
    {% else %}
    // Para projeto selecionado normalmente
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        console.log('üèóÔ∏è Projeto pr√©-selecionado detectado:', projetoSelect.value);
        carregarFuncionariosEmails();
    }
    {% endif %}

    // Inicializar editor modal Fabric.js - exatamente como no Express
    if (typeof initFabricPhotoEditorModal === 'function') {
        initFabricPhotoEditorModal();
        console.log('‚úÖ Editor modal inicializado');
    } else {
        console.error('‚ùå Editor modal n√£o dispon√≠vel');
    }
    
    // Criar relat√≥rio inicial e ativar auto save ap√≥s preencher dados b√°sicos
    let autoSaveInitialized = false;
    
    // Fun√ß√£o para inicializar auto save quando houver dados suficientes
    function tryInitializeAutoSave() {
        if (autoSaveInitialized) return;
        
        const titulo = document.getElementById('titulo').value;
        const projetoId = document.getElementById('projeto_id').value;
        
        if (titulo && projetoId) {
            console.log('üìù Dados b√°sicos preenchidos, criando relat√≥rio inicial...');
            
            // Criar relat√≥rio inicial
            createInitialReport().then(reportId => {
                window.currentReportId = reportId;
                
                // Inicializar auto save
                if (typeof initAutoSave === 'function') {
                    window.autoSaveInstance = initAutoSave(reportId, {
                        interval: 10000, // 10 segundos
                        statusElement: document.getElementById('autosave-status'),
                        form: document.getElementById('reportForm')
                    });
                    
                    autoSaveInitialized = true;
                    console.log('‚úÖ Auto save ativado para relat√≥rio', reportId);
                } else {
                    console.error('‚ùå Fun√ß√£o initAutoSave n√£o encontrada');
                }
            }).catch(error => {
                console.error('‚ùå Erro ao criar relat√≥rio inicial:', error);
            });
        }
    }
    
    // Observar mudan√ßas nos campos b√°sicos
    const tituloField = document.getElementById('titulo');
    const projetoField = document.getElementById('projeto_id');
    
    if (tituloField) {
        tituloField.addEventListener('blur', tryInitializeAutoSave);
    }
    
    if (projetoField) {
        projetoField.addEventListener('change', tryInitializeAutoSave);
    }
});

</script>

<!-- Fabric.js CDN - Exatamente como no Express -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Editor Scripts - Exatamente como no Express -->
<script src="{{ url_for('static', filename='js/fabric-photo-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/fabric-photo-editor-modal.js') }}"></script>

<!-- Modal do Editor de Fotos Professional - Exatamente como no Express -->
<div class="modal fade" id="fabricPhotoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editor de Fotos Professional
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-0" style="height: calc(100vh - 160px);">
                <div class="fabric-editor-container" style="height: 100%;">
                    <!-- √Årea principal do editor -->
                    <div class="fabric-editor-main" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Container do canvas -->
                        <div class="canvas-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa;">
                            <div class="canvas-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); overflow: hidden;">
                                <canvas id="fabricModalCanvas"></canvas>
                            </div>
                        </div>

                        <!-- Toolbar de ferramentas -->
                        <div class="fabric-toolbar" style="background: white; border-top: 1px solid #e1e5e9; padding: 16px;">
                            <!-- Ferramentas principais -->
                            <div class="tool-group mb-3">
                                <h6 class="text-muted mb-2">Ferramentas</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="fabric-tool-btn active" data-modal-tool="select" title="Sele√ß√£o">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="brush" title="Pincel">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="arrow" title="Seta">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="circle" title="C√≠rculo">
                                        <i class="far fa-circle"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="rectangle" title="Ret√¢ngulo">
                                        <i class="far fa-square"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="text" title="Texto">
                                        <i class="fas fa-font"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Propriedades -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Cor:</label>
                                    <input type="color" id="modal-color-picker" class="form-control form-control-color" value="#FF0000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Espessura:</label>
                                    <input type="range" id="modal-stroke-width" class="form-range" min="1" max="20" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Legenda:</label>
                                    <input type="text" id="modal-custom-legend" class="form-control" placeholder="Digite uma legenda...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="window.fabricPhotoEditorModal?.clear()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
                <button type="button" class="btn btn-warning" onclick="window.fabricPhotoEditorModal?.undo()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn btn-success" id="modal-save-btn">
                    <i class="fas fa-check"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos do modal do editor - Exatamente como no Express */
.fabric-tool-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 8px;
    color: #4b5563;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fabric-tool-btn:hover {
    background: #e5e7eb;
}

.fabric-tool-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
}

/* Indicador visual de foto editada */
.photo-container.edited {
    position: relative;
}

.edited-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    z-index: 10;
}

.edit-photo-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    border: none;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.edit-photo-btn:hover {
    background: #3b82f6;
    transform: scale(1.1);
}

/* Responsivo mobile */
@media (max-width: 768px) {
    .fabric-toolbar {
        max-height: 40vh;
        overflow-y: auto;
    }

    .fabric-tool-btn {
        min-width: 40px;
        min-height: 40px;
    }

    /* MOBILE: Otimiza√ß√µes espec√≠ficas para legendas pr√©-definidas */
    select[name^="photo_caption_"], 
    select[id^="predefined_"] {
        font-size: 16px !important;
        min-height: 48px !important;
        padding: 12px !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        background: white !important;
        display: block !important;
        width: 100% !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
        appearance: menulist !important;
    }

    /* Grupos de op√ß√µes vis√≠veis */
    optgroup {
        font-weight: bold !important;
        color: #007bff !important;
        font-size: 15px !important;
        padding: 4px !important;
    }

    option {
        font-size: 14px !important;
        padding: 8px !important;
        color: #333 !important;
        background: white !important;
    }

    /* Cards de fotos otimizados */
    .card-body.p-2 {
        padding: 16px !important;
    }

    /* Texto de categoria mais vis√≠vel */
    .text-muted {
        font-size: 14px !important;
        color: #555 !important;
        font-weight: 600 !important;
    }
}
</style>

<!-- Auto-populate project coordinates script -->
<script>
// Auto-populate project coordinates and location info when coming from project view
{% if selected_project %}
document.addEventListener('DOMContentLoaded', function() {
    // Ensure required elements exist
    const latitudeEl = document.getElementById('latitude');
    const longitudeEl = document.getElementById('longitude');
    const localizacaoInfo = document.getElementById('localizacao-info');

    if (!latitudeEl || !longitudeEl || !localizacaoInfo) {
        console.warn('Required form elements not found for auto-population');
        return;
    }

    {% if selected_project.latitude and selected_project.longitude %}
    // Auto-populate coordinates if available from project (using tojson for safety)
    latitudeEl.value = {{ selected_project.latitude | tojson }};
    longitudeEl.value = {{ selected_project.longitude | tojson }};

    // Display project location info (escaped properly)
    const endereco = {{ selected_project.endereco | tojson or "'Coordenadas do projeto'" }};
    localizacaoInfo.innerHTML = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Localiza√ß√£o do projeto pr√©-carregada!<br>
            <strong>üìç ${endereco}</strong>
            <br><small class="text-muted">Voc√™ pode capturar nova localiza√ß√£o se necess√°rio</small>
        </div>
    `;
    {% else %}
    // Show message that project has no coordinates
    localizacaoInfo.innerHTML = `
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> Este projeto n√£o possui coordenadas cadastradas.<br>
            <small>Use o bot√£o "Capturar Localiza√ß√£o Atual" para definir a localiza√ß√£o da visita.</small>
        </div>
    `;
    {% endif %}
});
{% endif %}

// Sistema de touch inteligente IGUAL AO EXPRESS - funcional 100%
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Sistema de touch inteligente carregado (igual express)');
    
    // Configura√ß√µes EXATAS do Express
    const TOUCH_THRESHOLD = 10; // pixels
    const TOUCH_TIME_LIMIT = 500; // ms
    
    let touchData = {
        startX: 0,
        startY: 0,
        startTime: 0,
        isDragging: false,
        element: null
    };
    
    // Fun√ß√£o para sele√ß√£o de categoria ID√äNTICA ao Express
    function selectPhotoCategory(category, element) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.photo-category').forEach(cat => {
            cat.classList.remove('selected');
        });
        
        // Adicionar sele√ß√£o atual
        element.classList.add('selected');
        
        // Feedback t√°til
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        console.log('üì∑ Categoria selecionada:', category);
        
        // Atualizar categoria global
        selectedCategory = category;
        
        // Habilitar bot√µes de upload
        const galleryBtn = document.getElementById('galleryBtn');
        const cameraBtn = document.getElementById('cameraBtn');
        if (galleryBtn) galleryBtn.disabled = false;
        if (cameraBtn) cameraBtn.disabled = false;
        
        // Atualizar input de fotos
        updatePhotoInput();
    }
    
    // Event listeners para categorias - C√ìDIGO EXATO DO EXPRESS
    document.querySelectorAll('.photo-category').forEach(categoryElement => {
        
        // Touch Start
        categoryElement.addEventListener('touchstart', function(e) {
            console.log('üëÜ TouchStart categoria');
            
            const touch = e.touches[0];
            touchData.startX = touch.clientX;
            touchData.startY = touch.clientY;
            touchData.startTime = Date.now();
            touchData.isDragging = false;
            touchData.element = categoryElement;
            
            // Feedback visual imediato
            categoryElement.classList.add('touching');
        }, { passive: true });
        
        // Touch Move
        categoryElement.addEventListener('touchmove', function(e) {
            if (!touchData.element) return;
            
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchData.startX);
            const deltaY = Math.abs(touch.clientY - touchData.startY);
            const totalDelta = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            // Se movimento exceder threshold, marcar como drag
            if (totalDelta > TOUCH_THRESHOLD) {
                touchData.isDragging = true;
                categoryElement.classList.remove('touching');
                console.log('üîÑ Movimento detectado - modo drag ativado');
            }
        }, { passive: true });
        
        // Touch End
        categoryElement.addEventListener('touchend', function(e) {
            console.log('üëÜ TouchEnd categoria');
            
            // Remover feedback visual
            categoryElement.classList.remove('touching');
            
            if (!touchData.element) return;
            
            const touchDuration = Date.now() - touchData.startTime;
            
            // Apenas selecionar se foi um tap r√°pido e sem movimento
            if (!touchData.isDragging && touchDuration < TOUCH_TIME_LIMIT) {
                e.preventDefault();
                e.stopPropagation();
                
                const category = categoryElement.getAttribute('data-category');
                selectPhotoCategory(category, categoryElement);
                
                console.log('‚úÖ Tap v√°lido - categoria selecionada');
            } else {
                console.log('‚ùå Drag detectado - n√£o selecionar categoria');
            }
            
            // Reset
            touchData.element = null;
            touchData.isDragging = false;
        }, { passive: false });
        
        // Mouse events para desktop (fallback)
        categoryElement.addEventListener('click', function(e) {
            // Apenas processar se n√£o houve toque recente
            if (touchData.startTime && (Date.now() - touchData.startTime) < 300) {
                return; // Ignorar click ap√≥s touch
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const category = categoryElement.getAttribute('data-category');
            selectPhotoCategory(category, categoryElement);
            
            console.log('üñ±Ô∏è Click desktop - categoria selecionada');
        });
    });
    
    console.log('‚úÖ Sistema de touch inteligente ativo para', document.querySelectorAll('.photo-category').length, 'categorias');
});

// Fun√ß√£o global para compatibilidade - integrada com sistema de touch
window.selectPhotoCategory = function(category, element) {
    if (!element) {
        element = document.querySelector(`[data-category="${category}"]`);
    }

    if (element) {
        // Usar a fun√ß√£o interna que j√° tem toda a l√≥gica
        const selectEvent = new CustomEvent('selectCategory', { 
            detail: { category: category, element: element } 
        });
        document.dispatchEvent(selectEvent);
    }
};
</script>

<!-- Auto Save Script -->
<script src="{{ url_for('static', filename='js/autosave.js') }}"></script>
<script>
// Inicializar Auto Save apenas se estivermos editando um relat√≥rio existente
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se temos um ID de relat√≥rio para auto save
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('report_id') || document.querySelector('input[name="report_id"]')?.value;
    
    if (reportId) {
        // Inicializar auto save
        const autoSave = initAutoSave(reportId, {
            interval: 10000, // 10 segundos
            statusElement: document.getElementById('autosave-status'),
            form: document.getElementById('reportForm')
        });
        
        console.log('Auto Save ativado para relat√≥rio', reportId);
        
        // Modificar o comportamento do bot√£o de finalizar
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                // Parar auto save antes de finalizar
                autoSave.stop();
                
                // Salvar uma √∫ltima vez e depois prosseguir
                autoSave.saveNow().then(() => {
                    // Alterar status para finalizado
                    const statusBadge = document.querySelector('.badge.bg-warning');
                    if (statusBadge) {
                        statusBadge.innerHTML = '<i class="fas fa-check me-1"></i>Finalizando...';
                        statusBadge.classList.remove('bg-warning');
                        statusBadge.classList.add('bg-success');
                    }
                });
            });
        }
    }
});
</script>

<!-- Mobile-First Photo System JavaScript -->
<script>
// Global variables for mobile photo system
let mobilePhotoCounter = 0;
let predefinedLegendas = [];
let mobilePhotoData = [];

// Load predefined captions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPredefinedLegendas();
    setupMobilePhotoSystem();
});

// Load predefined captions from API
async function loadPredefinedLegendas() {
    try {
        console.log('üìã Carregando legendas predefinidas...');
        const response = await fetch('/api/legendas?categoria=all');
        const data = await response.json();
        
        if (data.success) {
            predefinedLegendas = data.legendas;
            console.log(`‚úÖ ${predefinedLegendas.length} legendas carregadas`);
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar legendas:', error);
    }
}

// Setup mobile photo system
function setupMobilePhotoSystem() {
    console.log('üì± Configurando sistema de fotos mobile-first...');
    
    // Setup file input event listeners
    const mobilePhotoInput = document.getElementById('mobilePhotoInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');
    
    if (mobilePhotoInput) {
        mobilePhotoInput.addEventListener('change', handleMobilePhotoSelection);
    }
    
    if (mobileCameraInput) {
        mobileCameraInput.addEventListener('change', handleMobilePhotoSelection);
    }
}

// Mobile gallery selection
function mobileSelectFromGallery() {
    console.log('üì∏ Selecionando da galeria (mobile)...');
    const input = document.getElementById('mobilePhotoInput');
    if (input) {
        input.click();
    }
}

// Mobile camera capture
function mobileCaptureFromCamera() {
    console.log('üì∑ Capturando da c√¢mera (mobile)...');
    const input = document.getElementById('mobileCameraInput');
    if (input) {
        input.click();
    }
}

// Handle photo selection from mobile inputs
function handleMobilePhotoSelection(event) {
    console.log('üìã Processando fotos selecionadas...');
    const files = event.target.files;
    const defaultCategory = document.getElementById('defaultCategory').value;
    
    if (files.length === 0) return;
    
    Array.from(files).forEach(file => {
        createMobilePhotoCard(file, defaultCategory);
    });
    
    // Clear input for next selection
    event.target.value = '';
    
    updatePhotoCounter();
}

// Create mobile photo card with immediate display
function createMobilePhotoCard(file, category) {
    const photoId = 'mobile_photo_' + (++mobilePhotoCounter);
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const photoCard = createPhotoCardHTML(photoId, e.target.result, category, file.name);
        
        // Add to DOM
        const container = document.getElementById('mobilePhotoCards');
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-lg-4';
        cardCol.innerHTML = photoCard;
        container.appendChild(cardCol);
        
        // Store photo data
        mobilePhotoData.push({
            id: photoId,
            file: file,
            category: category,
            manualCaption: '',
            predefinedCaption: '',
            filename: file.name
        });
        
        // Setup event listeners for this card
        setupPhotoCardEvents(photoId);
        
        console.log(`üì∑ Foto adicionada: ${file.name} (${category})`);
    };
    
    reader.readAsDataURL(file);
}

// Create photo card HTML
function createPhotoCardHTML(photoId, imageSrc, category, filename) {
    const legendaSelectHTML = createLegendaSelectHTML(photoId);
    
    return `
        <div class="mobile-photo-card" data-photo-id="${photoId}">
            <img src="${imageSrc}" alt="${filename}" class="photo-card-image">
            <div class="photo-card-content">
                <div class="category-badge">${category}</div>
                
                <!-- Legenda Manual -->
                <input type="text" 
                       class="caption-input" 
                       id="manual_caption_${photoId}" 
                       placeholder="Digite uma legenda personalizada..."
                       data-photo-id="${photoId}">
                
                <!-- Legenda Pr√©-definida -->
                <select class="caption-select" 
                        id="predefined_caption_${photoId}" 
                        data-photo-id="${photoId}">
                    <option value="">Selecione uma legenda pr√©-definida...</option>
                    ${legendaSelectHTML}
                </select>
                
                <!-- Status da Legenda -->
                <div class="caption-status pending" id="caption_status_${photoId}">
                    ‚ö†Ô∏è Legenda obrigat√≥ria - preencha pelo menos um campo
                </div>
                
                <!-- A√ß√µes -->
                <div class="photo-card-actions">
                    <button type="button" class="photo-card-btn edit" onclick="editMobilePhoto('${photoId}')">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button type="button" class="photo-card-btn delete" onclick="deleteMobilePhoto('${photoId}')">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Create legend select HTML
function createLegendaSelectHTML(photoId) {
    let html = '';
    
    // Group legends by category
    const legendsByCategory = {};
    predefinedLegendas.forEach(legenda => {
        if (!legendsByCategory[legenda.categoria]) {
            legendsByCategory[legenda.categoria] = [];
        }
        legendsByCategory[legenda.categoria].push(legenda);
    });
    
    // Create optgroups
    Object.keys(legendsByCategory).forEach(categoria => {
        html += `<optgroup label="${categoria}">`;
        legendsByCategory[categoria].forEach(legenda => {
            html += `<option value="${legenda.texto}">${legenda.texto}</option>`;
        });
        html += `</optgroup>`;
    });
    
    return html;
}

// Setup event listeners for photo card
function setupPhotoCardEvents(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    
    if (manualInput) {
        manualInput.addEventListener('input', () => saveCaptionData(photoId));
        manualInput.addEventListener('blur', () => saveCaptionData(photoId));
    }
    
    if (predefinedSelect) {
        predefinedSelect.addEventListener('change', function() {
            if (this.value) {
                // Copy predefined to manual field
                manualInput.value = this.value;
                saveCaptionData(photoId);
                
                // Reset select for next use
                setTimeout(() => {
                    this.selectedIndex = 0;
                }, 500);
            }
        });
    }
}

// Save caption data via AJAX
async function saveCaptionData(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const statusDiv = document.getElementById(`caption_status_${photoId}`);
    
    const manualCaption = manualInput.value.trim();
    const predefinedCaption = predefinedSelect.value.trim();
    
    // Update local data
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (photoData) {
        photoData.manualCaption = manualCaption;
        photoData.predefinedCaption = predefinedCaption;
    }
    
    // Update status
    const hasCaption = manualCaption || predefinedCaption;
    if (hasCaption) {
        statusDiv.className = 'caption-status complete';
        statusDiv.innerHTML = '‚úÖ Legenda definida';
    } else {
        statusDiv.className = 'caption-status pending';
        statusDiv.innerHTML = '‚ö†Ô∏è Legenda obrigat√≥ria - preencha pelo menos um campo';
    }
    
    console.log(`üíæ Caption saved for ${photoId}: "${manualCaption}"`);
}

// Edit mobile photo
function editMobilePhoto(photoId) {
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (!photoData) return;
    
    // Open photo editor (using existing fabric editor)
    const imageUrl = URL.createObjectURL(photoData.file);
    const editorUrl = `/photo-editor?photoId=${photoId}&imageUrl=${encodeURIComponent(imageUrl)}`;
    window.open(editorUrl, '_blank');
}

// Delete mobile photo
function deleteMobilePhoto(photoId) {
    if (!confirm('Deseja excluir esta foto?')) return;
    
    // Remove from data array
    mobilePhotoData = mobilePhotoData.filter(p => p.id !== photoId);
    
    // Remove from DOM
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (photoCard) {
        photoCard.closest('.col-12, .col-md-6, .col-lg-4').remove();
    }
    
    updatePhotoCounter();
    console.log(`üóëÔ∏è Foto ${photoId} exclu√≠da`);
}

// Update photo counter
function updatePhotoCounter() {
    const counter = document.getElementById('photoCount');
    if (counter) {
        counter.textContent = mobilePhotoData.length;
    }
}

// Validate captions before form submission
function validateCaptions() {
    let hasInvalidPhotos = false;
    
    mobilePhotoData.forEach(photoData => {
        const hasCaption = photoData.manualCaption || photoData.predefinedCaption;
        if (!hasCaption) {
            hasInvalidPhotos = true;
            
            // Highlight invalid photo
            const statusDiv = document.getElementById(`caption_status_${photoData.id}`);
            if (statusDiv) {
                statusDiv.className = 'caption-status pending';
                statusDiv.innerHTML = '‚ùå OBRIGAT√ìRIO: Adicione uma legenda';
                statusDiv.style.animation = 'pulse 2s infinite';
            }
        }
    });
    
    return !hasInvalidPhotos;
}

// Prepare form data for submission
function prepareMobilePhotoFormData() {
    // Create form data for mobile photos
    const formData = {
        photos: mobilePhotoData.map(photoData => ({
            id: photoData.id,
            filename: photoData.filename,
            category: photoData.category,
            caption: photoData.manualCaption || photoData.predefinedCaption,
            file: photoData.file
        }))
    };
    
    // Add hidden input with photo data
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'mobile_photos_data';
    hiddenInput.value = JSON.stringify(formData);
    
    const form = document.getElementById('reportForm');
    if (form) {
        form.appendChild(hiddenInput);
    }
    
    console.log(`üì§ Preparados ${mobilePhotoData.length} fotos para envio`);
}

// Form submission validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Validate captions
            if (!validateCaptions()) {
                e.preventDefault();
                alert('‚ö†Ô∏è ATEN√á√ÉO: Todas as fotos devem ter pelo menos uma legenda (manual ou pr√©-definida). Verifique as fotos marcadas em vermelho.');
                
                // Scroll to first invalid photo
                const firstInvalid = document.querySelector('.caption-status.pending');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
            }
            
            // Prepare mobile photo data
            prepareMobilePhotoFormData();
            
            console.log('‚úÖ Formul√°rio validado - enviando...');
        });
    }
});

console.log('üì± Sistema de fotos mobile-first carregado');
</script>

{% endblock %}