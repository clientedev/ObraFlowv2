{% extends "base.html" %}

{% block title %}Relatório de Obra{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}

/* Mobile Touch Isolation - Evita conflitos com gestos nativos */
@media (max-width: 768px) {
    /* Isolar touch das divs principais de conteúdo */
    .card-body,
    .form-group,
    .checklist-item,
    .row.mb-4,
    .mb-3,
    .mb-4 {
        touch-action: manipulation; /* Permite apenas pan e zoom */
        -webkit-touch-callout: none; /* Desabilita callout no iOS */
        -webkit-user-select: none; /* Desabilita seleção de texto */
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    /* Permitir interação normal apenas em inputs específicos */
    input[type="text"],
    input[type="date"], 
    input[type="file"],
    textarea,
    select,
    .form-control {
        touch-action: auto;
        -webkit-user-select: auto;
        -moz-user-select: auto;
        -ms-user-select: auto;
        user-select: auto;
        -webkit-touch-callout: default;
    }
    
    /* Isolar categorias de fotos especificamente */
    .photo-category {
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        /* Área de toque mínima */
        min-height: 44px;
        min-width: 44px;
    }
    
    /* Evitar conflitos com scroll em containers */
    .container-fluid,
    .row {
        touch-action: pan-y; /* Apenas scroll vertical */
    }
    
    /* Preview de fotos - permitir apenas tap */
    .photo-preview {
        touch-action: manipulation;
    }
    
    /* OTIMIZAÇÃO EXTREMA PARA BOTÕES DE FERRAMENTAS MOBILE */
    .tool-btn,
    .fabric-tool-btn {
        min-height: 50px !important;
        min-width: 50px !important;
        padding: 12px !important;
        margin: 2px !important;
        font-size: 16px !important;
        border-radius: 8px !important;
        touch-action: manipulation !important;
        -webkit-tap-highlight-color: rgba(0,123,255,0.3) !important;
        -webkit-touch-callout: none !important;
        position: relative !important;
        z-index: 10 !important;
    }
    
    /* Estado ativo mais visível */
    .tool-btn.active,
    .fabric-tool-btn.active {
        background-color: #007bff !important;
        color: white !important;
        border-color: #007bff !important;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25) !important;
    }
    
    /* Hover/focus para mobile */
    .tool-btn:active,
    .fabric-tool-btn:active {
        background-color: #0056b3 !important;
        transform: scale(0.95) !important;
        transition: transform 0.1s ease !important;
    }
    
    /* Container das ferramentas otimizado */
    .btn-group-vertical,
    .tool-group,
    .d-flex.gap-2 {
        gap: 4px !important;
    }
    
    /* Área expandida de toque */
    .tool-btn::before,
    .fabric-tool-btn::before {
        content: '';
        position: absolute;
        top: -5px;
        left: -5px;
        right: -5px;
        bottom: -5px;
        z-index: -1;
    }
}

/* Estilos para auto-preenchimento de projeto - Mobile-First */
.mobile-project-info {
    border-left: 4px solid #17a2b8;
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(23, 162, 184, 0.1);
}

.project-auto-info p {
    margin-bottom: 0.25rem;
}

.project-auto-info strong {
    color: #0c5460;
    font-size: 1.05rem;
}

/* Responsividade mobile para info do projeto */
@media (max-width: 768px) {
    .mobile-project-info {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .mobile-project-info h6 {
        font-size: 1rem;
    }
    
    .mobile-project-info .fa-2x {
        font-size: 1.5rem;
    }
    
    .project-auto-info strong {
        font-size: 0.95rem;
    }
    
    .project-auto-info small {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-file-alt"></i> Relatório de Obra</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_report') }}" enctype="multipart/form-data" id="reportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <!-- Auto-preenchimento do Projeto (se selecionado) -->
                        {% if selected_project %}
                        <div class="alert alert-info mobile-project-info" role="alert">
                            <div class="row align-items-center">
                                <div class="col-md-1 col-2 text-center">
                                    <i class="fas fa-info-circle fa-2x"></i>
                                </div>
                                <div class="col-md-11 col-10">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="fas fa-building me-2"></i>Projeto Pré-selecionado
                                    </h6>
                                    <div class="project-auto-info">
                                        <p class="mb-1"><strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong></p>
                                        {% if selected_project.endereco %}
                                        <p class="mb-1"><small class="text-muted">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ selected_project.endereco }}
                                        </small></p>
                                        {% endif %}
                                        <p class="mb-0"><small class="text-muted">
                                            <i class="fas fa-building me-1"></i>{{ selected_project.construtora }} - {{ selected_project.nome_funcionario }}
                                        </small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Informações Básicas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">Título do Relatório *</label>
                                    <input type="text" name="titulo" id="titulo" class="form-control" 
                                           value="{% if selected_project %}Relatório - {{ selected_project.nome }}{% else %}Relatório de visita{% endif %}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    <select name="projeto_id" id="projeto_id" class="form-control" required onchange="carregarFuncionariosEmails()">
                                        <option value="">Selecione um projeto</option>
                                        {% for projeto in projetos %}
                                        <option value="{{ projeto.id }}" 
                                                {% if selected_project and selected_project.id == projeto.id %}selected{% endif %}>
                                            {{ projeto.numero }} - {{ projeto.nome }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Seleção de Funcionários e E-mails -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-users me-2"></i>Funcionários do Projeto
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="funcionarios-projeto">
                                            <p class="text-muted">Selecione um projeto para ver os funcionários disponíveis</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="fas fa-envelope me-2"></i>E-mails para Envio
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="emails-projeto">
                                            <p class="text-muted">Selecione um projeto para ver os e-mails disponíveis</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="aprovador_id">Aprovador do Relatório</label>
                                    <select name="aprovador_id" id="aprovador_id" class="form-control">
                                        <option value="">Selecione o aprovador</option>
                                        {% for admin in admin_users %}
                                        <option value="{{ admin.id }}" {% if selected_aprovador and admin.id == selected_aprovador.id %}selected{% endif %}>{{ admin.nome_completo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="data_relatorio">Data do Relatório</label>
                                    <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}">
                                </div>
                            </div>
                        </div>

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Fundação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observações sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Vedação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observações sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instalações (Elétrica/Hidráulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observações sobre instalações..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observações sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organização
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observações sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Observações Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observações Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4" 
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Captura de Localização -->
                        <div class="mb-4">
                            <h5><i class="fas fa-map-marker-alt"></i> Localização</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <button type="button" class="btn btn-outline-primary" onclick="capturarLocalizacao()">
                                        <i class="fas fa-crosshairs"></i> Capturar Localização Atual
                                    </button>
                                    <div id="localizacao-info" class="mt-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                    <small class="text-muted">A localização será anexada ao relatório para confirmar presença no local.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Fotos -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (Até 200 fotos) 🆕</h5>
                            
                            <!-- Seleção de Categoria -->
                            <div class="mb-3">
                                <label class="form-label">Selecione a categoria antes de adicionar a foto:</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Geral">
                                            <i class="fas fa-camera fa-2x mb-2"></i>
                                            <div>Geral</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Estrutura">
                                            <i class="fas fa-building fa-2x mb-2"></i>
                                            <div>Estrutura</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Acabamento">
                                            <i class="fas fa-paint-brush fa-2x mb-2"></i>
                                            <div>Acabamento</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Instalações">
                                            <i class="fas fa-tools fa-2x mb-2"></i>
                                            <div>Instalações</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Problema">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <div>Problema</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload de Fotos -->
                            <div class="mb-3">
                                <input type="file" id="photoInput" class="form-control" multiple accept="image/*" disabled style="opacity: 0.5;">
                                <small class="text-muted">Selecione uma categoria antes de escolher as fotos. <strong style="color: red;">Máximo 200 fotos - Limite total: 3GB.</strong></small>
                            </div>

                            <!-- Preview das Fotos -->
                            <div id="photoPreview" class="row"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Relatório
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Retângulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> Círculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>
                        
                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>
                        
                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>
                        
                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edição</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let selectedCategory = '';
let selectedPhotos = [];
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');
    
    // Event listeners para categorias - CORRIGIDO
    function setupCategoryListeners() {
        document.querySelectorAll('.photo-category').forEach(category => {
            // Remover listeners antigos
            category.removeEventListener('click', selectCategoryHandler);
            category.removeEventListener('touchstart', selectCategoryHandler);
            
            // Adicionar novos listeners
            category.addEventListener('click', selectCategoryHandler);
            category.addEventListener('touchstart', selectCategoryHandler);
        });
    }
    
    function selectCategoryHandler(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('📷 Categoria selecionada:', this.dataset.category);
        
        // Remover seleção anterior
        document.querySelectorAll('.photo-category').forEach(c => c.classList.remove('selected'));
        
        // Selecionar nova categoria
        this.classList.add('selected');
        selectedCategory = this.dataset.category;
        
        // Atualizar input de fotos
        updatePhotoInput();
        
        console.log('✅ Categoria atual:', selectedCategory);
    }
    
    // Chamar setup
    setupCategoryListeners();
    
    // Event listener para upload de fotos
    document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
    
    // Event listeners para ferramentas - OTIMIZADO PARA MOBILE
    document.querySelectorAll('.tool-btn').forEach(btn => {
        // Usar touchstart para resposta mais rápida no mobile
        const isMobile = window.innerWidth <= 768;
        const eventType = isMobile ? 'touchstart' : 'click';
        
        btn.addEventListener(eventType, function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Feedback visual imediato
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);
            
            // Atualizar ferramentas
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;
            
            console.log('🔧 Ferramenta selecionada:', currentTool);
        });
        
        // Prevenir eventos duplicados no mobile
        if (isMobile) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });
    
    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });
    
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });
    
    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

// Função para carregar funcionários e e-mails do projeto selecionado
function carregarFuncionariosEmails() {
    const projetoId = document.getElementById('projeto_id').value;
    const funcionariosDiv = document.getElementById('funcionarios-projeto');
    const emailsDiv = document.getElementById('emails-projeto');
    
    if (!projetoId) {
        funcionariosDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os funcionários disponíveis</p>';
        emailsDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os e-mails disponíveis</p>';
        return;
    }
    
    // Buscar funcionários e e-mails do projeto via AJAX
    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Renderizar funcionários
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                data.funcionarios.forEach(func => {
                    const checked = func.is_responsavel_principal ? 'checked' : '';
                    funcionariosHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="func_${func.id}" 
                                   name="funcionarios_selecionados[]" value="${func.id}" ${checked}>
                            <label class="form-check-label" for="func_${func.id}">
                                <strong>${func.nome_funcionario}</strong><br>
                                <small class="text-muted">${func.cargo || 'Sem cargo'} - ${func.empresa || 'Sem empresa'}</small>
                                ${func.is_responsavel_principal ? '<span class="badge bg-primary">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                funcionariosHtml = '<p class="text-muted">Nenhum funcionário encontrado para este projeto</p>';
            }
            funcionariosDiv.innerHTML = funcionariosHtml;
            
            // Renderizar e-mails
            let emailsHtml = '';
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    const checked = email.is_principal ? 'checked' : '';
                    emailsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_${email.id}" 
                                   name="emails_selecionados[]" value="${email.id}" ${checked}>
                            <label class="form-check-label" for="email_${email.id}">
                                <strong>${email.email}</strong><br>
                                <small class="text-muted">${email.nome_contato} - ${email.cargo || 'Sem cargo'}</small>
                                ${email.is_principal ? '<span class="badge bg-success">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                emailsHtml = '<p class="text-muted">Nenhum e-mail encontrado para este projeto</p>';
            }
            emailsDiv.innerHTML = emailsHtml;
        } else {
            funcionariosDiv.innerHTML = '<p class="text-danger">Erro ao carregar funcionários</p>';
            emailsDiv.innerHTML = '<p class="text-danger">Erro ao carregar e-mails</p>';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        funcionariosDiv.innerHTML = '<p class="text-danger">Erro de conexão</p>';
        emailsDiv.innerHTML = '<p class="text-danger">Erro de conexão</p>';
    });
}

function handlePhotoUpload(event) {
    console.log('📷 Upload de fotos iniciado');
    console.log('Categoria selecionada:', selectedCategory);
    
    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        event.target.value = '';
        return;
    }
    
    const files = event.target.files;
    console.log('Arquivos selecionados:', files.length);
    
    if (files.length + selectedPhotos.length > 200) {
        alert('Máximo de 200 fotos permitido.');
        return;
    }
    
    // Processar cada arquivo
    for (let file of files) {
        if (selectedPhotos.length >= 200) {
            console.log('⚠️ Limite de 200 fotos atingido');
            break;
        }
        console.log('Processando arquivo:', file.name);
        addPhotoPreview(file, selectedCategory);
    }
    
    event.target.value = ''; // Reset input
    console.log('✅ Upload concluído. Total de fotos:', selectedPhotos.length);
}

function addPhotoPreview(file, category) {
    console.log('🖼️ Adicionando preview da foto:', file.name, 'Categoria:', category);
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;
        
        console.log('✨ Criando elemento da foto com ID:', photoId);
        
        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.setAttribute('data-photo-id', photoId);
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" data-category="${category}">
                <div class="card-body p-2">
                    <!-- Seletor de Legendas -->
                    <select class="form-control form-control-sm mb-2" id="predefined_${photoId}" name="photo_caption_${photoId}" required>
                        <option value="">Selecione uma legenda...</option>
                    </select>
                    <small class="text-muted d-block">Categoria: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openPhotoEditor('${photoId}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('photoPreview').appendChild(photoDiv);
        
        selectedPhotos.push({
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src
        });
        
        console.log('✅ Foto adicionada ao array. Total:', selectedPhotos.length);
        
        loadPredefinedCaptionsForPhoto(photoId, category);
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    }
}

function loadPredefinedCaptionsForPhoto(photoId, category) {
    const select = document.getElementById(`predefined_${photoId}`);
    if (!select) return;
    
    select.innerHTML = '<option value="">Carregando legendas...</option>';
    
    // Carregar direto da API (PostgreSQL)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/legendas?categoria=all', true);
    xhr.timeout = 10000;
    
    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.legendas && data.legendas.length > 0) {
                    select.innerHTML = '<option value="">Selecione uma legenda...</option>';
                    
                    const cats = {
                        'Acabamentos': [],
                        'Estrutural': [],
                        'Geral': [],
                        'Segurança': []
                    };
                    
                    data.legendas.forEach(leg => {
                        if (cats[leg.categoria]) {
                            cats[leg.categoria].push(leg);
                        }
                    });
                    
                    Object.keys(cats).forEach(cat => {
                        if (cats[cat].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = cat + ' (' + cats[cat].length + ' itens)';
                            
                            cats[cat].forEach(legenda => {
                                const option = document.createElement('option');
                                option.value = legenda.texto;
                                option.textContent = legenda.texto;
                                optgroup.appendChild(option);
                            });
                            
                            select.appendChild(optgroup);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">Erro: nenhuma legenda encontrada</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="">Erro: formato inválido</option>';
            }
        } else {
            select.innerHTML = '<option value="">Erro: servidor indisponível</option>';
        }
    };
    
    xhr.onerror = function() {
        select.innerHTML = '<option value="">Erro: falha de rede</option>';
    };
    
    xhr.ontimeout = function() {
        select.innerHTML = '<option value="">Erro: tempo esgotado</option>';
    };
    
    xhr.send();
}

// Mapear categoria da foto para categoria da legenda
function mapCategoryToLegenda(photoCategory) {
    const mapping = {
        'Geral': 'Geral',
        'Estrutura': 'Estrutural', 
        'Acabamento': 'Acabamentos',
        'Instalações': 'Elétrica',
        'Problema': 'Segurança'
    };
    return mapping[photoCategory] || 'Geral';
}

function updatePhotoInput() {
    const input = document.getElementById('photoInput');
    console.log('🔄 Atualizando input de fotos. Categoria:', selectedCategory);
    
    if (selectedCategory) {
        input.disabled = false;
        input.style.opacity = '1';
        input.style.pointerEvents = 'auto';
        console.log('✅ Input de fotos habilitado');
    } else {
        input.disabled = true;
        input.style.opacity = '0.5';
        input.style.pointerEvents = 'none';
        console.log('⚠️ Input de fotos desabilitado');
    }
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();
    
    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;" 
                   name="custom_item_${itemId}" placeholder="Digite o item do checklist..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end" 
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observações..." rows="2"></textarea>
    `;
    
    checklistItems.appendChild(itemDiv);
}

// Marcar checklist como concluído
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    }
});

// Sistema Fabric.js Photo Editor - Exatamente como no Express
function openPhotoEditor(photoId) {
    try {
        console.log(`🎨 Abrindo editor para foto: ${photoId}`);
        
        const card = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (!card) {
            console.error(`❌ Card não encontrado para foto: ${photoId}`);
            return;
        }
        
        const img = card.querySelector('img');
        if (!img || !img.src) {
            console.error(`❌ Imagem não encontrada para foto: ${photoId}`);
            return;
        }
        
        // Callback para salvar a foto editada (definir primeiro)
        const saveCallback = async (data) => {
            console.log('💾 Salvando foto editada:', data.photoId);
            
            // Atualizar preview da foto no card
            img.src = data.imageData;
            img.dataset.edited = 'true';
            img.dataset.legend = data.legend;
            
            // Marcar visualmente como editada
            card.classList.add('edited');
            
            // Adicionar badge de editado se não existir
            if (!card.querySelector('.edited-badge')) {
                const badge = document.createElement('div');
                badge.className = 'edited-badge';
                badge.innerHTML = '<i class="fas fa-edit"></i> Editado';
                card.appendChild(badge);
            }
            
            console.log('✅ Foto salva com sucesso');
        };
        
        // Verificar se o editor modal está disponível  
        if (!window.fabricPhotoEditorModal) {
            console.error('❌ Editor modal não inicializado');
            
            // Verificar se as dependências estão carregadas
            if (typeof fabric === 'undefined') {
                alert('Fabric.js não está carregado. Recarregue a página.');
                return;
            }
            
            if (typeof bootstrap === 'undefined') {
                alert('Bootstrap não está carregado. Recarregue a página.');
                return;
            }
            
            if (typeof FabricPhotoEditor === 'undefined') {
                alert('Editor de fotos não está carregado. Recarregue a página.');
                return;
            }
            
            // Tentar inicializar o editor modal
            if (typeof initFabricPhotoEditorModal === 'function') {
                console.log('🔄 Tentando inicializar editor modal...');
                initFabricPhotoEditorModal();
                
                // Aguardar um momento para o editor ser inicializado
                setTimeout(() => {
                    if (window.fabricPhotoEditorModal) {
                        console.log('✅ Editor inicializado com sucesso');
                        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
                    } else {
                        console.error('❌ Falha ao inicializar editor após tentativa');
                        alert('Editor de fotos não pode ser carregado. Recarregue a página.');
                    }
                }, 500);
                return;
            }
        }
        
        // Editor disponível, abrir diretamente
        console.log('✅ Abrindo editor');
        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
        
    } catch (error) {
        console.error('❌ Erro ao abrir editor:', error);
        alert('Erro ao abrir editor de fotos. Tente novamente.');
    }
}

// Função para auto-scroll centralizado
function scrollToEditorCenter() {
    console.log('🎨 Executando auto-scroll para centro do editor');
    
    const modal = document.getElementById('fabricPhotoEditorModal');
    if (!modal) {
        console.log('⚠️ Modal não encontrado');
        return;
    }
    
    const canvasContainer = modal.querySelector('.canvas-container');
    if (!canvasContainer) {
        console.log('⚠️ Canvas container não encontrado');
        return;
    }
    
    try {
        // Scroll suave para o centro do canvas
        canvasContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });
        
        // Centralizar o scroll na janela também
        window.scrollTo({
            top: window.innerHeight / 4,
            behavior: 'smooth'
        });
        
        console.log('✅ Auto-scroll executado com sucesso');
    } catch (error) {
        console.error('❌ Erro no auto-scroll:', error);
    }
}

// Nova função para atualizar foto do Fabric Editor
function updatePhotoFromFabricEditor(photoId, editedImageData) {
    console.log('💾 Atualizando foto editada:', photoId);
    
    // Buscar elemento da foto diretamente pelo ID
    const photoElement = document.getElementById(photoId);
    if (!photoElement) {
        console.error('❌ Elemento da foto não encontrado:', photoId);
        return;
    }
    
    // Atualizar imagem no preview
    const img = photoElement.querySelector('.photo-preview');
    if (img && editedImageData.imageData) {
        img.src = editedImageData.imageData;
        console.log('✅ Imagem do preview atualizada');
        
        // Também atualizar onclick para manter funcionalidade
        img.setAttribute('onclick', `editPhoto('${photoId}', '${editedImageData.imageData}', '${img.getAttribute('data-category') || 'Geral'}')`);
    }
    
    // Atualizar também em selectedPhotos se existir
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.annotatedSrc = editedImageData.imageData;
        console.log('✅ Dados da foto atualizados em selectedPhotos');
    }
    
    // Adicionar indicador visual de foto editada
    const card = photoElement.querySelector('.card');
    if (card && !card.classList.contains('border-success')) {
        card.classList.add('border-success', 'border-2');
        
        // Remover indicador anterior se existir
        const oldIndicator = card.querySelector('.edit-indicator');
        if (oldIndicator) oldIndicator.remove();
        
        const indicator = document.createElement('small');
        indicator.className = 'text-success fw-bold edit-indicator d-block mt-1';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Editada';
        photoElement.querySelector('.card-body').appendChild(indicator);
        console.log('✅ Indicador visual adicionado');
    }
    
    console.log('✅ Foto atualizada com sucesso');
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;
    
    if (currentTool === 'text') {
        const text = prompt('Digite o texto:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }
    
    // Para caneta, começar o path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;
    
    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';
    
    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;
    
    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    
    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }
    
    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);
    
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;
        
        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version
        
        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        editButton.innerHTML = '<i class="fas fa-check"></i> Editada';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Submissão do formulário
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    
    // Create FormData object for proper file handling
    const formData = new FormData(this);
    
    // Coletar dados do checklist
    const checklistData = [];
    document.querySelectorAll('.checklist-item').forEach(item => {
        const checkbox = item.querySelector('.form-check-input[type="checkbox"]');
        const label = item.querySelector('.form-check-label');
        const customInput = item.querySelector('input[type="text"]');
        const textarea = item.querySelector('textarea');
        
        if (checkbox) {
            const itemText = label ? label.textContent.trim() : (customInput ? customInput.value : '');
            if (itemText) {
                checklistData.push({
                    item: itemText,
                    completed: checkbox.checked,
                    observations: textarea ? textarea.value : ''
                });
            }
        }
    });
    
    // Add checklist data
    formData.append('checklist_data', JSON.stringify(checklistData));
    
    // Add photo files and metadata
    selectedPhotos.forEach((photo, index) => {
        // Add the actual file
        formData.append(`photo_${index}`, photo.file);
        
        // Add photo metadata
        formData.append(`photo_category_${index}`, photo.category);
        
        const caption = document.querySelector(`select[name="photo_caption_${photo.id}"]`);
        if (caption && caption.value) {
            formData.append(`photo_caption_${index}`, caption.value);
        }
        
        // Add edited photo data if exists
        if (photo.editedSrc) {
            formData.append(`edited_photo_${index}`, photo.editedSrc);
        }
    });
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitBtn.disabled = true;
    
    // Submit via fetch
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => Promise.reject(err));
        }
    })
    .then(data => {
        if (data.success) {
            alert('Relatório salvo com sucesso!');
            window.location.href = data.redirect || '/reports';
        } else {
            throw new Error(data.error || 'Erro ao salvar relatório');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar relatório. Tente novamente.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Função para capturar localização
function capturarLocalizacao() {
    const infoDiv = document.getElementById('localizacao-info');
    
    if (!navigator.geolocation) {
        infoDiv.innerHTML = '<div class="alert alert-danger">Geolocalização não é suportada pelo navegador.</div>';
        return;
    }
    
    infoDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Capturando localização...</div>';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Localização capturada com sucesso!<br>
                    <small id="addressDisplay">Obtendo endereço... (precisão: ${Math.round(accuracy)}m)</small>
                </div>
            `;
            
            // Obter endereço formatado via API
            fetch('/get_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.endereco) {
                    document.getElementById('addressDisplay').innerHTML = `<strong>📍 ${data.endereco}</strong> (precisão: ${Math.round(accuracy)}m)`;
                } else {
                    document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precisão: ${Math.round(accuracy)}m)`;
                }
            })
            .catch(error => {
                console.error('Erro ao obter endereço:', error);
                document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precisão: ${Math.round(accuracy)}m)`;
            });
        },
        function(error) {
            let errorMsg = 'Erro ao capturar localização.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permissão negada para acessar localização.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Localização indisponível.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tempo limite para capturar localização.';
                    break;
            }
            infoDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</div>`;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}

// FUNÇÃO DUPLICADA REMOVIDA - usar apenas a versão otimizada para mobile

// FUNÇÃO DUPLICADA REMOVIDA - usar apenas a versão do início do arquivo

// Função para alternar checkbox e mostrar/ocultar campo de observações
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsField = document.getElementById(`obs_${itemId}`);
    const parentItem = checkbox.closest('.checklist-item');
    
    if (checkbox.checked) {
        if (obsField) {
            obsField.style.display = 'block';
        }
        if (parentItem) {
            parentItem.classList.add('completed');
        }
    } else {
        if (obsField) {
            obsField.style.display = 'none';
        }
        if (parentItem) {
            parentItem.classList.remove('completed');
        }
    }
}

// Função para alternar estado do checklist item
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsSection = document.getElementById(`obs_${itemId}`);
    const checklistItem = checkbox.closest('.checklist-item');
    
    if (checkbox.checked) {
        // Marcar como completo
        checklistItem.classList.add('completed');
        // Mostrar campo de observações
        if (obsSection) {
            obsSection.style.display = 'block';
        }
    } else {
        // Desmarcar como completo
        checklistItem.classList.remove('completed');
        // Ocultar campo de observações
        if (obsSection) {
            obsSection.style.display = 'none';
            // Limpar observações se desejar
            const textarea = obsSection.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }
}

// Carregar checklist padrão do sistema
function carregarChecklistPadrao() {
    fetch('/api/checklist-padrao')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.checklist.length > 0) {
                const container = document.getElementById('checklistItems');
                container.innerHTML = ''; // Limpar conteúdo atual
                
                data.checklist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item mb-3';
                    itemDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="check_${item.id}" onchange="toggleChecklistItem(this)">
                                <label class="form-check-label" for="check_${item.id}">
                                    ${item.texto}
                                </label>
                            </div>
                        </div>
                        <div class="mt-2" style="display: none;" id="obs_${item.id}">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="Observações (opcional)..." name="obs_${item.id}"></textarea>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });
                
                console.log(`${data.checklist.length} itens do checklist padrão carregados`);
            } else {
                const container = document.getElementById('checklistItems');
                container.innerHTML = '<p class="text-muted">Nenhum item no checklist padrão. <a href="/admin/checklist-padrao">Configurar checklist</a></p>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar checklist padrão:', error);
            const container = document.getElementById('checklistItems');
            container.innerHTML = '<p class="text-danger">Erro ao carregar checklist. <a href="#" onclick="carregarChecklistPadrao()">Tentar novamente</a></p>';
        });
}

// Inicializar sistema ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Carregar checklist padrão automaticamente
    carregarChecklistPadrao();
    
    // Auto-carregar dados do projeto se pre-selecionado
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        console.log('🏗️ Projeto pré-selecionado detectado:', projetoSelect.value);
        carregarFuncionariosEmails();
    }
    
    // Inicializar editor modal Fabric.js - exatamente como no Express
    if (typeof initFabricPhotoEditorModal === 'function') {
        initFabricPhotoEditorModal();
        console.log('✅ Editor modal inicializado');
    } else {
        console.error('❌ Editor modal não disponível');
    }
});

</script>

<!-- Fabric.js CDN - Exatamente como no Express -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Editor Scripts - Exatamente como no Express -->
<script src="{{ url_for('static', filename='js/fabric-photo-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/fabric-photo-editor-modal.js') }}"></script>

<!-- Modal do Editor de Fotos Professional - Exatamente como no Express -->
<div class="modal fade" id="fabricPhotoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editor de Fotos Professional
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <!-- Body -->
            <div class="modal-body p-0" style="height: calc(100vh - 160px);">
                <div class="fabric-editor-container" style="height: 100%;">
                    <!-- Área principal do editor -->
                    <div class="fabric-editor-main" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Container do canvas -->
                        <div class="canvas-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa;">
                            <div class="canvas-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); overflow: hidden;">
                                <canvas id="fabricModalCanvas"></canvas>
                            </div>
                        </div>
                        
                        <!-- Toolbar de ferramentas -->
                        <div class="fabric-toolbar" style="background: white; border-top: 1px solid #e1e5e9; padding: 16px;">
                            <!-- Ferramentas principais -->
                            <div class="tool-group mb-3">
                                <h6 class="text-muted mb-2">Ferramentas</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="fabric-tool-btn active" data-modal-tool="select" title="Seleção">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="brush" title="Pincel">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="arrow" title="Seta">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="circle" title="Círculo">
                                        <i class="far fa-circle"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="rectangle" title="Retângulo">
                                        <i class="far fa-square"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="text" title="Texto">
                                        <i class="fas fa-font"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Propriedades -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Cor:</label>
                                    <input type="color" id="modal-color-picker" class="form-control form-control-color" value="#FF0000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Espessura:</label>
                                    <input type="range" id="modal-stroke-width" class="form-range" min="1" max="20" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Legenda:</label>
                                    <input type="text" id="modal-custom-legend" class="form-control" placeholder="Digite uma legenda...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="window.fabricPhotoEditorModal?.clear()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
                <button type="button" class="btn btn-warning" onclick="window.fabricPhotoEditorModal?.undo()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn btn-success" id="modal-save-btn">
                    <i class="fas fa-check"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos do modal do editor - Exatamente como no Express */
.fabric-tool-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 8px;
    color: #4b5563;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fabric-tool-btn:hover {
    background: #e5e7eb;
}

.fabric-tool-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
}

/* Indicador visual de foto editada */
.photo-container.edited {
    position: relative;
}

.edited-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    z-index: 10;
}

.edit-photo-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    border: none;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.edit-photo-btn:hover {
    background: #3b82f6;
    transform: scale(1.1);
}

/* Responsivo mobile */
@media (max-width: 768px) {
    .fabric-toolbar {
        max-height: 40vh;
        overflow-y: auto;
    }
    
    .fabric-tool-btn {
        min-width: 40px;
        min-height: 40px;
    }
    
    /* MOBILE: Otimizações específicas para legendas pré-definidas */
    select[name^="photo_caption_"], 
    select[id^="predefined_"] {
        font-size: 16px !important;
        min-height: 48px !important;
        padding: 12px !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        background: white !important;
        display: block !important;
        width: 100% !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
        appearance: menulist !important;
    }
    
    /* Grupos de opções visíveis */
    optgroup {
        font-weight: bold !important;
        color: #007bff !important;
        font-size: 15px !important;
        padding: 4px !important;
    }
    
    option {
        font-size: 14px !important;
        padding: 8px !important;
        color: #333 !important;
        background: white !important;
    }
    
    /* Cards de fotos otimizados */
    .card-body.p-2 {
        padding: 16px !important;
    }
    
    /* Texto de categoria mais visível */
    .text-muted {
        font-size: 14px !important;
        color: #555 !important;
        font-weight: 600 !important;
    }
}
</style>

{% endblock %}