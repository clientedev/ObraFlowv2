{% extends "base.html" %}

{% block title %}Relat√≥rio de Obra{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-file-alt"></i> Relat√≥rio de Obra</h3>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="reportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">T√≠tulo do Relat√≥rio *</label>
                                    <input type="text" name="titulo" id="titulo" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    <select name="projeto_id" id="projeto_id" class="form-control" required>
                                        <option value="">Selecione um projeto</option>
                                        {% for projeto in projetos %}
                                        <option value="{{ projeto.id }}">{{ projeto.numero }} - {{ projeto.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="aprovador_id">Aprovador do Relat√≥rio</label>
                                    <select name="aprovador_id" id="aprovador_id" class="form-control">
                                        <option value="">Selecione o aprovador</option>
                                        {% for admin in admin_users %}
                                        <option value="{{ admin.id }}">{{ admin.nome_completo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="data_relatorio">Data do Relat√≥rio</label>
                                    <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}">
                                </div>
                            </div>
                        </div>

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Funda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observa√ß√µes sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Veda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observa√ß√µes sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instala√ß√µes (El√©trica/Hidr√°ulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observa√ß√µes sobre instala√ß√µes..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observa√ß√µes sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organiza√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observa√ß√µes sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Observa√ß√µes Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observa√ß√µes Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4" 
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Captura de Localiza√ß√£o -->
                        <div class="mb-4">
                            <h5><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</h5>
                            <div class="row">
                                <div class="col-md-8">
                                    <button type="button" class="btn btn-outline-primary" onclick="capturarLocalizacao()">
                                        <i class="fas fa-crosshairs"></i> Capturar Localiza√ß√£o Atual
                                    </button>
                                    <div id="localizacao-info" class="mt-2"></div>
                                </div>
                                <div class="col-md-4">
                                    <input type="hidden" id="latitude" name="latitude">
                                    <input type="hidden" id="longitude" name="longitude">
                                    <small class="text-muted">A localiza√ß√£o ser√° anexada ao relat√≥rio para confirmar presen√ßa no local.</small>
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Fotos -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (At√© 50 fotos) üÜï</h5>
                            
                            <!-- Sele√ß√£o de Categoria -->
                            <div class="mb-3">
                                <label class="form-label">Selecione a categoria antes de adicionar a foto:</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Geral">
                                            <i class="fas fa-camera fa-2x mb-2"></i>
                                            <div>Geral</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Estrutura">
                                            <i class="fas fa-building fa-2x mb-2"></i>
                                            <div>Estrutura</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Acabamento">
                                            <i class="fas fa-paint-brush fa-2x mb-2"></i>
                                            <div>Acabamento</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Instala√ß√µes">
                                            <i class="fas fa-tools fa-2x mb-2"></i>
                                            <div>Instala√ß√µes</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="photo-category text-center" data-category="Problema">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <div>Problema</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Upload de Fotos -->
                            <div class="mb-3">
                                <input type="file" id="photoInput" class="form-control" multiple accept="image/*" disabled style="opacity: 0.5;">
                                <small class="text-muted">Selecione uma categoria antes de escolher as fotos. <strong style="color: red;">M√°ximo 50 fotos.</strong></small>
                            </div>

                            <!-- Preview das Fotos -->
                            <div id="photoPreview" class="row"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Relat√≥rio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Ret√¢ngulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> C√≠rculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>
                        
                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>
                        
                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>
                        
                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edi√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let selectedCategory = '';
let selectedPhotos = [];
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');
    
    // Event listeners para categorias
    document.querySelectorAll('.photo-category').forEach(category => {
        category.addEventListener('click', function() {
            document.querySelectorAll('.photo-category').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedCategory = this.dataset.category;
            updatePhotoInput();
        });
    });
    
    // Event listener para upload de fotos
    document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
    
    // Event listeners para ferramentas
    document.querySelectorAll('.tool-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;
        });
    });
    
    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });
    
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });
    
    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

function handlePhotoUpload(event) {
    const files = event.target.files;
    if (files.length + selectedPhotos.length > 50) {
        alert('M√°ximo de 50 fotos permitido.');
        return;
    }
    
    for (let file of files) {
        if (selectedPhotos.length >= 5) break;
        addPhotoPreview(file, selectedCategory);
    }
    
    event.target.value = ''; // Reset input
}

function addPhotoPreview(file, category) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;
        
        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" onclick="editPhoto('${photoId}', '${src}', '${category}')">
                <div class="card-body p-2">
                    <input type="text" class="form-control form-control-sm mb-2" 
                           name="photo_caption_${photoId}" placeholder="Legenda da foto...">
                    <small class="text-muted d-block">Categoria: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="editPhoto('${photoId}', '${src}', '${category}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('photoPreview').appendChild(photoDiv);
        
        selectedPhotos.push({
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src
        });
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    }
}

function updatePhotoInput() {
    const input = document.getElementById('photoInput');
    if (selectedCategory) {
        input.disabled = false;
        input.style.opacity = '1';
    } else {
        input.disabled = true;
        input.style.opacity = '0.5';
    }
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();
    
    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;" 
                   name="custom_item_${itemId}" placeholder="Digite o item do checklist..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end" 
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observa√ß√µes..." rows="2"></textarea>
    `;
    
    checklistItems.appendChild(itemDiv);
}

// Marcar checklist como conclu√≠do
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    }
});

// Editor de fotos
function editPhoto(photoId, imageSrc, category) {
    currentEditingPhoto = selectedPhotos.find(p => p.id === photoId);
    if (!currentEditingPhoto) return;
    
    const img = new Image();
    img.onload = function() {
        // Manter propor√ß√£o mas limitar tamanho m√°ximo
        const maxWidth = 800;
        const maxHeight = 600;
        let width = img.width;
        let height = img.height;
        
        if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
        }
        if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
        }
        
        canvas.width = width;
        canvas.height = height;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, width, height);
    };
    img.src = imageSrc;
    
    const modal = new bootstrap.Modal(document.getElementById('photoEditorModal'));
    modal.show();
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;
    
    if (currentTool === 'text') {
        const text = prompt('Digite o texto:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }
    
    // Para caneta, come√ßar o path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;
    
    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';
    
    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;
    
    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    
    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }
    
    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);
    
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;
        
        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version
        
        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        editButton.innerHTML = '<i class="fas fa-check"></i> Editada';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Submiss√£o do formul√°rio
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    
    // Create FormData object for proper file handling
    const formData = new FormData(this);
    
    // Coletar dados do checklist
    const checklistData = [];
    document.querySelectorAll('.checklist-item').forEach(item => {
        const checkbox = item.querySelector('.form-check-input[type="checkbox"]');
        const label = item.querySelector('.form-check-label');
        const customInput = item.querySelector('input[type="text"]');
        const textarea = item.querySelector('textarea');
        
        if (checkbox) {
            const itemText = label ? label.textContent.trim() : (customInput ? customInput.value : '');
            if (itemText) {
                checklistData.push({
                    item: itemText,
                    completed: checkbox.checked,
                    observations: textarea ? textarea.value : ''
                });
            }
        }
    });
    
    // Add checklist data
    formData.append('checklist_data', JSON.stringify(checklistData));
    
    // Add photo files and metadata
    selectedPhotos.forEach((photo, index) => {
        // Add the actual file
        formData.append(`photo_${index}`, photo.file);
        
        // Add photo metadata
        formData.append(`photo_category_${index}`, photo.category);
        
        const caption = document.querySelector(`input[name="photo_caption_${photo.id}"]`);
        if (caption && caption.value) {
            formData.append(`photo_caption_${index}`, caption.value);
        }
        
        // Add edited photo data if exists
        if (photo.editedSrc) {
            formData.append(`edited_photo_${index}`, photo.editedSrc);
        }
    });
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitBtn.disabled = true;
    
    // Submit via fetch
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => Promise.reject(err));
        }
    })
    .then(data => {
        if (data.success) {
            alert('Relat√≥rio salvo com sucesso!');
            window.location.href = data.redirect || '/reports';
        } else {
            throw new Error(data.error || 'Erro ao salvar relat√≥rio');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar relat√≥rio. Tente novamente.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Fun√ß√£o para capturar localiza√ß√£o
function capturarLocalizacao() {
    const infoDiv = document.getElementById('localizacao-info');
    
    if (!navigator.geolocation) {
        infoDiv.innerHTML = '<div class="alert alert-danger">Geolocaliza√ß√£o n√£o √© suportada pelo navegador.</div>';
        return;
    }
    
    infoDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Capturando localiza√ß√£o...</div>';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
            
            infoDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Localiza√ß√£o capturada com sucesso!<br>
                    <small id="addressDisplay">Obtendo endere√ßo... (precis√£o: ${Math.round(accuracy)}m)</small>
                </div>
            `;
            
            // Obter endere√ßo formatado via API
            fetch('/get_location', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.endereco) {
                    document.getElementById('addressDisplay').innerHTML = `<strong>üìç ${data.endereco}</strong> (precis√£o: ${Math.round(accuracy)}m)`;
                } else {
                    document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precis√£o: ${Math.round(accuracy)}m)`;
                }
            })
            .catch(error => {
                console.error('Erro ao obter endere√ßo:', error);
                document.getElementById('addressDisplay').innerHTML = `Coordenadas: ${lat.toFixed(6)}, ${lng.toFixed(6)} (precis√£o: ${Math.round(accuracy)}m)`;
            });
        },
        function(error) {
            let errorMsg = 'Erro ao capturar localiza√ß√£o.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permiss√£o negada para acessar localiza√ß√£o.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Localiza√ß√£o indispon√≠vel.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tempo limite para capturar localiza√ß√£o.';
                    break;
            }
            infoDiv.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${errorMsg}</div>`;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000
        }
    );
}
</script>
{% endblock %}