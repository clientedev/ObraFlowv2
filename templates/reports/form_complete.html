{% extends "base.html" %}

{% block title %}Relatório de Obra{% endblock %}

{% block head %}
<!-- Meta tag CSRF para auto-save -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}

/* Mobile Touch - Sistema inteligente igual ao Express */
    @media (max-width: 768px) {
        /* Categorias de fotos - touch otimizado */
        .photo-category {
            min-height: 60px;
            min-width: 60px;
            touch-action: auto !important;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            pointer-events: auto !important;
            transition: all 0.15s ease;
        }
        
        /* Feedback visual do touch - igual Express */
        .photo-category.touching {
            transform: scale(0.95);
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* Todos os inputs e controles - interação normal */
        input[type="text"],
        input[type="date"], 
        input[type="file"],
        textarea,
        select,
        .form-control {
            touch-action: auto !important;
            -webkit-user-select: auto;
            user-select: auto;
        }

        /* Containers - scroll completamente livre */
        .container-fluid,
        .row,
        .card-body,
        body,
        html {
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overflow: auto !important;
        }

        /* Data do Relatório - Design padrão */
        .alert.border-primary {
            border-width: 1px !important;
            background: #f8f9fa;
        }
        
        #data_relatorio {
            font-size: 16px;
            font-weight: 400;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: none;
        }
        
        #data_relatorio:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    }
    
    @media (max-width: 768px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
            padding: 12px !important;
        }
        
        .form-label {
            font-size: 14px !important;
            margin-bottom: 0.5rem !important;
        }
        
        .alert.border-primary {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            border-radius: 0.375rem !important;
        }
    }
    
    @media (max-width: 576px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
        }
    }

    /* Mobile-First Photo System Styles */
    .mobile-photo-btn {
        border-radius: 12px !important;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mobile-photo-btn:hover, .mobile-photo-btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .mobile-photo-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .mobile-photo-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .photo-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .photo-card-content {
        padding: 16px;
    }

    .caption-input {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        transition: all 0.3s ease;
    }

    .caption-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .caption-select {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        background: white;
        transition: all 0.3s ease;
    }

    .caption-select:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
    }

    .photo-card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
    }

    .photo-card-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        min-height: 42px;
        border: 2px solid;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .photo-card-btn.edit {
        background: white;
        color: #007bff;
        border-color: #007bff;
    }

    .photo-card-btn.edit:hover {
        background: #007bff;
        color: white;
    }

    .photo-card-btn.delete {
        background: white;
        color: #dc3545;
        border-color: #dc3545;
    }

    .photo-card-btn.delete:hover {
        background: #dc3545;
        color: white;
    }

    .category-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .photo-count-badge {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .caption-status {
        font-size: 12px;
        margin-top: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        text-align: center;
    }

    .caption-status.complete {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .caption-status.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .fixed-photo-buttons {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .mobile-photo-card {
            margin-bottom: 20px;
        }
        
        .photo-card-image {
            height: 160px;
        }
        
        .photo-card-content {
            padding: 12px;
        }
        
        .caption-input, .caption-select {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Relatório de Obra</h3>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-warning">
                                <i class="fas fa-edit me-1"></i>Em preenchimento
                            </span>
                            <div id="autosave-status"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_report') }}" enctype="multipart/form-data" id="reportForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        {% if existing_report %}
                        <input type="hidden" name="edit_report_id" value="{{ existing_report.id }}">
                        {% endif %}
                        {% if selected_project %}
                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                        {% endif %}
                        
                        <!-- Data do Relatório -->
                        <div class="mb-3">
                            <label class="form-label" for="data_relatorio">
                                Data do Relatório *
                            </label>
                            <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}" required>
                        </div>
                        <!-- Auto-preenchimento do Projeto (se selecionado) -->
                        {% if selected_project %}
                        <div class="alert alert-info mobile-project-info" role="alert">
                            <div class="row align-items-center">
                                <div class="col-md-1 col-2 text-center">
                                    <i class="fas fa-info-circle fa-2x"></i>
                                </div>
                                <div class="col-md-11 col-10">
                                    <h6 class="mb-2 fw-bold">
                                        <i class="fas fa-building me-2"></i>Projeto Pré-selecionado
                                    </h6>
                                    <div class="project-auto-info">
                                        <p class="mb-1"><strong>{{ selected_project.numero }} - {{ selected_project.nome }}</strong></p>
                                        {% if selected_project.endereco %}
                                        <p class="mb-1"><small class="text-success">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ selected_project.endereco }}
                                        </small></p>
                                        {% else %}
                                        <p class="mb-1"><small class="text-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Endereço não cadastrado — preencha para continuar
                                        </small></p>
                                        {% endif %}
                                        <p class="mb-0"><small class="text-muted">
                                            <i class="fas fa-building me-1"></i>{{ selected_project.construtora }} - {{ selected_project.nome_funcionario }}
                                        </small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Informações Básicas - Ocultar quando vier de projeto específico -->
                        {% if not selected_project %}
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">Título do Relatório *</label>
                                    <input type="text" name="titulo" id="titulo" class="form-control" 
                                           value="Relatório de visita" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    <select name="projeto_id" id="projeto_id" class="form-control" required onchange="carregarFuncionariosEmails(); carregarCategoriasProjeto(this.value); atualizarNumeroRelatorio(this.value); carregarChecklistProjeto(this.value);">
                                        <option value="">Selecione um projeto</option>
                                        {% for projeto in projetos %}
                                        <option value="{{ projeto.id }}">
                                            {{ projeto.numero }} - {{ projeto.nome }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Campos ocultos quando projeto pré-selecionado -->
                        <input type="hidden" name="titulo" value="Relatório - {{ selected_project.nome }}">
                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                        {% endif %}

                        <!-- Número do Relatório -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="numero">
                                        Número do Relatório
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" 
                                           title="O número é gerado automaticamente, mas você pode editá-lo se necessário"></i>
                                    </label>
                                    {% if existing_report %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               value="{{ existing_report.numero }}" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>O número não pode ser alterado após a criação
                                        </small>
                                    {% elif next_numero %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               value="{{ next_numero }}" placeholder="REL-0001">
                                        <small class="form-text text-muted">
                                            <i class="fas fa-pencil-alt me-1"></i>Número pré-preenchido automaticamente - editável antes de salvar
                                        </small>
                                    {% else %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               placeholder="Selecione uma obra para gerar o número" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-exclamation-circle me-1"></i>Selecione uma obra primeiro
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Acompanhantes da Visita -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user-friends me-2"></i>👥 Acompanhantes da Visita
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalAcompanhantes()">
                                            <i class="fas fa-plus me-1"></i>Adicionar Acompanhante
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="lista-acompanhantes">
                                            <p class="text-muted text-center py-3">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Nenhum acompanhante adicionado ainda. Clique em "Adicionar Acompanhante" para começar.
                                            </p>
                                        </div>
                                        <input type="hidden" id="acompanhantes-data" name="acompanhantes" value="[]">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nota: O aprovador é definido automaticamente pelo sistema -->
                        <!-- Aprovador Temporário do projeto (se configurado) ou Aprovador Global -->

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Fundação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observações sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Vedação
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observações sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instalações (Elétrica/Hidráulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observações sobre instalações..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observações sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organização
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observações sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Lembrete da Última Visita -->
                        {% if lembrete_anterior %}
                        <div class="alert alert-warning border-warning mb-4" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-sticky-note me-2"></i>Lembrete da última visita ({{ lembrete_anterior.numero }})
                            </h6>
                            <hr>
                            <p class="mb-0">{{ lembrete_anterior.texto }}</p>
                        </div>
                        {% endif %}

                        <!-- Observações Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observações Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4" 
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Lembrete para Próxima Visita -->
                        <div class="mb-4">
                            <label class="form-label" for="lembrete_proxima_visita">
                                <i class="fas fa-bell me-2"></i>Lembrete para Próxima Visita (Opcional)
                            </label>
                            <textarea class="form-control" name="lembrete_proxima_visita" id="lembrete_proxima_visita" rows="3" 
                                    placeholder="Deixe um lembrete ou ponto de atenção para a próxima visita a esta obra..."></textarea>
                            <small class="text-muted">Este lembrete será exibido automaticamente no próximo relatório desta obra.</small>
                        </div>

                        <!-- Sistema de Fotos Mobile-First -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (Até 200 fotos) <span id="photoCount" class="badge bg-primary ms-2">0</span></h5>

                            <!-- Botões Fixos de Câmera e Galeria (Mobile-First) -->
                            <div class="fixed-photo-buttons sticky-top bg-white p-3 mb-3 border rounded" style="z-index: 10;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-primary w-100 mobile-photo-btn" 
                                                id="mobileCameraBtn" onclick="mobileCaptureFromCamera()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-camera fa-lg mb-1"></i>
                                                <small>Câmera</small>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-success w-100 mobile-photo-btn" 
                                                id="mobileGalleryBtn" onclick="mobileSelectFromGallery()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-images fa-lg mb-1"></i>
                                                <small>Galeria</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="mobilePhotoInput" class="form-control" multiple accept="image/*" style="display: none;">
                                <input type="file" id="mobileCameraInput" class="form-control" accept="image/*" capture="environment" style="display: none;">
                                <div class="text-center mt-2">
                                    <small class="text-muted"><strong>Máximo 200 fotos - Limite total: 3GB</strong></small>
                                </div>
                            </div>

                            <!-- Preview das Fotos com Cards Mobile-First -->
                            <div id="mobilePhotoCards" class="row g-3"></div>
                            
                            <!-- Quick Action Bar para adicionar mais fotos -->
                            <div id="quickPhotoActions" class="text-center mt-3 p-3 bg-light rounded" style="display: none;">
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <button type="button" class="btn btn-success" onclick="mobileCaptureFromCamera()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-camera me-2"></i>Adicionar da Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="mobileSelectFromGallery()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-images me-2"></i>Adicionar da Galeria
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">Total: <span id="quickPhotoCount">0</span> fotos (máximo 200)</small>
                            </div>
                            
                            <!-- Fotos antigas (mantido para compatibilidade) -->
                            <div id="photoPreview" class="row" style="display: none;"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Concluir relatório
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Retângulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> Círculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>

                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>

                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>

                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edição</button>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let selectedPhotos = [];
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');

    // Event listeners para upload de fotos com error handling
    const photoInput = document.getElementById('photoInput');
    const cameraInput = document.getElementById('cameraInput');

    if (photoInput) {
        photoInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Photo input element not found');
    }

    if (cameraInput) {
        cameraInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Camera input element not found');
    }

    // Event listeners para ferramentas - OTIMIZADO PARA MOBILE
    document.querySelectorAll('.tool-btn').forEach(btn => {
        // Usar touchstart para resposta mais rápida no mobile
        const isMobile = window.innerWidth <= 768;
        const eventType = isMobile ? 'touchstart' : 'click';

        btn.addEventListener(eventType, function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Feedback visual imediato
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);

            // Atualizar ferramentas
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;

            console.log('🔧 Ferramenta selecionada:', currentTool);
        });

        // Prevenir eventos duplicados no mobile
        if (isMobile) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });

    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

// Função para carregar funcionários e e-mails do projeto selecionado
function carregarFuncionariosEmails() {
    const projetoId = document.getElementById('projeto_id').value;
    carregarFuncionariosEmailsPorId(projetoId);
    carregarCategoriasProjeto(projetoId);
}

// Função para atualizar o número do relatório quando o projeto é selecionado
function atualizarNumeroRelatorio(projetoId) {
    const numeroInput = document.getElementById('numero');
    
    if (!projetoId || !numeroInput) {
        return;
    }
    
    // Buscar o próximo número do relatório para este projeto via AJAX
    fetch(`/api/projeto/${projetoId}/next-report-number`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.next_numero) {
            numeroInput.value = data.next_numero;
            numeroInput.readOnly = false;
            console.log(`Número do relatório atualizado para: ${data.next_numero}`);
        }
    })
    .catch(error => {
        console.error('Erro ao buscar próximo número do relatório:', error);
    });
}

function carregarFuncionariosEmailsPorId(projetoId) {
    const funcionariosDiv = document.getElementById('funcionarios-projeto');
    const emailsDiv = document.getElementById('emails-projeto');

    if (!projetoId) {
        funcionariosDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os funcionários disponíveis</p>';
        emailsDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os e-mails disponíveis</p>';
        return;
    }

    // Buscar funcionários e e-mails do projeto via AJAX
    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Renderizar funcionários
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                data.funcionarios.forEach(func => {
                    const checked = func.is_responsavel_principal ? 'checked' : '';
                    funcionariosHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="func_${func.id}" 
                                   name="funcionarios_selecionados[]" value="${func.id}" ${checked}>
                            <label class="form-check-label" for="func_${func.id}">
                                <strong>${func.nome_funcionario}</strong><br>
                                <small class="text-muted">${func.cargo || 'Sem cargo'} - ${func.empresa || 'Sem empresa'}</small>
                                ${func.is_responsavel_principal ? '<span class="badge bg-primary">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                funcionariosHtml = '<p class="text-muted">Nenhum funcionário encontrado para este projeto</p>';
            }
            funcionariosDiv.innerHTML = funcionariosHtml;

            // Renderizar e-mails
            let emailsHtml = '';
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    emailsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_${email.id}" 
                                   name="emails_selecionados[]" value="${email.id}">
                            <label class="form-check-label" for="email_${email.id}">
                                <strong>${email.email}</strong><br>
                                <small class="text-muted">${email.nome_contato} - ${email.cargo || 'Sem cargo'}</small>
                            </label>
                        </div>
                    `;
                });
            } else {
                emailsHtml = '<p class="text-muted">Nenhum e-mail encontrado para este projeto</p>';
            }
            emailsDiv.innerHTML = emailsHtml;
        } else {
            funcionariosDiv.innerHTML = '<p class="text-danger">Erro ao carregar funcionários</p>';
            emailsDiv.innerHTML = '<p class="text-danger">Erro ao carregar e-mails</p>';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        funcionariosDiv.innerHTML = '<p class="text-danger">Erro de conexão</p>';
        emailsDiv.innerHTML = '<p class="text-danger">Erro de conexão</p>';
    });
}

function handlePhotoUpload(event) {
    // Upload de fotos iniciado

    const files = event.target.files;
    // Processando arquivos selecionados

    if (files.length + selectedPhotos.length > 200) {
        alert('Máximo de 200 fotos permitido.');
        return;
    }

    // Processar cada arquivo
    for (let file of files) {
        if (selectedPhotos.length >= 200) {
            // Limite de fotos atingido
            break;
        }
        // Processando arquivo
        addPhotoPreview(file, '');
    }

    event.target.value = ''; // Reset input
    // Upload concluído
}

// Camera and gallery functions with error handling
function selectFromGallery() {
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    } else {
        console.warn('Photo input element not found');
    }
}

function captureFromCamera() {
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
        cameraInput.click();
    } else {
        console.warn('Camera input element not found');
    }
}

// Remove duplicate updatePhotoInput function (already exists below)

function addPhotoPreview(file, category) {
    // Adicionando preview da foto

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;

        // Criando elemento da foto

        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.setAttribute('data-photo-id', photoId);
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" data-category="${category}">
                <div class="card-body p-2">
                    <!-- Seletor de Legendas -->
                    <select class="form-control form-control-sm mb-2" id="predefined_${photoId}" name="photo_caption_${photoId}" required>
                        <option value="">Selecione uma legenda...</option>
                    </select>
                    <small class="text-muted d-block">Categoria: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openPhotoEditor('${photoId}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('photoPreview').appendChild(photoDiv);

        selectedPhotos.push({
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src
        });

        // Foto adicionada ao array

        loadPredefinedCaptionsForPhoto(photoId, category);
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
    }
}

function loadPredefinedCaptionsForPhoto(photoId, category) {
    const select = document.getElementById(`predefined_${photoId}`);
    if (!select) return;

    select.innerHTML = '<option value="">Carregando legendas...</option>';

    // Carregar direto da API (PostgreSQL)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/legendas?categoria=all', true);
    xhr.timeout = 10000;

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.legendas && data.legendas.length > 0) {
                    select.innerHTML = '<option value="">Selecione uma legenda...</option>';

                    const cats = {
                        'Acabamentos': [],
                        'Estrutural': [],
                        'Geral': [],
                        'Segurança': []
                    };

                    data.legendas.forEach(leg => {
                        if (cats[leg.categoria]) {
                            cats[leg.categoria].push(leg);
                        }
                    });

                    Object.keys(cats).forEach(cat => {
                        if (cats[cat].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = cat + ' (' + cats[cat].length + ' itens)';

                            cats[cat].forEach(legenda => {
                                const option = document.createElement('option');
                                option.value = legenda.texto;
                                option.textContent = legenda.texto;
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">Erro: nenhuma legenda encontrada</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="">Erro: formato inválido</option>';
            }
        } else {
            select.innerHTML = '<option value="">Erro: servidor indisponível</option>';
        }
    };

    xhr.onerror = function() {
        select.innerHTML = '<option value="">Erro: falha de rede</option>';
    };

    xhr.ontimeout = function() {
        select.innerHTML = '<option value="">Erro: tempo esgotado</option>';
    };

    xhr.send();
}

// Mapear categoria da foto para categoria da legenda
function mapCategoryToLegenda(photoCategory) {
    const mapping = {
        'Geral': 'Geral',
        'Estrutura': 'Estrutural', 
        'Acabamento': 'Acabamentos',
        'Instalações': 'Elétrica',
        'Problema': 'Segurança'
    };
    return mapping[photoCategory] || 'Geral';
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();

    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;" 
                   name="custom_item_${itemId}" placeholder="Digite o item do checklist..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end" 
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observações..." rows="2"></textarea>
    `;

    checklistItems.appendChild(itemDiv);
}

// Marcar checklist como concluído
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    }
});

// Sistema Fabric.js Photo Editor - Exatamente como no Express
function openPhotoEditor(photoId) {
    try {
        // Abrindo editor para foto

        const card = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (!card) {
            console.error(`❌ Card não encontrado para foto: ${photoId}`);
            return;
        }

        const img = card.querySelector('img');
        if (!img || !img.src) {
            console.error(`❌ Imagem não encontrada para foto: ${photoId}`);
            return;
        }

        // Callback para salvar a foto editada (definir primeiro)
        const saveCallback = async (data) => {
            // Salvando foto editada

            // Atualizar preview da foto no card
            img.src = data.imageData;
            img.dataset.edited = 'true';
            img.dataset.legend = data.legend;

            // Marcar visualmente como editada
            card.classList.add('edited');

            // Adicionar badge de editado se não existir
            if (!card.querySelector('.edited-badge')) {
                const badge = document.createElement('div');
                badge.className = 'edited-badge';
                badge.innerHTML = '<i class="fas fa-edit"></i> Editado';
                card.appendChild(badge);
            }

            // Foto salva com sucesso
        };

        // Verificar se o editor modal está disponível  
        if (!window.fabricPhotoEditorModal) {
            console.error('❌ Editor modal não inicializado');

            // Verificar se as dependências estão carregadas
            if (typeof fabric === 'undefined') {
                alert('Fabric.js não está carregado. Recarregue a página.');
                return;
            }

            if (typeof bootstrap === 'undefined') {
                alert('Bootstrap não está carregado. Recarregue a página.');
                return;
            }

            if (typeof FabricPhotoEditor === 'undefined') {
                alert('Editor de fotos não está carregado. Recarregue a página.');
                return;
            }

            // Tentar inicializar o editor modal
            if (typeof initFabricPhotoEditorModal === 'function') {
                // Tentando inicializar editor modal
                initFabricPhotoEditorModal();

                // Aguardar um momento para o editor ser inicializado
                setTimeout(() => {
                    if (window.fabricPhotoEditorModal) {
                        console.log('✅ Editor inicializado com sucesso');
                        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
                    } else {
                        console.error('❌ Falha ao inicializar editor após tentativa');
                        alert('Editor de fotos não pode ser carregado. Recarregue a página.');
                    }
                }, 500);
                return;
            }
        }

        // Editor disponível, abrir diretamente
        console.log('✅ Abrindo editor');
        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);

    } catch (error) {
        console.error('❌ Erro ao abrir editor:', error);
        alert('Erro ao abrir editor de fotos. Tente novamente.');
    }
}

// Função para auto-scroll centralizado
function scrollToEditorCenter() {
    console.log('🎨 Executando auto-scroll para centro do editor');

    const modal = document.getElementById('fabricPhotoEditorModal');
    if (!modal) {
        console.log('⚠️ Modal não encontrado');
        return;
    }

    const canvasContainer = modal.querySelector('.canvas-container');
    if (!canvasContainer) {
        console.log('⚠️ Canvas container não encontrado');
        return;
    }

    try {
        // Scroll suave para o centro do canvas
        canvasContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });

        // Centralizar o scroll na janela também
        window.scrollTo({
            top: window.innerHeight / 4,
            behavior: 'smooth'
        });

        console.log('✅ Auto-scroll executado com sucesso');
    } catch (error) {
        console.error('❌ Erro no auto-scroll:', error);
    }
}

// Nova função para atualizar foto do Fabric Editor
function updatePhotoFromFabricEditor(photoId, editedImageData) {
    console.log('💾 Atualizando foto editada:', photoId);

    // Buscar elemento da foto diretamente pelo ID
    const photoElement = document.getElementById(photoId);
    if (!photoElement) {
        console.error('❌ Elemento da foto não encontrado:', photoId);
        return;
    }

    // Atualizar imagem no preview
    const img = photoElement.querySelector('.photo-preview');
    if (img && editedImageData.imageData) {
        img.src = editedImageData.imageData;
        console.log('✅ Imagem do preview atualizada');

        // Também atualizar onclick para manter funcionalidade
        img.setAttribute('onclick', `editPhoto('${photoId}', '${editedImageData.imageData}', '${img.getAttribute('data-category') || 'Geral'}')`);
    }

    // Atualizar também em selectedPhotos se existir
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.annotatedSrc = editedImageData.imageData;
        console.log('✅ Dados da foto atualizados em selectedPhotos');
    }

    // Adicionar indicador visual de foto editada
    const card = photoElement.querySelector('.card');
    if (card && !card.classList.contains('border-success')) {
        card.classList.add('border-success', 'border-2');

        // Remover indicador anterior se existir
        const oldIndicator = card.querySelector('.edit-indicator');
        if (oldIndicator) oldIndicator.remove();

        const indicator = document.createElement('small');
        indicator.className = 'text-success fw-bold edit-indicator d-block mt-1';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Editada';
        photoElement.querySelector('.card-body').appendChild(indicator);
        console.log('✅ Indicador visual adicionado');
    }

    console.log('✅ Foto atualizada com sucesso');
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;

    if (currentTool === 'text') {
        const text = prompt('Digite o texto:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }

    // Para caneta, começar o path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';

    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;

    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }

    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;

        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version

        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        editButton.innerHTML = '<i class="fas fa-check"></i> Editada';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Função para criar relatório inicial em preenchimento
async function createInitialReport() {
    const formData = new FormData(document.getElementById('reportForm'));
    
    try {
        const response = await fetch('{{ url_for("create_report") }}', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success && result.report_id) {
            console.log('✅ Relatório inicial criado:', result.report_id);
            return result.report_id;
        } else {
            throw new Error(result.error || 'Erro ao criar relatório');
        }
    } catch (error) {
        console.error('❌ Erro ao criar relatório inicial:', error);
        throw error;
    }
}

// Submissão do formulário
document.getElementById('reportForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission

    // CRÍTICO: Se há currentReportId, garantir que edit_report_id está no form
    // Isso previne duplicação - sempre ATUALIZA o relatório existente
    if (window.currentReportId) {
        // Adicionar ou atualizar campo edit_report_id no formulário
        let editField = this.querySelector('input[name="edit_report_id"]');
        if (!editField) {
            editField = document.createElement('input');
            editField.type = 'hidden';
            editField.name = 'edit_report_id';
            this.appendChild(editField);
        }
        editField.value = window.currentReportId;
        console.log('✅ edit_report_id adicionado ao form:', window.currentReportId);
        
        // Adicionar flag para finalizar após salvar
        let finalizeField = this.querySelector('input[name="should_finalize"]');
        if (!finalizeField) {
            finalizeField = document.createElement('input');
            finalizeField.type = 'hidden';
            finalizeField.name = 'should_finalize';
            this.appendChild(finalizeField);
        }
        finalizeField.value = 'true';
        console.log('✅ Flag should_finalize adicionada ao form');
    }

    // Create FormData object for proper file handling
    const formData = new FormData(this);

    // Coletar dados do checklist
    const checklistData = [];
    document.querySelectorAll('.checklist-item').forEach(item => {
        const checkbox = item.querySelector('.form-check-input[type="checkbox"]');
        const label = item.querySelector('.form-check-label');
        const customInput = item.querySelector('input[type="text"]');
        const textarea = item.querySelector('textarea');

        if (checkbox) {
            const itemText = label ? label.textContent.trim() : (customInput ? customInput.value : '');
            if (itemText) {
                checklistData.push({
                    item: itemText,
                    completed: checkbox.checked,
                    observations: textarea ? textarea.value : ''
                });
            }
        }
    });

    // Add checklist data
    formData.append('checklist_data', JSON.stringify(checklistData));

    // Add photo files and metadata
    selectedPhotos.forEach((photo, index) => {
        // Add the actual file
        formData.append(`photo_${index}`, photo.file);

        // Add photo metadata
        formData.append(`photo_category_${index}`, photo.category);

        const caption = document.querySelector(`select[name="photo_caption_${photo.id}"]`);
        if (caption && caption.value) {
            formData.append(`photo_caption_${index}`, caption.value);
        }

        // Add edited photo data if exists
        if (photo.editedSrc) {
            formData.append(`edited_photo_${index}`, photo.editedSrc);
        }
    });

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitBtn.disabled = true;

    // Submit via fetch
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        } else {
            return response.json().then(err => Promise.reject(err));
        }
    })
    .then(data => {
        if (data.success) {
            alert('Relatório salvo com sucesso!');
            window.location.href = data.redirect || '/reports';
        } else {
            throw new Error(data.error || 'Erro ao salvar relatório');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao salvar relatório. Tente novamente.');
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// FUNÇÃO DUPLICADA REMOVIDA - usar apenas a versão otimizada para mobile

// FUNÇÃO DUPLICADA REMOVIDA - usar apenas a versão do início do arquivo

// Função para alternar checkbox e mostrar/ocultar campo de observações
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsField = document.getElementById(`obs_${itemId}`);
    const parentItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        if (obsField) {
            obsField.style.display = 'block';
        }
        if (parentItem) {
            parentItem.classList.add('completed');
        }
    } else {
        if (obsField) {
            obsField.style.display = 'none';
        }
        if (parentItem) {
            parentItem.classList.remove('completed');
        }
    }
}

// Função para alternar estado do checklist item
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsSection = document.getElementById(`obs_${itemId}`);
    const checklistItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        // Marcar como completo
        checklistItem.classList.add('completed');
        // Mostrar campo de observações
        if (obsSection) {
            obsSection.style.display = 'block';
        }
    } else {
        // Desmarcar como completo
        checklistItem.classList.remove('completed');
        // Ocultar campo de observações
        if (obsSection) {
            obsSection.style.display = 'none';
            // Limpar observações se desejar
            const textarea = obsSection.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }
}

// Carregar checklist do projeto (personalizado ou padrão)
function carregarChecklistProjeto(projetoId) {
    const container = document.getElementById('checklistItems');
    
    if (!projetoId) {
        container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
        return;
    }
    
    container.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando checklist...</p>';
    
    fetch(`/api/projeto/${projetoId}/checklist`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.checklist && data.checklist.length > 0) {
                container.innerHTML = '';
                
                // Mostrar tipo de checklist
                if (data.tipo === 'personalizado') {
                    const badge = document.createElement('div');
                    badge.className = 'alert alert-success mb-3';
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> <strong>Checklist Personalizado da Obra</strong>';
                    container.appendChild(badge);
                }

                data.checklist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item mb-3';
                    itemDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="check_${item.id}" onchange="toggleChecklistItem(this)">
                                <label class="form-check-label" for="check_${item.id}">
                                    ${item.texto}
                                </label>
                            </div>
                        </div>
                        <div class="mt-2" style="display: none;" id="obs_${item.id}">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="Observações (opcional)..." name="obs_${item.id}"></textarea>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                console.log(`✅ ${data.checklist.length} itens do checklist carregados (tipo: ${data.tipo})`);
            } else {
                container.innerHTML = '<p class="text-muted">Nenhum item no checklist. <a href="/admin/checklist-padrao">Configurar checklist</a></p>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar checklist:', error);
            container.innerHTML = `<p class="text-danger">Erro ao carregar checklist. <a href="#" onclick="carregarChecklistProjeto(${projetoId})">Tentar novamente</a></p>`;
        });
}

// Manter compatibilidade com código antigo
function carregarChecklistPadrao() {
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        carregarChecklistProjeto(projetoSelect.value);
    } else {
        const container = document.getElementById('checklistItems');
        container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
    }
}

// Inicializar sistema ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    // Auto-carregar dados do projeto se pre-selecionado
    {% if disable_fields and preselected_project_id %}
    // Para projeto pré-selecionado com campos desabilitados
    console.log('🏗️ Projeto pré-selecionado detectado (campos desabilitados):', {{ preselected_project_id }});
    carregarFuncionariosEmailsPorId({{ preselected_project_id }});
    carregarChecklistProjeto({{ preselected_project_id }});
    atualizarNumeroRelatorio({{ preselected_project_id }});
    {% else %}
    // Para projeto selecionado normalmente
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        console.log('🏗️ Projeto pré-selecionado detectado:', projetoSelect.value);
        carregarFuncionariosEmails();
        carregarChecklistProjeto(projetoSelect.value);
        atualizarNumeroRelatorio(projetoSelect.value);
    } else {
        // Se não há projeto selecionado, mostrar mensagem
        const container = document.getElementById('checklistItems');
        if (container) {
            container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
        }
    }
    {% endif %}

    // Inicializar editor modal Fabric.js - exatamente como no Express
    if (typeof initFabricPhotoEditorModal === 'function') {
        initFabricPhotoEditorModal();
        console.log('✅ Editor modal inicializado');
    } else {
        console.error('❌ Editor modal não disponível');
    }
    
    // Criar relatório inicial e ativar auto save após preencher dados básicos
    let autoSaveInitialized = false;
    
    // Função para inicializar auto save quando houver dados suficientes
    function tryInitializeAutoSave() {
        if (autoSaveInitialized) return;
        
        const titulo = document.getElementById('titulo').value;
        const projetoId = document.getElementById('projeto_id').value;
        
        if (titulo && projetoId) {
            console.log('📝 Dados básicos preenchidos, criando relatório inicial...');
            
            // Criar relatório inicial
            createInitialReport().then(reportId => {
                window.currentReportId = reportId;
                
                // Inicializar auto save
                if (typeof initAutoSave === 'function') {
                    window.autoSaveInstance = initAutoSave(reportId, {
                        interval: 10000, // 10 segundos
                        statusElement: document.getElementById('autosave-status'),
                        form: document.getElementById('reportForm')
                    });
                    
                    autoSaveInitialized = true;
                    console.log('✅ Auto save ativado para relatório', reportId);
                } else {
                    console.error('❌ Função initAutoSave não encontrada');
                }
            }).catch(error => {
                console.error('❌ Erro ao criar relatório inicial:', error);
            });
        }
    }
    
    // Observar mudanças nos campos básicos
    const tituloField = document.getElementById('titulo');
    const projetoField = document.getElementById('projeto_id');
    
    if (tituloField) {
        tituloField.addEventListener('blur', tryInitializeAutoSave);
    }
    
    if (projetoField) {
        projetoField.addEventListener('change', tryInitializeAutoSave);
    }
});

</script>

<!-- Fabric.js CDN - Exatamente como no Express -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Editor Scripts - Exatamente como no Express -->
<script src="{{ url_for('static', filename='js/fabric-photo-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/fabric-photo-editor-modal.js') }}"></script>

<!-- Modal do Editor de Fotos Professional - Exatamente como no Express -->
<div class="modal fade" id="fabricPhotoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editor de Fotos Professional
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-0" style="height: calc(100vh - 160px);">
                <div class="fabric-editor-container" style="height: 100%;">
                    <!-- Área principal do editor -->
                    <div class="fabric-editor-main" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Container do canvas -->
                        <div class="canvas-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa;">
                            <div class="canvas-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); overflow: hidden;">
                                <canvas id="fabricModalCanvas"></canvas>
                            </div>
                        </div>

                        <!-- Toolbar de ferramentas -->
                        <div class="fabric-toolbar" style="background: white; border-top: 1px solid #e1e5e9; padding: 16px;">
                            <!-- Ferramentas principais -->
                            <div class="tool-group mb-3">
                                <h6 class="text-muted mb-2">Ferramentas</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="fabric-tool-btn active" data-modal-tool="select" title="Seleção">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="brush" title="Pincel">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="arrow" title="Seta">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="circle" title="Círculo">
                                        <i class="far fa-circle"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="rectangle" title="Retângulo">
                                        <i class="far fa-square"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="text" title="Texto">
                                        <i class="fas fa-font"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Propriedades -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Cor:</label>
                                    <input type="color" id="modal-color-picker" class="form-control form-control-color" value="#FF0000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Espessura:</label>
                                    <input type="range" id="modal-stroke-width" class="form-range" min="1" max="20" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Legenda:</label>
                                    <input type="text" id="modal-custom-legend" class="form-control" placeholder="Digite uma legenda...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="window.fabricPhotoEditorModal?.clear()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
                <button type="button" class="btn btn-warning" onclick="window.fabricPhotoEditorModal?.undo()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn btn-success" id="modal-save-btn">
                    <i class="fas fa-check"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos do modal do editor - Exatamente como no Express */
.fabric-tool-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 8px;
    color: #4b5563;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fabric-tool-btn:hover {
    background: #e5e7eb;
}

.fabric-tool-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
}

/* Indicador visual de foto editada */
.photo-container.edited {
    position: relative;
}

.edited-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    z-index: 10;
}

.edit-photo-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    border: none;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.edit-photo-btn:hover {
    background: #3b82f6;
    transform: scale(1.1);
}

/* Responsivo mobile */
@media (max-width: 768px) {
    .fabric-toolbar {
        max-height: 40vh;
        overflow-y: auto;
    }

    .fabric-tool-btn {
        min-width: 40px;
        min-height: 40px;
    }

    /* MOBILE: Otimizações específicas para legendas pré-definidas */
    select[name^="photo_caption_"], 
    select[id^="predefined_"] {
        font-size: 16px !important;
        min-height: 48px !important;
        padding: 12px !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        background: white !important;
        display: block !important;
        width: 100% !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
        appearance: menulist !important;
    }

    /* Grupos de opções visíveis */
    optgroup {
        font-weight: bold !important;
        color: #007bff !important;
        font-size: 15px !important;
        padding: 4px !important;
    }

    option {
        font-size: 14px !important;
        padding: 8px !important;
        color: #333 !important;
        background: white !important;
    }

    /* Cards de fotos otimizados */
    .card-body.p-2 {
        padding: 16px !important;
    }

    /* Texto de categoria mais visível */
    .text-muted {
        font-size: 14px !important;
        color: #555 !important;
        font-weight: 600 !important;
    }
}
</style>

<script>
// Sistema de touch inteligente IGUAL AO EXPRESS - funcional 100%
document.addEventListener('DOMContentLoaded', function() {
    console.log('🎯 Sistema de touch inteligente carregado (igual express)');
    
    // Configurações EXATAS do Express
    const TOUCH_THRESHOLD = 10; // pixels
    const TOUCH_TIME_LIMIT = 500; // ms
    
    let touchData = {
        startX: 0,
        startY: 0,
        startTime: 0,
        isDragging: false,
        element: null
    };
    
    // Função para seleção de categoria IDÊNTICA ao Express
    function selectPhotoCategory(category, element) {
        // Remover seleção anterior
        document.querySelectorAll('.photo-category').forEach(cat => {
            cat.classList.remove('selected');
        });
        
        // Adicionar seleção atual
        element.classList.add('selected');
        
        // Feedback tátil
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
        
        console.log('📷 Categoria selecionada:', category);
    }
    
    // Event listeners para categorias - CÓDIGO EXATO DO EXPRESS
    document.querySelectorAll('.photo-category').forEach(categoryElement => {
        
        // Touch Start
        categoryElement.addEventListener('touchstart', function(e) {
            console.log('👆 TouchStart categoria');
            
            const touch = e.touches[0];
            touchData.startX = touch.clientX;
            touchData.startY = touch.clientY;
            touchData.startTime = Date.now();
            touchData.isDragging = false;
            touchData.element = categoryElement;
            
            // Feedback visual imediato
            categoryElement.classList.add('touching');
        }, { passive: true });
        
        // Touch Move
        categoryElement.addEventListener('touchmove', function(e) {
            if (!touchData.element) return;
            
            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchData.startX);
            const deltaY = Math.abs(touch.clientY - touchData.startY);
            const totalDelta = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            
            // Se movimento exceder threshold, marcar como drag
            if (totalDelta > TOUCH_THRESHOLD) {
                touchData.isDragging = true;
                categoryElement.classList.remove('touching');
                console.log('🔄 Movimento detectado - modo drag ativado');
            }
        }, { passive: true });
        
        // Touch End
        categoryElement.addEventListener('touchend', function(e) {
            console.log('👆 TouchEnd categoria');
            
            // Remover feedback visual
            categoryElement.classList.remove('touching');
            
            if (!touchData.element) return;
            
            const touchDuration = Date.now() - touchData.startTime;
            
            // Apenas selecionar se foi um tap rápido e sem movimento
            if (!touchData.isDragging && touchDuration < TOUCH_TIME_LIMIT) {
                e.preventDefault();
                e.stopPropagation();
                
                const category = categoryElement.getAttribute('data-category');
                selectPhotoCategory(category, categoryElement);
                
                console.log('✅ Tap válido - categoria selecionada');
            } else {
                console.log('❌ Drag detectado - não selecionar categoria');
            }
            
            // Reset
            touchData.element = null;
            touchData.isDragging = false;
        }, { passive: false });
        
        // Mouse events para desktop (fallback)
        categoryElement.addEventListener('click', function(e) {
            // Apenas processar se não houve toque recente
            if (touchData.startTime && (Date.now() - touchData.startTime) < 300) {
                return; // Ignorar click após touch
            }
            
            e.preventDefault();
            e.stopPropagation();
            
            const category = categoryElement.getAttribute('data-category');
            selectPhotoCategory(category, categoryElement);
            
            console.log('🖱️ Click desktop - categoria selecionada');
        });
    });
    
    console.log('✅ Sistema de touch inteligente ativo para', document.querySelectorAll('.photo-category').length, 'categorias');
});

// Função global para compatibilidade - integrada com sistema de touch
window.selectPhotoCategory = function(category, element) {
    if (!element) {
        element = document.querySelector(`[data-category="${category}"]`);
    }

    if (element) {
        // Usar a função interna que já tem toda a lógica
        const selectEvent = new CustomEvent('selectCategory', { 
            detail: { category: category, element: element } 
        });
        document.dispatchEvent(selectEvent);
    }
};
</script>

<!-- Auto Save Script -->
<!-- Sistema de autosave antigo desabilitado para evitar conflitos -->
<!-- <script src="{{ url_for('static', filename='js/autosave.js') }}"></script> -->
<script>
// Inicializar Auto Save apenas se estivermos editando um relatório existente
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se temos um ID de relatório para auto save
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('report_id') || document.querySelector('input[name="report_id"]')?.value;
    
    if (reportId) {
        // Inicializar auto save
        const autoSave = initAutoSave(reportId, {
            interval: 10000, // 10 segundos
            statusElement: document.getElementById('autosave-status'),
            form: document.getElementById('reportForm')
        });
        
        console.log('Auto Save ativado para relatório', reportId);
        
        // Modificar o comportamento do botão de finalizar
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                // Parar auto save antes de finalizar
                autoSave.stop();
                
                // Salvar uma última vez e depois prosseguir
                autoSave.saveNow().then(() => {
                    // Alterar status para finalizado
                    const statusBadge = document.querySelector('.badge.bg-warning');
                    if (statusBadge) {
                        statusBadge.innerHTML = '<i class="fas fa-check me-1"></i>Finalizando...';
                        statusBadge.classList.remove('bg-warning');
                        statusBadge.classList.add('bg-success');
                    }
                });
            });
        }
    }
});
</script>

<!-- Mobile-First Photo System JavaScript -->
<script>
// Global variables for mobile photo system
let mobilePhotoCounter = 0;
let predefinedLegendas = [];
let mobilePhotoData = [];

// Load predefined captions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPredefinedLegendas();
    setupMobilePhotoSystem();
});

// Load predefined captions from API
async function loadPredefinedLegendas() {
    try {
        console.log('📋 Carregando legendas predefinidas...');
        const response = await fetch('/api/legendas?categoria=all');
        const data = await response.json();
        
        if (data.success) {
            predefinedLegendas = data.legendas;
            console.log(`✅ ${predefinedLegendas.length} legendas carregadas`);
        }
    } catch (error) {
        console.error('❌ Erro ao carregar legendas:', error);
    }
}

// Setup mobile photo system
function setupMobilePhotoSystem() {
    console.log('📱 Configurando sistema de fotos mobile-first...');
    
    // Setup file input event listeners
    const mobilePhotoInput = document.getElementById('mobilePhotoInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');
    
    if (mobilePhotoInput) {
        mobilePhotoInput.addEventListener('change', handleMobilePhotoSelection);
    }
    
    if (mobileCameraInput) {
        mobileCameraInput.addEventListener('change', handleMobilePhotoSelection);
    }
}

// Mobile gallery selection
function mobileSelectFromGallery() {
    console.log('📸 Selecionando da galeria (mobile)...');
    const input = document.getElementById('mobilePhotoInput');
    if (input) {
        input.click();
    }
}

// Mobile camera capture
function mobileCaptureFromCamera() {
    console.log('📷 Capturando da câmera (mobile)...');
    const input = document.getElementById('mobileCameraInput');
    if (input) {
        input.click();
    }
}

// Handle photo selection from mobile inputs
function handleMobilePhotoSelection(event) {
    console.log('📋 Processando fotos selecionadas...');
    const files = event.target.files;
    
    if (files.length === 0) return;
    
    Array.from(files).forEach(file => {
        createMobilePhotoCard(file, '');
    });
    
    // Clear input for next selection
    event.target.value = '';
}

// Create mobile photo card with immediate display
function createMobilePhotoCard(file, category) {
    const photoId = 'mobile_photo_' + (++mobilePhotoCounter);
    const reader = new FileReader();
    
    reader.onload = function(e) {
        const photoCard = createPhotoCardHTML(photoId, e.target.result, category, file.name);
        
        // Add to DOM
        const container = document.getElementById('mobilePhotoCards');
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-lg-4';
        cardCol.innerHTML = photoCard;
        container.appendChild(cardCol);
        
        // Store photo data
        mobilePhotoData.push({
            id: photoId,
            file: file,
            category: category,
            local: '',
            manualCaption: '',
            predefinedCaption: '',
            filename: file.name
        });
        
        // Update counter after adding photo
        updatePhotoCounter();
        
        // Setup event listeners for this card
        setupPhotoCardEvents(photoId);
        
        // Immediately scroll to the new photo and focus on caption for better UX
        setTimeout(() => {
            const newCard = cardCol.querySelector('.mobile-photo-card');
            if (newCard) {
                newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Auto-focus on caption input for immediate editing
                const captionInput = newCard.querySelector('.caption-input');
                if (captionInput) {
                    setTimeout(() => {
                        captionInput.focus();
                        captionInput.select();
                    }, 600);
                }
            }
        }, 300);
        
        console.log(`📷 Foto adicionada: ${file.name} (${category})`);
    };
    
    reader.readAsDataURL(file);
}

// Create photo card HTML
function createPhotoCardHTML(photoId, imageSrc, category, filename) {
    const legendaSelectHTML = createLegendaSelectHTML(photoId);
    
    return `
        <div class="mobile-photo-card enhanced" data-photo-id="${photoId}" style="border: 2px solid #007bff; border-radius: 12px; padding: 12px; background: white; box-shadow: 0 4px 12px rgba(0,123,255,0.15); margin-bottom: 16px;">
            <!-- Layout Vertical: IMAGEM EM CIMA -->
            <div class="text-center mb-3">
                <img src="${imageSrc}" 
                     alt="${filename}" 
                     data-photo-id="${photoId}"
                     style="width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef; cursor: pointer;">
            </div>
            
            <!-- Categoria (Seleção dentro do card) -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">📁 Categoria *</label>
                <select class="form-select form-select-sm categoria-select" 
                        id="category_${photoId}" 
                        data-photo-id="${photoId}"
                        required
                        style="border: 2px solid #007bff; font-size: 13px;">
                    <option value="">${category ? category : 'Selecione...'}</option>
                </select>
            </div>
            
            <!-- Local (novo campo obrigatório) -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">📍 Local *</label>
                <input type="text" 
                       class="form-control form-control-sm local-input" 
                       id="local_${photoId}" 
                       placeholder="Ex: Sala principal, Fachada norte..."
                       data-photo-id="${photoId}"
                       required
                       style="border: 2px solid #ff9800; font-size: 13px; padding: 6px;">
            </div>
            
            <!-- Legenda Manual -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">📝 Legenda *</label>
                <input type="text" 
                       class="form-control caption-input" 
                       id="manual_caption_${photoId}" 
                       placeholder="Digite uma legenda..."
                       data-photo-id="${photoId}"
                       required
                       style="border: 2px solid #28a745; font-size: 13px; padding: 6px; background-color: #f8fff9;">
            </div>
            
            <!-- Legenda Pré-definida -->
            <div class="mb-2">
                <select class="form-select form-select-sm caption-select" 
                        id="predefined_caption_${photoId}" 
                        data-photo-id="${photoId}"
                        style="font-size: 12px;">
                    <option value="">📋 Ou escolha uma legenda pré-definida...</option>
                    ${legendaSelectHTML}
                </select>
            </div>
            
            <!-- Status da Legenda -->
            <div class="caption-status pending alert alert-warning py-1 px-2 mb-2" id="caption_status_${photoId}" style="font-size: 12px; margin: 0;">
                ⚠️ Legenda obrigatória - preencha o campo acima
            </div>
            
            <!-- Ações -->
            <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editMobilePhoto('${photoId}')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMobilePhoto('${photoId}')">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
        </div>
    `;
}

// Create legend select HTML
function createLegendaSelectHTML(photoId) {
    let html = '';
    
    // Group legends by category
    const legendsByCategory = {};
    predefinedLegendas.forEach(legenda => {
        if (!legendsByCategory[legenda.categoria]) {
            legendsByCategory[legenda.categoria] = [];
        }
        legendsByCategory[legenda.categoria].push(legenda);
    });
    
    // Create optgroups
    Object.keys(legendsByCategory).forEach(categoria => {
        html += `<optgroup label="${categoria}">`;
        legendsByCategory[categoria].forEach(legenda => {
            html += `<option value="${legenda.texto}">${legenda.texto}</option>`;
        });
        html += `</optgroup>`;
    });
    
    return html;
}

// Setup event listeners for photo card
function setupPhotoCardEvents(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const localInput = document.getElementById(`local_${photoId}`);
    const categorySelect = document.getElementById(`category_${photoId}`);
    
    if (manualInput) {
        manualInput.addEventListener('input', () => savePhotoData(photoId));
        manualInput.addEventListener('blur', () => savePhotoData(photoId));
    }
    
    if (localInput) {
        localInput.addEventListener('input', () => savePhotoData(photoId));
        localInput.addEventListener('blur', () => savePhotoData(photoId));
    }
    
    if (categorySelect) {
        categorySelect.addEventListener('change', () => savePhotoData(photoId));
    }
    
    if (predefinedSelect) {
        predefinedSelect.addEventListener('change', function() {
            if (this.value) {
                // Copy predefined to manual field
                manualInput.value = this.value;
                savePhotoData(photoId);
                
                // Reset select for next use
                setTimeout(() => {
                    this.selectedIndex = 0;
                }, 500);
            }
        });
    }
    
    // Populate category select with available categories
    populateCategorySelect(photoId);
}

// Save photo data (category, local, caption) - Updated function
async function savePhotoData(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const localInput = document.getElementById(`local_${photoId}`);
    const categorySelect = document.getElementById(`category_${photoId}`);
    const statusDiv = document.getElementById(`caption_status_${photoId}`);
    
    const manualCaption = manualInput ? manualInput.value.trim() : '';
    const predefinedCaption = predefinedSelect ? predefinedSelect.value.trim() : '';
    const local = localInput ? localInput.value.trim() : '';
    const category = categorySelect ? categorySelect.value : '';
    
    // Update stored data
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (photoData) {
        photoData.manualCaption = manualCaption;
        photoData.predefinedCaption = predefinedCaption;
        photoData.local = local;
        photoData.category = category;
    }
    
    // Update status indicator
    const hasCaption = manualCaption || predefinedCaption;
    const hasLocal = local.length > 0;
    const hasCategory = category && category !== '';
    
    if (hasCaption && hasLocal && hasCategory) {
        statusDiv.className = 'caption-status complete alert alert-success py-1 px-2 mb-2';
        statusDiv.innerHTML = '✅ Todos os campos preenchidos';
    } else {
        statusDiv.className = 'caption-status pending alert alert-warning py-1 px-2 mb-2';
        let missing = [];
        if (!hasCategory) missing.push('Categoria');
        if (!hasLocal) missing.push('Local');
        if (!hasCaption) missing.push('Legenda');
        statusDiv.innerHTML = `⚠️ Obrigatório: ${missing.join(', ')}`;
    }
    
    console.log(`💾 Photo data saved for ${photoId}: category="${category}", local="${local}", caption="${manualCaption}"`);
}

// Populate category select for a photo card
function populateCategorySelect(photoId) {
    const categorySelect = document.getElementById(`category_${photoId}`);
    const projetoId = document.getElementById('projeto_id')?.value;
    
    if (!categorySelect || !projetoId) return;
    
    // Buscar categorias do projeto via API
    fetch(`/api/projects/${projetoId}/categorias`)
        .then(response => response.json())
        .then(data => {
            if (data.categorias && data.categorias.length > 0) {
                // Renderizar categorias
                let html = '<option value="">Sem categoria</option>';
                data.categorias.forEach(cat => {
                    html += `<option value="${cat.nome}">${cat.nome}</option>`;
                });
                categorySelect.innerHTML = html;
                
                // Set the currently selected value if it exists in photoData
                const photoData = mobilePhotoData.find(p => p.id === photoId);
                if (photoData && photoData.category) {
                    categorySelect.value = photoData.category;
                }
            } else {
                // Nenhuma categoria encontrada
                categorySelect.innerHTML = '<option value="">Sem categoria</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar categorias:', error);
            categorySelect.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

// Keep old function for backward compatibility
async function saveCaptionData(photoId) {
    return savePhotoData(photoId);
}

// Edit mobile photo - RESTAURADO como funcionava antes
function editMobilePhoto(photoId) {
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (!photoData) return;
    
    // Encontrar o elemento img da foto
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    const imgElement = photoCard.querySelector('img');
    
    if (!imgElement) {
        console.error('Imagem não encontrada para edição');
        return;
    }
    
    // Abrir editor modal como funcionava antes
    openPhotoEditorFromElement(imgElement);
}

// Delete mobile photo
function deleteMobilePhoto(photoId) {
    if (!confirm('Deseja excluir esta foto?')) return;
    
    // Remove from data array
    mobilePhotoData = mobilePhotoData.filter(p => p.id !== photoId);
    
    // Remove from DOM
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (photoCard) {
        photoCard.closest('.col-12, .col-md-6, .col-lg-4').remove();
    }
    
    updatePhotoCounter();
    console.log(`🗑️ Foto ${photoId} excluída`);
}

// Update photo counter and show quick actions
function updatePhotoCounter() {
    const count = mobilePhotoData.length;
    
    // Update main counter
    const counter = document.getElementById('photoCount');
    if (counter) {
        counter.textContent = count;
    }
    
    // Update quick action counter
    const quickCounter = document.getElementById('quickPhotoCount');
    if (quickCounter) {
        quickCounter.textContent = count;
    }
    
    // Show quick action bar after first photo
    const quickActionBar = document.getElementById('quickPhotoActions');
    if (quickActionBar) {
        if (count > 0) {
            quickActionBar.style.display = 'block';
        } else {
            quickActionBar.style.display = 'none';
        }
    }
}

// Validate captions before form submission
function validateCaptions() {
    let hasInvalidPhotos = false;
    
    mobilePhotoData.forEach(photoData => {
        const hasCaption = photoData.manualCaption || photoData.predefinedCaption;
        if (!hasCaption) {
            hasInvalidPhotos = true;
            
            // Highlight invalid photo
            const statusDiv = document.getElementById(`caption_status_${photoData.id}`);
            if (statusDiv) {
                statusDiv.className = 'caption-status pending';
                statusDiv.innerHTML = '❌ OBRIGATÓRIO: Adicione uma legenda';
                statusDiv.style.animation = 'pulse 2s infinite';
            }
        }
    });
    
    return !hasInvalidPhotos;
}

// Prepare form data for submission
async function prepareMobilePhotoFormData() {
    console.log('📱 Preparando dados das fotos mobile...');
    
    // Adicionar os arquivos reais ao FormData
    mobilePhotoData.forEach((photoData, index) => {
        console.log(`✅ Adicionando foto ${index}: ${photoData.filename} (${photoData.category})`);
        
        // Criar inputs hidden para metadados
        const categoryInput = document.createElement('input');
        categoryInput.type = 'hidden';
        categoryInput.name = `photo_category_${index}`;
        categoryInput.value = photoData.category;
        
        const captionInput = document.createElement('input');
        captionInput.type = 'hidden';
        captionInput.name = `photo_caption_${index}`;
        captionInput.value = photoData.manualCaption || photoData.predefinedCaption;
        
        // Criar file input para o arquivo real
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = `photo_${index}`;
        fileInput.style.display = 'none';
        
        // Transferir o arquivo para o input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(photoData.file);
        fileInput.files = dataTransfer.files;
        
        // Adicionar ao form
        const form = document.getElementById('reportForm');
        if (form) {
            form.appendChild(categoryInput);
            form.appendChild(captionInput);
            form.appendChild(fileInput);
        }
    });
    
    console.log(`📤 Preparados ${mobilePhotoData.length} fotos com arquivos binários para envio`);
}

// Helper function to convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Form submission validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            // Validate captions
            if (!validateCaptions()) {
                e.preventDefault();
                alert('⚠️ ATENÇÃO: Todas as fotos devem ter pelo menos uma legenda (manual ou pré-definida). Verifique as fotos marcadas em vermelho.');
                
                // Scroll to first invalid photo
                const firstInvalid = document.querySelector('.caption-status.pending');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
            }
            
            // If there are photos, prepare mobile photo data
            if (mobilePhotoData.length > 0) {
                e.preventDefault(); // Prevent default submission while processing photos
                
                console.log('📸 Processando fotos...');
                try {
                    await prepareMobilePhotoFormData();
                    console.log('✅ Fotos preparadas - enviando formulário com arquivos binários...');
                    
                    // Submit the form with the prepared files (native form submission)
                    form.submit();
                } catch (error) {
                    console.error('❌ Erro ao processar fotos:', error);
                    alert('❌ Erro ao processar as fotos. Por favor, tente novamente.');
                    return false;
                }
            } else {
                console.log('✅ Formulário validado sem fotos - enviando...');
            }
        });
    }
});

console.log('📱 Sistema de fotos mobile-first carregado');
</script>

<!-- Modal de Acompanhantes da Visita -->
<div class="modal fade" id="modalAcompanhantes" tabindex="-1" aria-labelledby="modalAcompanhantesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAcompanhantesLabel">
                    <i class="fas fa-user-friends me-2"></i>Adicionar Acompanhante da Visita
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAcompanhante">
                    <!-- Opção de seleção: Funcionário ou Manual -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Acompanhante</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="tipo_acompanhante" id="tipo_funcionario" value="funcionario" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="tipo_funcionario">
                                <i class="fas fa-user-tie me-1"></i>Funcionário da Obra
                            </label>
                            
                            <input type="radio" class="btn-check" name="tipo_acompanhante" id="tipo_externo" value="externo" autocomplete="off">
                            <label class="btn btn-outline-info" for="tipo_externo">
                                <i class="fas fa-user me-1"></i>Externo (Cliente/Visitante)
                            </label>
                        </div>
                    </div>
                    
                    <!-- Seleção de Funcionário -->
                    <div id="selecao-funcionario" class="mb-3">
                        <label for="funcionario-select" class="form-label">Selecionar Funcionário *</label>
                        <select class="form-select" id="funcionario-select">
                            <option value="">Selecione um projeto primeiro...</option>
                        </select>
                        <small class="text-muted">Funcionários cadastrados nesta obra</small>
                    </div>
                    
                    <!-- Entrada Manual -->
                    <div id="entrada-manual" class="d-none">
                        <div class="mb-3">
                            <label for="nome-manual" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome-manual" placeholder="Nome completo do acompanhante">
                        </div>
                        <div class="mb-3">
                            <label for="funcao-acompanhante" class="form-label">Função/Cargo</label>
                            <input type="text" class="form-control" id="funcao-acompanhante" placeholder="Ex: Engenheiro, Cliente, Gerente, etc.">
                            <small class="text-muted">Opcional</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between flex-wrap gap-2">
                <button type="button" class="btn btn-secondary flex-fill" style="min-width: 120px;" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i><span>Cancelar</span>
                </button>
                <button type="button" class="btn btn-success flex-fill" style="min-width: 120px;" onclick="adicionarAcompanhante()">
                    <i class="fas fa-check me-1"></i><span>Adicionar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para Gerenciar Acompanhantes -->
<script>
// Array para armazenar acompanhantes
let acompanhantes = [];

// Alternar entre seleção de funcionário e entrada manual
document.querySelectorAll('input[name="tipo_acompanhante"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const selecaoFunc = document.getElementById('selecao-funcionario');
        const entradaManual = document.getElementById('entrada-manual');
        
        if (this.value === 'funcionario') {
            selecaoFunc.classList.remove('d-none');
            entradaManual.classList.add('d-none');
        } else {
            selecaoFunc.classList.add('d-none');
            entradaManual.classList.remove('d-none');
        }
    });
});

// Carregar funcionários quando projeto for selecionado
document.getElementById('projeto_id')?.addEventListener('change', function() {
    carregarFuncionariosParaAcompanhantes(this.value);
});

// Carregar funcionários da obra
function carregarFuncionariosParaAcompanhantes(projetoId) {
    const select = document.getElementById('funcionario-select');
    
    if (!projetoId) {
        select.innerHTML = '<option value="">Selecione um projeto primeiro...</option>';
        return;
    }
    
    select.innerHTML = '<option value="">Carregando...</option>';
    
    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.funcionarios && data.funcionarios.length > 0) {
            let options = '<option value="">Selecione um funcionário...</option>';
            data.funcionarios.forEach(func => {
                const nome = func.nome_funcionario || 'Sem nome';
                const cargo = func.cargo || 'Não informado';
                options += `<option value="${func.id}" data-nome="${nome}" data-cargo="${cargo}">${nome} – ${cargo}</option>`;
            });
            select.innerHTML = options;
        } else {
            select.innerHTML = '<option value="">Nenhum funcionário cadastrado nesta obra</option>';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar funcionários:', error);
        select.innerHTML = '<option value="">Erro ao carregar funcionários</option>';
    });
}

// Abrir modal
function abrirModalAcompanhantes() {
    const projetoId = document.getElementById('projeto_id')?.value;
    
    if (!projetoId) {
        alert('Por favor, selecione um projeto primeiro!');
        return;
    }
    
    // Carregar funcionários se ainda não foram carregados
    carregarFuncionariosParaAcompanhantes(projetoId);
    
    // Limpar formulário
    document.getElementById('formAcompanhante').reset();
    document.getElementById('tipo_funcionario').checked = true;
    document.getElementById('selecao-funcionario').classList.remove('d-none');
    document.getElementById('entrada-manual').classList.add('d-none');
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalAcompanhantes'));
    modal.show();
}

// Adicionar acompanhante
function adicionarAcompanhante() {
    const tipo = document.querySelector('input[name="tipo_acompanhante"]:checked').value;
    let nome = '';
    let funcao = '';
    let origem = '';
    
    if (tipo === 'funcionario') {
        const select = document.getElementById('funcionario-select');
        const selectedOption = select.options[select.selectedIndex];
        
        if (!select.value) {
            alert('Por favor, selecione um funcionário!');
            return;
        }
        
        nome = selectedOption.getAttribute('data-nome');
        funcao = selectedOption.getAttribute('data-cargo') || '';
        origem = 'Funcionário da obra';
    } else {
        nome = document.getElementById('nome-manual').value.trim();
        funcao = document.getElementById('funcao-acompanhante').value.trim();
        
        if (!nome) {
            alert('Por favor, preencha o nome do acompanhante!');
            return;
        }
        
        origem = 'Inserido manualmente';
    }
    
    // Adicionar ao array
    const acompanhante = {
        nome: nome,
        funcao: funcao,
        origem: origem
    };
    
    acompanhantes.push(acompanhante);
    
    // Atualizar visualização
    atualizarListaAcompanhantes();
    
    // Atualizar campo hidden
    document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);
    
    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalAcompanhantes')).hide();
    
    console.log('✅ Acompanhante adicionado:', acompanhante);
}

// Atualizar lista de acompanhantes
function atualizarListaAcompanhantes() {
    const lista = document.getElementById('lista-acompanhantes');
    
    if (acompanhantes.length === 0) {
        lista.innerHTML = `
            <p class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-1"></i>
                Nenhum acompanhante adicionado ainda. Clique em "Adicionar Acompanhante" para começar.
            </p>
        `;
        return;
    }
    
    let html = '<div class="list-group">';
    acompanhantes.forEach((acomp, index) => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-user me-2 text-primary"></i>
                            <strong>${acomp.nome}</strong>
                        </h6>
                        ${acomp.funcao ? `<p class="mb-1 text-muted"><small><i class="fas fa-briefcase me-1"></i>${acomp.funcao}</small></p>` : ''}
                        <p class="mb-0">
                            <span class="badge bg-${acomp.origem.includes('Funcionário') ? 'info' : 'success'}">
                                ${acomp.origem}
                            </span>
                        </p>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAcompanhante(${index})" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    lista.innerHTML = html;
}

// Remover acompanhante
function removerAcompanhante(index) {
    if (confirm('Deseja remover este acompanhante?')) {
        acompanhantes.splice(index, 1);
        atualizarListaAcompanhantes();
        document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);
        console.log('🗑️ Acompanhante removido. Total:', acompanhantes.length);
    }
}

// Carregar acompanhantes existentes ao editar relatório
{% if existing_report and existing_report.acompanhantes %}
try {
    const acompanhantesExistentes = {{ existing_report.acompanhantes | tojson | safe }};
    if (acompanhantesExistentes && Array.isArray(acompanhantesExistentes)) {
        acompanhantes = acompanhantesExistentes;
        atualizarListaAcompanhantes();
        document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);
        console.log('✅ Acompanhantes carregados:', acompanhantes.length);
    }
} catch (e) {
    console.error('❌ Erro ao carregar acompanhantes existentes:', e);
}
{% endif %}

console.log('✅ Sistema de acompanhantes inicializado');
</script>

<!-- Auto Save Script -->
<script src="{{ url_for('static', filename='js/reports_autosave.js') }}"></script>

{% endblock %}