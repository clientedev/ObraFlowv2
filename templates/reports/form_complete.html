{% extends "base.html" %}

{% block title %}Relat√≥rio de Obra{% endblock %}

{% block head %}
<!-- Meta tag CSRF para auto-save -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block extra_css %}
<style>
.checklist-item {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.checklist-item.completed {
    border-left-color: #28a745;
    background-color: #d4edda;
}

.photo-preview {
    max-width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
}

.photo-category {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 10px;
    margin: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.photo-category.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
}

.photo-category:hover {
    border-color: #007bff;
}

/* Mobile Touch - Sistema inteligente igual ao Express */
    @media (max-width: 768px) {
        /* Categorias de fotos - touch otimizado */
        .photo-category {
            min-height: 60px;
            min-width: 60px;
            touch-action: auto !important;
            -webkit-user-select: none;
            user-select: none;
            cursor: pointer;
            pointer-events: auto !important;
            transition: all 0.15s ease;
        }

        /* Feedback visual do touch - igual Express */
        .photo-category.touching {
            transform: scale(0.95);
            background-color: rgba(0, 123, 255, 0.1);
            border-color: #007bff;
        }

        /* Todos os inputs e controles - intera√ß√£o normal */
        input[type="text"],
        input[type="date"], 
        input[type="file"],
        textarea,
        select,
        .form-control {
            touch-action: auto !important;
            -webkit-user-select: auto;
            user-select: auto;
        }

        /* Containers - scroll completamente livre */
        .container-fluid,
        .row,
        .card-body,
        body,
        html {
            touch-action: auto !important;
            -webkit-overflow-scrolling: touch !important;
            overflow: auto !important;
        }

        /* Data do Relat√≥rio - Design padr√£o */
        .alert.border-primary {
            border-width: 1px !important;
            background: #f8f9fa;
        }

        #data_relatorio {
            font-size: 16px;
            font-weight: 400;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: none;
        }

        #data_relatorio:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    }

    @media (max-width: 768px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
            padding: 12px !important;
        }

        .form-label {
            font-size: 14px !important;
            margin-bottom: 0.5rem !important;
        }

        .alert.border-primary {
            margin-bottom: 1rem !important;
            padding: 1rem !important;
            border-radius: 0.375rem !important;
        }
    }

    @media (max-width: 576px) {
        #data_relatorio {
            font-size: 16px !important;
            min-height: 44px !important;
        }
    }

    /* Mobile-First Photo System Styles */
    .mobile-photo-btn {
        border-radius: 12px !important;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .mobile-photo-btn:hover, .mobile-photo-btn:focus {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .mobile-photo-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .mobile-photo-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }

    .photo-card-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f8f9fa;
    }

    .photo-card-content {
        padding: 16px;
    }

    .caption-input {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        transition: all 0.3s ease;
    }

    .caption-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .caption-select {
        width: 100%;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 16px;
        margin-bottom: 12px;
        min-height: 48px;
        background: white;
        transition: all 0.3s ease;
    }

    .caption-select:focus {
        outline: none;
        border-color: #28a745;
        box-shadow: 0 0 0 3px rgba(40,167,69,0.1);
    }

    .photo-card-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 12px;
    }

    .photo-card-btn {
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 14px;
        min-height: 42px;
        border: 2px solid;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .photo-card-btn.edit {
        background: white;
        color: #007bff;
        border-color: #007bff;
    }

    .photo-card-btn.edit:hover {
        background: #007bff;
        color: white;
    }

    .photo-card-btn.delete {
        background: white;
        color: #dc3545;
        border-color: #dc3545;
    }

    .photo-card-btn.delete:hover {
        background: #dc3545;
        color: white;
    }

    .category-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .photo-count-badge {
        background: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .caption-status {
        font-size: 12px;
        margin-top: 8px;
        padding: 6px 12px;
        border-radius: 6px;
        text-align: center;
    }

    .caption-status.complete {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .caption-status.pending {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .fixed-photo-buttons {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .mobile-photo-card {
            margin-bottom: 20px;
        }

        .photo-card-image {
            height: 160px;
        }

        .photo-card-content {
            padding: 12px;
        }

        .caption-input, .caption-select {
            font-size: 16px !important; /* Prevent zoom on iOS */
        }
    }
</style>
{% endblock %}

{% block content %}
<script>
  const REPORT_DATA = {{ report_data | tojson | safe }};
  const EDIT_MODE = {{ edit_mode | tojson | safe }};
  console.log("üìù Dados carregados para edi√ß√£o:", REPORT_DATA);
</script>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3><i class="fas fa-file-alt"></i> Relat√≥rio de Obra</h3>
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-warning">
                                <i class="fas fa-edit me-1"></i>Em preenchimento
                            </span>
                            <div id="autosave-status"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('create_report') }}" enctype="multipart/form-data" id="reportForm" {% if existing_report %}data-report-id="{{ existing_report.id }}"{% endif %}>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        {% if existing_report %}
                        <input type="hidden" name="edit_report_id" value="{{ existing_report.id }}">
                        {% endif %}
                        {% if selected_project %}
                        <input type="hidden" name="projeto_id" value="{{ selected_project.id }}">
                        {% endif %}

                        <!-- Data do Relat√≥rio -->
                        <div class="mb-3">
                            <label class="form-label" for="data_relatorio">
                                Data do Relat√≥rio *
                            </label>
                            <input type="date" name="data_relatorio" id="data_relatorio" class="form-control" value="{{ today }}" required>
                        </div>

                        <!-- Informa√ß√µes B√°sicas - Sempre mostrar, apenas pr√©-selecionar se vier de projeto espec√≠fico -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="titulo">T√≠tulo do Relat√≥rio *</label>
                                    <input type="text" name="titulo" id="titulo" class="form-control" 
                                           value="{% if existing_report %}{{ existing_report.titulo }}{% else %}Relat√≥rio de visita{% endif %}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="projeto_id">Projeto *</label>
                                    <select name="projeto_id" id="projeto_id" class="form-control" required onchange="carregarFuncionariosEmails(); carregarCategoriasProjeto(this.value); atualizarNumeroRelatorio(this.value); carregarChecklistProjeto(this.value); carregarLembrete(this.value);">
                                        <option value="">Selecione um projeto</option>
                                        {% for projeto in projetos %}
                                        <option value="{{ projeto.id }}" {% if selected_project and selected_project.id == projeto.id %}selected{% endif %}>
                                            {{ projeto.numero }} - {{ projeto.nome }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- N√∫mero do Relat√≥rio -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label" for="numero">
                                        N√∫mero do Relat√≥rio
                                        <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" 
                                           title="O n√∫mero √© gerado automaticamente, mas voc√™ pode edit√°-lo se necess√°rio"></i>
                                    </label>
                                    {% if existing_report %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               value="{{ existing_report.numero }}" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-lock me-1"></i>O n√∫mero n√£o pode ser alterado ap√≥s a cria√ß√£o
                                        </small>
                                    {% elif next_numero %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               value="{{ next_numero }}" placeholder="REL-0001">
                                        <small class="form-text text-muted">
                                            <i class="fas fa-pencil-alt me-1"></i>N√∫mero pr√©-preenchido automaticamente - edit√°vel antes de salvar
                                        </small>
                                    {% else %}
                                        <input type="text" name="numero" id="numero" class="form-control" 
                                               placeholder="Selecione uma obra para gerar o n√∫mero" readonly>
                                        <small class="form-text text-muted">
                                            <i class="fas fa-exclamation-circle me-1"></i>Selecione uma obra primeiro
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Acompanhantes da Visita -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user-friends me-2"></i>üë• Acompanhantes da Visita
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="abrirModalAcompanhantes()">
                                            <i class="fas fa-plus me-1"></i>Adicionar Acompanhante
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div id="lista-acompanhantes">
                                            <p class="text-muted text-center py-3">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Nenhum acompanhante adicionado ainda. Clique em "Adicionar Acompanhante" para come√ßar.
                                            </p>
                                        </div>
                                        <input type="hidden" id="acompanhantes-data" name="acompanhantes" value="[]">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Nota: O aprovador √© definido automaticamente pelo sistema -->
                        <!-- Aprovador Tempor√°rio do projeto (se configurado) ou Aprovador Global -->

                        <!-- Card de Lembrete do √öltimo Relat√≥rio -->
                        <div id="lembrete-card" class="alert alert-warning mt-3" style="display: none;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong id="lembrete-titulo">‚ö†Ô∏è Lembrete do √∫ltimo relat√≥rio:</strong><br>
                                    <span id="lembrete-texto"></span>
                                </div>
                                <button type="button" class="btn-close" onclick="document.getElementById('lembrete-card').style.display='none'"></button>
                            </div>
                        </div>

                        <!-- Checklist da Obra -->
                        <div class="mb-4">
                            <h5><i class="fas fa-tasks"></i> Checklist da Obra</h5>
                            <div id="checklistItems">
                                <!-- Itens predefinidos -->
                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="estrutura">
                                        <label class="form-check-label fw-bold" for="estrutura">
                                            Estrutura / Funda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_estrutura" placeholder="Observa√ß√µes sobre estrutura..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alvenaria">
                                        <label class="form-check-label fw-bold" for="alvenaria">
                                            Alvenaria / Veda√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_alvenaria" placeholder="Observa√ß√µes sobre alvenaria..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="instalacoes">
                                        <label class="form-check-label fw-bold" for="instalacoes">
                                            Instala√ß√µes (El√©trica/Hidr√°ulica)
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_instalacoes" placeholder="Observa√ß√µes sobre instala√ß√µes..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="acabamento">
                                        <label class="form-check-label fw-bold" for="acabamento">
                                            Acabamentos
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_acabamento" placeholder="Observa√ß√µes sobre acabamentos..."></textarea>
                                </div>

                                <div class="checklist-item mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="limpeza">
                                        <label class="form-check-label fw-bold" for="limpeza">
                                            Limpeza / Organiza√ß√£o
                                        </label>
                                    </div>
                                    <textarea class="form-control mt-2" name="obs_limpeza" placeholder="Observa√ß√µes sobre limpeza..."></textarea>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addCustomChecklistItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item Personalizado
                                </button>
                            </div>
                        </div>

                        <!-- Lembrete da √öltima Visita -->
                        {% if lembrete_anterior %}
                        <div class="alert alert-warning border-warning mb-4" role="alert">
                            <h6 class="alert-heading">
                                <i class="fas fa-sticky-note me-2"></i>Lembrete da √∫ltima visita ({{ lembrete_anterior.numero }})
                            </h6>
                            <hr>
                            <p class="mb-0">{{ lembrete_anterior.texto }}</p>
                        </div>
                        {% endif %}

                        <!-- Observa√ß√µes Gerais -->
                        <div class="mb-4">
                            <label class="form-label" for="conteudo">Observa√ß√µes Gerais</label>
                            <textarea class="form-control" name="conteudo" id="conteudo" rows="4" 
                                    placeholder="Descreva detalhes gerais da visita, pontos importantes, etc."></textarea>
                        </div>

                        <!-- Lembrete para Pr√≥xima Visita -->
                        <div class="mb-4">
                            <label class="form-label" for="lembrete_proxima_visita">
                                <i class="fas fa-bell me-2"></i>Lembrete para Pr√≥xima Visita (Opcional)
                            </label>
                            <textarea class="form-control" name="lembrete_proxima_visita" id="lembrete_proxima_visita" rows="3" 
                                    placeholder="Deixe um lembrete ou ponto de aten√ß√£o para a pr√≥xima visita a esta obra..."></textarea>
                            <small class="text-muted">Este lembrete ser√° exibido automaticamente no pr√≥ximo relat√≥rio desta obra.</small>
                        </div>

                        <!-- Sistema de Fotos Mobile-First -->
                        <div class="mb-4">
                            <h5><i class="fas fa-camera"></i> Fotos (At√© 200 fotos) <span id="photoCount" class="badge bg-primary ms-2">0</span></h5>

                            <!-- Bot√µes Fixos de C√¢mera e Galeria (Mobile-First) -->
                            <div class="fixed-photo-buttons sticky-top bg-white p-3 mb-3 border rounded" style="z-index: 10;">
                                <div class="row g-2">
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-primary w-100 mobile-photo-btn" 
                                                id="mobileCameraBtn" onclick="mobileCaptureFromCamera()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-camera fa-lg mb-1"></i>
                                                <small>C√¢mera</small>
                                            </div>
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button type="button" class="btn btn-outline-success w-100 mobile-photo-btn" 
                                                id="mobileGalleryBtn" onclick="mobileSelectFromGallery()" style="min-height: 56px;">
                                            <div class="d-flex flex-column align-items-center">
                                                <i class="fas fa-images fa-lg mb-1"></i>
                                                <small>Galeria</small>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                                <input type="file" id="mobilePhotoInput" class="form-control" multiple accept="image/*" style="display: none;">
                                <input type="file" id="mobileCameraInput" class="form-control" accept="image/*" capture="environment" style="display: none;">
                                <div class="text-center mt-2">
                                    <small class="text-muted"><strong>M√°ximo 200 fotos - Limite total: 3GB</strong></small>
                                </div>
                            </div>

                            <!-- Preview das Fotos com Cards Mobile-First -->
                            <div id="mobilePhotoCards" class="row g-3"></div>

                            <!-- Quick Action Bar para adicionar mais fotos -->
                            <div id="quickPhotoActions" class="text-center mt-3 p-3 bg-light rounded" style="display: none;">
                                <div class="d-flex justify-content-center gap-2 flex-wrap">
                                    <button type="button" class="btn btn-success" onclick="mobileCaptureFromCamera()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-camera me-2"></i>Adicionar da C√¢mera
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="mobileSelectFromGallery()" style="min-height: 48px; border-radius: 24px;">
                                        <i class="fas fa-images me-2"></i>Adicionar da Galeria
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-2">Total: <span id="quickPhotoCount">0</span> fotos (m√°ximo 200)</small>
                            </div>

                            <!-- Fotos antigas (mantido para compatibilidade) -->
                            <div id="photoPreview" class="row" style="display: none;"></div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('reports') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Concluir relat√≥rio
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal do Editor de Fotos -->
<div class="modal fade" id="photoEditorModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editor de Foto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-9">
                        <div style="overflow: auto; max-height: 500px;">
                            <canvas id="photoCanvas" style="border: 1px solid #ddd; cursor: crosshair;"></canvas>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6>Ferramentas</h6>
                        <div class="btn-group-vertical w-100 mb-3">
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Caneta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                                <i class="fas fa-arrow-right"></i> Seta
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Ret√¢ngulo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                                <i class="fas fa-circle"></i> C√≠rculo
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                                <i class="fas fa-font"></i> Texto
                            </button>
                        </div>

                        <h6>Cores</h6>
                        <div class="mb-3">
                            <input type="color" id="colorPicker" value="#ff0000" class="form-control">
                        </div>

                        <h6>Espessura</h6>
                        <div class="mb-3">
                            <input type="range" id="lineWidth" min="1" max="10" value="3" class="form-range">
                        </div>

                        <button type="button" class="btn btn-warning w-100 mb-2" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedPhoto()">Salvar Edi√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let selectedPhotos = [];
let currentEditingPhoto = null;
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let startX, startY;

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');

    // Event listeners para upload de fotos com error handling
    const photoInput = document.getElementById('photoInput');
    const cameraInput = document.getElementById('cameraInput');

    if (photoInput) {
        photoInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Photo input element not found');
    }

    if (cameraInput) {
        cameraInput.addEventListener('change', handlePhotoUpload);
    } else {
        console.warn('Camera input element not found');
    }

    // Event listeners para ferramentas - OTIMIZADO PARA MOBILE
    document.querySelectorAll('.tool-btn').forEach(btn => {
        // Usar touchstart para resposta mais r√°pida no mobile
        const isMobile = window.innerWidth <= 768;
        const eventType = isMobile ? 'touchstart' : 'click';

        btn.addEventListener(eventType, function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Feedback visual imediato
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 100);

            // Atualizar ferramentas
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;

            console.log('üîß Ferramenta selecionada:', currentTool);
        });

        // Prevenir eventos duplicados no mobile
        if (isMobile) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
            });
        }
    });

    // Canvas events - Mouse
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Canvas events - Touch (mobile)
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    });
});

// Fun√ß√£o para carregar funcion√°rios e e-mails do projeto selecionado
function carregarFuncionariosEmails() {
    const projetoId = document.getElementById('projeto_id').value;
    carregarFuncionariosEmailsPorId(projetoId);
    // carregarCategoriasProjeto j√° √© chamada no onchange, n√£o precisa duplicar
}

// Fun√ß√£o para carregar categorias do projeto
function carregarCategoriasProjeto(projetoId) {
    if (!projetoId) {
        console.log('Nenhum projeto selecionado para carregar categorias');
        return;
    }

    // Buscar categorias do projeto via API
    fetch(`/api/projects/${projetoId}/categorias`)
        .then(response => response.json())
        .then(data => {
            if (data.categorias) {
                console.log(`‚úÖ Categorias carregadas: ${data.categorias.length} categorias para projeto ${projetoId}`);
                // As categorias ser√£o usadas pelos selects de categoria nas fotos
                // Armazena globalmente para uso posterior
                window.currentProjectCategorias = data.categorias;
            }
        })
        .catch(error => {
            console.error('Erro ao carregar categorias do projeto:', error);
        });
}

// Fun√ß√£o para carregar lembrete do √∫ltimo relat√≥rio
function carregarLembrete(projetoId) {
    const lembreteCard = document.getElementById('lembrete-card');
    const lembreteTitulo = document.getElementById('lembrete-titulo');
    const lembreteTexto = document.getElementById('lembrete-texto');

    // Ocultar o card se nenhum projeto estiver selecionado
    if (!projetoId) {
        lembreteCard.style.display = 'none';
        return;
    }

    // Buscar o lembrete via API
    fetch(`/relatorios/ultimo-lembrete?obra_id=${projetoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.lembrete) {
                // Exibir o card com o lembrete
                lembreteTitulo.textContent = `‚ö†Ô∏è Lembrete do √∫ltimo relat√≥rio (${data.relatorio_origem}):`;
                lembreteTexto.textContent = data.lembrete;
                lembreteCard.style.display = 'block';
                console.log(`‚úÖ Lembrete carregado: ${data.lembrete}`);
            } else {
                // Ocultar o card se n√£o houver lembrete
                lembreteCard.style.display = 'none';
                console.log('‚ÑπÔ∏è Nenhum lembrete encontrado para esta obra');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar lembrete:', error);
            lembreteCard.style.display = 'none';
        });
}

// Fun√ß√£o para atualizar o n√∫mero do relat√≥rio quando o projeto √© selecionado
function atualizarNumeroRelatorio(projetoId) {
    const numeroInput = document.getElementById('numero');

    if (!projetoId || !numeroInput) {
        return;
    }

    // Buscar o pr√≥ximo n√∫mero do relat√≥rio para este projeto via AJAX
    fetch(`/api/projeto/${projetoId}/next-report-number`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.next_numero) {
            numeroInput.value = data.next_numero;
            numeroInput.readOnly = false;
            console.log(`N√∫mero do relat√≥rio atualizado para: ${data.next_numero}`);
        }
    })
    .catch(error => {
        console.error('Erro ao buscar pr√≥ximo n√∫mero do relat√≥rio:', error);
    });
}

function carregarFuncionariosEmailsPorId(projetoId) {
    const funcionariosDiv = document.getElementById('funcionarios-projeto');
    const emailsDiv = document.getElementById('emails-projeto');

    // Verificar se os elementos existem antes de tentar modific√°-los
    if (!funcionariosDiv || !emailsDiv) {
        console.log('‚ö†Ô∏è Elementos funcionarios-projeto ou emails-projeto n√£o encontrados - pulando carregamento');
        return;
    }

    if (!projetoId) {
        funcionariosDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os funcion√°rios dispon√≠veis</p>';
        emailsDiv.innerHTML = '<p class="text-muted">Selecione um projeto para ver os e-mails dispon√≠veis</p>';
        return;
    }

    // Buscar funcion√°rios e e-mails do projeto via AJAX
    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Renderizar funcion√°rios
            let funcionariosHtml = '';
            if (data.funcionarios && data.funcionarios.length > 0) {
                data.funcionarios.forEach(func => {
                    const checked = func.is_responsavel_principal ? 'checked' : '';
                    funcionariosHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="func_${func.id}" 
                                   name="funcionarios_selecionados[]" value="${func.id}" ${checked}>
                            <label class="form-check-label" for="func_${func.id}">
                                <strong>${func.nome_funcionario}</strong><br>
                                <small class="text-muted">${func.cargo || 'Sem cargo'} - ${func.empresa || 'Sem empresa'}</small>
                                ${func.is_responsavel_principal ? '<span class="badge bg-primary">Principal</span>' : ''}
                            </label>
                        </div>
                    `;
                });
            } else {
                funcionariosHtml = '<p class="text-muted">Nenhum funcion√°rio encontrado para este projeto</p>';
            }
            if (funcionariosDiv) funcionariosDiv.innerHTML = funcionariosHtml;

            // Renderizar e-mails
            let emailsHtml = '';
            if (data.emails && data.emails.length > 0) {
                data.emails.forEach(email => {
                    emailsHtml += `
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="email_${email.id}" 
                                   name="emails_selecionados[]" value="${email.id}">
                            <label class="form-check-label" for="email_${email.id}">
                                <strong>${email.email}</strong><br>
                                <small class="text-muted">${email.nome_contato} - ${email.cargo || 'Sem cargo'}</small>
                            </label>
                        </div>
                    `;
                });
            } else {
                emailsHtml = '<p class="text-muted">Nenhum e-mail encontrado para este projeto</p>';
            }
            if (emailsDiv) emailsDiv.innerHTML = emailsHtml;
        } else {
            if (funcionariosDiv) funcionariosDiv.innerHTML = '<p class="text-danger">Erro ao carregar funcion√°rios</p>';
            if (emailsDiv) emailsDiv.innerHTML = '<p class="text-danger">Erro ao carregar e-mails</p>';
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        if (funcionariosDiv) funcionariosDiv.innerHTML = '<p class="text-danger">Erro de conex√£o</p>';
        if (emailsDiv) emailsDiv.innerHTML = '<p class="text-danger">Erro de conex√£o</p>';
    });
}

function handlePhotoUpload(event) {
    // Upload de fotos iniciado

    const files = event.target.files;
    // Processando arquivos selecionados

    if (files.length + selectedPhotos.length > 200) {
        alert('M√°ximo de 200 fotos permitido.');
        return;
    }

    // Processar cada arquivo
    for (let file of files) {
        if (selectedPhotos.length >= 200) {
            // Limite de fotos atingido
            break;
        }
        // Processando arquivo
        addPhotoPreview(file, '');
    }

    event.target.value = ''; // Reset input
    // Upload conclu√≠do
}

// Camera and gallery functions with error handling
function selectFromGallery() {
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    } else {
        console.warn('Photo input element not found');
    }
}

function captureFromCamera() {
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
        cameraInput.click();
    } else {
        console.warn('Camera input element not found');
    }
}

// Remove duplicate updatePhotoInput function (already exists below)

function addPhotoPreview(file, category) {
    // Adicionando preview da foto

    const reader = new FileReader();
    reader.onload = function(e) {
        const photoId = 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const src = e.target.result;

        // Criando elemento da foto

        const photoDiv = document.createElement('div');
        photoDiv.className = 'col-md-4 mb-3';
        photoDiv.id = photoId;
        photoDiv.setAttribute('data-photo-id', photoId);
        photoDiv.innerHTML = `
            <div class="card">
                <img src="${src}" class="card-img-top photo-preview" alt="Preview" style="cursor: pointer;" data-category="${category}">
                <div class="card-body p-2">
                    <!-- Seletor de Legendas -->
                    <select class="form-control form-control-sm mb-2" id="predefined_${photoId}" name="photo_caption_${photoId}" required>
                        <option value="">Selecione uma legenda...</option>
                    </select>
                    <small class="text-muted d-block">Categoria: ${category}</small>
                    <div class="btn-group w-100 mt-2">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openPhotoEditor('${photoId}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePhoto('${photoId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('photoPreview').appendChild(photoDiv);

        // CORRE√á√ÉO DEFINITIVA: Adicionar a AMBOS os arrays para sincroniza√ß√£o total
        const photoObject = {
            id: photoId,
            file: file,
            category: category,
            element: photoDiv,
            originalSrc: src,
            previewUrl: src,
            name: file.name,
            filename: file.name,
            isExisting: false,  // Nova foto, n√£o existente
            savedId: null,  // Ainda n√£o foi salva
            metadata: {
                legenda: '',
                categoria: category,
                local: ''
            }
        };

        selectedPhotos.push(photoObject);
        
        // IMPORTANTE: Adicionar tamb√©m a window.mobilePhotoData
        if (!window.mobilePhotoData) {
            window.mobilePhotoData = [];
        }
        window.mobilePhotoData.push(photoObject);
        
        console.log(`‚úÖ Nova foto adicionada: ${file.name}`, {
            id: photoId,
            category: category,
            totalSelectedPhotos: selectedPhotos.length,
            totalMobilePhotoData: window.mobilePhotoData.length
        });

        loadPredefinedCaptionsForPhoto(photoId, category);
    };
    reader.readAsDataURL(file);
}

function removePhoto(photoId) {
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.element.remove();
        selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
        
        // CORRE√á√ÉO DEFINITIVA: Remover tamb√©m de window.mobilePhotoData
        if (window.mobilePhotoData) {
            window.mobilePhotoData = window.mobilePhotoData.filter(p => p.id !== photoId);
            console.log(`üóëÔ∏è Foto ${photoId} removida de ambos os arrays`);
        }
    }
}

function loadPredefinedCaptionsForPhoto(photoId, category) {
    const select = document.getElementById(`predefined_${photoId}`);
    if (!select) return;

    select.innerHTML = '<option value="">Carregando legendas...</option>';

    // Carregar direto da API (PostgreSQL)
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/legendas?categoria=all', true);
    xhr.timeout = 10000;

    xhr.onload = function() {
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success && data.legendas && data.legendas.length > 0) {
                    select.innerHTML = '<option value="">Selecione uma legenda...</option>';

                    const cats = {
                        'Acabamentos': [],
                        'Estrutural': [],
                        'Geral': [],
                        'Seguran√ßa' : []
                    };

                    data.legendas.forEach(leg => {
                        if (cats[leg.categoria]) {
                            cats[leg.categoria].push(leg);
                        }
                    });

                    Object.keys(cats).forEach(cat => {
                        if (cats[cat].length > 0) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = cat + ' (' + cats[cat].length + ' itens)';

                            cats[cat].forEach(legenda => {
                                const option = document.createElement('option');
                                option.value = legenda.texto;
                                option.textContent = legenda.texto;
                                optgroup.appendChild(option);
                            });

                            select.appendChild(optgroup);
                        }
                    });
                } else {
                    select.innerHTML = '<option value="">Erro: nenhuma legenda encontrada</option>';
                }
            } catch (e) {
                select.innerHTML = '<option value="">Erro: formato inv√°lido</option>';
            }
        } else {
            select.innerHTML = '<option value="">Erro: servidor indispon√≠vel</option>';
        }
    };

    xhr.onerror = function() {
        select.innerHTML = '<option value="">Erro: falha de rede</option>';
    };

    xhr.ontimeout = function() {
        select.innerHTML = '<option value="">Erro: tempo esgotado</option>';
    };

    xhr.send();
}

// Mapear categoria da foto para categoria da legenda
function mapCategoryToLegenda(photoCategory) {
    const mapping = {
        'Geral': 'Geral',
        'Estrutura': 'Estrutural', 
        'Acabamento': 'Acabamentos',
        'Instala√ß√µes': 'El√©trica',
        'Problema': 'Seguran√ßa'
    };
    return mapping[photoCategory] || 'Geral';
}

// Checklist functionality
function addCustomChecklistItem() {
    const checklistItems = document.getElementById('checklistItems');
    const itemId = 'custom_' + Date.now();

    const itemDiv = document.createElement('div');
    itemDiv.className = 'checklist-item mb-3';
    itemDiv.innerHTML = `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" id="${itemId}">
            <input type="text" class="form-control d-inline-block fw-bold" style="width: 70%;" 
                   name="custom_item_${itemId}" placeholder="Digite o item do checklist..." required>
            <button type="button" class="btn btn-sm btn-outline-danger float-end" 
                    onclick="this.parentElement.parentElement.remove()">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <textarea class="form-control mt-2" name="custom_obs_${itemId}" placeholder="Observa√ß√µes..." rows="2"></textarea>
    `;

    checklistItems.appendChild(itemDiv);
}

// Marcar checklist como conclu√≠do
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('form-check-input') && e.target.type === 'checkbox') {
        const item = e.target.closest('.checklist-item');
        if (e.target.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    }
});

// Sistema Fabric.js Photo Editor - Exatamente como no Express
function openPhotoEditor(photoId) {
    try {
        // Abrindo editor para foto

        const card = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (!card) {
            console.error(`‚ùå Card n√£o encontrado para foto: ${photoId}`);
            return;
        }

        const img = card.querySelector('img');
        if (!img || !img.src) {
            console.error(`‚ùå Imagem n√£o encontrada para foto: ${photoId}`);
            return;
        }

        // Callback para salvar a foto editada (definir primeiro)
        const saveCallback = async (data) => {
            // Salvando foto editada

            // Atualizar preview da foto no card
            img.src = data.imageData;
            img.dataset.edited = 'true';
            img.dataset.legend = data.legend;

            // Marcar visualmente como editada
            card.classList.add('edited');

            // Adicionar badge de editado se n√£o existir
            if (!card.querySelector('.edited-badge')) {
                const badge = document.createElement('div');
                badge.className = 'edited-badge';
                badge.innerHTML = '<i class="fas fa-edit"></i> Editado';
                card.appendChild(badge);
            }

            // Foto salva com sucesso
        };

        // Verificar se o editor modal est√° dispon√≠vel  
        if (!window.fabricPhotoEditorModal) {
            console.error('‚ùå Editor modal n√£o inicializado');

            // Verificar se as depend√™ncias est√£o carregadas
            if (typeof fabric === 'undefined') {
                alert('Fabric.js n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            if (typeof bootstrap === 'undefined') {
                alert('Bootstrap n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            if (typeof FabricPhotoEditor === 'undefined') {
                alert('Editor de fotos n√£o est√° carregado. Recarregue a p√°gina.');
                return;
            }

            // Tentar inicializar o editor modal
            if (typeof initFabricPhotoEditorModal === 'function') {
                // Tentando inicializar editor modal
                initFabricPhotoEditorModal();

                // Aguardar um momento para o editor ser inicializado
                setTimeout(() => {
                    if (window.fabricPhotoEditorModal) {
                        console.log('‚úÖ Editor inicializado com sucesso');
                        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);
                    } else {
                        console.error('‚ùå Falha ao inicializar editor ap√≥s tentativa');
                        alert('Editor de fotos n√£o pode ser carregado. Recarregue a p√°gina.');
                    }
                }, 500);
                return;
            }
        }

        // Editor dispon√≠vel, abrir diretamente
        console.log('‚úÖ Abrindo editor');
        window.fabricPhotoEditorModal.openEditor(img.src, photoId, saveCallback);

    } catch (error) {
        console.error('‚ùå Erro ao abrir editor:', error);
        alert('Erro ao abrir editor de fotos. Tente novamente.');
    }
}

// Fun√ß√£o para auto-scroll centralizado
function scrollToEditorCenter() {
    console.log('üé® Executando auto-scroll para centro do editor');

    const modal = document.getElementById('fabricPhotoEditorModal');
    if (!modal) {
        console.log('‚ö†Ô∏è Modal n√£o encontrado');
        return;
    }

    const canvasContainer = modal.querySelector('.canvas-container');
    if (!canvasContainer) {
        console.log('‚ö†Ô∏è Canvas container n√£o encontrado');
        return;
    }

    try {
        // Scroll suave para o centro do canvas
        canvasContainer.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center',
            inline: 'center'
        });

        // Centralizar o scroll na janela tamb√©m
        window.scrollTo({
            top: window.innerHeight / 4,
            behavior: 'smooth'
        });

        console.log('‚úÖ Auto-scroll executado com sucesso');
    } catch (error) {
        console.error('‚ùå Erro no auto-scroll:', error);
    }
}

// Nova fun√ß√£o para atualizar foto do Fabric Editor
function updatePhotoFromFabricEditor(photoId, editedImageData) {
    console.log('üíæ Atualizando foto editada:', photoId);

    // Buscar elemento da foto diretamente pelo ID
    const photoElement = document.getElementById(photoId);
    if (!photoElement) {
        console.error('‚ùå Elemento da foto n√£o encontrado:', photoId);
        return;
    }

    // Atualizar imagem no preview
    const img = photoElement.querySelector('.photo-preview');
    if (img && editedImageData.imageData) {
        img.src = editedImageData.imageData;
        console.log('‚úÖ Imagem do preview atualizada');

        // Tamb√©m atualizar onclick para manter funcionalidade
        img.setAttribute('onclick', `editPhoto('${photoId}', '${editedImageData.imageData}', '${img.getAttribute('data-category') || 'Geral'}')`);
    }

    // Atualizar tamb√©m em selectedPhotos se existir
    const photo = selectedPhotos.find(p => p.id === photoId);
    if (photo) {
        photo.annotatedSrc = editedImageData.imageData;
        console.log('‚úÖ Dados da foto atualizados em selectedPhotos');
    }

    // Adicionar indicador visual de foto editada
    const card = photoElement.querySelector('.card');
    if (card && !card.classList.contains('border-success')) {
        card.classList.add('border-success', 'border-2');

        // Remover indicador anterior se existir
        const oldIndicator = card.querySelector('.edit-indicator');
        if (oldIndicator) oldIndicator.remove();

        const indicator = document.createElement('small');
        indicator.className = 'text-success fw-bold edit-indicator d-block mt-1';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Editada';
        photoElement.querySelector('.card-body').appendChild(indicator);
        console.log('‚úÖ Indicador visual adicionado');
    }

    console.log('‚úÖ Foto atualizada com sucesso');
}

// Canvas drawing functions
function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    startX = (e.clientX - rect.left) * scaleX;
    startY = (e.clientY - rect.top) * scaleY;

    if (currentTool === 'text') {
        const text = prompt('Digite o texto:');
        if (text) {
            ctx.fillStyle = document.getElementById('colorPicker').value;
            ctx.font = 'bold 24px Arial';
            ctx.textBaseline = 'top';
            ctx.fillText(text, startX, startY);
        }
        isDrawing = false;
        return;
    }

    // Para caneta, come√ßar o path
    if (currentTool === 'pen') {
        ctx.beginPath();
        ctx.moveTo(startX, startY);
    }
}

function draw(e) {
    if (!isDrawing) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;
    ctx.lineCap = 'round';

    if (currentTool === 'pen') {
        ctx.globalCompositeOperation = 'source-over';
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(currentX, currentY);
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;

    ctx.strokeStyle = document.getElementById('colorPicker').value;
    ctx.lineWidth = document.getElementById('lineWidth').value;

    if (currentTool === 'arrow') {
        drawArrow(startX, startY, currentX, currentY);
    } else if (currentTool === 'rectangle') {
        ctx.strokeRect(startX, startY, currentX - startX, currentY - startY);
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2));
        ctx.beginPath();
        ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
        ctx.stroke();
    }

    ctx.beginPath();
}

function drawArrow(fromX, fromY, toX, toY) {
    const headlen = 15;
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.stroke();
}

function clearCanvas() {
    if (currentEditingPhoto) {
        const img = new Image();
        img.onload = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
        };
        img.src = currentEditingPhoto.originalSrc;
    }
}

function saveEditedPhoto() {
    if (currentEditingPhoto) {
        const editedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        const img = currentEditingPhoto.element.querySelector('img');
        img.src = editedDataUrl;

        // Update the photo object - mark as edited and remove original file reference
        currentEditingPhoto.editedSrc = editedDataUrl;
        currentEditingPhoto.file = null; // Remove original file since we'll use only the edited version

        // Add visual indicator that photo was edited
        const editButton = currentEditingPhoto.element.querySelector('.btn-primary');
        editButton.innerHTML = '<i class="fas fa-check"></i> Editada';
        editButton.classList.remove('btn-primary');
        editButton.classList.add('btn-success');
    }

    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

// Fun√ß√£o para criar relat√≥rio inicial em preenchimento
async function createInitialReport() {
    const formData = new FormData(document.getElementById('reportForm'));

    try {
        const response = await fetch('{{ url_for("create_report") }}', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success && result.report_id) {
            console.log('‚úÖ Relat√≥rio inicial criado:', result.report_id);
            return result.report_id;
        } else {
            throw new Error(result.error || 'Erro ao criar relat√≥rio');
        }
    } catch (error) {
        console.error('‚ùå Erro ao criar relat√≥rio inicial:', error);
        throw error;
    }
}

// Submiss√£o do formul√°rio
document.getElementById('reportForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    submitBtn.disabled = true;

    try {
        const formData = new FormData(this);

        // Coletar dados do checklist
        const checklistData = [];
        document.querySelectorAll('.checklist-item').forEach(item => {
            const checkbox = item.querySelector('.form-check-input[type="checkbox"]');
            const label = item.querySelector('.form-check-label');
            const customInput = item.querySelector('input[type="text"]');
            const textarea = item.querySelector('textarea');

            if (checkbox) {
                const itemText = label ? label.textContent.trim() : (customInput ? customInput.value : '');
                if (itemText) {
                    checklistData.push({
                        texto: itemText,
                        concluido: checkbox.checked,
                        observacao: textarea ? textarea.value : ''
                    });
                }
            }
        });

        // Adicionar checklist ao FormData
        formData.append('checklist', JSON.stringify(checklistData));

        // CORRE√á√ÉO DEFINITIVA: Coletar acompanhantes do campo hidden
        const acompanhantesField = document.getElementById('acompanhantes-data');
        let acompanhantesData = [];
        if (acompanhantesField && acompanhantesField.value) {
            try {
                acompanhantesData = JSON.parse(acompanhantesField.value);
                console.log(`üë• Acompanhantes coletados: ${acompanhantesData.length}`, acompanhantesData);
            } catch (e) {
                console.error('‚ùå Erro ao parsear acompanhantes:', e);
                acompanhantesData = [];
            }
        } else {
            console.warn('‚ö†Ô∏è Campo acompanhantes-data n√£o encontrado ou vazio');
        }
        formData.append('acompanhantes', JSON.stringify(acompanhantesData));

        // CORRE√á√ÉO DEFINITIVA: Usar window.mobilePhotoData (onde as fotos realmente est√£o)
        const photoData = window.mobilePhotoData || [];
        console.log(`üì∏ Total de fotos no sistema: ${photoData.length}`);

        // Coletar IDs das imagens existentes (que j√° estavam salvas)
        const imagensExistentes = [];
        const legendasImagens = []; // NOVO: Array para armazenar legendas de imagens existentes
        
        photoData.forEach(photo => {
            if (photo.savedId || photo.isExisting) {
                const fotoId = photo.savedId || photo.id;
                imagensExistentes.push(fotoId);
                console.log(`‚úÖ Imagem existente mantida: ${fotoId}`);
                
                // CORRE√á√ÉO: Coletar legenda, categoria e local da imagem existente
                const legenda = photo.manualCaption || photo.predefinedCaption || photo.caption || photo.metadata?.legenda || '';
                const categoria = photo.category || photo.metadata?.categoria || photo.metadata?.tipo_servico || '';
                const local = photo.local || photo.metadata?.local || '';
                
                legendasImagens.push({
                    id: fotoId,
                    legenda: legenda,
                    categoria: categoria,
                    local: local
                });
                
                console.log(`üìù Legenda coletada para imagem ${fotoId}: "${legenda.substring(0, 50)}..."`);
            }
        });
        
        imagensExistentes.forEach(id => {
            formData.append('imagens_existentes[]', id);
        });
        
        // CORRE√á√ÉO: Enviar legendas das imagens existentes
        if (legendasImagens.length > 0) {
            formData.append('legendas_imagens', JSON.stringify(legendasImagens));
            console.log(`üìù Total de legendas enviadas: ${legendasImagens.length}`);
        }
        
        console.log(`üíæ Total de imagens existentes a manter: ${imagensExistentes.length}`);

        // Adicionar novas imagens (que t√™m file mas n√£o t√™m savedId)
        let novasImagensCount = 0;
        photoData.forEach((photo, index) => {
            if (photo.file && !photo.savedId && !photo.isExisting) {
                formData.append('imagens', photo.file);
                novasImagensCount++;
                console.log(`üì§ Nova imagem #${novasImagensCount}: ${photo.name || photo.filename}`);
            }
        });
        console.log(`üì§ Total de novas imagens para upload: ${novasImagensCount}`);
        
        // CR√çTICO: Adicionar flag de finaliza√ß√£o
        // Quando o usu√°rio submete o formul√°rio "Concluir relat√≥rio", deve mudar status para "Aguardando Aprova√ß√£o"
        formData.append('should_finalize', 'true');
        
        // LOG FINAL DE DEBUG: Mostrar tudo que est√° sendo enviado
        console.log('üì¶ RESUMO DO QUE SER√Å ENVIADO:');
        console.log(`   üì∏ Imagens existentes: ${imagensExistentes.length}`);
        console.log(`   üì∏ Novas imagens: ${novasImagensCount}`);
        console.log(`   üë• Acompanhantes: ${acompanhantesData.length}`);
        console.log(`   ‚úì Checklist: ${checklistData.length} itens`);
        console.log(`   ‚úÖ Finalizar relat√≥rio: true`);
        if (acompanhantesData.length > 0) {
            console.log('   üë• Detalhes dos acompanhantes:', acompanhantesData);
        }

        // Determinar a URL de destino e m√©todo
        let url, method;
        if (EDIT_MODE && REPORT_DATA && REPORT_DATA.relatorio && REPORT_DATA.relatorio.id) {
            // Modo de edi√ß√£o: usar a nova rota de atualiza√ß√£o
            url = `/api/reports/${REPORT_DATA.relatorio.id}/update`;
            method = 'POST';
            console.log('üìù Modo de edi√ß√£o: atualizando relat√≥rio ID', REPORT_DATA.relatorio.id);
        } else if (window.currentReportId) {
            // Se h√° currentReportId, tamb√©m √© edi√ß√£o
            url = `/api/reports/${window.currentReportId}/update`;
            method = 'POST';
            formData.append('edit_report_id', window.currentReportId);
            console.log('üìù Atualizando relat√≥rio ID', window.currentReportId);
        } else {
            // Modo de cria√ß√£o: usar a rota original
            url = this.action;
            method = 'POST';
            console.log('üìù Modo de cria√ß√£o: criando novo relat√≥rio');
        }

        // Enviar requisi√ß√£o
        const response = await fetch(url, {
            method: method,
            body: formData
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || 'Erro ao salvar relat√≥rio');
        }

        // Sucesso!
        alert('‚úÖ Relat√≥rio atualizado com sucesso!');
        
        // Redirecionar para a lista de relat√≥rios
        window.location.href = '/reports';

    } catch (error) {
        console.error('‚ùå Erro ao salvar relat√≥rio:', error);
        alert('Erro ao salvar relat√≥rio: ' + error.message);
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// FUN√á√ÉO DUPLICADA REMOVIDA - usar apenas a vers√£o otimizada para mobile

// FUN√á√ÉO DUPLICADA REMOVIDA - usar apenas a vers√£o do in√≠cio do arquivo

// Fun√ß√£o para alternar checkbox e mostrar/ocultar campo de observa√ß√µes
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsField = document.getElementById(`obs_${itemId}`);
    const parentItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        if (obsField) {
            obsField.style.display = 'block';
        }
        if (parentItem) {
            parentItem.classList.add('completed');
        }
    } else {
        if (obsField) {
            obsField.style.display = 'none';
        }
        if (parentItem) {
            parentItem.classList.remove('completed');
        }
    }
}

// Fun√ß√£o para alternar estado do checklist item
function toggleChecklistItem(checkbox) {
    const itemId = checkbox.id.replace('check_', '');
    const obsSection = document.getElementById(`obs_${itemId}`);
    const checklistItem = checkbox.closest('.checklist-item');

    if (checkbox.checked) {
        // Marcar como completo
        checklistItem.classList.add('completed');
        // Mostrar campo de observa√ß√µes
        if (obsSection) {
            obsSection.style.display = 'block';
        }
    } else {
        // Desmarcar como completo
        checklistItem.classList.remove('completed');
        // Ocultar campo de observa√ß√µes
        if (obsSection) {
            obsSection.style.display = 'none';
            // Limpar observa√ß√µes se desejar
            const textarea = obsSection.querySelector('textarea');
            if (textarea) {
                textarea.value = '';
            }
        }
    }
}

// Carregar checklist do projeto (personalizado ou padr√£o)
function carregarChecklistProjeto(projetoId) {
    const container = document.getElementById('checklistItems');

    if (!projetoId) {
        container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
        return;
    }

    // Armazenar checkboxes marcados antes de trocar o projeto
    const currentCheckedIds = Array.from(document.querySelectorAll('#checklistItems input[type=checkbox]:checked'))
        .map(cb => cb.dataset.id || cb.id.replace('check_', ''));

    console.log(`üìã IDs marcados antes de trocar: ${currentCheckedIds.join(', ')}`);

    container.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando checklist...</p>';

    fetch(`/api/projeto/${projetoId}/checklist`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.checklist && data.checklist.length > 0) {
                container.innerHTML = '';

                // Mostrar tipo de checklist
                if (data.tipo === 'personalizado') {
                    const badge = document.createElement('div');
                    badge.className = 'alert alert-success mb-3';
                    badge.innerHTML = '<i class="fas fa-check-circle"></i> <strong>Checklist Personalizado da Obra</strong>';
                    container.appendChild(badge);
                }

                data.checklist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item mb-3';

                    // Verificar se este item estava marcado antes
                    const wasChecked = currentCheckedIds.includes(String(item.id));

                    itemDiv.innerHTML = `
                        <div class="d-flex align-items-start">
                            <div class="form-check me-3">
                                <input class="form-check-input" type="checkbox" id="check_${item.id}" data-id="${item.id}" ${wasChecked ? 'checked' : ''} onchange="toggleChecklistItem(this)">
                                <label class="form-check-label" for="check_${item.id}">
                                    ${item.texto}
                                </label>
                            </div>
                        </div>
                        <div class="mt-2" style="display: none;" id="obs_${item.id}">
                            <textarea class="form-control form-control-sm" rows="2" placeholder="Observa√ß√µes (opcional)..." name="obs_${item.id}"></textarea>
                        </div>
                    `;
                    container.appendChild(itemDiv);
                });

                console.log(`‚úÖ ${data.checklist.length} itens do checklist carregados (tipo: ${data.tipo})`);
            } else {
                container.innerHTML = '<p class="text-muted">Nenhum item no checklist. <a href="/admin/checklist-padrao">Configurar checklist</a></p>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar checklist:', error);
            container.innerHTML = `<p class="text-danger">Erro ao carregar checklist. <a href="#" onclick="carregarChecklistProjeto(${projetoId})">Tentar novamente</a></p>`;
        });
}

// Carregar checklist padr√£o do sistema
function carregarChecklistPadrao() {
    console.log('üìã Carregando checklist padr√£o...');

    fetch('/api/checklist-padrao')
        .then(response => response.json())
        .then(data => {
            console.log('üìã Resposta do servidor:', data);

            if (data.success && data.checklist && data.checklist.length > 0) {
                const container = document.getElementById('checklistItems');
                container.innerHTML = '';

                data.checklist.forEach((item, index) => {
                    const itemHtml = `
                        <div class="checklist-item card mb-3" data-item-id="${item.id}">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-9">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="check_${item.id}" name="checklist_${item.id}" onchange="toggleChecklistItem(this)">
                                            <label class="form-check-label fw-bold" for="check_${item.id}">
                                                ${item.texto}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <small class="text-muted">Item ${index + 1}</small>
                                    </div>
                                </div>
                                <div class="obs-section mt-3" style="display: none;">
                                    <label class="form-label">Observa√ß√µes:</label>
                                    <textarea class="form-control" name="obs_${item.id}" rows="2" placeholder="Observa√ß√µes sobre este item..."></textarea>
                                </div>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', itemHtml);
                });

                console.log('‚úÖ Checklist padr√£o carregado:', data.checklist.length, 'itens');
            } else {
                console.warn('‚ö†Ô∏è Nenhum item de checklist padr√£o encontrado');
                const container = document.getElementById('checklistItems');
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Nenhum item de checklist padr√£o configurado. Entre em contato com o administrador.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar checklist padr√£o:', error);
            const container = document.getElementById('checklistItems');
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar checklist. Tente recarregar a p√°gina.
                </div>
            `;
        });
}

// Manter compatibilidade com c√≥digo antigo
function carregarChecklistPadrao() {
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        carregarChecklistProjeto(projetoSelect.value);
    } else {
        const container = document.getElementById('checklistItems');
        container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
    }
}

// Inicializar sistema ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Auto-carregar dados do projeto se selecionado (tanto via URL quanto manualmente)
    const projetoSelect = document.getElementById('projeto_id');
    if (projetoSelect && projetoSelect.value) {
        console.log('üèóÔ∏è Projeto detectado:', projetoSelect.value);
        // Carregar dados do projeto
        carregarCategoriasProjeto(projetoSelect.value);
        carregarChecklistProjeto(projetoSelect.value);
        atualizarNumeroRelatorio(projetoSelect.value);
        carregarLembrete(projetoSelect.value);
        carregarFuncionariosEmails();
    } else {
        // Se n√£o h√° projeto selecionado, mostrar mensagem
        const container = document.getElementById('checklistItems');
        if (container) {
            container.innerHTML = '<p class="text-muted">Selecione um projeto para carregar o checklist</p>';
        }
    }

    // Inicializar editor modal Fabric.js - exatamente como no Express
    if (typeof initFabricPhotoEditorModal === 'function') {
        initFabricPhotoEditorModal();
        console.log('‚úÖ Editor modal inicializado');
    } else {
        console.error('‚ùå Editor modal n√£o dispon√≠vel');
    }

    // Criar relat√≥rio inicial e ativar auto save ap√≥s preencher dados b√°sicos
    let autoSaveInitialized = false;

    // Fun√ß√£o para inicializar auto save quando houver dados suficientes
    function tryInitializeAutoSave() {
        if (autoSaveInitialized) return;

        const titulo = document.getElementById('titulo').value;
        const projetoId = document.getElementById('projeto_id').value;

        if (titulo && projetoId) {
            console.log('üìù Dados b√°sicos preenchidos, criando relat√≥rio inicial...');

            // Criar relat√≥rio inicial
            createInitialReport().then(reportId => {
                window.currentReportId = reportId;

                // Adicionar data-report-id ao formul√°rio para autosave funcionar
                const form = document.getElementById('reportForm');
                if (form) {
                    form.setAttribute('data-report-id', reportId);
                    console.log('‚úÖ data-report-id adicionado ao formul√°rio:', reportId);
                }

                // Inicializar auto save com CSRF token correto
                if (typeof initAutoSave === 'function') {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
                    window.autoSaveInstance = initAutoSave(reportId, csrfToken);

                    autoSaveInitialized = true;
                    console.log('‚úÖ Auto save ativado para relat√≥rio', reportId);
                } else {
                    console.error('‚ùå Fun√ß√£o initAutoSave n√£o encontrada');
                }
            }).catch(error => {
                console.error('‚ùå Erro ao criar relat√≥rio inicial:', error);
            });
        }
    }

    // Observar mudan√ßas nos campos b√°sicos
    const tituloField = document.getElementById('titulo');
    const projetoField = document.getElementById('projeto_id');

    if (tituloField) {
        tituloField.addEventListener('blur', tryInitializeAutoSave);
    }

    if (projetoField) {
        projetoField.addEventListener('change', tryInitializeAutoSave);
    }
});

</script>

<!-- Fabric.js CDN - Exatamente como no Express -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<!-- Editor Scripts - Exatamente como no Express -->
<script src="{{ url_for('static', filename='js/fabric-photo-editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/fabric-photo-editor-modal.js') }}"></script>

<!-- Modal do Editor de Fotos Professional - Exatamente como no Express -->
<div class="modal fade" id="fabricPhotoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editor de Fotos Professional
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-0" style="height: calc(100vh - 160px);">
                <div class="fabric-editor-container" style="height: 100%;">
                    <!-- √Årea principal do editor -->
                    <div class="fabric-editor-main" style="flex: 1; display: flex; flex-direction: column;">
                        <!-- Container do canvas -->
                        <div class="canvas-container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; background: #f8f9fa;">
                            <div class="canvas-wrapper" style="background: white; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); overflow: hidden;">
                                <canvas id="fabricModalCanvas"></canvas>
                            </div>
                        </div>

                        <!-- Toolbar de ferramentas -->
                        <div class="fabric-toolbar" style="background: white; border-top: 1px solid #e1e5e9; padding: 16px;">
                            <!-- Ferramentas principais -->
                            <div class="tool-group mb-3">
                                <h6 class="text-muted mb-2">Ferramentas</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="fabric-tool-btn active" data-modal-tool="select" title="Sele√ß√£o">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="brush" title="Pincel">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="arrow" title="Seta">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="circle" title="C√≠rculo">
                                        <i class="far fa-circle"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="rectangle" title="Ret√¢ngulo">
                                        <i class="far fa-square"></i>
                                    </button>
                                    <button class="fabric-tool-btn" data-modal-tool="text" title="Texto">
                                        <i class="fas fa-font"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Propriedades -->
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Cor:</label>
                                    <input type="color" id="modal-color-picker" class="form-control form-control-color" value="#FF0000">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Espessura:</label>
                                    <input type="range" id="modal-stroke-width" class="form-range" min="1" max="20" value="3">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Legenda:</label>
                                    <input type="text" id="modal-custom-legend" class="form-control" placeholder="Digite uma legenda...">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="modal-cancel-btn">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="window.fabricPhotoEditorModal?.clear()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
                <button type="button" class="btn btn-warning" onclick="window.fabricPhotoEditorModal?.undo()">
                    <i class="fas fa-undo"></i> Desfazer
                </button>
                <button type="button" class="btn btn-success" id="modal-save-btn">
                    <i class="fas fa-check"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos do modal do editor - Exatamente como no Express */
.fabric-tool-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 44px;
    min-height: 44px;
    padding: 8px;
    background: #f8f9fa;
    border: 2px solid transparent;
    border-radius: 8px;
    color: #4b5563;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.fabric-tool-btn:hover {
    background: #e5e7eb;
}

.fabric-tool-btn.active {
    background: #3b82f6;
    color: white;
    border-color: #2563eb;
}

/* Indicador visual de foto editada */
.photo-container.edited {
    position: relative;
}

.edited-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    z-index: 10;
}

.edit-photo-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background: rgba(59, 130, 246, 0.9);
    color: white;
    border: none;
    padding: 8px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
}

.edit-photo-btn:hover {
    background: #3b82f6;
    transform: scale(1.1);
}

/* Responsivo mobile */
@media (max-width: 768px) {
    .fabric-toolbar {
        max-height: 40vh;
        overflow-y: auto;
    }

    .fabric-tool-btn {
        min-width: 40px;
        min-height: 40px;
    }

    /* MOBILE: Otimiza√ß√µes espec√≠ficas para legendas pr√©-definidas */
    select[name^="photo_caption_"], 
    select[id^="predefined_"] {
        font-size: 16px !important;
        min-height: 48px !important;
        padding: 12px !important;
        border: 2px solid #007bff !important;
        border-radius: 8px !important;
        background: white !important;
        display: block !important;
        width: 100% !important;
        -webkit-appearance: menulist !important;
        -moz-appearance: menulist !important;
        appearance: menulist !important;
    }

    /* Grupos de op√ß√µes vis√≠veis */
    optgroup {
        font-weight: bold !important;
        color: #007bff !important;
        font-size: 15px !important;
        padding: 4px !important;
    }

    option {
        font-size: 14px !important;
        padding: 8px !important;
        color: #333 !important;
        background: white !important;
    }

    /* Cards de fotos otimizados */
    .card-body.p-2 {
        padding: 16px !important;
    }

    /* Texto de categoria mais vis√≠vel */
    .text-muted {
        font-size: 14px !important;
        color: #555 !important;
        font-weight: 600 !important;
    }
}
</style>

<script>
// Sistema de touch inteligente IGUAL AO EXPRESS - funcional 100%
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Sistema de touch inteligente carregado (igual express)');

    // Configura√ß√µes EXATAS do Express
    const TOUCH_THRESHOLD = 10; // pixels
    const TOUCH_TIME_LIMIT = 500; // ms

    let touchData = {
        startX: 0,
        startY: 0,
        startTime: 0,
        isDragging: false,
        element: null
    };

    // Fun√ß√£o para sele√ß√£o de categoria ID√äNTICA ao Express
    function selectPhotoCategory(category, element) {
        // Remover sele√ß√£o anterior
        document.querySelectorAll('.photo-category').forEach(cat => {
            cat.classList.remove('selected');
        });

        // Adicionar sele√ß√£o atual
        element.classList.add('selected');

        // Feedback t√°til
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }

        console.log('üì∑ Categoria selecionada:', category);
    }

    // Event listeners para categorias - C√ìDIGO EXATO DO EXPRESS
    document.querySelectorAll('.photo-category').forEach(categoryElement => {

        // Touch Start
        categoryElement.addEventListener('touchstart', function(e) {
            console.log('üëÜ TouchStart categoria');

            const touch = e.touches[0];
            touchData.startX = touch.clientX;
            touchData.startY = touch.clientY;
            touchData.startTime = Date.now();
            touchData.isDragging = false;
            touchData.element = categoryElement;

            // Feedback visual imediato
            categoryElement.classList.add('touching');
        }, { passive: true });

        // Touch Move
        categoryElement.addEventListener('touchmove', function(e) {
            if (!touchData.element) return;

            const touch = e.touches[0];
            const deltaX = Math.abs(touch.clientX - touchData.startX);
            const deltaY = Math.abs(touch.clientY - touchData.startY);
            const totalDelta = Math.sqrt(deltaX * deltaX + deltaY * deltaY);

            // Se movimento exceder threshold, marcar como drag
            if (totalDelta > TOUCH_THRESHOLD) {
                touchData.isDragging = true;
                categoryElement.classList.remove('touching');
                console.log('üîÑ Movimento detectado - modo drag ativado');
            }
        }, { passive: true });

        // Touch End
        categoryElement.addEventListener('touchend', function(e) {
            console.log('üëÜ TouchEnd categoria');

            // Remover feedback visual
            categoryElement.classList.remove('touching');

            if (!touchData.element) return;

            const touchDuration = Date.now() - touchData.startTime;

            // Apenas selecionar se foi um tap r√°pido e sem movimento
            if (!touchData.isDragging && touchDuration < TOUCH_TIME_LIMIT) {
                e.preventDefault();
                e.stopPropagation();

                const category = categoryElement.getAttribute('data-category');
                selectPhotoCategory(category, categoryElement);

                console.log('‚úÖ Tap v√°lido - categoria selecionada');
            } else {
                console.log('‚ùå Drag detectado - n√£o selecionar categoria');
            }

            // Reset
            touchData.element = null;
            touchData.isDragging = false;
        }, { passive: false });

        // Mouse events para desktop (fallback)
        categoryElement.addEventListener('click', function(e) {
            // Apenas processar se n√£o houve toque recente
            if (touchData.startTime && (Date.now() - touchData.startTime) < 300) {
                return; // Ignorar click ap√≥s touch
            }

            e.preventDefault();
            e.stopPropagation();

            const category = categoryElement.getAttribute('data-category');
            selectPhotoCategory(category, categoryElement);

            console.log('üñ±Ô∏è Click desktop - categoria selecionada');
        });
    });

    console.log('‚úÖ Sistema de touch inteligente ativo para', document.querySelectorAll('.photo-category').length, 'categorias');
});

// Fun√ß√£o global para compatibilidade - integrada com sistema de touch
window.selectPhotoCategory = function(category, element) {
    if (!element) {
        element = document.querySelector(`[data-category="${category}"]`);
    }

    if (element) {
        // Usar a fun√ß√£o interna que j√° tem toda a l√≥gica
        const selectEvent = new CustomEvent('selectCategory', { 
            detail: { category: category, element: element } 
        });
        document.dispatchEvent(selectEvent);
    }
};
</script>

<!-- Auto Save Script -->
<!-- Sistema de autosave antigo desabilitado para evitar conflitos -->
<!-- <script src="{{ url_for('static', filename='js/autosave.js') }}"></script> -->
<script>
// Inicializar Auto Save ap√≥s DOM carregar
// ReportsAutoSave j√° detecta automaticamente o par√¢metro ?edit={id} da URL
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se existe um reportId renderizado pelo servidor
    const formReportId = document.querySelector('#reportForm')?.getAttribute('data-report-id');

    // Inicializar AutoSave (ele detectar√° automaticamente ?edit={id} ou usar√° formReportId)
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    // Se existe reportId do servidor, expor globalmente para o AutoSave
    if (formReportId) {
        window.currentReportId = parseInt(formReportId, 10);
    }

    // Inicializar AutoSave - ele detectar√° o ID automaticamente
    const autoSave = initAutoSave(null, csrfToken);

    console.log('‚úÖ Auto Save inicializado');
});
</script>

<!-- Mobile-First Photo System JavaScript -->
<script>
// Global variables for mobile photo system
let mobilePhotoCounter = 0;
let predefinedLegendas = [];

// Garantir que window.mobilePhotoData sempre exista (conforme especifica√ß√£o t√©cnica)
if (!window.mobilePhotoData) window.mobilePhotoData = [];

// ============================================================================
// CARREGAR DADOS EXISTENTES AO EDITAR RELAT√ìRIO
// ============================================================================
{% if existing_fotos and existing_fotos|length > 0 %}
console.log('üì∏ Carregando {{ existing_fotos|length }} fotos existentes...');
try {
    const fotosExistentes = {{ existing_fotos | tojson | safe }};
    window.mobilePhotoData = fotosExistentes.map((foto, index) => ({
        id: foto.id,
        previewUrl: foto.url,
        file: null,
        metadata: {
            legenda: foto.legenda || '',
            titulo: foto.titulo || '',
            descricao: foto.descricao || '',
            categoria: foto.tipo_servico || 'Geral',
            local: foto.local || ''
        },
        isExisting: true,
        ordem: foto.ordem || index
    }));
    console.log('‚úÖ Fotos existentes carregadas:', window.mobilePhotoData.length);
} catch (e) {
    console.error('‚ùå Erro ao carregar fotos existentes:', e);
}
{% endif %}

{% if existing_checklist %}
console.log('‚úÖ Carregando checklist existente...');
try {
    const checklistExistente = {{ existing_checklist | tojson | safe }};
    console.log('üìã Checklist existente:', checklistExistente);

    // Marcar checkboxes do checklist
    document.addEventListener('DOMContentLoaded', function() {
        if (!checklistExistente) {
            console.log('‚ö†Ô∏è Nenhum checklist existente');
            return;
        }

        if (Array.isArray(checklistExistente)) {
            console.log(`üìã Processando ${checklistExistente.length} itens do checklist (array)`);
            // Se for um array, iterar sobre os itens
            checklistExistente.forEach((item, index) => {
                console.log(`  üìù Item ${index}:`, item);
                if (item && item.id) {
                    const checkbox = document.querySelector(`#check_${item.id}`);
                    if (checkbox) {
                        if (item.completed || item.concluido) {
                            checkbox.checked = true;
                            toggleChecklistItem(checkbox);
                            console.log(`  ‚úì Marcado: ${item.texto || item.id}`);
                        }
                    } else {
                        console.log(`  ‚ö†Ô∏è Checkbox n√£o encontrado para ID: ${item.id}`);
                    }
                }
            });
        } else if (typeof checklistExistente === 'object') {
            console.log('üìã Processando checklist (objeto)');
            // Se for um objeto, usar Object.keys
            Object.keys(checklistExistente).forEach(key => {
                const checkbox = document.querySelector(`input[name="${key}"]`);
                if (checkbox && checklistExistente[key]) {
                    checkbox.checked = true;
                    console.log(`‚úì Checklist item marcado: ${key}`);
                }
            });
        } else {
            console.warn('‚ö†Ô∏è Formato de checklist n√£o reconhecido:', typeof checklistExistente);
        }
    });
} catch (e) {
    console.error('‚ùå Erro ao carregar checklist:', e);
}
{% endif %}

// Load predefined captions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadPredefinedLegendas();
    setupMobilePhotoSystem();

    // Renderizar fotos existentes na galeria
    {% if existing_fotos and existing_fotos|length > 0 %}
    setTimeout(() => {
        updatePhotoGallery();
        console.log('‚úÖ Galeria de fotos renderizada com fotos existentes');
    }, 500);
    {% endif %}
});

// Load predefined captions from API
async function loadPredefinedLegendas() {
    try {
        console.log('üì¶ Carregando legendas pr√©-definidas...');
        const response = await fetch('/api/legendas?categoria=all');
        
        if (!response.ok) {
            throw new Error(`Falha ao carregar legendas. Status: ${response.status}`);
        }
        
        const data = await response.json();

        if (data.success && Array.isArray(data.legendas)) {
            predefinedLegendas = data.legendas;
            console.log(`‚úÖ ${predefinedLegendas.length} legendas carregadas com sucesso`);
            
            // ‚úÖ CORRE√á√ÉO: Preencher todos os dropdowns existentes ap√≥s carregar as legendas
            preencherDropdownLegendas();
        } else if (Array.isArray(data.legendas) && data.legendas.length > 0) {
            // Se apenas data.legendas existe, usar mesmo assim
            predefinedLegendas = data.legendas;
            console.log(`‚úÖ ${predefinedLegendas.length} legendas carregadas (sem flag success)`);
            preencherDropdownLegendas();
        } else {
            console.warn('‚ö†Ô∏è Nenhuma legenda encontrada na resposta');
            predefinedLegendas = [];
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar legendas:', error);
        predefinedLegendas = [];
    }
}

// ‚úÖ NOVA FUN√á√ÉO: Preenche todos os dropdowns de legendas pr√©-definidas
function preencherDropdownLegendas() {
    if (!predefinedLegendas || predefinedLegendas.length === 0) {
        console.warn('‚ö†Ô∏è Nenhuma legenda dispon√≠vel para preencher dropdowns');
        return;
    }

    // Selecionar todos os dropdowns de legenda (caption-select)
    const selects = document.querySelectorAll('.caption-select');
    
    if (selects.length === 0) {
        console.log('‚ÑπÔ∏è Nenhum dropdown de legenda encontrado no momento (normal se n√£o h√° fotos ainda)');
        return;
    }

    console.log(`üìã Preenchendo ${selects.length} dropdowns de legendas...`);
    
    selects.forEach(select => {
        // Limpar op√ß√µes antigas (manter apenas o placeholder)
        select.innerHTML = '<option value="">üìã Ou escolha uma legenda pr√©-definida...</option>';
        
        // Agrupar legendas por categoria
        const legendsByCategory = {};
        predefinedLegendas.forEach(legenda => {
            if (!legendsByCategory[legenda.categoria]) {
                legendsByCategory[legenda.categoria] = [];
            }
            legendsByCategory[legenda.categoria].push(legenda);
        });
        
        // Adicionar op√ß√µes agrupadas
        Object.keys(legendsByCategory).sort().forEach(categoria => {
            const optgroup = document.createElement('optgroup');
            optgroup.label = `${categoria} (${legendsByCategory[categoria].length})`;
            
            legendsByCategory[categoria].forEach(legenda => {
                const option = document.createElement('option');
                option.value = legenda.texto;
                option.textContent = legenda.texto;
                option.dataset.categoria = legenda.categoria;
                option.dataset.id = legenda.id;
                
                optgroup.appendChild(option);
            });
            
            select.appendChild(optgroup);
        });
        
        // ‚úÖ CORRE√á√ÉO: Garantir que o listener de change est√° configurado
        const photoId = select.dataset.photoId;
        if (photoId && !select.dataset.listenerAdded) {
            const manualInput = document.getElementById(`manual_caption_${photoId}`);
            if (manualInput) {
                select.addEventListener('change', function() {
                    if (this.value) {
                        // Preencher o campo de texto automaticamente
                        manualInput.value = this.value;
                        manualInput.classList.add('border-success');
                        savePhotoData(photoId);
                        
                        // Reset select para permitir reutiliza√ß√£o
                        setTimeout(() => {
                            this.selectedIndex = 0;
                        }, 500);
                    }
                });
                select.dataset.listenerAdded = 'true';
            }
        }
    });
    
    console.log(`‚úÖ ${selects.length} dropdowns preenchidos com ${predefinedLegendas.length} legendas`);
}

// Setup mobile photo system
function setupMobilePhotoSystem() {
    console.log('üì± Configurando sistema de fotos mobile-first...');

    // Setup file input event listeners
    const mobilePhotoInput = document.getElementById('mobilePhotoInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');

    if (mobilePhotoInput) {
        mobilePhotoInput.addEventListener('change', handleMobilePhotoSelection);
    }

    if (mobileCameraInput) {
        mobileCameraInput.addEventListener('change', handleMobilePhotoSelection);
    }
}

// Mobile gallery selection
function mobileSelectFromGallery() {
    console.log('üì∏ Selecionando da galeria (mobile)...');
    const input = document.getElementById('mobilePhotoInput');
    if (input) {
        input.click();
    }
}

// Mobile camera capture
function mobileCaptureFromCamera() {
    console.log('üì∑ Capturando da c√¢mera (mobile)...');
    const input = document.getElementById('mobileCameraInput');
    if (input) {
        input.click();
    }
}

/**
 * Fun√ß√£o para registrar corretamente as fotos com todos os metadados
 * Conforme especifica√ß√£o t√©cnica do prompt
 * PRESERVA todos os metadados existentes (savedId, temp_id, etc.)
 * SUPORTA tanto novas fotos (com File) quanto fotos existentes (apenas metadados)
 */
function handlePhotoAdded(file, metadata = {}) {
    // Garantir que o array global existe
    if (!window.mobilePhotoData) window.mobilePhotoData = [];

    // Determinar previewUrl: usar metadata primeiro, sen√£o criar de File se dispon√≠vel
    let previewUrl = metadata.previewUrl || metadata.url;
    if (!previewUrl && file) {
        try {
            previewUrl = URL.createObjectURL(file);
        } catch (e) {
            console.warn("‚ö†Ô∏è Erro ao criar preview URL:", e);
            previewUrl = null;
        }
    }

    // Determinar filename e name
    const filename = metadata.filename || (file ? file.name : null) || "foto_" + Date.now();
    const name = metadata.name || (file ? file.name : null) || "foto_" + Date.now();

    const photoEntry = {
        id: metadata.id || (crypto.randomUUID ? crypto.randomUUID() : 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)),
        name: name,
        path: metadata.path || (file ? file.path : null) || null,
        previewUrl: previewUrl,
        category: metadata.category || null,
        local: metadata.local || null,
        caption: metadata.caption || "",
        manualCaption: metadata.manualCaption || "",
        predefinedCaption: metadata.predefinedCaption || "",
        filename: filename,
        file: file || null,  // Pode ser null para fotos existentes
        blob: file || null,  // üî• Campo blob para compatibilidade com AutoSave
        hasFile: !!file,
        // PRESERVAR savedId e temp_id se j√° existirem em metadata
        savedId: metadata.savedId || null,
        temp_id: metadata.temp_id || null,
        // Preservar URL se existir (para fotos j√° salvas)
        url: metadata.url || null,
        ordem: metadata.ordem !== undefined ? metadata.ordem : null
    };

    // Atualiza o array global
    window.mobilePhotoData.push(photoEntry);

    console.log("üì∑ Foto adicionada ao mobilePhotoData:", window.mobilePhotoData);

    return photoEntry;
}

// Handle photo selection from mobile inputs
function handleMobilePhotoSelection(event) {
    console.log('üìã Processando fotos selecionadas...');
    const files = event.target.files;

    if (files.length === 0) return;

    Array.from(files).forEach(file => {
        createMobilePhotoCard(file, '');
    });

    // Clear input for next selection
    event.target.value = '';
}

// Create mobile photo card with immediate display
function createMobilePhotoCard(file, category) {
    const photoId = 'mobile_photo_' + (++mobilePhotoCounter);

    // Registrar foto globalmente usando handlePhotoAdded (conforme especifica√ß√£o t√©cnica)
    const photoEntry = handlePhotoAdded(file, {
        category: category || null,
        local: '',
        caption: '',
        manualCaption: '',
        predefinedCaption: ''
    });

    // Atualizar o ID da foto no photoEntry
    photoEntry.id = photoId;

    const reader = new FileReader();

    reader.onload = function(e) {
        const photoCard = createPhotoCardHTML(photoId, e.target.result, category, file.name);

        // Add to DOM
        const container = document.getElementById('mobilePhotoCards');
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-lg-4';
        cardCol.innerHTML = photoCard;
        container.appendChild(cardCol);

        // Update counter after adding photo
        updatePhotoCounter();

        // Setup event listeners for this card
        setupPhotoCardEvents(photoId);

        // ‚úÖ CORRE√á√ÉO: Preencher dropdowns de legendas para o novo cart√£o
        if (predefinedLegendas && predefinedLegendas.length > 0) {
            preencherDropdownLegendas();
        }

        // Immediately scroll to the new photo and focus on caption for better UX
        setTimeout(() => {
            const newCard = cardCol.querySelector('.mobile-photo-card');
            if (newCard) {
                newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Auto-focus on caption input for immediate editing
                const captionInput = newCard.querySelector('.caption-input');
                if (captionInput) {
                    setTimeout(() => {
                        captionInput.focus();
                        captionInput.select();
                    }, 600);
                }
            }
        }, 300);

        console.log(`üì∑ Foto adicionada: ${file.name} (${category})`);
        console.log(`üì∏ Total de fotos em mobilePhotoData: ${window.mobilePhotoData.length}`);
    };

    reader.readAsDataURL(file);
}

// Create photo card HTML
function createPhotoCardHTML(photoId, imageSrc, category, filename) {
    const legendaSelectHTML = createLegendaSelectHTML(photoId);

    return `
        <div class="mobile-photo-card enhanced" data-photo-id="${photoId}" style="border: 2px solid #007bff; border-radius: 12px; padding: 12px; background: white; box-shadow: 0 4px 12px rgba(0,123,255,0.15); margin-bottom: 16px;">
            <!-- Layout Vertical: IMAGEM EM CIMA -->
            <div class="text-center mb-3">
                <img src="${imageSrc}" 
                     alt="${filename}" 
                     data-photo-id="${photoId}"
                     style="width: 100%; max-width: 200px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e9ecef; cursor: pointer;">
            </div>

            <!-- Categoria (Sele√ß√£o dentro do card) -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">üìÅ Categoria</label>
                <select class="form-select form-select-sm categoria-select" 
                        id="category_${photoId}" 
                        data-photo-id="${photoId}"
                        style="border: 2px solid #007bff; font-size: 13px;">
                    <option value="">${category ? category : 'Selecione...'}</option>
                </select>
            </div>

            <!-- Local -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">üìç Local</label>
                <input type="text" 
                       class="form-control form-control-sm local-input" 
                       id="local_${photoId}" 
                       placeholder="Ex: Sala principal, Fachada norte..."
                       data-photo-id="${photoId}"
                       style="border: 2px solid #ff9800; font-size: 13px; padding: 6px;">
            </div>

            <!-- Legenda Manual -->
            <div class="mb-2">
                <label class="form-label fw-bold mb-1" style="font-size: 12px;">üìù Legenda *</label>
                <input type="text" 
                       class="form-control caption-input" 
                       id="manual_caption_${photoId}" 
                       placeholder="Digite uma legenda..."
                       data-photo-id="${photoId}"
                       required
                       style="border: 2px solid #28a745; font-size: 13px; padding: 6px; background-color: #f8fff9;">
            </div>

            <!-- Legenda Pr√©-definida -->
            <div class="mb-2">
                <select class="form-select form-select-sm caption-select" 
                        id="predefined_caption_${photoId}" 
                        data-photo-id="${photoId}"
                        style="font-size: 12px;">
                    <option value="">üìã Ou escolha uma legenda pr√©-definida...</option>
                    ${legendaSelectHTML}
                </select>
            </div>

            <!-- Status da Legenda -->
            <div class="caption-status pending alert alert-warning py-1 px-2 mb-2" id="caption_status_${photoId}" style="font-size: 12px; margin: 0;">
                ‚ö†Ô∏è Legenda obrigat√≥ria - preencha o campo acima
            </div>

            <!-- A√ß√µes -->
            <div class="d-flex gap-2 justify-content-center">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editMobilePhoto('${photoId}')">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteMobilePhoto('${photoId}')">
                    <i class="fas fa-trash"></i> Excluir
                </button>
            </div>
        </div>
    `;
}

// Create legend select HTML
// ‚úÖ CORRE√á√ÉO: Esta fun√ß√£o agora retorna vazio - o preenchimento √© feito por preencherDropdownLegendas()
function createLegendaSelectHTML(photoId) {
    // Retornar vazio - as legendas ser√£o carregadas dinamicamente por preencherDropdownLegendas()
    // Isso garante que as legendas sejam carregadas ap√≥s o fetch da API estar completo
    return '';
}

// Setup event listeners for photo card
function setupPhotoCardEvents(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const localInput = document.getElementById(`local_${photoId}`);
    const categorySelect = document.getElementById(`category_${photoId}`);

    if (manualInput) {
        manualInput.addEventListener('input', () => savePhotoData(photoId));
        manualInput.addEventListener('blur', () => savePhotoData(photoId));
    }

    if (localInput) {
        localInput.addEventListener('input', () => savePhotoData(photoId));
        localInput.addEventListener('blur', () => savePhotoData(photoId));
    }

    if (categorySelect) {
        categorySelect.addEventListener('change', () => savePhotoData(photoId));
    }

    if (predefinedSelect) {
        predefinedSelect.addEventListener('change', function() {
            if (this.value) {
                // Copy predefined to manual field
                manualInput.value = this.value;
                savePhotoData(photoId);

                // Reset select for next use
                setTimeout(() => {
                    this.selectedIndex = 0;
                }, 500);
            }
        });
    }

    // Populate category select with available categories
    populateCategorySelect(photoId);
}

// Save photo data (category, local, caption) - Updated function
async function savePhotoData(photoId) {
    const manualInput = document.getElementById(`manual_caption_${photoId}`);
    const predefinedSelect = document.getElementById(`predefined_caption_${photoId}`);
    const localInput = document.getElementById(`local_${photoId}`);
    const categorySelect = document.getElementById(`category_${photoId}`);
    const statusDiv = document.getElementById(`caption_status_${photoId}`);

    const manualCaption = manualInput ? manualInput.value.trim() : '';
    const predefinedCaption = predefinedSelect ? predefinedSelect.value.trim() : '';
    const local = localInput ? localInput.value.trim() : '';
    const category = categorySelect ? categorySelect.value : '';

    // Update stored data
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (photoData) {
        photoData.manualCaption = manualCaption;
        photoData.predefinedCaption = predefinedCaption;
        photoData.local = local;
        photoData.category = category;
    }

    // Update status indicator
    const hasCaption = manualCaption || predefinedCaption;
    const hasLocal = local.length > 0;
    const hasCategory = category && category !== '';

    if (hasCaption) {
        statusDiv.className = 'caption-status complete alert alert-success py-1 px-2 mb-2';
        statusDiv.innerHTML = '‚úÖ Legenda preenchida';
    } else {
        statusDiv.className = 'caption-status pending alert alert-warning py-1 px-2 mb-2';
        statusDiv.innerHTML = `‚ö†Ô∏è Obrigat√≥rio: Legenda`;
    }

    console.log(`üíæ Photo data saved for ${photoId}: category="${category}", local="${local}", caption="${manualCaption}"`);
}

// Populate category select for a photo card
function populateCategorySelect(photoId) {
    const categorySelect = document.getElementById(`category_${photoId}`);
    const projetoId = document.getElementById('projeto_id')?.value;

    if (!categorySelect || !projetoId) return;

    // Buscar categorias do projeto via API
    fetch(`/api/projects/${projetoId}/categorias`)
        .then(response => response.json())
        .then(data => {
            if (data.categorias && data.categorias.length > 0) {
                // Renderizar categorias
                let html = '<option value="">Sem categoria</option>';
                data.categorias.forEach(cat => {
                    html += `<option value="${cat.nome}">${cat.nome}</option>`;
                });
                categorySelect.innerHTML = html;

                // Set the currently selected value if it exists in photoData
                const photoData = mobilePhotoData.find(p => p.id === photoId);
                if (photoData && photoData.category) {
                    categorySelect.value = photoData.category;
                }
            } else {
                // Nenhuma categoria encontrada
                categorySelect.innerHTML = '<option value="">Sem categoria</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar categorias:', error);
            categorySelect.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

// Keep old function for backward compatibility
async function saveCaptionData(photoId) {
    return savePhotoData(photoId);
}

// Edit mobile photo - RESTAURADO como funcionava antes
function editMobilePhoto(photoId) {
    const photoData = mobilePhotoData.find(p => p.id === photoId);
    if (!photoData) return;

    // Encontrar o elemento img da foto
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    const imgElement = photoCard.querySelector('img');

    if (!imgElement) {
        console.error('Imagem n√£o encontrada para edi√ß√£o');
        return;
    }

    // Abrir editor modal como funcionava antes
    openPhotoEditorFromElement(imgElement);
}

// Delete mobile photo - CORRIGIDO para deletar do banco se for foto existente
async function deleteMobilePhoto(photoId) {
    if (!confirm('Deseja excluir esta foto?')) return;

    // Encontrar a foto nos dados
    const photoData = window.mobilePhotoData.find(p => p.id === photoId);
    
    // Se a foto tem savedId, significa que j√° est√° salva no banco - precisa deletar via API
    if (photoData && photoData.savedId) {
        try {
            const response = await fetch(`/api/fotos/${photoData.savedId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            });
            
            const result = await response.json();
            
            if (!result.success) {
                console.error('‚ùå Erro ao deletar foto do banco:', result.error);
                alert('Erro ao excluir foto: ' + result.error);
                return;
            }
            
            console.log(`‚úÖ Foto ${photoData.savedId} deletada do banco de dados`);
        } catch (error) {
            console.error('‚ùå Erro ao chamar API de exclus√£o:', error);
            alert('Erro ao excluir foto. Tente novamente.');
            return;
        }
    }

    // Remove from data array
    window.mobilePhotoData = window.mobilePhotoData.filter(p => p.id !== photoId);

    // Remove from DOM
    const photoCard = document.querySelector(`[data-photo-id="${photoId}"]`);
    if (photoCard) {
        photoCard.closest('.col-12, .col-md-6, .col-lg-4').remove();
    }

    updatePhotoCounter();
    console.log(`üóëÔ∏è Foto ${photoId} exclu√≠da${photoData && photoData.savedId ? ' do banco e' : ''} da interface`);
}

// Update photo counter and show quick actions
function updatePhotoCounter() {
    const count = mobilePhotoData.length;

    // Update main counter
    const counter = document.getElementById('photoCount');
    if (counter) {
        counter.textContent = count;
    }

    // Update quick action counter
    const quickCounter = document.getElementById('quickPhotoCount');
    if (quickCounter) {
        quickCounter.textContent = count;
    }

    // Show quick action bar after first photo
    const quickActionBar = document.getElementById('quickPhotoActions');
    if (quickActionBar) {
        if (count > 0) {
            quickActionBar.style.display = 'block';
        } else {
            quickActionBar.style.display = 'none';
        }
    }
}

// Validate captions before form submission
function validateCaptions() {
    let hasInvalidPhotos = false;

    mobilePhotoData.forEach(photoData => {
        const hasCaption = photoData.manualCaption || photoData.predefinedCaption;
        if (!hasCaption) {
            hasInvalidPhotos = true;

            // Highlight invalid photo
            const statusDiv = document.getElementById(`caption_status_${photoData.id}`);
            if (statusDiv) {
                statusDiv.className = 'caption-status pending';
                statusDiv.innerHTML = '‚ùå OBRIGAT√ìRIO: Adicione uma legenda';
                statusDiv.style.animation = 'pulse 2s infinite';
            }
        }
    });

    return !hasInvalidPhotos;
}

// Prepare form data for submission
async function prepareMobilePhotoFormData() {
    console.log('üì± Preparando dados das fotos mobile...');

    // Adicionar os arquivos reais ao FormData
    mobilePhotoData.forEach((photoData, index) => {
        console.log(`‚úÖ Adicionando foto ${index}: ${photoData.filename} (${photoData.category})`);

        // Criar inputs hidden para metadados
        const categoryInput = document.createElement('input');
        categoryInput.type = 'hidden';
        categoryInput.name = `photo_category_${index}`;
        categoryInput.value = photoData.category;

        const captionInput = document.createElement('input');
        captionInput.type = 'hidden';
        captionInput.name = `photo_caption_${index}`;
        captionInput.value = photoData.manualCaption || photoData.predefinedCaption;

        // Criar file input para o arquivo real
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.name = `photo_${index}`;
        fileInput.style.display = 'none';

        // Transferir o arquivo para o input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(photoData.file);
        fileInput.files = dataTransfer.files;

        // Adicionar ao form
        const form = document.getElementById('reportForm');
        if (form) {
            form.appendChild(categoryInput);
            form.appendChild(captionInput);
            form.appendChild(fileInput);
        }
    });

    console.log(`üì§ Preparados ${mobilePhotoData.length} fotos com arquivos bin√°rios para envio`);
}

// COMENTADO - Este event listener foi substitu√≠do por uma nova implementa√ß√£o
// que suporta edi√ß√£o de relat√≥rios via API
/*
// Form submission validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('reportForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            // Validate captions
            if (!validateCaptions()) {
                e.preventDefault();
                alert('‚ö†Ô∏è ATEN√á√ÉO: Todas as fotos devem ter pelo menos uma legenda (manual ou pr√©-definida). Verifique as fotos marcadas em vermelho.');

                // Scroll to first invalid photo
                const firstInvalid = document.querySelector('.caption-status.pending');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                return false;
            }

            // If there are photos, prepare mobile photo data
            if (mobilePhotoData.length > 0) {
                e.preventDefault(); // Prevent default submission while processing photos

                console.log('üì∏ Processando fotos...');
                try {
                    await prepareMobilePhotoFormData();
                    console.log('‚úÖ Fotos preparadas - enviando formul√°rio com arquivos bin√°rios...');

                    // Submit the form with the prepared files (native form submission)
                    form.submit();
                } catch (error) {
                    console.error('‚ùå Erro ao processar fotos:', error);
                    alert('‚ùå Erro ao processar as fotos. Por favor, tente novamente.');
                    return false;
                }
            } else {
                console.log('‚úÖ Formul√°rio validado sem fotos - enviando...');
            }
        });
    }
});
*/

console.log('üì± Sistema de fotos mobile-first carregado');
</script>

<!-- Modal de Acompanhantes da Visita -->
<div class="modal fade" id="modalAcompanhantes" tabindex="-1" aria-labelledby="modalAcompanhantesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAcompanhantesLabel">
                    <i class="fas fa-user-friends me-2"></i>Adicionar Acompanhante da Visita
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formAcompanhante">
                    <!-- Op√ß√£o de sele√ß√£o: Funcion√°rio ou Manual -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Tipo de Acompanhante</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="tipo_acompanhante" id="tipo_funcionario" value="funcionario" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="tipo_funcionario">
                                <i class="fas fa-user-tie me-1"></i>Funcion√°rio da Obra
                            </label>

                            <input type="radio" class="btn-check" name="tipo_acompanhante" id="tipo_externo" value="externo" autocomplete="off">
                            <label class="btn btn-outline-info" for="tipo_externo">
                                <i class="fas fa-user me-1"></i>Externo (Cliente/Visitante)
                            </label>
                        </div>
                    </div>

                    <!-- Sele√ß√£o de Funcion√°rio -->
                    <div id="selecao-funcionario" class="mb-3">
                        <label for="funcionario-select" class="form-label">Selecionar Funcion√°rio *</label>
                        <select class="form-select" id="funcionario-select">
                            <option value="">Selecione um projeto primeiro...</option>
                        </select>
                        <small class="text-muted">Funcion√°rios cadastrados nesta obra</small>
                    </div>

                    <!-- Entrada Manual -->
                    <div id="entrada-manual" class="d-none">
                        <div class="mb-3">
                            <label for="nome-manual" class="form-label">Nome *</label>
                            <input type="text" class="form-control" id="nome-manual" placeholder="Nome completo do acompanhante">
                        </div>
                        <div class="mb-3">
                            <label for="funcao-acompanhante" class="form-label">Fun√ß√£o/Cargo</label>
                            <input type="text" class="form-control" id="funcao-acompanhante" placeholder="Ex: Engenheiro, Cliente, Gerente, etc.">
                            <small class="text-muted">Opcional</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer d-flex justify-content-between flex-wrap gap-2">
                <button type="button" class="btn btn-secondary flex-fill" style="min-width: 120px;" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i><span>Cancelar</span>
                </button>
                <button type="button" class="btn btn-success flex-fill" style="min-width: 120px;" onclick="adicionarAcompanhante()">
                    <i class="fas fa-check me-1"></i><span>Adicionar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para Gerenciar Acompanhantes -->
<script>
// Array para armazenar acompanhantes
let acompanhantes = [];

// Alternar entre sele√ß√£o de funcion√°rio e entrada manual
document.querySelectorAll('input[name="tipo_acompanhante"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const selecaoFunc = document.getElementById('selecao-funcionario');
        const entradaManual = document.getElementById('entrada-manual');

        if (this.value === 'funcionario') {
            selecaoFunc.classList.remove('d-none');
            entradaManual.classList.add('d-none');
        } else {
            selecaoFunc.classList.add('d-none');
            entradaManual.classList.remove('d-none');
        }
    });
});

// Carregar funcion√°rios quando projeto for selecionado
document.getElementById('projeto_id')?.addEventListener('change', function() {
    carregarFuncionariosParaAcompanhantes(this.value);
});

// Carregar funcion√°rios da obra
function carregarFuncionariosParaAcompanhantes(projetoId) {
    const select = document.getElementById('funcionario-select');

    if (!projetoId) {
        select.innerHTML = '<option value="">Selecione um projeto primeiro...</option>';
        return;
    }

    select.innerHTML = '<option value="">Carregando...</option>';

    fetch(`/api/projeto/${projetoId}/funcionarios-emails`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.funcionarios && data.funcionarios.length > 0) {
            let options = '<option value="">Selecione um funcion√°rio...</option>';
            data.funcionarios.forEach(func => {
                const nome = func.nome_funcionario || 'Sem nome';
                const cargo = func.cargo || 'N√£o informado';
                options += `<option value="${func.id}" data-nome="${nome}" data-cargo="${cargo}">${nome} ‚Äì ${cargo}</option>`;
            });
            select.innerHTML = options;
        } else {
            select.innerHTML = '<option value="">Nenhum funcion√°rio cadastrado nesta obra</option>';
        }
    })
    .catch(error => {
        console.error('Erro ao carregar funcion√°rios:', error);
        select.innerHTML = '<option value="">Erro ao carregar funcion√°rios</option>';
    });
}

// Abrir modal
function abrirModalAcompanhantes() {
    const projetoId = document.getElementById('projeto_id')?.value;

    if (!projetoId) {
        alert('Por favor, selecione um projeto primeiro!');
        return;
    }

    // Carregar funcion√°rios se ainda n√£o foram carregados
    carregarFuncionariosParaAcompanhantes(projetoId);

    // Limpar formul√°rio
    document.getElementById('formAcompanhante').reset();
    document.getElementById('tipo_funcionario').checked = true;
    document.getElementById('selecao-funcionario').classList.remove('d-none');
    document.getElementById('entrada-manual').classList.add('d-none');

    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalAcompanhantes'));
    modal.show();
}

// Adicionar acompanhante
function adicionarAcompanhante() {
    const tipo = document.querySelector('input[name="tipo_acompanhante"]:checked').value;
    let nome = '';
    let funcao = '';
    let origem = '';

    if (tipo === 'funcionario') {
        const select = document.getElementById('funcionario-select');
        const selectedOption = select.options[select.selectedIndex];

        if (!select.value) {
            alert('Por favor, selecione um funcion√°rio!');
            return;
        }

        nome = selectedOption.getAttribute('data-nome');
        funcao = selectedOption.getAttribute('data-cargo') || '';
        origem = 'Funcion√°rio da obra';
    } else {
        nome = document.getElementById('nome-manual').value.trim();
        funcao = document.getElementById('funcao-acompanhante').value.trim();

        if (!nome) {
            alert('Por favor, preencha o nome do acompanhante!');
            return;
        }

        origem = 'Inserido manualmente';
    }

    // Adicionar ao array
    const acompanhante = {
        nome: nome,
        funcao: funcao,
        origem: origem
    };

    acompanhantes.push(acompanhante);

    // Atualizar visualiza√ß√£o
    atualizarListaAcompanhantes();

    // Atualizar campo hidden
    document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);

    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById('modalAcompanhantes')).hide();

    console.log('‚úÖ Acompanhante adicionado:', acompanhante);
}

// Atualizar lista de acompanhantes
function atualizarListaAcompanhantes() {
    const lista = document.getElementById('lista-acompanhantes');

    if (acompanhantes.length === 0) {
        lista.innerHTML = `
            <p class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-1"></i>
                Nenhum acompanhante adicionado ainda. Clique em "Adicionar Acompanhante" para come√ßar.
            </p>
        `;
        return;
    }

    let html = '<div class="list-group">';
    acompanhantes.forEach((acomp, index) => {
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-user me-2 text-primary"></i>
                            <strong>${acomp.nome}</strong>
                        </h6>
                        ${acomp.funcao ? `<p class="mb-1 text-muted"><small><i class="fas fa-briefcase me-1"></i>${acomp.funcao}</small></p>` : ''}
                        <p class="mb-0">
                            <span class="badge bg-${acomp.origem.includes('Funcion√°rio') ? 'info' : 'success'}">
                                ${acomp.origem}
                            </span>
                        </p>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerAcompanhante(${index})" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';

    lista.innerHTML = html;
}

// Remover acompanhante
function removerAcompanhante(index) {
    if (confirm('Deseja remover este acompanhante?')) {
        acompanhantes.splice(index, 1);
        atualizarListaAcompanhantes();
        document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);
        console.log('üóëÔ∏è Acompanhante removido. Total:', acompanhantes.length);
    }
}

// Carregar acompanhantes existentes ao editar relat√≥rio
{% if existing_acompanhantes and existing_acompanhantes|length > 0 %}
try {
    const acompanhantesExistentes = {{ existing_acompanhantes | tojson | safe }};
    if (acompanhantesExistentes && Array.isArray(acompanhantesExistentes)) {
        acompanhantes = acompanhantesExistentes;
        atualizarListaAcompanhantes();
        document.getElementById('acompanhantes-data').value = JSON.stringify(acompanhantes);
        console.log('‚úÖ Acompanhantes carregados:', acompanhantes.length);
    }
} catch (e) {
    console.error('‚ùå Erro ao carregar acompanhantes existentes:', e);
}
{% endif %}

console.log('‚úÖ Sistema de acompanhantes inicializado');
</script>

<!-- Script de carregamento para modo de edi√ß√£o -->
<script>
// Update photo gallery - VERS√ÉO CORRIGIDA para fotos existentes
function updatePhotoGallery() {
    const container = document.getElementById('mobilePhotoCards');
    if (!container) {
        console.warn('‚ö†Ô∏è Container mobilePhotoCards n√£o encontrado');
        return;
    }

    container.innerHTML = '';

    if (!window.mobilePhotoData || window.mobilePhotoData.length === 0) {
        console.log('üì∏ Nenhuma foto para renderizar');
        updatePhotoCounter();
        return;
    }

    console.log(`üé® Renderizando ${window.mobilePhotoData.length} fotos`);

    window.mobilePhotoData.forEach((photo, index) => {
        const cardCol = document.createElement('div');
        cardCol.className = 'col-12 col-md-6 col-lg-4';

        // CORRE√á√ÉO: Garantir que categoria seja extra√≠da corretamente
        const categoria = photo.metadata?.categoria || photo.metadata?.tipo_servico || photo.category || photo.tipo_servico || '';
        const local = photo.metadata?.local || photo.local || '';
        const legenda = photo.metadata?.legenda || photo.legenda || photo.caption || '';

        console.log(`üì∏ Foto ${index + 1}:`, {
            id: photo.id,
            categoria: categoria,
            local: local,
            legenda: legenda,
            isExisting: photo.isExisting
        });

        const photoCard = createPhotoCardHTML(
            photo.id,
            photo.previewUrl || photo.url,
            categoria,
            photo.name || photo.filename || photo.filename_original || `foto_${index + 1}`
        );

        cardCol.innerHTML = photoCard;
        container.appendChild(cardCol);

        // Setup event listeners for this card
        setupPhotoCardEvents(photo.id);

        // CORRE√á√ÉO: Preencher TODOS os campos com dados existentes
        setTimeout(() => {
            const legendaInput = document.getElementById(`manual_caption_${photo.id}`);
            const categoriaSelect = document.getElementById(`category_${photo.id}`);
            const localInput = document.getElementById(`local_${photo.id}`);
            const predefinedSelect = document.getElementById(`predefined_caption_${photo.id}`);

            // Preencher legenda manual
            if (legendaInput && legenda) {
                legendaInput.value = legenda;
                console.log(`‚úÖ Legenda preenchida para ${photo.id}: ${legenda}`);
            }

            // Preencher categoria
            if (categoriaSelect && categoria) {
                categoriaSelect.value = categoria;
                console.log(`‚úÖ Categoria preenchida para ${photo.id}: ${categoria}`);
            }

            // Preencher local
            if (localInput && local) {
                localInput.value = local;
                console.log(`‚úÖ Local preenchido para ${photo.id}: ${local}`);
            }

            // Se tem legenda, tamb√©m preencher o select de predefinidas
            if (predefinedSelect && legenda) {
                const options = predefinedSelect.querySelectorAll('option');
                for (let opt of options) {
                    if (opt.value === legenda) {
                        predefinedSelect.value = legenda;
                        break;
                    }
                }
            }
        }, 200);
    });

    updatePhotoCounter();
    
    // ‚úÖ CORRE√á√ÉO: Preencher dropdowns de legendas para todas as fotos existentes
    setTimeout(() => {
        if (predefinedLegendas && predefinedLegendas.length > 0) {
            preencherDropdownLegendas();
            console.log('‚úÖ Dropdowns de legendas preenchidos para fotos existentes');
        }
    }, 400);
    
    console.log('‚úÖ Galeria atualizada com metadados completos');
}

function carregarChecklist(items) {
  console.log('üìã carregarChecklist() chamada com:', items);

  const list = document.querySelector("#checklistItems");
  if (!list) {
    console.error('‚ùå Container #checklistItems n√£o encontrado no DOM!');
    return;
  }

  console.log(`üìã Container #checklistItems encontrado, limpando conte√∫do...`);
  list.innerHTML = "";

  if (!items || items.length === 0) {
    console.warn('‚ö†Ô∏è Array de items vazio ou undefined');
    list.innerHTML = `
      <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Nenhum item no checklist. Adicione itens personalizados conforme necess√°rio.
      </div>
    `;
    return;
  }

  console.log(`üìã Processando ${items.length} itens do checklist...`);

  items.forEach((item, index) => {
    console.log(`üìã Item ${index}:`, item);

    const div = document.createElement("div");
    div.className = "checklist-item mb-3";
    if (item.checked) {
      div.classList.add("completed");
    }

    const texto = item.texto || 'Sem descri√ß√£o';
    const checked = item.checked || false;
    const imagem = item.imagem_url || '';
    const observacao = item.observacao || '';

    console.log(`  üìù Texto: "${texto}", Checked: ${checked}, Imagem: ${imagem ? 'SIM' : 'N√ÉO'}`);

    let itemHTML = `
      <div class="form-check">
        <input type="checkbox" class="form-check-input" id="check_${item.id || index}" data-id="${item.id || ''}" ${checked ? "checked" : ""}>
        <label class="form-check-label fw-bold" for="check_${item.id || index}">
          ${texto}
        </label>
      </div>
    `;

    // Adicionar imagem se existir
    if (imagem && imagem.trim() !== "") {
      itemHTML += `
        <div class="mt-2">
          <img src="${imagem}" 
               alt="Imagem do checklist" 
               class="img-fluid rounded"
               style="max-width: 200px; max-height: 200px; object-fit: cover;"
               onerror="console.error('Erro ao carregar imagem:', this.src); this.style.display='none';">
        </div>
      `;
    }

    // Adicionar campo de observa√ß√£o
    itemHTML += `
      <textarea class="form-control mt-2" 
                placeholder="Observa√ß√µes sobre este item..." 
                data-id="${item.id || ''}"
                rows="2">${observacao}</textarea>
    `;

    div.innerHTML = itemHTML;
    list.appendChild(div);
  });

  console.log(`‚úÖ ${items.length} itens do checklist renderizados com sucesso!`);
}

function carregarAcompanhantes(acompanhantesData) {
  console.log('üîÑ carregarAcompanhantes chamada com:', acompanhantesData);
  
  const list = document.querySelector("#lista-acompanhantes");
  if (!list) {
    console.warn('‚ö†Ô∏è Container #lista-acompanhantes n√£o encontrado');
    return;
  }

  // CORRE√á√ÉO CR√çTICA: Clonar dados antes de manipular para evitar perda de refer√™ncia
  const dadosParaProcessar = acompanhantesData ? JSON.parse(JSON.stringify(acompanhantesData)) : [];
  console.log('üìã Dados clonados para processamento:', dadosParaProcessar.length, 'itens');

  // Sincronizar com o array global
  if (typeof acompanhantes !== 'undefined') {
    // Limpar array global (agora √© seguro porque clonamos os dados)
    acompanhantes.length = 0;
    
    // Repopular com os dados clonados
    if (dadosParaProcessar.length > 0) {
      dadosParaProcessar.forEach(a => {
        acompanhantes.push({
          id: a.id,
          nome: a.nome || 'Nome n√£o informado',
          funcao: a.funcao || a.cargo || '',
          origem: a.origem || 'Carregado do relat√≥rio'
        });
      });
      console.log(`‚úÖ Array global sincronizado: ${acompanhantes.length} acompanhantes`);
    }
    
    // Atualizar campo hidden
    const hiddenField = document.getElementById('acompanhantes-data');
    if (hiddenField) {
      hiddenField.value = JSON.stringify(acompanhantes);
      console.log('‚úÖ Campo hidden atualizado com:', acompanhantes.length, 'acompanhantes');
    } else {
      console.error('‚ùå Campo hidden #acompanhantes-data N√ÉO encontrado!');
    }
  } else {
    console.warn('‚ö†Ô∏è Vari√°vel global acompanhantes n√£o est√° definida');
  }

  // Renderizar visualiza√ß√£o usando os dados clonados
  list.innerHTML = "";

  if (dadosParaProcessar.length === 0) {
    list.innerHTML = `
      <p class="text-muted text-center py-3">
        <i class="fas fa-info-circle me-1"></i>
        Nenhum acompanhante adicionado ainda. Clique em "Adicionar Acompanhante" para come√ßar.
      </p>
    `;
    console.log('‚ÑπÔ∏è Lista de acompanhantes vazia - mostrando mensagem padr√£o');
    return;
  }

  const listGroup = document.createElement("div");
  listGroup.className = "list-group";

  dadosParaProcessar.forEach((a, index) => {
    const div = document.createElement("div");
    div.className = "list-group-item d-flex justify-content-between align-items-center";
    div.setAttribute('data-acompanhante-id', a.id);
    div.setAttribute('data-acompanhante-index', index);

    div.innerHTML = `
      <div class="d-flex align-items-center flex-grow-1">
        <i class="fas fa-user me-3 text-primary"></i>
        <div>
          <h6 class="mb-1"><strong>${a.nome || 'Nome n√£o informado'}</strong></h6>
          ${a.funcao || a.cargo ? `<p class="mb-0 text-muted"><small><i class="fas fa-briefcase me-1"></i>${a.funcao || a.cargo}</small></p>` : ''}
        </div>
      </div>
      <button type="button" 
              class="btn btn-sm btn-outline-danger" 
              onclick="removerAcompanhanteDoRelatorio(${index})"
              title="Remover acompanhante">
        <i class="fas fa-trash"></i>
      </button>
    `;
    listGroup.appendChild(div);
  });

  list.appendChild(listGroup);
  console.log(`‚úÖ ${dadosParaProcessar.length} acompanhantes renderizados na tela!`);
}

// Fun√ß√£o para remover acompanhante do relat√≥rio em edi√ß√£o
function removerAcompanhanteDoRelatorio(index) {
  if (!confirm('Deseja remover este acompanhante do relat√≥rio?')) {
    return;
  }

  // Remover do array global
  if (typeof acompanhantes !== 'undefined' && acompanhantes[index]) {
    acompanhantes.splice(index, 1);
    
    // Atualizar campo hidden
    const hiddenField = document.getElementById('acompanhantes-data');
    if (hiddenField) {
      hiddenField.value = JSON.stringify(acompanhantes);
    }
    
    // CORRE√á√ÉO: Usar carregarAcompanhantes para manter renderiza√ß√£o consistente
    carregarAcompanhantes(acompanhantes);
    console.log(`üóëÔ∏è Acompanhante removido. Total: ${acompanhantes.length}`);
  }
}

// Carregar dados quando estiver em modo de edi√ß√£o
document.addEventListener("DOMContentLoaded", () => {
  console.log('üöÄ DOMContentLoaded - Verificando modo de edi√ß√£o');

  if (typeof REPORT_DATA === 'undefined' || !REPORT_DATA || !REPORT_DATA.relatorio) {
    console.log('‚ÑπÔ∏è N√£o h√° dados de relat√≥rio para carregar (modo cria√ß√£o)');
    return;
  }

  console.log('üìù Modo de edi√ß√£o ativado - Carregando dados do relat√≥rio');

  const r = REPORT_DATA.relatorio;

  // Preencher campos b√°sicos
  if (r.data_relatorio) {
    const dataField = document.querySelector('[name="data_relatorio"]');
    if (dataField) {
      dataField.value = r.data_relatorio;
      console.log(`‚úÖ Data: ${r.data_relatorio}`);
    }
  }

  if (r.titulo) {
    const tituloField = document.querySelector('[name="titulo"]') || document.querySelector('[name="titulo_relatorio"]');
    if (tituloField) {
      tituloField.value = r.titulo;
      console.log(`‚úÖ T√≠tulo carregado: "${r.titulo}"`);
    } else {
      console.warn('‚ö†Ô∏è Campo de t√≠tulo n√£o encontrado no DOM');
    }
  }

  if (r.numero) {
    const numeroField = document.querySelector('[name="numero_relatorio"]') || document.querySelector('[name="numero"]');
    if (numeroField) {
      numeroField.value = r.numero;
      console.log(`‚úÖ N√∫mero: ${r.numero}`);
    }
  }

  if (r.observacoes_finais) {
    const obsField = document.querySelector('[name="conteudo"]') || document.querySelector('[name="observacoes_finais"]') || document.querySelector('[name="observacoes"]');
    if (obsField) {
      obsField.value = r.observacoes_finais;
      console.log(`‚úÖ Observa√ß√µes finais carregadas: "${r.observacoes_finais.substring(0, 50)}..."`);
    } else {
      console.warn('‚ö†Ô∏è Campo de observa√ß√µes n√£o encontrado no DOM');
    }
  }

  if (r.lembrete_proxima_visita) {
    const lembreteField = document.querySelector('[name="lembrete_proxima_visita"]');
    if (lembreteField) {
      lembreteField.value = r.lembrete_proxima_visita;
      console.log(`‚úÖ Lembrete carregado`);
    }
  }

  // Preencher projeto
  let projetoIdSelecionado = null;
  if (REPORT_DATA.projeto) {
    const projetoField = document.querySelector('[name="projeto"]') || document.querySelector('[name="projeto_id"]');
    if (projetoField) {
      // Se for um select, adicionar a op√ß√£o selecionada
      if (projetoField.tagName === 'SELECT') {
        const option = document.createElement('option');
        option.value = REPORT_DATA.projeto.id;
        option.textContent = `${REPORT_DATA.projeto.codigo || REPORT_DATA.projeto.numero || ''} - ${REPORT_DATA.projeto.nome || ''}`;
        option.selected = true;
        projetoField.appendChild(option);
      } else {
        projetoField.value = REPORT_DATA.projeto.id;
      }
      projetoIdSelecionado = REPORT_DATA.projeto.id;
      console.log(`‚úÖ Projeto selecionado: ${REPORT_DATA.projeto.nome} (ID: ${projetoIdSelecionado})`);
    }
  }

  // Carregar checklist
  console.log('üìã Verificando checklist...', REPORT_DATA.checklist);

  // Verificar se o checklist tem itens v√°lidos (com campo "texto")
  const checklistValido = REPORT_DATA.checklist && 
                          REPORT_DATA.checklist.length > 0 && 
                          REPORT_DATA.checklist.some(item => item.texto && item.texto !== '');

  if (checklistValido) {
    console.log(`üìã Carregando ${REPORT_DATA.checklist.length} itens do checklist do relat√≥rio`);
    carregarChecklist(REPORT_DATA.checklist);
  } else {
    console.warn('‚ö†Ô∏è Checklist vazio ou inv√°lido no relat√≥rio');

    // Se h√° um projeto selecionado, carregar o checklist do projeto
    if (projetoIdSelecionado) {
      console.log(`üìã Carregando checklist do projeto ${projetoIdSelecionado}...`);
      carregarChecklistProjeto(projetoIdSelecionado);
    } else {
      console.warn('‚ö†Ô∏è Nenhum projeto selecionado para carregar checklist');
    }
  }

  // Carregar acompanhantes
  console.log('üë• Verificando acompanhantes...', REPORT_DATA.acompanhantes);
  if (REPORT_DATA.acompanhantes && REPORT_DATA.acompanhantes.length > 0) {
    console.log(`üë• Carregando ${REPORT_DATA.acompanhantes.length} acompanhantes`);
    carregarAcompanhantes(REPORT_DATA.acompanhantes);
  } else {
    console.warn('‚ö†Ô∏è Nenhum acompanhante para carregar');
  }

  // Carregar fotos - CORRIGIDO para adicionar ao window.mobilePhotoData
  console.log('üì∏ Verificando fotos...', REPORT_DATA.fotos);
  if (REPORT_DATA.fotos && REPORT_DATA.fotos.length > 0) {
    console.log(`üì∏ Carregando ${REPORT_DATA.fotos.length} fotos existentes`);
    
    // Inicializar window.mobilePhotoData se n√£o existir
    if (!window.mobilePhotoData) {
      window.mobilePhotoData = [];
    }
    
    // Adicionar fotos existentes ao window.mobilePhotoData
    REPORT_DATA.fotos.forEach((foto, index) => {
      const photoData = {
        id: foto.id,
        savedId: foto.id,  // IMPORTANTE: savedId deve ser o ID do banco de dados
        name: foto.filename || `foto_${foto.id}`,
        filename: foto.filename,
        file: null,  // Fotos existentes n√£o t√™m file
        previewUrl: foto.url,
        url: foto.url,
        category: foto.categoria || '',
        local: foto.local || '',
        caption: foto.legenda || '',
        manualCaption: foto.legenda || '',
        predefinedCaption: foto.legenda || '',
        ordem: foto.ordem || index,
        isExisting: true,  // IMPORTANTE: marcar como existente
        metadata: {
          legenda: foto.legenda || '',
          categoria: foto.categoria || '',
          tipo_servico: foto.categoria || '',
          local: foto.local || ''
        }
      };
      window.mobilePhotoData.push(photoData);
      console.log(`‚úÖ Foto existente ${foto.id} carregada:`, {
        id: photoData.id,
        savedId: photoData.savedId,
        isExisting: photoData.isExisting,
        filename: photoData.filename
      });
    });
    
    console.log(`üì∏ TOTAL em mobilePhotoData: ${window.mobilePhotoData.length} fotos`);
    
    // Agora renderizar a galeria
    updatePhotoGallery();
    console.log(`‚úÖ ${REPORT_DATA.fotos.length} fotos carregadas na galeria`);
  } else {
    console.warn('‚ö†Ô∏è Nenhuma foto para carregar');
  }

  console.log('‚úÖ Carregamento completo dos dados do relat√≥rio');
});
</script>

<!-- Auto Save Script -->
<script src="{{ url_for('static', filename='js/reports_autosave.js') }}"></script>

{% endblock %}