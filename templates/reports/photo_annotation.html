<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anotação de Foto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        .annotation-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        #photoCanvas {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }
        .toolbar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 20px;
        }
        .tool-btn {
            margin: 0 5px;
            min-width: 80px;
        }
        .tool-btn.active {
            background-color: #007bff;
            color: white;
        }
        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 5px;
        }
        .form-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .canvas-container {
            text-align: center;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .btn-save {
            background-color: #28a745;
            border-color: #28a745;
            font-weight: bold;
        }
        .btn-save:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Left Panel - Tools and Form -->
            <div class="col-md-4">
                <!-- Toolbar -->
                <div class="form-section">
                    <h5><i class="fas fa-tools"></i> Ferramentas de Anotação</h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Ferramenta:</label><br>
                        <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pencil">
                            <i class="fas fa-pencil-alt"></i> Desenhar
                        </button>
                        <button type="button" class="btn btn-outline-primary tool-btn" data-tool="arrow">
                            <i class="fas fa-arrow-right"></i> Seta
                        </button>
                        <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                            <i class="fas fa-circle"></i> Círculo
                        </button>
                        <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                            <i class="fas fa-square"></i> Retângulo
                        </button>
                        <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                            <i class="fas fa-font"></i> Texto
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cor:</label><br>
                        <input type="color" class="color-picker" value="#ff0000" id="colorPicker">
                        <input type="color" class="color-picker" value="#00ff00">
                        <input type="color" class="color-picker" value="#0000ff">
                        <input type="color" class="color-picker" value="#ffff00">
                        <input type="color" class="color-picker" value="#ff00ff">
                        <input type="color" class="color-picker" value="#00ffff">
                        <input type="color" class="color-picker" value="#000000">
                        <input type="color" class="color-picker" value="#ffffff">
                    </div>

                    <div class="mb-3">
                        <label for="lineWidth" class="form-label">Espessura da Linha:</label>
                        <input type="range" class="form-range" id="lineWidth" min="1" max="10" value="3">
                        <small class="text-muted">Valor: <span id="lineWidthValue">3</span>px</small>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-warning" onclick="undoLastAction()">
                            <i class="fas fa-undo"></i> Desfazer
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="clearCanvas()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                </div>

                <!-- Photo Information Form -->
                <div class="form-section">
                    <h5><i class="fas fa-info-circle"></i> Informações da Foto</h5>
                    
                    <form id="photoForm">
                        <input type="hidden" id="photoId" name="photo_id" value="">
                        <input type="hidden" id="reportId" name="report_id" value="">
                        <input type="hidden" id="originalFilename" name="original_filename" value="">
                        <input type="hidden" id="annotationsData" name="annotations_data" value="">

                        <div class="mb-3">
                            <label for="legenda" class="form-label">Legenda/Título *</label>
                            <input type="text" class="form-control" id="legenda" name="legenda" required 
                                   placeholder="Ex: Vista frontal da estrutura">
                        </div>

                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="3"
                                      placeholder="Descreva o que está sendo mostrado na foto..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="tipoServico" class="form-label">Tipo de Serviço</label>
                            <select class="form-select" id="tipoServico" name="tipo_servico">
                                <option value="">Selecione o tipo</option>
                                <option value="Fundacao">Fundação</option>
                                <option value="Estrutura">Estrutura</option>
                                <option value="Alvenaria">Alvenaria</option>
                                <option value="Cobertura">Cobertura</option>
                                <option value="Instalacoes">Instalações</option>
                                <option value="Acabamento">Acabamento</option>
                                <option value="Problema">Problema Identificado</option>
                                <option value="Progresso">Progresso da Obra</option>
                                <option value="Geral">Vista Geral</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-save btn-lg" onclick="saveAnnotatedPhoto()">
                                <i class="fas fa-save"></i> Salvar Foto Anotada
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="window.close()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Right Panel - Photo Canvas -->
            <div class="col-md-8">
                <div class="canvas-container">
                    <h5><i class="fas fa-image"></i> Foto para Anotação</h5>
                    <div class="annotation-container">
                        <canvas id="photoCanvas"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Clique e arraste para desenhar. Use as ferramentas à esquerda para diferentes tipos de anotação.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Canvas and drawing variables
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pencil';
        let currentColor = '#ff0000';
        let currentLineWidth = 3;
        let startX, startY;
        let annotations = [];
        let backgroundImage = null;

        // Initialize canvas when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCanvas();
            setupEventListeners();
            loadPhotoParameters();
            loadPhoto();
        });

        function initializeCanvas() {
            canvas = document.getElementById('photoCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function setupEventListeners() {
            // Tool selection
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                });
            });

            // Color selection
            document.querySelectorAll('.color-picker').forEach(picker => {
                picker.addEventListener('click', function() {
                    currentColor = this.value;
                    document.getElementById('colorPicker').value = this.value;
                });
            });

            // Line width
            const lineWidthSlider = document.getElementById('lineWidth');
            lineWidthSlider.addEventListener('input', function() {
                currentLineWidth = this.value;
                document.getElementById('lineWidthValue').textContent = this.value;
            });

            // Canvas drawing events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
        }

        function loadPhotoParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const photoPath = urlParams.get('photo');
            const reportId = urlParams.get('report_id');
            const photoId = urlParams.get('photo_id');

            document.getElementById('reportId').value = reportId || '';
            document.getElementById('photoId').value = photoId || '';
            document.getElementById('originalFilename').value = photoPath || '';

            // Load existing photo data if editing
            if (photoId) {
                loadExistingPhotoData(photoId);
            }
        }

        function loadPhoto() {
            const photoPath = new URLSearchParams(window.location.search).get('photo');
            if (!photoPath) {
                alert('Erro: Foto não especificada.');
                return;
            }

            const img = new Image();
            img.onload = function() {
                // Set canvas size to image size
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw the image
                ctx.drawImage(img, 0, 0);
                backgroundImage = img;
                
                // Load existing annotations if any
                loadExistingAnnotations();
            };
            img.onerror = function() {
                alert('Erro ao carregar a imagem.');
            };
            img.src = `/uploads/${photoPath}`;
        }

        function loadExistingPhotoData(photoId) {
            fetch(`/api/photo-annotations/${photoId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('legenda').value = data.legenda || '';
                    document.getElementById('descricao').value = data.descricao || '';
                    document.getElementById('tipoServico').value = data.tipo_servico || '';
                    
                    if (data.annotations) {
                        try {
                            annotations = JSON.parse(data.annotations);
                        } catch (e) {
                            console.error('Error parsing annotations:', e);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading photo data:', error);
                });
        }

        function loadExistingAnnotations() {
            annotations.forEach(annotation => {
                drawAnnotation(annotation);
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            if (currentTool === 'pencil') {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
            }
        }

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const currentX = e.clientX - rect.left;
            const currentY = e.clientY - rect.top;

            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentLineWidth;

            if (currentTool === 'pencil') {
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
            }
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            isDrawing = false;

            const rect = canvas.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            // Save annotation
            const annotation = {
                tool: currentTool,
                color: currentColor,
                lineWidth: currentLineWidth,
                startX: startX,
                startY: startY,
                endX: endX,
                endY: endY,
                timestamp: Date.now()
            };

            // Draw shape-based tools
            if (currentTool !== 'pencil') {
                drawShapeAnnotation(annotation);
            }

            annotations.push(annotation);
        }

        function drawShapeAnnotation(annotation) {
            ctx.strokeStyle = annotation.color;
            ctx.lineWidth = annotation.lineWidth;
            ctx.beginPath();

            switch (annotation.tool) {
                case 'arrow':
                    drawArrow(annotation.startX, annotation.startY, annotation.endX, annotation.endY);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(annotation.endX - annotation.startX, 2) + Math.pow(annotation.endY - annotation.startY, 2));
                    ctx.arc(annotation.startX, annotation.startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    break;
                case 'rectangle':
                    ctx.rect(annotation.startX, annotation.startY, annotation.endX - annotation.startX, annotation.endY - annotation.startY);
                    ctx.stroke();
                    break;
                case 'text':
                    const text = prompt('Digite o texto:');
                    if (text) {
                        ctx.font = `${annotation.lineWidth * 6}px Arial`;
                        ctx.fillStyle = annotation.color;
                        ctx.fillText(text, annotation.startX, annotation.startY);
                        annotation.text = text;
                    }
                    break;
            }
        }

        function drawArrow(fromX, fromY, toX, toY) {
            const headLength = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);

            // Draw line
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();

            // Draw arrow head
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function drawAnnotation(annotation) {
            ctx.strokeStyle = annotation.color;
            ctx.lineWidth = annotation.lineWidth;
            ctx.beginPath();

            switch (annotation.tool) {
                case 'pencil':
                    // For pencil tool, we'd need to store path data
                    break;
                default:
                    drawShapeAnnotation(annotation);
                    break;
            }
        }

        function undoLastAction() {
            if (annotations.length > 0) {
                annotations.pop();
                redrawCanvas();
            }
        }

        function clearCanvas() {
            annotations = [];
            redrawCanvas();
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (backgroundImage) {
                ctx.drawImage(backgroundImage, 0, 0);
            }
            annotations.forEach(annotation => {
                drawAnnotation(annotation);
            });
        }

        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                              e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function saveAnnotatedPhoto() {
            const legenda = document.getElementById('legenda').value.trim();
            if (!legenda) {
                alert('Por favor, insira uma legenda para a foto.');
                return;
            }

            // Convert canvas to blob
            canvas.toBlob(function(blob) {
                const formData = new FormData();
                formData.append('annotated_image', blob, 'annotated_photo.png');
                formData.append('photo_id', document.getElementById('photoId').value);
                formData.append('report_id', document.getElementById('reportId').value);
                formData.append('original_filename', document.getElementById('originalFilename').value);
                formData.append('legenda', document.getElementById('legenda').value);
                formData.append('descricao', document.getElementById('descricao').value);
                formData.append('tipo_servico', document.getElementById('tipoServico').value);
                formData.append('annotations_data', JSON.stringify(annotations));

                fetch('/api/save-annotated-photo', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Foto anotada salva com sucesso!');
                        if (window.opener) {
                            window.opener.location.reload();
                        }
                        window.close();
                    } else {
                        alert('Erro ao salvar: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Erro ao salvar a foto: ' + error.message);
                });
            }, 'image/png');
        }

        // Set initial tool
        document.querySelector('.tool-btn[data-tool="pencil"]').classList.add('active');
    </script>
</body>
</html>