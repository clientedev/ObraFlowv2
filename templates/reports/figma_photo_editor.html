<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Editor de Fotos Mobile - Profissional</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    
    <!-- CSS customizado -->
    <link href="{{ url_for('static', filename='css/figma-mobile-editor.css') }}" rel="stylesheet">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #f5f5f5;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e1e5e9;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: #5d6c7b;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando editor...</div>
    </div>
    
    <!-- Editor Container -->
    <div class="figma-editor-container" id="editorContainer" style="display: none;">
        
        <!-- Canvas Container -->
        <div class="figma-canvas-container">
            <canvas id="figmaCanvas" width="800" height="600"></canvas>
        </div>
        
        <!-- Toolbar -->
        <div class="figma-toolbar">
            <button class="figma-tool-btn" id="selectTool" data-tool="select">
                <i class="fas fa-mouse-pointer"></i>
                <span class="tool-label">Selecionar</span>
            </button>
            
            <button class="figma-tool-btn" id="brushTool" data-tool="brush">
                <i class="fas fa-paint-brush"></i>
                <span class="tool-label">Pincel</span>
            </button>
            
            <button class="figma-tool-btn" id="arrowTool" data-tool="arrow">
                <i class="fas fa-arrow-right"></i>
                <span class="tool-label">Seta</span>
            </button>
            
            <button class="figma-tool-btn" id="circleTool" data-tool="circle">
                <i class="far fa-circle"></i>
                <span class="tool-label">C√≠rculo</span>
            </button>
            
            <button class="figma-tool-btn" id="rectangleTool" data-tool="rectangle">
                <i class="far fa-square"></i>
                <span class="tool-label">Ret√¢ngulo</span>
            </button>
            
            <button class="figma-tool-btn" id="textTool" data-tool="text">
                <i class="fas fa-font"></i>
                <span class="tool-label">Texto</span>
            </button>
            
            <button class="figma-tool-btn" id="figmaColorButton">
                <span class="tool-label">Cor</span>
            </button>
        </div>
        
        <!-- Stroke Width Slider -->
        <div class="figma-stroke-slider">
            <span class="stroke-label">Espessura:</span>
            <input type="range" id="strokeSlider" class="stroke-slider" min="1" max="20" value="3">
            <div class="stroke-preview">
                <div class="stroke-preview-line"></div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="figma-actions">
            <button class="figma-action-btn" id="undoBtn">
                <i class="fas fa-undo"></i>
                Desfazer
            </button>
            
            <button class="figma-action-btn" id="redoBtn">
                <i class="fas fa-redo"></i>
                Refazer
            </button>
            
            <button class="figma-action-btn" id="deleteBtn">
                <i class="fas fa-trash"></i>
                Excluir
            </button>
            
            <button class="figma-action-btn danger" id="clearBtn">
                <i class="fas fa-eraser"></i>
                Limpar
            </button>
            
            <button class="figma-action-btn primary" id="saveBtn">
                <i class="fas fa-save"></i>
                Salvar
            </button>
        </div>
    </div>
    
    <!-- Caption Section (mant√©m compatibilidade com sistema atual) -->
    <div class="container-fluid bg-white p-3 border-top" style="display: none;" id="captionSection">
        <div class="row">
            <div class="col-12">
                <div class="mb-3">
                    <label for="captionCategoryFilter" class="form-label">Categoria:</label>
                    <select class="form-select" id="captionCategoryFilter">
                        <option value="all">Todas as categorias</option>
                        <option value="Geral">Geral</option>
                        <option value="Estrutural">Estrutural</option>
                        <option value="Hidr√°ulica">Hidr√°ulica</option>
                        <option value="El√©trica">El√©trica</option>
                        <option value="Acabamentos">Acabamentos</option>
                        <option value="Seguran√ßa">Seguran√ßa</option>
                        <option value="Fachada">Fachada</option>
                        <option value="Impermeabiliza√ß√£o">Impermeabiliza√ß√£o</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="predefinedCaptionSelect" class="form-label">Legenda Pr√©-definida:</label>
                    <select class="form-select" id="predefinedCaptionSelect">
                        <option value="">Selecione uma legenda...</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="photoCaption" class="form-label">Legenda da Foto:</label>
                    <textarea class="form-control" id="photoCaption" rows="2" placeholder="Digite a legenda da foto"></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="photoCategory" class="form-label">Categoria:</label>
                    <select class="form-select" id="photoCategory">
                        <option value="ok">‚úÖ OK - Conforme</option>
                        <option value="atencao">‚ö†Ô∏è Aten√ß√£o - Requer Cuidado</option>
                        <option value="problema">üö® Problema - N√£o Conforme</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="photoDescription" class="form-label">Observa√ß√µes:</label>
                    <textarea class="form-control" id="photoDescription" rows="3" placeholder="Observa√ß√µes detalhadas sobre a foto"></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/figma-color-picker.js') }}"></script>
    <script src="{{ url_for('static', filename='js/figma-mobile-editor.js') }}"></script>
    
    <script>
        let figmaEditor = null;
        let colorPicker = null;
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            initializeFigmaEditor();
        });
        
        function initializeFigmaEditor() {
            // Simular loading para melhor UX
            setTimeout(() => {
                // Esconder loading screen
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('editorContainer').style.display = 'flex';
                document.getElementById('captionSection').style.display = 'block';
                
                // Inicializar editor
                figmaEditor = new FigmaMobileEditor('figmaCanvas', {
                    touchThreshold: 6,
                    pinchThreshold: 8,
                    rotationThreshold: 3,
                    maxUndoSteps: 20
                });
                
                // Inicializar color picker
                colorPicker = new FigmaColorPicker(function(color) {
                    figmaEditor.setColor(color);
                    updateColorButton(color);
                });
                
                // Carregar imagem se especificada
                const imageUrl = getImageUrlFromStorage();
                if (imageUrl) {
                    figmaEditor.loadImage(imageUrl);
                }
                
                // Setup de eventos
                setupEventListeners();
                setupCaptionListeners();
                
                console.log('üöÄ Editor Mobile Figma inicializado com sucesso!');
                
            }, 1000);
        }
        
        function setupEventListeners() {
            // Tool buttons
            document.querySelectorAll('.figma-tool-btn[data-tool]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tool = btn.dataset.tool;
                    figmaEditor.setTool(tool);
                    
                    // Adicionar objetos automaticamente para algumas ferramentas
                    switch(tool) {
                        case 'arrow':
                            figmaEditor.addArrow();
                            break;
                        case 'circle':
                            figmaEditor.addCircle();
                            break;
                        case 'rectangle':
                            figmaEditor.addRectangle();
                            break;
                        case 'text':
                            figmaEditor.addText();
                            break;
                    }
                });
            });
            
            // Color button
            document.getElementById('figmaColorButton').addEventListener('click', () => {
                colorPicker.show(figmaEditor.currentColor);
            });
            
            // Stroke width slider
            const strokeSlider = document.getElementById('strokeSlider');
            strokeSlider.addEventListener('input', (e) => {
                const width = parseInt(e.target.value);
                figmaEditor.setStrokeWidth(width);
                updateStrokePreview(width);
            });
            
            // Action buttons
            document.getElementById('undoBtn').addEventListener('click', () => {
                figmaEditor.undo();
            });
            
            document.getElementById('redoBtn').addEventListener('click', () => {
                figmaEditor.redo();
            });
            
            document.getElementById('deleteBtn').addEventListener('click', () => {
                figmaEditor.deleteSelected();
            });
            
            document.getElementById('clearBtn').addEventListener('click', () => {
                figmaEditor.clear();
            });
            
            document.getElementById('saveBtn').addEventListener('click', () => {
                saveAnnotatedPhoto();
            });
            
            // Inicializar preview da espessura
            updateStrokePreview(3);
            updateColorButton('#ff0000');
        }
        
        function updateColorButton(color) {
            const colorButton = document.getElementById('figmaColorButton');
            colorButton.style.setProperty('--current-color', color);
            
            // Atualizar preview da espessura tamb√©m
            const strokeSlider = document.getElementById('strokeSlider');
            updateStrokePreview(strokeSlider.value, color);
        }
        
        function updateStrokePreview(width, color = null) {
            const preview = document.querySelector('.stroke-preview-line');
            if (preview) {
                preview.style.setProperty('--stroke-width', width + 'px');
                if (color) {
                    preview.style.setProperty('--current-color', color);
                }
            }
        }
        
        function getImageUrlFromStorage() {
            // Obter dados da imagem do sessionStorage ou URL
            const storedData = sessionStorage.getItem('photoEditorData');
            if (storedData) {
                try {
                    const photoData = JSON.parse(storedData);
                    return photoData.imageUrl;
                } catch (e) {
                    console.warn('Erro ao obter dados da imagem:', e);
                }
            }
            
            // Fallback para URL params
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('imageUrl');
        }
        
        function saveAnnotatedPhoto() {
            if (!figmaEditor) {
                alert('Editor n√£o inicializado');
                return;
            }
            
            // Capturar dados da imagem anotada
            const imageData = figmaEditor.exportCanvas();
            const caption = document.getElementById('photoCaption').value;
            const category = document.getElementById('photoCategory').value;
            const description = document.getElementById('photoDescription').value;
            
            // Obter photoId
            let photoId = null;
            const storedData = sessionStorage.getItem('photoEditorData');
            if (storedData) {
                try {
                    const photoData = JSON.parse(storedData);
                    photoId = photoData.photoId;
                } catch (e) {
                    console.warn('Erro ao obter photoId:', e);
                }
            }
            
            if (!photoId) {
                photoId = new URLSearchParams(window.location.search).get('photoId');
            }
            
            // Enviar dados para a janela pai
            if (window.opener) {
                window.opener.postMessage({
                    type: 'photo-edited',
                    photoId: photoId,
                    imageData: imageData,
                    caption: caption,
                    category: category,
                    description: description,
                    annotations: figmaEditor.undoStack // Enviar hist√≥rico para compatibilidade
                }, '*');
                
                // Limpar sessionStorage e fechar
                sessionStorage.removeItem('photoEditorData');
                window.close();
            } else {
                alert('Erro: Janela pai n√£o encontrada.');
            }
        }
        
        // Sistema de legendas (compatibilidade)
        function setupCaptionListeners() {
            // Carregar legendas iniciais
            loadPredefinedCaptions('all');
            
            // Filtro de categoria
            document.getElementById('captionCategoryFilter').addEventListener('change', function() {
                loadPredefinedCaptions(this.value);
            });
            
            // Sele√ß√£o de legenda pr√©-definida
            document.getElementById('predefinedCaptionSelect').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('photoCaption').value = this.value;
                }
            });
        }
        
        function loadPredefinedCaptions(categoria = 'all') {
            fetch(`/api/legendas?categoria=${categoria}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('predefinedCaptionSelect');
                    select.innerHTML = '<option value="">Selecione uma legenda...</option>';
                    
                    if (data.success) {
                        data.legendas.forEach(legenda => {
                            const option = document.createElement('option');
                            option.value = legenda.texto;
                            option.textContent = `${legenda.texto} (${legenda.categoria})`;
                            select.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar legendas:', error);
                });
        }
        
        // Prevenir zoom em iOS
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gesturechange', function(e) {
            e.preventDefault();
        });
        
        document.addEventListener('gestureend', function(e) {
            e.preventDefault();
        });
        
        // Prevenir context menu em mobile
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });
        
        // Performance monitor (desenvolvimento)
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('replit')) {
            let frameCount = 0;
            let lastTime = performance.now();
            
            function monitorFPS() {
                frameCount++;
                const currentTime = performance.now();
                
                if (currentTime - lastTime >= 1000) {
                    console.log(`FPS: ${frameCount}`);
                    frameCount = 0;
                    lastTime = currentTime;
                }
                
                requestAnimationFrame(monitorFPS);
            }
            
            monitorFPS();
        }
    </script>
</body>
</html>