{% extends "base.html" %}

{% block title %}{{ 'Editar' if project else 'Novo' }} Projeto - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-{{ 'edit' if project else 'plus' }} me-2"></i>
            {{ 'Editar' if project else 'Novo' }} Projeto
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    {% if project %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Número do Projeto</label>
                            <input type="text" class="form-control" value="{{ project.numero }}" readonly>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-3">
                                {{ form.nome.label(class="form-label") }}
                                {{ form.nome(class="form-control" + (" is-invalid" if form.nome.errors else "")) }}
                                {% for error in form.nome.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        {{ form.nome.label(class="form-label") }}
                        {{ form.nome(class="form-control" + (" is-invalid" if form.nome.errors else "")) }}
                        {% for error in form.nome.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                        <small class="form-text text-muted">O número do projeto será gerado automaticamente.</small>
                    </div>
                    {% endif %}
                    
                    <div class="mb-3">
                        {{ form.descricao.label(class="form-label") }}
                        {{ form.descricao(class="form-control", rows="3") }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.endereco.label(class="form-label") }}
                        {{ form.endereco(class="form-control", rows="2", id="endereco") }}
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="getGPSLocationAndAddress()" title="Capturar localização via GPS e preencher endereço">
                                <i class="fas fa-location-crosshairs"></i> Capturar GPS + Endereço
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openMapModal()" title="Escolher localização no mapa">
                                <i class="fas fa-map-marked-alt"></i> Escolher no Mapa
                            </button>
                        </div>
                        <small class="text-muted">
                            <span id="locationStatus"></span>
                        </small>
                        <div id="addressPreview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Endereço capturado:</strong>
                                <div id="capturedAddress"></div>
                            </div>
                        </div>
                        {{ form.latitude() }}
                        {{ form.longitude() }}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.tipo_obra.label(class="form-label") }}
                                {{ form.tipo_obra(class="form-control" + (" is-invalid" if form.tipo_obra.errors else ""), placeholder="Ex: Residencial, Comercial, Industrial...") }}
                                {% for error in form.tipo_obra.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.responsavel_id.label(class="form-label") }}
                                {{ form.responsavel_id(class="form-select" + (" is-invalid" if form.responsavel_id.errors else "")) }}
                                {% for error in form.responsavel_id.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.data_inicio.label(class="form-label") }}
                                {{ form.data_inicio(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.data_previsao_fim.label(class="form-label") }}
                                {{ form.data_previsao_fim(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('projects_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{{ 'Atualizar' if project else 'Cadastrar' }} Projeto
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">Escolher Localização no Mapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px; width: 100%;"></div>
                <div class="mt-3">
                    <small class="text-muted">Clique no mapa para selecionar a localização do projeto</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmMapLocation()">Confirmar Localização</button>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let selectedLat = null;
let selectedLng = null;

// GPS Location capture with automatic address filling
function getGPSLocationAndAddress() {
    const statusElement = document.getElementById('locationStatus');
    
    if (!navigator.geolocation) {
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> GPS não suportado neste navegador';
        return;
    }
    
    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> Capturando localização e endereço...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Set coordinates in hidden fields
            const latField = document.querySelector('input[name="latitude"]');
            const lngField = document.querySelector('input[name="longitude"]');
            if (latField) latField.value = lat;
            if (lngField) lngField.value = lng;
            
            // Get address from coordinates and fill address field
            reverseGeocodeAndFillAddress(lat, lng);
            
            statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localização capturada! Obtendo endereço...';
        },
        function(error) {
            let errorMsg = 'Erro ao capturar localização';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permissão negada para acessar localização';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Localização não disponível';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tempo limite excedido';
                    break;
            }
            statusElement.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> ' + errorMsg;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 600000
        }
    );
}

// Legacy function for compatibility
function getGPSLocation() {
    getGPSLocationAndAddress();
}

// Reverse geocoding to get address from coordinates and fill address field
function reverseGeocodeAndFillAddress(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=pt-BR&addressdetails=1`;
    
    fetch(url, {
        headers: {
            'User-Agent': 'ConstructionSiteReporting/1.0'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data && data.display_name) {
                const endereco = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
                if (endereco) {
                    // Format a cleaner address
                    let formattedAddress = '';
                    if (data.address) {
                        const addr = data.address;
                        
                        // Street info
                        let street = '';
                        if (addr.house_number) street += addr.house_number + ' ';
                        if (addr.road) street += addr.road;
                        if (street) formattedAddress += street + '\n';
                        
                        // Neighborhood/District
                        if (addr.neighbourhood || addr.suburb) {
                            formattedAddress += (addr.neighbourhood || addr.suburb) + '\n';
                        }
                        
                        // City, State
                        let cityState = '';
                        if (addr.city || addr.town || addr.municipality) {
                            cityState += (addr.city || addr.town || addr.municipality);
                        }
                        if (addr.state) {
                            cityState += (cityState ? ', ' : '') + addr.state;
                        }
                        if (cityState) formattedAddress += cityState + '\n';
                        
                        // Country
                        if (addr.country) {
                            formattedAddress += addr.country;
                        }
                    }
                    
                    // Use formatted address or fallback to display_name
                    endereco.value = formattedAddress.trim() || data.display_name;
                    
                    // Show address preview
                    document.getElementById('addressPreview').style.display = 'block';
                    document.getElementById('capturedAddress').textContent = formattedAddress.trim() || data.display_name;
                    
                    // Update status to show completion
                    const statusElement = document.getElementById('locationStatus');
                    statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localização e endereço capturados com sucesso!';
                }
            }
        })
        .catch(error => {
            console.log('Erro ao obter endereço:', error);
        });
}

// Legacy function for compatibility
function reverseGeocode(lat, lng) {
    reverseGeocodeAndFillAddress(lat, lng);
}

// Initialize map
function initMap() {
    // Default center (São Paulo)
    const defaultLat = -23.5505;
    const defaultLng = -46.6333;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);
    
    // Click handler
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Remove existing marker
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Add new marker
        marker = L.marker([lat, lng]).addTo(map);
        
        selectedLat = lat;
        selectedLng = lng;
        
        // Get address for this location
        reverseGeocode(lat, lng);
    });
}

// Open map modal
function openMapModal() {
    const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
    mapModal.show();
    
    // Initialize map when modal is shown
    document.getElementById('mapModal').addEventListener('shown.bs.modal', function () {
        if (!map) {
            initMap();
        } else {
            map.invalidateSize();
        }
        
        // If we have existing coordinates, show them on map
        const latField = document.querySelector('input[name="latitude"]');
        const lngField = document.querySelector('input[name="longitude"]');
        const lat = latField ? latField.value : '';
        const lng = lngField ? lngField.value : '';
        
        if (lat && lng) {
            const latFloat = parseFloat(lat);
            const lngFloat = parseFloat(lng);
            
            map.setView([latFloat, lngFloat], 15);
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([latFloat, lngFloat]).addTo(map);
            selectedLat = latFloat;
            selectedLng = lngFloat;
        }
    });
}

// Confirm map location
function confirmMapLocation() {
    if (selectedLat && selectedLng) {
        const latField = document.querySelector('input[name="latitude"]');
        const lngField = document.querySelector('input[name="longitude"]');
        if (latField) latField.value = selectedLat;
        if (lngField) lngField.value = selectedLng;
        
        const statusElement = document.getElementById('locationStatus');
        statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localização selecionada no mapa';
        
        // Close modal
        const mapModal = bootstrap.Modal.getInstance(document.getElementById('mapModal'));
        mapModal.hide();
    }
}
</script>

<!-- Load Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

{% endblock %}
