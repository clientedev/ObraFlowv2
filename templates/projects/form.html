{% extends "base.html" %}

{% block title %}{{ 'Editar' if project else 'Nova' }} Obra - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-{{ 'edit' if project else 'plus' }} me-2"></i>
            {{ 'Editar' if project else 'Nova' }} Obra
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{{ url_for('project_edit', project_id=project.id) if project else url_for('project_new') }}" id="projectForm">
                    {{ form.hidden_tag() }}
                    
                    {% if project %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">N√∫mero da Obra</label>
                            <input type="text" class="form-control" value="{{ project.numero }}" readonly>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-3">
                                {{ form.nome.label(class="form-label") }}
                                {{ form.nome(class="form-control" + (" is-invalid" if form.nome.errors else "")) }}
                                {% for error in form.nome.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        {{ form.nome.label(class="form-label") }}
                        {{ form.nome(class="form-control" + (" is-invalid" if form.nome.errors else "")) }}
                        {% for error in form.nome.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                        <small class="form-text text-muted">O n√∫mero da obra ser√° gerado automaticamente.</small>
                    </div>
                    {% endif %}
                    
                    
                    <div class="mb-3">
                        {{ form.endereco.label(class="form-label") }}
                        {{ form.endereco(class="form-control", rows="2", id="endereco") }}
                        <div class="mt-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="getGPSLocationAndAddress()" title="Capturar localiza√ß√£o via GPS e preencher endere√ßo">
                                <i class="fas fa-location-crosshairs"></i> Capturar GPS + Endere√ßo
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openMapModal()" title="Escolher localiza√ß√£o no mapa">
                                <i class="fas fa-map-marked-alt"></i> Escolher no Mapa
                            </button>
                        </div>
                        <small class="text-muted">
                            <span id="locationStatus"></span>
                        </small>
                        <div id="addressPreview" class="mt-2" style="display: none;">
                            <div class="alert alert-info">
                                <strong>Endere√ßo capturado:</strong>
                                <div id="capturedAddress"></div>
                            </div>
                        </div>
                        {{ form.latitude() }}
                        {{ form.longitude() }}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.responsavel_id.label(class="form-label") }}
                        {{ form.responsavel_id(class="form-select" + (" is-invalid" if form.responsavel_id.errors else "")) }}
                        {% for error in form.responsavel_id.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.construtora.label(class="form-label") }}
                                {{ form.construtora(class="form-control" + (" is-invalid" if form.construtora.errors else ""), placeholder="Nome da construtora respons√°vel") }}
                                {% for error in form.construtora.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.nome_funcionario.label(class="form-label") }}
                                {{ form.nome_funcionario(class="form-control" + (" is-invalid" if form.nome_funcionario.errors else ""), placeholder="Nome do funcion√°rio respons√°vel principal") }}
                                {% for error in form.nome_funcionario.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                                <small class="form-text text-muted">Este ser√° o funcion√°rio respons√°vel principal. Voc√™ pode adicionar mais funcion√°rios abaixo.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.email_principal.label(class="form-label") }}
                        {{ form.email_principal(class="form-control" + (" is-invalid" if form.email_principal.errors else ""), placeholder="cliente@exemplo.com") }}
                        {% for error in form.email_principal.errors %}
                            <div class="invalid-feedback">{{ error }}</div>
                        {% endfor %}
                        <small class="form-text text-muted">E-mail principal do cliente para envio de relat√≥rios. Voc√™ pode adicionar mais e-mails abaixo.</small>
                    </div>
                    
                    <!-- Se√ß√£o de Funcion√°rios Adicionais -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-users me-2"></i>Funcion√°rios da Obra
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="funcionarios-list">
                                <!-- Funcion√°rios adicionais ser√£o adicionados aqui dinamicamente -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarFuncionario()">
                                <i class="fas fa-plus me-1"></i>Adicionar Funcion√°rio
                            </button>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o de E-mails Adicionais -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-envelope me-2"></i>E-mails da Obra
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="emails-list">
                                <!-- E-mails adicionais ser√£o adicionados aqui dinamicamente -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarEmail()">
                                <i class="fas fa-plus me-1"></i>Adicionar E-mail
                            </button>
                        </div>
                    </div>
                    
                    <!-- Se√ß√£o de Categorias da Obra - Item 16 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tags me-2"></i>Categorias da Obra
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                As categorias s√£o usadas para organizar fotos nos relat√≥rios. 
                                Voc√™ pode editar, excluir ou adicionar novas categorias abaixo.
                            </p>
                            {% if project %}
                            <div id="categorias-container" class="mt-3"></div>
                            <button id="btnAddCategoria" class="btn btn-outline-primary mt-2">+ Adicionar Categoria</button>
                            {% else %}
                            <div id="categorias-list">
                                <!-- Categorias ser√£o adicionadas aqui dinamicamente -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="adicionarCategoria()">
                                <i class="fas fa-plus me-1"></i>Adicionar Categoria
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.data_inicio.label(class="form-label") }}
                                {{ form.data_inicio(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.data_previsao_fim.label(class="form-label") }}
                                {{ form.data_previsao_fim(class="form-control") }}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                {{ form.status.label(class="form-label") }}
                                {{ form.status(class="form-select") }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('projects_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{{ 'Atualizar' if project else 'Cadastrar' }} Obra
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Map Modal -->
<div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">Escolher Localiza√ß√£o no Mapa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px; width: 100%;"></div>
                <div class="mt-3">
                    <small class="text-muted">Clique no mapa para selecionar a localiza√ß√£o da obra</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmMapLocation()">Confirmar Localiza√ß√£o</button>
            </div>
        </div>
    </div>
</div>

<script>
let map;
let marker;
let selectedLat = null;
let selectedLng = null;

// GPS Location capture with automatic address filling
function getGPSLocationAndAddress() {
    const statusElement = document.getElementById('locationStatus');
    
    if (!navigator.geolocation) {
        statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> GPS n√£o suportado neste navegador';
        return;
    }
    
    statusElement.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> Capturando localiza√ß√£o e endere√ßo...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            // Set coordinates in hidden fields
            const latField = document.querySelector('input[name="latitude"]');
            const lngField = document.querySelector('input[name="longitude"]');
            if (latField) latField.value = lat;
            if (lngField) lngField.value = lng;
            
            // Get address from coordinates and fill address field
            reverseGeocodeAndFillAddress(lat, lng);
            
            statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localiza√ß√£o capturada! Obtendo endere√ßo...';
        },
        function(error) {
            let errorMsg = 'Erro ao capturar localiza√ß√£o';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permiss√£o negada para acessar localiza√ß√£o';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Localiza√ß√£o n√£o dispon√≠vel';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tempo limite excedido';
                    break;
            }
            statusElement.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> ' + errorMsg;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 600000
        }
    );
}

// Legacy function for compatibility
function getGPSLocation() {
    getGPSLocationAndAddress();
}

// Reverse geocoding to get address from coordinates and fill address field
function reverseGeocodeAndFillAddress(lat, lng) {
    // Use backend endpoint for consistent geocoding
    fetch('/get_location', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
            latitude: lat,
            longitude: lng
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const endereco = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
            if (endereco) {
                endereco.value = data.endereco;
                
                // Show address preview
                const addressPreview = document.getElementById('addressPreview');
                const capturedAddress = document.getElementById('capturedAddress');
                if (addressPreview && capturedAddress) {
                    addressPreview.style.display = 'block';
                    capturedAddress.textContent = data.endereco;
                }
                
                // Update status to show completion
                const statusElement = document.getElementById('locationStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localiza√ß√£o e endere√ßo capturados com sucesso!';
                }
            }
        } else {
            console.log('Erro ao obter endere√ßo do servidor');
            
            // Fallback to coordinates
            const endereco = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
            if (endereco) {
                endereco.value = `Lat: ${lat}, Lng: ${lng}`;
            }
        }
    })
    .catch(error => {
        console.log('Erro ao obter endere√ßo:', error);
        
        // Fallback to coordinates
        const endereco = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
        if (endereco) {
            endereco.value = `Lat: ${lat}, Lng: ${lng}`;
        }
    });
}

// Legacy function for compatibility
function reverseGeocode(lat, lng) {
    reverseGeocodeAndFillAddress(lat, lng);
}

// Initialize map
function initMap() {
    // Default center (S√£o Paulo)
    const defaultLat = -23.5505;
    const defaultLng = -46.6333;
    
    map = L.map('map').setView([defaultLat, defaultLng], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Click handler
    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;
        
        // Remove existing marker
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Add new marker
        marker = L.marker([lat, lng]).addTo(map);
        
        selectedLat = lat;
        selectedLng = lng;
        
        // Get address for this location and fill the address field
        reverseGeocodeAndFillAddress(lat, lng);
    });
}

// Open map modal
function openMapModal() {
    const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
    mapModal.show();
    
    // Initialize map when modal is shown
    document.getElementById('mapModal').addEventListener('shown.bs.modal', function () {
        if (!map) {
            initMap();
        } else {
            map.invalidateSize();
        }
        
        // If we have existing coordinates, show them on map
        const latField = document.querySelector('input[name="latitude"]');
        const lngField = document.querySelector('input[name="longitude"]');
        const lat = latField ? latField.value : '';
        const lng = lngField ? lngField.value : '';
        
        if (lat && lng) {
            const latFloat = parseFloat(lat);
            const lngFloat = parseFloat(lng);
            
            map.setView([latFloat, lngFloat], 15);
            
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([latFloat, lngFloat]).addTo(map);
            selectedLat = latFloat;
            selectedLng = lngFloat;
        }
    });
}

// Confirm map location
function confirmMapLocation() {
    if (selectedLat && selectedLng) {
        const latField = document.querySelector('input[name="latitude"]');
        const lngField = document.querySelector('input[name="longitude"]');
        if (latField) latField.value = selectedLat;
        if (lngField) lngField.value = selectedLng;
        
        // Get address for this location and fill address field
        reverseGeocodeAndFillAddress(selectedLat, selectedLng);
        
        const statusElement = document.getElementById('locationStatus');
        statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Localiza√ß√£o selecionada no mapa';
        
        // Close modal
        const mapModal = bootstrap.Modal.getInstance(document.getElementById('mapModal'));
        if (mapModal) {
            mapModal.hide();
        }
    }
}

// Contador para IDs √∫nicos
let funcionarioCounter = 0;
let emailCounter = 0;
let categoriaCounter = 0;

// Fun√ß√£o para adicionar funcion√°rio
function adicionarFuncionario() {
    funcionarioCounter++;
    const funcionariosList = document.getElementById('funcionarios-list');
    
    const funcionarioDiv = document.createElement('div');
    funcionarioDiv.className = 'border rounded p-3 mb-3';
    funcionarioDiv.id = `funcionario-${funcionarioCounter}`;
    
    funcionarioDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">Nome do Funcion√°rio</label>
                <input type="text" class="form-control" name="funcionarios[${funcionarioCounter}][nome]" placeholder="Nome completo" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cargo</label>
                <input type="text" class="form-control" name="funcionarios[${funcionarioCounter}][cargo]" placeholder="Cargo/Fun√ß√£o">
            </div>
            <div class="col-md-3">
                <label class="form-label">Empresa</label>
                <input type="text" class="form-control" name="funcionarios[${funcionarioCounter}][empresa]" placeholder="Nome da empresa">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerFuncionario(${funcionarioCounter})">
                    <i class="fas fa-trash"></i> Remover
                </button>
            </div>
        </div>
    `;
    
    funcionariosList.appendChild(funcionarioDiv);
}

// Fun√ß√£o para remover funcion√°rio
function removerFuncionario(id) {
    const funcionarioDiv = document.getElementById(`funcionario-${id}`);
    if (funcionarioDiv) {
        funcionarioDiv.remove();
    }
}

// Fun√ß√£o para adicionar e-mail
function adicionarEmail() {
    emailCounter++;
    const emailsList = document.getElementById('emails-list');
    
    const emailDiv = document.createElement('div');
    emailDiv.className = 'border rounded p-3 mb-3';
    emailDiv.id = `email-${emailCounter}`;
    
    emailDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <label class="form-label">E-mail</label>
                <input type="email" class="form-control" name="emails[${emailCounter}][email]" placeholder="email@exemplo.com" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Nome do Contato</label>
                <input type="text" class="form-control" name="emails[${emailCounter}][nome]" placeholder="Nome da pessoa" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cargo</label>
                <input type="text" class="form-control" name="emails[${emailCounter}][cargo]" placeholder="Cargo/Fun√ß√£o">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerEmail(${emailCounter})">
                    <i class="fas fa-trash"></i> Remover
                </button>
            </div>
        </div>
    `;
    
    emailsList.appendChild(emailDiv);
}

// Fun√ß√£o para remover e-mail
function removerEmail(id) {
    const emailDiv = document.getElementById(`email-${id}`);
    if (emailDiv) {
        emailDiv.remove();
    }
}

// Fun√ß√£o para adicionar categoria - Item 16
function adicionarCategoria() {
    categoriaCounter++;
    const categoriasList = document.getElementById('categorias-list');
    
    const categoriaDiv = document.createElement('div');
    categoriaDiv.className = 'border rounded p-3 mb-3';
    categoriaDiv.id = `categoria-${categoriaCounter}`;
    
    categoriaDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Nome da Categoria</label>
                <input type="text" class="form-control" name="categorias[${categoriaCounter}][nome]" placeholder="Ex: Torre 1, √Årea Comum, etc." required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Ordem de Exibi√ß√£o</label>
                <input type="number" class="form-control" name="categorias[${categoriaCounter}][ordem]" value="${categoriaCounter}" min="0">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCategoria(${categoriaCounter})">
                    <i class="fas fa-trash"></i> Remover
                </button>
            </div>
        </div>
    `;
    
    categoriasList.appendChild(categoriaDiv);
}

// Fun√ß√£o para remover categoria
function removerCategoria(id) {
    const categoriaDiv = document.getElementById(`categoria-${id}`);
    if (categoriaDiv) {
        categoriaDiv.remove();
    }
}

{% if project %}
// Script de edi√ß√£o de categorias - conforme orienta√ß√µes do prompt
const categoriasExistentes = {{ categorias|tojson|safe }};
console.log("Categorias carregadas:", categoriasExistentes);

const container = document.getElementById("categorias-container");

// Fun√ß√£o para renderizar as categorias
function renderCategorias() {
  container.innerHTML = "";
  categoriasExistentes.forEach(cat => {
    const card = document.createElement("div");
    card.className = "card mb-3";
    card.innerHTML = `
      <div class="card-body">
        <label>Nome da Categoria</label>
        <input type="text" class="form-control nome-categoria" data-id="${cat.id}" value="${cat.nome || ''}">
        <small class="text-muted d-block mt-1">Categoria vinculada ao projeto #${cat.project_id}</small>

        <label class="mt-2">Ordem de Exibi√ß√£o</label>
        <input type="number" class="form-control ordem-categoria" data-id="${cat.id}" value="${cat.ordem || 0}">

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-success btn-save" data-id="${cat.id}">üíæ Salvar</button>
          <button class="btn btn-danger btn-delete" data-id="${cat.id}">üóëÔ∏è Excluir</button>
        </div>
      </div>
    `;
    container.appendChild(card);
  });
}
renderCategorias();

// Salvando altera√ß√µes
container.addEventListener("click", async (e) => {
  if (e.target.classList.contains("btn-save")) {
    const id = e.target.dataset.id;
    const nome = document.querySelector(`.nome-categoria[data-id='${id}']`).value;
    const ordem = document.querySelector(`.ordem-categoria[data-id='${id}']`).value;

    const res = await fetch(`/api/categorias/${id}/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome, ordem })
    });
    const data = await res.json();
    alert(data.message || "Categoria atualizada!");
  }

  if (e.target.classList.contains("btn-delete")) {
    const id = e.target.dataset.id;
    if (!confirm("Deseja realmente excluir esta categoria?")) return;

    const res = await fetch(`/api/categorias/${id}/delete`, { method: "DELETE" });
    const data = await res.json();
    alert(data.message || "Categoria exclu√≠da!");
    categoriasExistentes.splice(categoriasExistentes.findIndex(c => c.id == id), 1);
    renderCategorias();
  }
});

// Adicionar nova categoria (visualmente)
document.getElementById("btnAddCategoria").addEventListener("click", () => {
  const nova = {
    id: Date.now(), // tempor√°rio at√© salvar
    nome: "",
    ordem: categoriasExistentes.length + 1,
    project_id: {{ project.id }}
  };
  categoriasExistentes.push(nova);
  renderCategorias();
});
{% endif %}

// Aplicar normaliza√ß√£o de endere√ßos quando carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    
    const enderecoField = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
    
    if (enderecoField && window.normalizeAddress) {
        // Normalizar quando o usu√°rio sair do campo
        enderecoField.addEventListener('blur', function() {
            const originalValue = this.value;
            const normalizedValue = window.normalizeAddress(originalValue);
            
            if (originalValue !== normalizedValue) {
                this.value = normalizedValue;
                
                // Mostrar feedback visual
                const statusElement = document.getElementById('locationStatus');
                if (statusElement) {
                    statusElement.innerHTML = '<i class="fas fa-check text-success"></i> Endere√ßo normalizado automaticamente';
                    setTimeout(() => {
                        statusElement.innerHTML = '';
                    }, 3000);
                }
            }
        });
        
        // Adicionar bot√£o para geocodifica√ß√£o com normaliza√ß√£o
        const buttonContainer = enderecoField.parentElement.querySelector('.mt-2');
        if (buttonContainer) {
            const geocodeBtn = document.createElement('button');
            geocodeBtn.type = 'button';
            geocodeBtn.className = 'btn btn-outline-info btn-sm ms-2';
            geocodeBtn.title = 'Buscar coordenadas para este endere√ßo';
            geocodeBtn.innerHTML = '<i class="fas fa-search-location"></i> Buscar no Mapa';
            
            geocodeBtn.addEventListener('click', function() {
                geocodeAddressToCoordinates();
            });
            
            buttonContainer.appendChild(geocodeBtn);
        }
    }
});

// Fun√ß√£o para geocodificar endere√ßo digitado para coordenadas
function geocodeAddressToCoordinates() {
    const enderecoField = document.querySelector('textarea[name="endereco"]') || document.getElementById('endereco');
    const statusElement = document.getElementById('locationStatus');
    
    if (!enderecoField || !enderecoField.value.trim()) {
        if (statusElement) {
            statusElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Por favor, digite um endere√ßo primeiro';
        }
        return;
    }
    
    const originalAddress = enderecoField.value.trim();
    const normalizedAddress = window.normalizeAddress ? window.normalizeAddress(originalAddress) : originalAddress;
    
    // Update field with normalized address if different
    if (originalAddress !== normalizedAddress) {
        enderecoField.value = normalizedAddress;
    }
    
    if (statusElement) {
        statusElement.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> Buscando coordenadas...';
    }
    
    // Create a simple geocoding API call to backend
    fetch('/api/geocode-address', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
            address: normalizedAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.latitude && data.longitude) {
            // Fill coordinate fields
            const latField = document.querySelector('input[name="latitude"]');
            const lngField = document.querySelector('input[name="longitude"]');
            if (latField) latField.value = data.latitude;
            if (lngField) lngField.value = data.longitude;
            
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-check-circle text-success"></i> Coordenadas encontradas!';
            }
            
            // Show address preview
            const addressPreview = document.getElementById('addressPreview');
            const capturedAddress = document.getElementById('capturedAddress');
            if (addressPreview && capturedAddress) {
                addressPreview.style.display = 'block';
                capturedAddress.textContent = `Coords: ${data.latitude}, ${data.longitude}`;
            }
        } else {
            if (statusElement) {
                statusElement.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> N√£o foi poss√≠vel encontrar as coordenadas';
            }
        }
    })
    .catch(error => {
        console.error('Erro no geocoding:', error);
        if (statusElement) {
            statusElement.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> Erro de conex√£o';
        }
    });
}
</script>

<!-- Load Leaflet CSS and JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Load Address Normalizer -->
<script src="{{ url_for('static', filename='js/address-normalizer.js') }}"></script>

{% endblock %}
