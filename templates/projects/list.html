{% extends "base.html" %}

{% block title %}Obras - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block extra_styles %}
<style>
.clickable-card {
    transition: background-color 0.2s ease, transform 0.1s ease;
}
.project-card:hover .clickable-card {
    background-color: #e9ecef !important;
    transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>
                <i class="fas fa-building me-2"></i>
                Obras
            </h1>
            {% if current_user.is_master %}
            <a href="{{ url_for('project_new') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Nova Obra
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Abas de Filtro por Status -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs mb-3" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if status_filter == 'ativo' %}active{% endif %}" 
                   href="{{ url_for('projects_list', status='ativo', q=request.args.get('q', '')) }}"
                   role="tab">
                    <i class="fas fa-hammer me-1"></i>
                    Obras Ativas
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if status_filter == 'concluido' %}active{% endif %}" 
                   href="{{ url_for('projects_list', status='concluido', q=request.args.get('q', '')) }}"
                   role="tab">
                    <i class="fas fa-check-circle me-1"></i>
                    Obras Conclu√≠das
                </a>
            </li>
        </ul>
    </div>
</div>

<!-- Busca Simples -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-3">
                <form method="GET" action="{{ url_for('projects_list') }}">
                    <!-- Hidden field to preserve status filter -->
                    <input type="hidden" name="status" value="{{ status_filter }}">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">üîç Busca R√°pida</label>
                            <input type="text" class="form-control" name="q" value="{{ request.args.get('q', '') }}" 
                                   placeholder="Digite o nome, n√∫mero ou palavra-chave da obra...">
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>Buscar
                                </button>
                                {% if request.args.get('q') %}
                                <a href="{{ url_for('projects_list', status=status_filter) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>Limpar
                                </a>
                                {% endif %}
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#filtrosAvancados">
                                    <i class="fas fa-filter me-1"></i>Busca Avan√ßada
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Avan√ßados (Colaps√°veis) -->
<div class="collapse mb-4" id="filtrosAvancados">
    <div class="card">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros Avan√ßados</h6>
        </div>
        <div class="card-body py-3">
            <div class="row g-3">
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Status:</label>
                    <select class="form-select form-select-sm" id="filterStatus">
                        <option value="">Todos os Status</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Pausado">Pausado</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                        <option value="Cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Tipo de Obra:</label>
                    <select class="form-select form-select-sm" id="filterTipo">
                        <option value="">Todos os Tipos</option>
                        <!-- Ser√° preenchido dinamicamente -->
                    </select>
                </div>
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Construtora:</label>
                    <select class="form-select form-select-sm" id="filterConstrutora">
                        <option value="">Todas Construtoras</option>
                        <!-- Ser√° preenchido dinamicamente -->
                    </select>
                </div>
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Funcion√°rio:</label>
                    <select class="form-select form-select-sm" id="filterFuncionario">
                        <option value="">Todos Funcion√°rios</option>
                        <!-- Ser√° preenchido dinamicamente -->
                    </select>
                </div>
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Respons√°vel:</label>
                    <select class="form-select form-select-sm" id="filterResponsavel">
                        <option value="">Todos Respons√°veis</option>
                        <!-- Ser√° preenchido dinamicamente -->
                    </select>
                </div>
                <div class="col-md-2 col-sm-6">
                    <label class="form-label small fw-bold">Pesquisar nos filtros:</label>
                    <input type="text" class="form-control form-control-sm" id="searchProject" placeholder="Nome ou n√∫mero da obra">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Limpar Filtros Avan√ßados
                    </button>
                    <small class="text-muted">
                        <span id="filteredCount">{{ projects|length }}</span> obra(s) encontrada(s)
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if projects %}
                    <!-- Indicador de ordena√ß√£o por dist√¢ncia -->
                    <div id="sortingIndicator" class="alert alert-info d-none mb-3">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>üìç Ordenando obras por dist√¢ncia...</span>
                        </div>
                    </div>
                    
                    <!-- Layout de cards mobile-first sem rolagem horizontal -->
                    <div class="mobile-projects-list" id="projectsTable">
                        {% for project in projects %}
                        <div class="project-card mb-2" 
                             data-status="{{ project.status }}" 
                             data-tipo="{{ project.tipo_obra if project.tipo_obra else '' }}"
                             data-construtora="{{ project.construtora if project.construtora else '' }}"
                             data-funcionario="{{ project.nome_funcionario if project.nome_funcionario else '' }}"
                             data-responsavel="{{ project.responsavel.nome_completo if project.responsavel else '' }}"
                             data-search="{{ (project.numero + ' ' + project.nome)|lower }}"
                             data-lat="{{ project.latitude if project.latitude else '' }}"
                             data-lon="{{ project.longitude if project.longitude else '' }}"
                             onclick="window.location.href='{{ url_for('project_view', project_id=project.id) }}'"
                             style="cursor: pointer;">
                            
                            <div class="card border-0 shadow-sm h-100 clickable-card" style="background: #f8f9fa; transition: all 0.2s ease;">
                                <div class="card-body p-3">
                                    <div class="row align-items-center">
                                        <!-- Coluna principal com informa√ß√µes -->
                                        <div class="col-9">
                                            <!-- N√∫mero do projeto -->
                                            <div class="fw-bold text-primary mb-1" style="font-size: 0.9rem;">
                                                {{ project.numero }}
                                            </div>
                                            
                                            <!-- Nome do projeto -->
                                            <div class="fw-semibold text-dark mb-1" style="font-size: 0.95rem; line-height: 1.2;">
                                                {{ project.nome }}
                                            </div>
                                            
                                            <!-- Informa√ß√µes adicionais -->
                                            <div class="text-muted" style="font-size: 0.8rem;">
                                                {% if project.construtora %}{{ project.construtora }}{% endif %}
                                                {% if project.data_inicio and project.construtora %} ‚Ä¢ {% endif %}
                                                {% if project.data_inicio %}{{ project.data_inicio.strftime('%d/%m/%Y') }}{% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Coluna lateral com status -->
                                        <div class="col-3 text-end">
                                            <!-- Status -->
                                            {% if project.status == 'Ativo' %}
                                                <span class="badge bg-success" style="font-size: 0.75rem;">Ativo</span>
                                            {% elif project.status == 'Pausado' %}
                                                <span class="badge bg-warning text-dark" style="font-size: 0.75rem;">Pausado</span>
                                            {% elif project.status == 'Conclu√≠do' %}
                                                <span class="badge bg-primary" style="font-size: 0.75rem;">Conclu√≠do</span>
                                            {% else %}
                                                <span class="badge bg-secondary" style="font-size: 0.75rem;">{{ project.status }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        {% if request.args.get('q') %}
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhum resultado encontrado para a busca: "{{ request.args.get('q') }}"</h5>
                            <p class="text-muted">Tente usar palavras-chave diferentes ou verifique a ortografia.</p>
                            <a href="{{ url_for('projects_list') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Limpar Busca
                            </a>
                        {% else %}
                            <i class="fas fa-building fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhuma obra cadastrada</h5>
                            {% if current_user.is_master %}
                                <p class="text-muted">Comece cadastrando a primeira obra.</p>
                                <a href="{{ url_for('project_new') }}" class="btn btn-primary">
                                    <i class="fas fa-plus me-2"></i>Cadastrar Primeira Obra
                                </a>
                            {% else %}
                                <p class="text-muted">Nenhuma obra dispon√≠vel no momento.</p>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('projectsTable');
    if (!table) return;
    
    const projectCards = table.querySelectorAll('.project-card');
    
    // Fun√ß√£o para calcular dist√¢ncia usando f√≥rmula de Haversine
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Raio da Terra em km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }
    
    // Tentar obter localiza√ß√£o e ordenar projetos
    async function sortProjectsByDistance() {
        const indicator = document.getElementById('sortingIndicator');
        
        try {
            console.log('üìç Tentando obter localiza√ß√£o para ordenar projetos...');
            
            // Mostrar indicador
            if (indicator) {
                indicator.classList.remove('d-none');
            }
            
            // Usar o sistema de geolocaliza√ß√£o global se dispon√≠vel
            if (window.geoLocation) {
                const position = await window.geoLocation.getLocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000, // Cache de 5 minutos
                    showUI: false, // N√£o mostrar UI
                    fallbackToIP: true,
                    reverseGeocode: false
                });
                
                const userLat = position.coords.latitude;
                const userLon = position.coords.longitude;
                
                console.log('‚úÖ Localiza√ß√£o obtida:', { userLat, userLon });
                
                // Calcular dist√¢ncia para cada projeto e adicionar badge de dist√¢ncia
                const projectsWithDistance = [];
                projectCards.forEach(card => {
                    const lat = parseFloat(card.dataset.lat);
                    const lon = parseFloat(card.dataset.lon);
                    
                    let distance = Infinity;
                    if (!isNaN(lat) && !isNaN(lon)) {
                        distance = calculateDistance(userLat, userLon, lat, lon);
                    }
                    
                    projectsWithDistance.push({ card, distance });
                    
                    // Adicionar badge de dist√¢ncia no card
                    if (distance !== Infinity) {
                        const distanceText = distance < 1 
                            ? `${Math.round(distance * 1000)}m` 
                            : `${distance.toFixed(1)}km`;
                        
                        const badgeContainer = card.querySelector('.col-3.text-end');
                        if (badgeContainer) {
                            const distanceBadge = document.createElement('div');
                            distanceBadge.className = 'text-muted mt-1';
                            distanceBadge.style.fontSize = '0.7rem';
                            distanceBadge.innerHTML = `<i class="fas fa-location-arrow me-1"></i>${distanceText}`;
                            badgeContainer.appendChild(distanceBadge);
                        }
                    }
                });
                
                // Ordenar por dist√¢ncia
                projectsWithDistance.sort((a, b) => a.distance - b.distance);
                
                // Reordenar os cards no DOM
                const container = table;
                projectsWithDistance.forEach(({ card }) => {
                    container.appendChild(card);
                });
                
                console.log('‚úÖ Projetos ordenados por dist√¢ncia');
                
                // Ocultar indicador com mensagem de sucesso
                if (indicator) {
                    indicator.classList.add('alert-success');
                    indicator.classList.remove('alert-info');
                    indicator.innerHTML = '<i class="fas fa-check-circle me-2"></i>Obras ordenadas por dist√¢ncia da sua localiza√ß√£o';
                    setTimeout(() => {
                        indicator.classList.add('d-none');
                    }, 3000);
                }
            } else {
                console.log('‚ö†Ô∏è Sistema de geolocaliza√ß√£o n√£o dispon√≠vel');
                if (indicator) {
                    indicator.classList.add('d-none');
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è N√£o foi poss√≠vel obter localiza√ß√£o:', error.message);
            // Ocultar indicador se falhou
            if (indicator) {
                indicator.classList.add('d-none');
            }
        }
    }
    
    // Executar ordena√ß√£o por dist√¢ncia
    sortProjectsByDistance();
    
    const rows = projectCards; // Compatibilidade com c√≥digo existente
    // Lista de projetos carregada
    
    // Preencher filtros dinamicamente
    fillFilterOptions();
    
    // Configurar eventos dos filtros
    setupFilters();
    
    function fillFilterOptions() {
        const tipoSet = new Set();
        const construtoraSet = new Set();
        const funcionarioSet = new Set();
        const responsavelSet = new Set();
        
        rows.forEach(row => {
            const tipo = row.getAttribute('data-tipo');
            const construtora = row.getAttribute('data-construtora');
            const funcionario = row.getAttribute('data-funcionario');
            const responsavel = row.getAttribute('data-responsavel');
            
            if (tipo && tipo !== '' && tipo !== '-') tipoSet.add(tipo);
            if (construtora && construtora !== '' && construtora !== '-') construtoraSet.add(construtora);
            if (funcionario && funcionario !== '' && funcionario !== '-') funcionarioSet.add(funcionario);
            if (responsavel && responsavel !== '' && responsavel !== '-') responsavelSet.add(responsavel);
        });
        
        // Filtros preenchidos dinamicamente
        
        // Preencher select de tipos
        const tipoSelect = document.getElementById('filterTipo');
        if (tipoSelect) {
            tipoSet.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                tipoSelect.appendChild(option);
            });
        }
        
        // Preencher select de construtoras
        const construtoraSelect = document.getElementById('filterConstrutora');
        if (construtoraSelect) {
            Array.from(construtoraSet).sort().forEach(construtora => {
                const option = document.createElement('option');
                option.value = construtora;
                option.textContent = construtora;
                construtoraSelect.appendChild(option);
            });
        }
        
        // Preencher select de funcion√°rios
        const funcionarioSelect = document.getElementById('filterFuncionario');
        if (funcionarioSelect) {
            Array.from(funcionarioSet).sort().forEach(funcionario => {
                const option = document.createElement('option');
                option.value = funcionario;
                option.textContent = funcionario;
                funcionarioSelect.appendChild(option);
            });
        }
        
        // Preencher select de respons√°veis
        const responsavelSelect = document.getElementById('filterResponsavel');
        if (responsavelSelect) {
            responsavelSet.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                responsavelSelect.appendChild(option);
            });
        }
    }
    
    function setupFilters() {
        const filterStatus = document.getElementById('filterStatus');
        const filterTipo = document.getElementById('filterTipo');
        const filterConstrutora = document.getElementById('filterConstrutora');
        const filterFuncionario = document.getElementById('filterFuncionario');
        const filterResponsavel = document.getElementById('filterResponsavel');
        const searchInput = document.getElementById('searchProject');
        
        [filterStatus, filterTipo, filterConstrutora, filterFuncionario, filterResponsavel].forEach(filter => {
            if (filter) filter.addEventListener('change', applyFilters);
        });
        
        if (searchInput) searchInput.addEventListener('input', applyFilters);
    }
    
    function applyFilters() {
        const statusFilter = document.getElementById('filterStatus')?.value || '';
        const tipoFilter = document.getElementById('filterTipo')?.value || '';
        const construtoraFilter = document.getElementById('filterConstrutora')?.value || '';
        const funcionarioFilter = document.getElementById('filterFuncionario')?.value || '';
        const responsavelFilter = document.getElementById('filterResponsavel')?.value || '';
        const searchText = (document.getElementById('searchProject')?.value || '').toLowerCase();
        
        console.log('Aplicando filtros:', { statusFilter, tipoFilter, construtoraFilter, funcionarioFilter, responsavelFilter, searchText });
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status') || '';
            const tipo = row.getAttribute('data-tipo') || '';
            const construtora = row.getAttribute('data-construtora') || '';
            const funcionario = row.getAttribute('data-funcionario') || '';
            const responsavel = row.getAttribute('data-responsavel') || '';
            const searchData = row.getAttribute('data-search') || '';
            
            const statusMatch = !statusFilter || status === statusFilter;
            const tipoMatch = !tipoFilter || tipo === tipoFilter;
            const construtoraMatch = !construtoraFilter || construtora === construtoraFilter;
            const funcionarioMatch = !funcionarioFilter || funcionario === funcionarioFilter;
            const responsavelMatch = !responsavelFilter || responsavel === responsavelFilter;
            const searchMatch = !searchText || searchData.includes(searchText);
            
            if (statusMatch && tipoMatch && construtoraMatch && funcionarioMatch && responsavelMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = visibleCount;
        
        console.log('Filtros aplicados. Vis√≠veis:', visibleCount);
    }
    
    // Expor fun√ß√£o global para o bot√£o de limpar
    window.clearFilters = function() {
        console.log('Limpando filtros');
        
        const filters = ['filterStatus', 'filterTipo', 'filterConstrutora', 'filterFuncionario', 'filterResponsavel', 'searchProject'];
        filters.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        rows.forEach(row => {
            row.style.display = '';
        });
        
        const countElement = document.getElementById('filteredCount');
        if (countElement) countElement.textContent = rows.length;
    };
});
</script>
{% endblock %}
