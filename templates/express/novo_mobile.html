{% extends "base.html" %}

{% block title %}Novo Relatório Express{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<style>
/* Mobile First Design System - SEM TREMIDA */
* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent !important;
    -webkit-touch-callout: none !important;
    -webkit-user-select: none !important;
    user-select: none !important;
    touch-action: manipulation !important;

    /* ELIMINAR TODAS ANIMAÇÕES */
    -webkit-transition: none !important;
    -moz-transition: none !important;
    -o-transition: none !important;
    transition: none !important;

    /* ELIMINAR TRANSFORMAÇÕES */
    -webkit-transform: none !important;
    -moz-transform: none !important;
    -o-transform: none !important;
    transform: none !important;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: #ffffff;
    margin: 0;
    padding: 0;
    -webkit-user-select: none !important;
    user-select: none !important;
    -webkit-touch-callout: none !important;
    touch-action: pan-y !important;
}

/* Permitir seleção apenas em inputs */
input, textarea, select {
    -webkit-user-select: text !important;
    user-select: text !important;
    -webkit-touch-callout: default !important;
    touch-action: manipulation !important;
    font-size: 16px !important; /* Prevenir zoom */
}

.mobile-container {
    width: 100%;
    min-height: 100vh;
    padding: 0;
    margin: 0;
}

/* Header Mobile */
.mobile-header {
    background: #f8f9fa;
    color: #495057;
    padding: 15px;
    text-align: center;
    font-size: 18px;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    position: sticky;
    top: 0;
    z-index: 100;
    border-bottom: 1px solid #e9ecef;
}

/* Form Sections */
.form-section {
    background: white;
    margin: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    overflow: hidden;
    border: 1px solid #e9ecef;
}

.section-header {
    background: #f8f9fa;
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
    color: #495057;
    font-size: 16px;
}

.section-content {
    padding: 20px;
}

/* Form Controls Mobile */
.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    font-size: 14px;
}

.form-control, .form-select, textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    font-size: 16px; /* Prevents zoom on iOS */
    background: white;
    transition: all 0.3s ease;
    -webkit-appearance: none;
    appearance: none;
    min-height: 52px;
}

.form-control:focus, .form-select:focus, textarea:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    background: #fbfcff;
}

textarea {
    min-height: 100px;
    resize: vertical;
}

/* Button System Mobile */
.btn {
    display: block;
    width: 100%;
    padding: 16px 20px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 12px;
    min-height: 52px;
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.btn-primary {
    background: #007bff;
    color: white;
    border: 1px solid #007bff;
}

.btn-primary:hover, .btn-primary:active {
    background: #0056b3;
    border-color: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-outline-primary {
    background: white;
    color: #007bff;
    border: 2px solid #007bff;
}

.btn-outline-primary:hover, .btn-outline-primary:active {
    background: #007bff;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
    border: 1px solid #28a745;
}

.btn-danger {
    background: #dc3545;
    color: white;
    border: 1px solid #dc3545;
}

/* Loading States */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn .spinner-border {
    width: 20px;
    height: 20px;
    margin-right: 8px;
}

/* Photo Upload Mobile */
.photo-upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 30px 20px;
    text-align: center;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 15px 0;
}

.photo-upload-zone:hover, .photo-upload-zone:active {
    border-color: #007bff;
    background: #f0f8ff;
}

.photo-upload-zone.dragover {
    border-color: #28a745;
    background: #f8fff8;
}

.upload-icon {
    font-size: 3rem;
    color: #6c757d;
    margin-bottom: 15px;
}

.upload-text {
    color: #6c757d;
    font-size: 16px;
    line-height: 1.4;
}

/* Category Selection Mobile */
.category-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.category-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.category-card:hover, .category-card:active {
    border-color: #007bff;
    background: #f8f9ff;
    transform: translateY(-2px);
}

.category-card.selected {
    border-color: #28a745;
    background: #f8fff8;
    color: #155724;
}

.category-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    color: #6c757d;
    transition: color 0.3s ease;
}

.category-card.selected .category-icon {
    color: #28a745;
}

.category-name {
    font-size: 14px;
    font-weight: 600;
    margin: 0;
}

/* Photo Configuration Mobile */
.photo-config-list {
    margin: 20px 0;
}

.photo-config-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.photo-preview {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 15px;
}

.legend-select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 16px;
    margin-bottom: 15px;
    min-height: 48px;
}

.photo-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.photo-actions .btn {
    margin-bottom: 0;
    padding: 12px 16px;
    font-size: 14px;
    min-height: 44px;
}

/* Checklist Mobile */
.checklist-container {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
}

.checklist-item {
    display: flex;
    align-items: flex-start;
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
    border-left: 4px solid #007bff;
    min-height: 60px;
}

.checklist-checkbox {
    width: 24px;
    height: 24px;
    margin: 2px 15px 0 0;
    flex-shrink: 0;
    cursor: pointer;
}

.checklist-label {
    flex: 1;
    font-size: 15px;
    line-height: 1.4;
    margin: 0;
    cursor: pointer;
    color: #495057;
}

.checklist-item.completed {
    border-left-color: #28a745;
}

.checklist-item.completed .checklist-label {
    color: #28a745;
    font-weight: 500;
}

/* Photo Editor Mobile */
.photo-editor-modal .modal-dialog {
    margin: 0;
    width: 100vw;
    height: 100vh;
    max-width: none;
    max-height: none;
}

.photo-editor-modal .modal-content {
    height: 100vh;
    border-radius: 0;
    display: flex;
    flex-direction: column;
}

.editor-header {
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.editor-canvas-container {
    flex: 1;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
}

.editor-canvas {
    max-width: 100%;
    max-height: 100%;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    touch-action: none;
    background: white;
}

.editor-tools {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 15px;
}

.tool-section {
    margin-bottom: 20px;
}

.tool-title {
    font-size: 14px;
    font-weight: 600;
    color: #495057;
    margin-bottom: 12px;
}

.color-palette {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    margin: 10px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    cursor: pointer;
    transition: all 0.3s ease;
}

.color-option:hover, .color-option.selected {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}

.drawing-tools {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin: 15px 0;
}

.tool-button {
    padding: 12px 8px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    background: white;
    color: #495057;
    font-size: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.tool-button:hover, .tool-button.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.tool-button i {
    font-size: 16px;
    margin-bottom: 4px;
}

/* Map Mobile */
#map {
    height: 200px;
    border-radius: 8px;
    margin: 15px 0;
}

/* Responsive Grid */
.mobile-grid {
    display: grid;
    gap: 15px;
}

.mobile-grid.two-col {
    grid-template-columns: 1fr 1fr;
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    color: white;
}

.loading-overlay.hidden {
    display: none;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255,255,255,0.3);
    border-top: 4px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Success/Error Messages */
.alert-mobile {
    margin: 10px;
    padding: 15px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.4;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-danger {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

/* Bottom Action Bar */
.bottom-action-bar {
    position: sticky;
    bottom: 0;
    background: #f8f9fa;
    padding: 15px;
    border-top: 1px solid #e9ecef;
    box-shadow: 0 -1px 3px rgba(0,0,0,0.1);
}

/* Configured Photos Display */
.configured-photos-display {
    margin: 15px 0;
}

.configured-photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
}

.configured-photo-item {
    background: white;
    border: 2px solid #28a745;
    border-radius: 8px;
    padding: 8px;
    text-align: center;
}

.configured-photo-item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 8px;
}

.configured-photo-legend {
    font-size: 11px;
    color: #495057;
    line-height: 1.2;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Form Validation */
.form-control.invalid, .form-select.invalid {
    border-color: #dc3545;
    background: #fff5f5;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 13px;
    margin-top: 5px;
    display: block;
}

/* Accessibility */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0,0,0,0);
    white-space: nowrap;
    border: 0;
}

/* Manter tema claro sempre */
.form-section {
    background: white;
}

.form-control, .form-select, textarea {
    background: white;
    color: #495057;
}

.checklist-item {
    background: white;
}

/* Estilos específicos para controle de tamanho de imagem nos relatórios express */
.express-photo-container {
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
    padding: 5px;
    border: 1px solid #dee2e6;
}

.express-photo-container .photo-preview {
    display: flex;
    justify-content: center;
    align-items: center;
    max-height: 300px; /* Limita a altura máxima da prévia */
    overflow: hidden;
}

.express-photo-container img {
    width: 100%;
    height: auto; /* Mantém a proporção */
    max-height: 100%; /* Garante que não exceda o contêiner */
    object-fit: cover; /* Cobre a área do contêiner, mantendo a proporção */
    border-radius: 8px; /* Arredonda as bordas da imagem */
}

.express-photo-container .photo-info {
    padding: 10px;
    background-color: #fff;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.express-photo-container .photo-actions {
    display: flex;
    gap: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="mobile-container">
    <!-- Mobile Header -->
    <div class="mobile-header">
        <i class="fas fa-file-alt" style="color: #007bff;"></i> Novo Relatório Express
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <div>Salvando relatório...</div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="expressForm">
        {{ form.hidden_tag() }}

        <!-- Dados da Empresa -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-building"></i> Dados da Empresa
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label class="form-label" for="empresa_nome">Nome da Empresa *</label>
                    {{ form.empresa_nome(class="form-control", placeholder="Digite o nome da empresa") }}
                </div>

                <div class="form-group">
                    <label class="form-label" for="empresa_endereco">Endereço</label>
                    {{ form.empresa_endereco(class="form-control", placeholder="Endereço da empresa") }}
                </div>

                <div class="mobile-grid two-col">
                    <div class="form-group">
                        <label class="form-label" for="empresa_telefone">Telefone</label>
                        {{ form.empresa_telefone(class="form-control", placeholder="(11) 99999-9999") }}
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="empresa_email">E-mail</label>
                        {{ form.empresa_email(class="form-control", placeholder="contato@empresa.com") }}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="empresa_responsavel">Responsável</label>
                    {{ form.empresa_responsavel(class="form-control", placeholder="Nome do responsável") }}
                </div>
            </div>
        </div>

        <!-- Dados da Visita -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-calendar-alt"></i> Dados da Visita
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label class="form-label" for="data_visita">Data da Visita *</label>
                    {{ form.data_visita(class="form-control") }}
                </div>

                <div class="mobile-grid two-col">
                    <div class="form-group">
                        <label class="form-label" for="periodo_inicio">Início</label>
                        {{ form.periodo_inicio(class="form-control") }}
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="periodo_fim">Fim</label>
                        {{ form.periodo_fim(class="form-control") }}
                    </div>
                </div>

                <div class="mobile-grid two-col">
                    <div class="form-group">
                        <label class="form-label" for="condicoes_climaticas">Condições Climáticas</label>
                        {{ form.condicoes_climaticas(class="form-select") }}
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="temperatura">Temperatura</label>
                        {{ form.temperatura(class="form-control", placeholder="Ex: 25°C") }}
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="endereco_visita">Local da Visita</label>
                    {{ form.endereco_visita(class="form-control", placeholder="Endereço do local visitado") }}
                </div>
            </div>
        </div>

        <!-- Checklist -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-tasks"></i> Checklist
            </div>
            <div class="section-content">
                <div id="checklistContainer" class="checklist-container">
                    <div class="loading-spinner" id="checklistLoading">
                        <i class="fas fa-spinner fa-spin"></i> Carregando checklist...
                    </div>
                </div>
                <input type="hidden" id="checklistData" name="checklist_completo">
            </div>
        </div>

        <!-- Fotos -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-camera"></i> Fotos <span id="photoCounter" class="photo-counter">0</span>
            </div>
            <div class="section-content">
                <!-- Seleção de Categoria -->
                <div id="categorySelection">
                    <label class="form-label">Selecione a categoria para as fotos:</label>
                    <div class="category-grid">
                        <div class="category-card" data-category="Torre 1">
                            <div class="category-icon"><i class="fas fa-building"></i></div>
                            <div class="category-name">Torre 1</div>
                        </div>
                        <div class="category-card" data-category="Torre 2">
                            <div class="category-icon"><i class="fas fa-building"></i></div>
                            <div class="category-name">Torre 2</div>
                        </div>
                        <div class="category-card" data-category="Área Comum">
                            <div class="category-icon"><i class="fas fa-users"></i></div>
                            <div class="category-name">Área Comum</div>
                        </div>
                        <div class="category-card" data-category="Piscina">
                            <div class="category-icon"><i class="fas fa-swimmer"></i></div>
                            <div class="category-name">Piscina</div>
                        </div>
                    </div>
                </div>

                <!-- Upload de Fotos -->
                <div id="photoUploadZone" class="photo-upload-zone" style="display: none;">
                    <div class="upload-options">
                        <button type="button" class="btn btn-outline-primary" onclick="selectFromGallery()">
                            <i class="fas fa-images"></i><br>Galeria
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="captureFromCamera()">
                            <i class="fas fa-camera"></i><br>Câmera
                        </button>
                    </div>
                    <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                </div>

                <!-- Preview de Fotos -->
                <div id="photoPreviewContainer" style="display: none;"></div>

                <!-- Fotos Configuradas -->
                <div id="configuredPhotosDisplay" class="configured-photos-display" style="display: none;">
                    <div class="form-label">Fotos Configuradas:</div>
                    <div id="configuredPhotoGrid" class="configured-photo-grid"></div>
                </div>

                <!-- Container para fotos enviadas -->
                <div class="uploaded-photos" id="uploadedPhotos">
                        <!-- Fotos aparecerão aqui com controle de tamanho -->
                    </div>

                <input type="hidden" id="fotoConfiguracoes" name="foto_configuracoes">
            </div>
        </div>

        <!-- Observações -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-clipboard-list"></i> Observações
            </div>
            <div class="section-content">
                <div class="form-group">
                    <label class="form-label" for="observacoes_gerais">Observações Gerais</label>
                    {{ form.observacoes_gerais(class="form-control", rows="4", placeholder="Observações sobre a visita...") }}
                </div>

                <div class="form-group">
                    <label class="form-label" for="pendencias">Pendências</label>
                    {{ form.pendencias(class="form-control", rows="3", placeholder="Itens pendentes...") }}
                </div>

                <div class="form-group">
                    <label class="form-label" for="recomendacoes">Recomendações</label>
                    {{ form.recomendacoes(class="form-control", rows="3", placeholder="Recomendações técnicas...") }}
                </div>
            </div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="bottom-action-bar">
            <button type="submit" class="btn btn-primary" id="saveButton">
                <i class="fas fa-save"></i> Concluir relatório
            </button>
            <a href="{{ url_for('express_list') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Voltar
            </a>
        </div>
    </form>
</div>

<!-- Photo Configuration Modal -->
<div class="modal fade photo-editor-modal" id="photoConfigModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="editor-header">
                <i class="fas fa-cog"></i> Configurar Fotos
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 15px;">
                <div id="photoConfigList" class="photo-config-list"></div>
            </div>
            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #e9ecef;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="confirmPhotoConfiguration()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Photo Editor Modal -->
<div class="modal fade photo-editor-modal" id="photoEditorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="editor-header">
                <i class="fas fa-edit"></i> Editor de Foto
            </div>
            <div class="editor-canvas-container">
                <canvas id="photoCanvas" class="editor-canvas"></canvas>
            </div>
            <div class="editor-tools">
                <div class="tool-section">
                    <div class="tool-title">Cores</div>
                    <div class="color-palette">
                        <div class="color-option selected" data-color="#ff0000" style="background: #ff0000;"></div>
                        <div class="color-option" data-color="#00ff00" style="background: #00ff00;"></div>
                        <div class="color-option" data-color="#0000ff" style="background: #0000ff;"></div>
                        <div class="color-option" data-color="#ffff00" style="background: #ffff00;"></div>
                        <div class="color-option" data-color="#ff00ff" style="background: #ff00ff;"></div>
                        <div class="color-option" data-color="#000000" style="background: #000000;"></div>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-title">Ferramentas</div>
                    <div class="drawing-tools">
                        <div class="tool-button active" data-tool="brush">
                            <i class="fas fa-paint-brush"></i>
                            Pincel
                        </div>
                        <div class="tool-button" data-tool="arrow">
                            <i class="fas fa-arrow-right"></i>
                            Seta
                        </div>
                        <div class="tool-button" data-tool="text">
                            <i class="fas fa-font"></i>
                            Texto
                        </div>
                    </div>
                </div>

                <div class="mobile-grid two-col">
                    <button type="button" class="btn btn-outline-primary" onclick="undoLastAction()">
                        <i class="fas fa-undo"></i> Desfazer
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="clearCanvas()">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px; border-top: 1px solid #e9ecef;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="saveEditedPhoto()">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Mobile-optimized JavaScript
let selectedCategory = null;
let uploadedPhotos = [];
let configuredPhotos = [];
let currentEditingPhoto = null;

// Global drawing variables
let canvas, ctx;
let isDrawing = false;
let currentTool = 'brush';
let currentColor = '#ff0000';
let drawingHistory = [];

document.addEventListener('DOMContentLoaded', function() {
    initializeMobileInterface();
    loadDefaultChecklist();
});

function initializeMobileInterface() {
    // Category selection
    document.querySelectorAll('.category-card').forEach(card => {
        card.addEventListener('click', function() {
            selectCategory(this.dataset.category);
        });
    });

    // Photo upload
    const photoInput = document.getElementById('photoInput');
    const uploadZone = document.getElementById('photoUploadZone');

    uploadZone.addEventListener('click', () => photoInput.click());

    photoInput.addEventListener('change', function(e) {
        handlePhotoUpload(e.target.files);
    });

    // Drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        handlePhotoUpload(e.dataTransfer.files);
    });

    // Form submission
    document.getElementById('expressForm').addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
            showLoadingOverlay();
            this.submit();
        }
    });
}

function selectCategory(category) {
    selectedCategory = category;

    // Update visual selection
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('selected');

    // Show upload zone
    document.getElementById('photoUploadZone').style.display = 'block';
}

// Camera and gallery functions with error handling
function selectFromGallery() {
    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        return;
    }
    const photoInput = document.getElementById('photoInput');
    if (photoInput) {
        photoInput.click();
    } else {
        console.warn('Photo input element not found');
    }
}

function captureFromCamera() {
    if (!selectedCategory) {
        alert('Selecione uma categoria antes de adicionar fotos.');
        return;
    }
    const cameraInput = document.getElementById('cameraInput');
    if (cameraInput) {
        cameraInput.click();
    } else {
        console.warn('Camera input element not found');
    }
}

function handlePhotoUpload(files) {
    if (!selectedCategory) {
        alert('Por favor, selecione uma categoria primeiro.');
        return;
    }

    Array.from(files).forEach((file, index) => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoId = `photo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const photoData = {
                    id: photoId,
                    file: file,
                    dataUrl: e.target.result,
                    category: selectedCategory,
                    fileName: file.name,
                    configured: false
                };

                uploadedPhotos.push(photoData);
                showPhotoConfigurationModal();
            };
            reader.readAsDataURL(file);
        }
    });
}

function showPhotoConfigurationModal() {
    const modal = new bootstrap.Modal(document.getElementById('photoConfigModal'));
    const configList = document.getElementById('photoConfigList');

    configList.innerHTML = '';

    uploadedPhotos.filter(photo => !photo.configured).forEach(photo => {
        const configItem = createPhotoConfigItem(photo);
        configList.appendChild(configItem);
        loadLegendsForPhoto(photo.id, photo.category);
    });

    modal.show();
}

function createPhotoConfigItem(photo) {
    const item = document.createElement('div');
    item.className = 'photo-config-item';
    item.dataset.photoId = photo.id;
    item.dataset.category = photo.category;
    item.dataset.fileName = photo.fileName;

    item.innerHTML = `
        <img src="${photo.dataUrl}" alt="Preview" class="photo-preview">
        <div class="form-group">
            <label class="form-label">Categoria: <strong>${photo.category}</strong></label>
        </div>
        <div class="form-group">
            <label class="form-label" for="legend_${photo.id}">Legenda (Obrigatória):</label>
            <select class="legend-select" id="legend_${photo.id}" required>
                <option value="">Carregando legendas...</option>
            </select>
        </div>
        <div class="photo-actions">
            <button type="button" class="btn btn-primary btn-sm edit-photo-btn" onclick="editPhoto('${photo.id}')">
                <i class="fas fa-edit"></i> Editar
            </button>
            <button type="button" class="btn btn-danger btn-sm" onclick="removePhoto('${photo.id}')">
                <i class="fas fa-trash"></i> Remover
            </button>
        </div>
    `;

    return item;
}

async function loadLegendsForPhoto(photoId, category) {
    try {
        console.log(`Carregando legendas para foto ${photoId}, categoria: ${category}`);

        const categoryMap = {
            'Geral': 'Geral',
            'Estrutura': 'Estrutural',
            'Acabamento': 'Acabamentos',
            'Instalações': 'Elétrica',
            'Segurança': 'Segurança',
            'Problema': 'Geral'
        };

        const mappedCategory = categoryMap[category] || 'Geral';
        console.log(`Categoria mapeada: ${mappedCategory}`);

        const response = await fetch(`/api/legendas?categoria=${mappedCategory}`);
        const data = await response.json();
        console.log('Dados recebidos:', data);

        const select = document.getElementById(`legend_${photoId}`);
        console.log('Select element:', select);

        if (select && data.success && data.legendas) {
            select.innerHTML = '<option value="">Selecione uma legenda...</option>';

            data.legendas.forEach(legenda => {
                const option = document.createElement('option');
                option.value = legenda.texto;
                option.textContent = legenda.texto;
                select.appendChild(option);
            });

            console.log(`${data.legendas.length} legendas carregadas para categoria ${mappedCategory}`);
        }
    } catch (error) {
        console.error('Erro ao carregar legendas:', error);
        const select = document.getElementById(`legend_${photoId}`);
        if (select) {
            select.innerHTML = '<option value="">Erro ao carregar legendas</option>';
        }
    }
}

function editPhoto(photoId) {
    currentEditingPhoto = photoId;
    const photo = uploadedPhotos.find(p => p.id === photoId);

    if (photo) {
        initializePhotoEditor(photo.dataUrl);
        const modal = new bootstrap.Modal(document.getElementById('photoEditorModal'));
        modal.show();
    }
}

function initializePhotoEditor(imageSrc) {
    canvas = document.getElementById('photoCanvas');
    ctx = canvas.getContext('2d');

    const img = new Image();
    img.onload = function() {
        // Set canvas size to fit the container while maintaining aspect ratio
        const containerWidth = canvas.parentElement.clientWidth - 20;
        const containerHeight = canvas.parentElement.clientHeight - 20;

        const aspectRatio = img.width / img.height;
        let canvasWidth, canvasHeight;

        if (containerWidth / containerHeight > aspectRatio) {
            canvasHeight = containerHeight;
            canvasWidth = canvasHeight * aspectRatio;
        } else {
            canvasWidth = containerWidth;
            canvasHeight = canvasWidth / aspectRatio;
        }

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        // Draw image
        ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);

        // Save initial state
        drawingHistory = [ctx.getImageData(0, 0, canvas.width, canvas.height)];
    };
    img.src = imageSrc;

    setupCanvasEvents();
    setupToolEvents();
}

function setupCanvasEvents() {
    let lastX, lastY;

    // Touch events for mobile
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        isDrawing = true;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        lastX = touch.clientX - rect.left;
        lastY = touch.clientY - rect.top;
    });

    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!isDrawing) return;

        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const currentX = touch.clientX - rect.left;
        const currentY = touch.clientY - rect.top;

        if (currentTool === 'brush') {
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
        }

        lastX = currentX;
        lastY = currentY;
    });

    canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        isDrawing = false;
        // Save state for undo
        drawingHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        if (drawingHistory.length > 10) drawingHistory.shift(); // Keep only last 10 states
    });

    // Mouse events for desktop compatibility
    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = e.clientX - rect.left;
        lastY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;

        const rect = canvas.getBoundingClientRect();
        const currentX = e.clientX - rect.left;
        const currentY = e.clientY - rect.top;

        if (currentTool === 'brush') {
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
        }

        lastX = currentX;
        lastY = currentY;
    });

    canvas.addEventListener('mouseup', () => {
        isDrawing = false;
        drawingHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        if (drawingHistory.length > 10) drawingHistory.shift();
    });
}

function setupToolEvents() {
    // Color selection
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            currentColor = this.dataset.color;
            console.log(`Cor selecionada: ${currentColor}`);
        });
    });

    // Tool selection
    document.querySelectorAll('.tool-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.tool-button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentTool = this.dataset.tool;
            console.log(`Ferramenta selecionada: ${currentTool}`);
        });
    });
}

function undoLastAction() {
    if (drawingHistory.length > 1) {
        drawingHistory.pop(); // Remove current state
        const previousState = drawingHistory[drawingHistory.length - 1];
        ctx.putImageData(previousState, 0, 0);
    }
}

function clearCanvas() {
    if (confirm('Tem certeza que deseja limpar todas as anotações?')) {
        // Redraw original image
        const photo = uploadedPhotos.find(p => p.id === currentEditingPhoto);
        if (photo) {
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                drawingHistory = [ctx.getImageData(0, 0, canvas.width, canvas.height)];
            };
            img.src = photo.dataUrl;
        }
    }
}

function saveEditedPhoto() {
    const editedImageData = canvas.toDataURL('image/png');
    const photo = uploadedPhotos.find(p => p.id === currentEditingPhoto);

    if (photo) {
        photo.dataUrl = editedImageData;
        photo.edited = true;

        // Update preview in configuration modal
        const configItem = document.querySelector(`[data-photo-id="${currentEditingPhoto}"]`);
        if (configItem) {
            const img = configItem.querySelector('img');
            img.src = editedImageData;
        }

        console.log(`Foto ${currentEditingPhoto} editada e salva`);
    }

    // Close editor modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('photoEditorModal'));
    modal.hide();
}

function removePhoto(photoId) {
    if (confirm('Tem certeza que deseja remover esta foto?')) {
        uploadedPhotos = uploadedPhotos.filter(p => p.id !== photoId);
        const configItem = document.querySelector(`[data-photo-id="${photoId}"]`);
        if (configItem) {
            configItem.remove();
        }
        console.log(`Foto ${photoId} removida`);
    }
}

function confirmPhotoConfiguration() {
    const photoConfigItems = document.querySelectorAll('.photo-config-item');
    let validPhotos = 0;
    let photoConfigurations = [];

    photoConfigItems.forEach(item => {
        const photoId = item.dataset.photoId;
        const legendSelect = item.querySelector('.legend-select');
        const legend = legendSelect.value.trim();
        const img = item.querySelector('img');

        if (!legend) {
            legendSelect.style.borderColor = '#dc3545';
            legendSelect.focus();
            alert('Por favor, selecione uma legenda predefinida para todas as fotos.');
            return;
        }

        if (legend && img) {
            const photo = uploadedPhotos.find(p => p.id === photoId);
            if (photo) {
                const photoConfig = {
                    data: img.src,
                    legenda: legend,
                    categoria: photo.category,
                    originalName: photo.fileName
                };

                photoConfigurations.push(photoConfig);
                photo.configured = true;
                photo.legend = legend;
                validPhotos++;

                console.log(`Foto ${photoId} configurada com legenda: ${legend}`);
            }
        }
    });

    if (validPhotos !== photoConfigItems.length) {
        alert('Por favor, selecione legendas predefinidas para todas as fotos.');
        return;
    }

    if (validPhotos === 0) {
        alert('Por favor, configure pelo menos uma foto com legenda predefinida.');
        return;
    }

    // Save configurations
    document.getElementById('fotoConfiguracoes').value = JSON.stringify(photoConfigurations);
    console.log(`Configurações das fotos salvas: ${photoConfigurations.length} fotos`);

    // Update configured photos display
    displayConfiguredPhotos();
    updatePhotoCounter();

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('photoConfigModal'));
    modal.hide();

    // Reset for next category
    resetCategorySelection();

    alert(`${validPhotos} foto(s) configurada(s) com sucesso!`);
}

function displayConfiguredPhotos() {
    const display = document.getElementById('configuredPhotosDisplay');
    const grid = document.getElementById('configuredPhotoGrid');

    grid.innerHTML = '';

    const configured = uploadedPhotos.filter(p => p.configured);

    if (configured.length > 0) {
        display.style.display = 'block';

        configured.forEach(photo => {
            const item = document.createElement('div');
            item.className = 'configured-photo-item';
            item.innerHTML = `
                <img src="${photo.dataUrl}" alt="${photo.legend}">
                <div class="configured-photo-legend">${photo.legend}</div>
            `;
            grid.appendChild(item);
        });
    } else {
        display.style.display = 'none';
    }
}

function updatePhotoCounter() {
    const counter = document.getElementById('photoCounter');
    const configuredCount = uploadedPhotos.filter(p => p.configured).length;
    counter.textContent = configuredCount;
    counter.style.display = configuredCount > 0 ? 'inline' : 'none';
}

function resetCategorySelection() {
    selectedCategory = null;
    document.querySelectorAll('.category-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.getElementById('photoUploadZone').style.display = 'none';
    document.getElementById('photoInput').value = '';
}

async function loadDefaultChecklist() {
    try {
        console.log('Carregando checklist padrão...');

        const response = await fetch('/api/checklist_express');
        const data = await response.json();

        if (data.success && data.items) {
            renderChecklist(data.items);
            console.log(`${data.items.length} itens do checklist padrão carregados`);
        } else {
            throw new Error('Erro ao carregar checklist');
        }
    } catch (error) {
        console.error('Erro ao carregar checklist:', error);
        document.getElementById('checklistContainer').innerHTML = `
            <div class="alert-mobile alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Erro ao carregar checklist. Tente recarregar a página.
            </div>
        `;
    }
}

function renderChecklist(items) {
    const container = document.getElementById('checklistContainer');
    container.innerHTML = '';

    items.forEach((item, index) => {
        const checklistItem = document.createElement('div');
        checklistItem.className = 'checklist-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checklist-checkbox';
        checkbox.id = `checklist_${index}`;
        checkbox.addEventListener('change', updateChecklistData);

        const label = document.createElement('label');
        label.className = 'checklist-label';
        label.htmlFor = `checklist_${index}`;
        label.textContent = item.texto;

        checklistItem.appendChild(checkbox);
        checklistItem.appendChild(label);
        container.appendChild(checklistItem);
    });
}

function updateChecklistData() {
    const checkboxes = document.querySelectorAll('.checklist-checkbox');
    const checklistData = [];

    checkboxes.forEach((checkbox, index) => {
        const label = document.querySelector(`label[for="${checkbox.id}"]`);
        checklistData.push({
            titulo: label.textContent,
            concluido: checkbox.checked
        });

        // Update visual state
        const item = checkbox.closest('.checklist-item');
        if (checkbox.checked) {
            item.classList.add('completed');
        } else {
            item.classList.remove('completed');
        }
    });

    document.getElementById('checklistData').value = JSON.stringify(checklistData);
}

function validateForm() {
    const empresaNome = document.getElementById('empresa_nome');
    const dataVisita = document.getElementById('data_visita');

    let isValid = true;

    // Clear previous validation
    document.querySelectorAll('.form-control, .form-select').forEach(el => {
        el.classList.remove('invalid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

    // Validate required fields
    if (!empresaNome.value.trim()) {
        showFieldError(empresaNome, 'Nome da empresa é obrigatório');
        isValid = false;
    }

    if (!dataVisita.value) {
        showFieldError(dataVisita, 'Data da visita é obrigatória');
        isValid = false;
    }

    if (!isValid) {
        // Scroll to first error
        const firstError = document.querySelector('.form-control.invalid, .form-select.invalid');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    return isValid;
}

function showFieldError(field, message) {
    field.classList.add('invalid');

    const feedback = document.createElement('div');
    feedback.className = 'invalid-feedback';
    feedback.textContent = message;

    field.parentNode.appendChild(feedback);
}

function showLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoadingOverlay() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}

// SERVICE WORKER COMPLETAMENTE REMOVIDO - Sistema usa apenas PostgreSQL
// PWA funciona apenas como instalação, sem cache offline
</script>
{% endblock %}