{% extends "base.html" %}

{% block title %}Novo Relatório Express{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-plus-circle"></i> Novo Relatório Express</h3>
                <a href="{{ url_for('express_list') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar à Lista
                </a>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        {{ form.hidden_tag() }}
        
        <div class="row">
            <div class="col-lg-8">
                <!-- DADOS DA EMPRESA -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-building"></i> Dados da Empresa</h5>
                        <small class="text-muted">Informações da empresa visitada</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.empresa_nome.label(class="form-label") }}
                                {{ form.empresa_nome(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.empresa_responsavel.label(class="form-label") }}
                                {{ form.empresa_responsavel(class="form-control") }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.empresa_telefone.label(class="form-label") }}
                                {{ form.empresa_telefone(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.empresa_email.label(class="form-label") }}
                                {{ form.empresa_email(class="form-control") }}
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.empresa_endereco.label(class="form-label") }}
                            {{ form.empresa_endereco(class="form-control") }}
                        </div>
                    </div>
                </div>

                <!-- DADOS DA VISITA -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar-check"></i> Dados da Visita</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ form.data_visita.label(class="form-label") }}
                                {{ form.data_visita(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.periodo_inicio.label(class="form-label") }}
                                {{ form.periodo_inicio(class="form-control") }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ form.periodo_fim.label(class="form-label") }}
                                {{ form.periodo_fim(class="form-control") }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.condicoes_climaticas.label(class="form-label") }}
                                {{ form.condicoes_climaticas(class="form-control") }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.temperatura.label(class="form-label") }}
                                {{ form.temperatura(class="form-control") }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LOCALIZAÇÃO -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marker-alt"></i> Localização da Visita</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.endereco_visita.label(class="form-label") }}
                            {{ form.endereco_visita(class="form-control") }}
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <button type="button" id="getLocationBtn" class="btn btn-outline-primary">
                                    <i class="fas fa-crosshairs"></i> Obter Localização Atual
                                </button>
                            </div>
                        </div>
                        {{ form.latitude() }}
                        {{ form.longitude() }}
                    </div>
                </div>

                <!-- OBSERVAÇÕES E RELATÓRIO -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-clipboard-list"></i> Relatório da Visita</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ form.observacoes_gerais.label(class="form-label") }}
                            {{ form.observacoes_gerais(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.pendencias.label(class="form-label") }}
                            {{ form.pendencias(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.recomendacoes.label(class="form-label") }}
                            {{ form.recomendacoes(class="form-control") }}
                        </div>
                    </div>
                </div>

                <!-- FOTOS -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-camera"></i> Registro Fotográfico</h5>
                    </div>
                    <div class="card-body">
                        {{ form.fotos.label(class="form-label") }}
                        {{ form.fotos(class="form-control", onchange="previewImages(this)") }}
                        <small class="form-text text-muted">Selecione múltiplas fotos (JPG, PNG). Máximo 16MB por foto.</small>
                        <div id="imagePreview" class="mt-3"></div>
                    </div>
                </div>
            </div>

            <!-- SIDEBAR DE AÇÕES -->
            <div class="col-lg-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h6><i class="fas fa-cogs"></i> Ações</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary">
                                <i class="fas fa-save"></i> Salvar Rascunho
                            </button>
                            <button type="submit" name="action" value="finalize" class="btn btn-success">
                                <i class="fas fa-check"></i> Finalizar Relatório
                            </button>
                            <hr>
                            <a href="{{ url_for('express_list') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancelar
                            </a>
                        </div>
                        
                        <div class="mt-4">
                            <h6>ℹ️ Informações:</h6>
                            <ul class="list-unstyled small">
                                <li>• <strong>Rascunho:</strong> Pode ser editado</li>
                                <li>• <strong>Finalizado:</strong> Gera PDF automaticamente</li>
                                <li>• Use fotos de qualidade para melhor resultado</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// Preview de imagens
function previewImages(input) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (input.files && input.files.length > 0) {
        const title = document.createElement('h6');
        title.textContent = `${input.files.length} foto(s) selecionada(s):`;
        title.className = 'mt-3 mb-2';
        preview.appendChild(title);
        
        Array.from(input.files).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-3';
                    col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" style="height: 150px; object-fit: cover;">
                            <div class="card-body p-2">
                                <small class="text-muted">${file.name}</small>
                            </div>
                        </div>
                    `;
                    preview.appendChild(col);
                };
                reader.readAsDataURL(file);
            }
        });
    }
}

// Localização GPS
document.getElementById('getLocationBtn').addEventListener('click', function() {
    getCurrentLocation(this);
});

function getCurrentLocation(btn) {
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obtendo localização...';
    btn.disabled = true;
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('latitude').value = position.coords.latitude;
            document.getElementById('longitude').value = position.coords.longitude;
            
            btn.innerHTML = '<i class="fas fa-check"></i> Localização obtida!';
            btn.className = 'btn btn-outline-success';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.className = 'btn btn-outline-primary';
                btn.disabled = false;
            }, 2000);
        }, function(error) {
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao obter localização';
            btn.className = 'btn btn-outline-danger';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.className = 'btn btn-outline-primary';
                btn.disabled = false;
            }, 3000);
        });
    } else {
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Geolocalização não suportada';
        btn.className = 'btn btn-outline-warning';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.className = 'btn btn-outline-primary';
            btn.disabled = false;
        }, 3000);
    }
}

// Auto-preencher data atual
document.addEventListener('DOMContentLoaded', function() {
    const dataVisita = document.getElementById('data_visita');
    if (!dataVisita.value) {
        const hoje = new Date().toISOString().split('T')[0];
        dataVisita.value = hoje;
    }
});
</script>
{% endblock %}