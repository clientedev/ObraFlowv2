{% extends "base.html" %}

{% block title %}Novo Relatório Express{% endblock %}

{% block head %}
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
/* === ESTILO CUSTOMIZADO ELP COM BOOTSTRAP === */

:root {
    --elp-primary: #20c1e8;
    --elp-secondary: #343a40;
    --elp-gradient: linear-gradient(135deg, #343a40 0%, #20c1e8 100%);
    --elp-shadow: 0 8px 32px rgba(32, 193, 232, 0.15);
}

body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

/* Header ELP */
.elp-header {
    background: var(--elp-gradient);
    color: white;
    padding: 2rem;
    border-radius: 20px;
    text-align: center;
    margin-bottom: 2rem;
    box-shadow: var(--elp-shadow);
    position: relative;
    overflow: hidden;
}

.elp-header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
    animation: shimmer 4s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 0.7; }
}

.elp-header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    margin: 0;
    position: relative;
    z-index: 2;
    text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.elp-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin-top: 0.5rem;
    position: relative;
    z-index: 2;
}

/* Progress Bar Customizado */
.progress-elp {
    height: 10px;
    border-radius: 10px;
    background: #e9ecef;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-elp .progress-bar {
    background: linear-gradient(90deg, var(--elp-primary), #17a2b8);
    border-radius: 10px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Cards com Estilo ELP */
.card-elp {
    border: none;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    border: 1px solid rgba(32, 193, 232, 0.1);
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.card-header-elp {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-bottom: 2px solid rgba(32, 193, 232, 0.1);
    padding: 1rem 1.5rem;
}

.card-header-elp h5 {
    margin: 0;
    color: #2c3e50;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-icon {
    color: var(--elp-primary);
    font-size: 1.2rem;
}

/* Formulário */
.form-control:focus {
    border-color: var(--elp-primary);
    box-shadow: 0 0 0 0.2rem rgba(32, 193, 232, 0.25);
}

.form-select:focus {
    border-color: var(--elp-primary);
    box-shadow: 0 0 0 0.2rem rgba(32, 193, 232, 0.25);
}

/* Input Groups */
.input-group-text {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 1px solid #ced4da;
    color: var(--elp-primary);
    font-weight: 600;
}

/* Botões ELP */
.btn-elp-primary {
    background: linear-gradient(135deg, var(--elp-primary), #17a2b8);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.8rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(32, 193, 232, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-elp-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 24px rgba(32, 193, 232, 0.4);
    color: white;
}

.btn-elp-secondary {
    background: linear-gradient(135deg, #6c757d, #495057);
    border: none;
    color: white;
    font-weight: 700;
    padding: 0.8rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-elp-secondary:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
    color: white;
}

.btn-elp-outline {
    background: white;
    color: var(--elp-primary);
    border: 2px solid var(--elp-primary);
    font-weight: 700;
    padding: 0.8rem 2rem;
    border-radius: 12px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-elp-outline:hover {
    background: var(--elp-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(32, 193, 232, 0.3);
}

/* Alert para localização */
.alert-success {
    background: linear-gradient(135deg, #d4edda, #f0fff0);
    border-left: 4px solid #28a745;
    border-radius: 10px;
}

/* Animações */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.card-elp {
    animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.card-elp:nth-child(1) { animation-delay: 0.1s; }
.card-elp:nth-child(2) { animation-delay: 0.2s; }
.card-elp:nth-child(3) { animation-delay: 0.3s; }
.card-elp:nth-child(4) { animation-delay: 0.4s; }

/* Responsivo Mobile */
@media (max-width: 768px) {
    .elp-header h1 {
        font-size: 1.5rem;
    }
    
    .btn-elp-primary,
    .btn-elp-secondary,
    .btn-elp-outline {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        font-size: 16px; /* Previne zoom no iOS */
    }
}

/* Loading states */
.btn.loading {
    position: relative;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* High Contrast Support */
@media (prefers-contrast: high) {
    .elp-header {
        background: #2c3e50;
    }
    
    .btn-elp-primary {
        background: #0056b3;
    }
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8 col-xl-6">
            
            <!-- Header ELP -->
            <div class="elp-header">
                <h1>
                    <i class="fas fa-bolt me-2"></i>
                    Novo Relatório Express
                </h1>
                <div class="elp-subtitle">Sistema ELP - Criação Rápida e Profissional</div>
            </div>
            
            <!-- Progress Card -->
            <div class="card-elp">
                <div class="card-body">
                    <div class="progress-elp">
                        <div class="progress-bar" role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                    <div class="text-center">
                        <small class="text-muted" id="progressText">Preencha os campos obrigatórios para continuar</small>
                    </div>
                </div>
            </div>
            
            <form method="POST" enctype="multipart/form-data" id="expressForm">
                {{ form.hidden_tag() }}
                
                <!-- Dados da Empresa -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-building section-icon"></i>
                            Dados da Empresa
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">
                                    {{ form.empresa_nome.label.text }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-building"></i>
                                    </span>
                                    {{ form.empresa_nome(class="form-control", required=true, placeholder="Digite o nome da empresa") }}
                                </div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">{{ form.empresa_endereco.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </span>
                                    {{ form.empresa_endereco(class="form-control", rows="2", placeholder="Endereço completo da empresa") }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">{{ form.empresa_telefone.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-phone"></i>
                                    </span>
                                    {{ form.empresa_telefone(class="form-control", placeholder="(00) 00000-0000") }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">{{ form.empresa_email.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                    {{ form.empresa_email(class="form-control", type="email", placeholder="contato@empresa.com") }}
                                </div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">{{ form.empresa_responsavel.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-user"></i>
                                    </span>
                                    {{ form.empresa_responsavel(class="form-control", placeholder="Nome do responsável") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dados da Visita -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-calendar section-icon"></i>
                            Dados da Visita
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    {{ form.data_visita.label.text }}
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                    {{ form.data_visita(class="form-control", required=true) }}
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">{{ form.periodo_inicio.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    {{ form.periodo_inicio(class="form-control") }}
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">{{ form.periodo_fim.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-clock"></i>
                                    </span>
                                    {{ form.periodo_fim(class="form-control") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Condições Climáticas -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-cloud-sun section-icon"></i>
                            Condições Climáticas
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">{{ form.condicoes_climaticas.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-cloud-sun"></i>
                                    </span>
                                    {{ form.condicoes_climaticas(class="form-select") }}
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">{{ form.temperatura.label.text }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-thermometer-half"></i>
                                    </span>
                                    {{ form.temperatura(class="form-control", placeholder="Ex: 25°C") }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Localização -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-map-marker-alt section-icon"></i>
                            Localização da Visita
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.endereco_visita.label.text }}</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-map-marker-alt"></i>
                                </span>
                                {{ form.endereco_visita(class="form-control", rows="2", placeholder="Endereço onde foi realizada a visita") }}
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <button type="button" id="getLocationBtn" class="btn btn-elp-outline">
                                <i class="fas fa-crosshairs me-2"></i>
                                Obter Localização GPS
                            </button>
                        </div>
                        
                        <div id="locationPreview" class="alert alert-success d-none">
                            <strong><i class="fas fa-check-circle me-2"></i>Localização obtida!</strong>
                            <div id="locationText"></div>
                        </div>
                        
                        {{ form.latitude }}
                        {{ form.longitude }}
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-clipboard-list section-icon"></i>
                            Observações e Relatório
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.observacoes_gerais.label.text }}</label>
                            {{ form.observacoes_gerais(class="form-control", rows="4", placeholder="Observações gerais sobre a visita") }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.pendencias.label.text }}</label>
                            {{ form.pendencias(class="form-control", rows="3", placeholder="Pendências identificadas") }}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.recomendacoes.label.text }}</label>
                            {{ form.recomendacoes(class="form-control", rows="3", placeholder="Recomendações técnicas") }}
                        </div>
                    </div>
                </div>
                
                <!-- Fotos -->
                <div class="card-elp">
                    <div class="card-header-elp">
                        <h5>
                            <i class="fas fa-camera section-icon"></i>
                            Anexar Fotos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">{{ form.fotos.label.text }}</label>
                            {{ form.fotos(class="form-control") }}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Formatos aceitos: JPG, PNG. Múltiplas fotos permitidas.
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Campos ocultos -->
                {{ form.checklist_completo }}
                
                <!-- Botões de Ação -->
                <div class="card-elp">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <button type="submit" name="action" value="finalize" class="btn btn-elp-primary w-100" id="finalizeBtn">
                                    <i class="fas fa-check me-2"></i>
                                    Finalizar Relatório
                                </button>
                            </div>
                            <div class="col-12 col-md-4">
                                <button type="submit" name="action" value="save_draft" class="btn btn-elp-secondary w-100">
                                    <i class="fas fa-save me-2"></i>
                                    Salvar Rascunho
                                </button>
                            </div>
                            <div class="col-12 col-md-4">
                                <a href="{{ url_for('express_list') }}" class="btn btn-elp-outline w-100">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    Cancelar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                
            </form>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Sistema ELP Express Report iniciado');
    
    // Elementos principais
    const form = document.getElementById('expressForm');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const locationPreview = document.getElementById('locationPreview');
    const locationText = document.getElementById('locationText');
    const finalizeBtn = document.getElementById('finalizeBtn');
    
    // Configurar data/hora atual
    const hoje = new Date().toISOString().split('T')[0];
    const agora = new Date().toTimeString().split(' ')[0].substring(0, 5);
    
    const dataInput = document.querySelector('input[name="data_visita"]');
    const horaInput = document.querySelector('input[name="periodo_inicio"]');
    
    if (dataInput && !dataInput.value) dataInput.value = hoje;
    if (horaInput && !horaInput.value) horaInput.value = agora;
    
    // Função para atualizar progresso
    function updateProgress() {
        const requiredFields = form.querySelectorAll('[required]');
        let filledCount = 0;
        
        requiredFields.forEach(field => {
            if (field.value && field.value.trim()) {
                filledCount++;
            }
        });
        
        const progress = Math.round((filledCount / requiredFields.length) * 100);
        
        if (progressBar) {
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        }
        
        if (progressText) {
            if (progress === 0) {
                progressText.textContent = 'Comece preenchendo os campos obrigatórios';
            } else if (progress < 50) {
                progressText.textContent = `${progress}% completo - Continue preenchendo`;
            } else if (progress < 100) {
                progressText.textContent = `${progress}% completo - Quase pronto!`;
            } else {
                progressText.textContent = '✅ Todos os campos obrigatórios preenchidos';
            }
        }
        
        // Habilitar/desabilitar botão finalizar
        if (finalizeBtn) {
            finalizeBtn.disabled = progress < 100;
            if (progress === 100) {
                finalizeBtn.classList.remove('opacity-50');
            } else {
                finalizeBtn.classList.add('opacity-50');
            }
        }
    }
    
    // Monitorar campos obrigatórios
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('input', updateProgress);
        field.addEventListener('change', updateProgress);
    });
    
    // Geolocalização GPS
    if (getLocationBtn) {
        getLocationBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocalização não é suportada pelo seu navegador.');
                return;
            }
            
            const originalHTML = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Obtendo localização...';
            this.disabled = true;
            this.classList.add('loading');
            
            console.log('📍 Obtendo coordenadas GPS...');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    
                    // Preencher campos ocultos
                    const latInput = document.querySelector('input[name="latitude"]');
                    const lonInput = document.querySelector('input[name="longitude"]');
                    
                    if (latInput) latInput.value = lat.toFixed(6);
                    if (lonInput) lonInput.value = lon.toFixed(6);
                    
                    // Mostrar localização obtida
                    if (locationText && locationPreview) {
                        locationText.innerHTML = `
                            <small class="d-block">Latitude: ${lat.toFixed(6)}</small>
                            <small class="d-block">Longitude: ${lon.toFixed(6)}</small>
                            <small class="text-muted">Precisão: ${accuracy}m</small>
                        `;
                        locationPreview.classList.remove('d-none');
                    }
                    
                    // Atualizar botão
                    getLocationBtn.innerHTML = '<i class="fas fa-check me-2"></i>Localização Obtida';
                    getLocationBtn.disabled = false;
                    getLocationBtn.classList.remove('loading', 'btn-elp-outline');
                    getLocationBtn.classList.add('btn-success');
                    
                    console.log('✅ Localização obtida com sucesso');
                },
                function(error) {
                    console.error('❌ Erro ao obter localização:', error);
                    
                    let errorMessage = 'Erro ao obter localização.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Permissão negada. Permita o acesso à localização.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Localização indisponível no momento.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Tempo limite atingido para obter localização.';
                            break;
                    }
                    
                    alert(errorMessage);
                    
                    // Restaurar botão
                    getLocationBtn.innerHTML = originalHTML;
                    getLocationBtn.disabled = false;
                    getLocationBtn.classList.remove('loading');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 600000
                }
            );
        });
    }
    
    // Submissão do formulário
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitBtn = e.submitter;
            
            if (submitBtn && submitBtn.classList.contains('btn')) {
                const originalHTML = submitBtn.innerHTML;
                
                if (submitBtn.name === 'action' && submitBtn.value === 'finalize') {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Finalizando...';
                    submitBtn.classList.add('loading');
                    console.log('📝 Finalizando relatório express...');
                } else if (submitBtn.name === 'action' && submitBtn.value === 'save_draft') {
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
                    submitBtn.classList.add('loading');
                    console.log('💾 Salvando rascunho...');
                }
                
                // Restaurar após timeout
                setTimeout(() => {
                    if (submitBtn.classList.contains('loading')) {
                        submitBtn.innerHTML = originalHTML;
                        submitBtn.classList.remove('loading');
                    }
                }, 30000);
            }
        });
    }
    
    // Progresso inicial
    setTimeout(updateProgress, 500);
    
    console.log('✅ Sistema ELP inicializado com sucesso');
});
</script>
{% endblock %}