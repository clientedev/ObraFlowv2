<!-- Sistema de Notifica√ß√µes (Discreto) -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="alert alert-light border" style="padding: 0.75rem 1rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span id="notification-badge" class="badge bg-secondary me-2">
                        <i class="fas fa-spinner fa-spin me-1"></i>
                        Verificando...
                    </span>
                    <small class="text-muted">
                        <i class="fas fa-bell me-1"></i>
                        Notifica√ß√µes de proximidade e novidades
                    </small>
                </div>
                <button class="btn btn-outline-primary btn-sm" id="notification-toggle" onclick="toggleNotifications()">
                    <i class="fas fa-bell me-1"></i>
                    <span id="toggle-text">Ativar</span>
                </button>
            </div>
                
            <!-- Status Expandido (Opcional) -->
            <div class="mt-2" id="notification-details" style="display: none;">
                <small class="text-muted d-block mb-2">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    <span id="location-text">Detectando localiza√ß√£o...</span>
                </small>
                <div id="nearby-list" class="small">
                    <!-- Lista de obras pr√≥ximas -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Controle de Notifica√ß√µes no Dashboard
function updateNotificationStatus() {
    const badge = document.getElementById('notification-badge');
    const toggleBtn = document.getElementById('notification-toggle');
    const toggleText = document.getElementById('toggle-text');
    
    // Verificar se notifica√ß√µes s√£o suportadas
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        badge.innerHTML = '<i class="fas fa-info-circle me-1"></i>N√£o Dispon√≠vel';
        badge.className = 'badge bg-secondary me-2';
        toggleBtn.style.display = 'none';
        return;
    }
    
    // Carregar notifica√ß√µes do sistema (drawer) se dispon√≠vel - funciona independentemente
    if (window.notificationsManager && typeof window.notificationsManager.carregarNotificacoes === 'function') {
        window.notificationsManager.carregarNotificacoes(true);
    }
    
    // Verificar permiss√£o de push notifications (proximidade) - com guard defensivo
    if (!window.notificationManager) {
        // Push manager ainda n√£o carregou, mas permitir que drawer funcione
        badge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Carregando...';
        badge.className = 'badge bg-info me-2';
        toggleBtn.disabled = true;
        
        // Tentar novamente apenas algumas vezes para evitar loop infinito
        if (!updateNotificationStatus.retryCount) {
            updateNotificationStatus.retryCount = 0;
        }
        if (updateNotificationStatus.retryCount < 10) {
            updateNotificationStatus.retryCount++;
            setTimeout(updateNotificationStatus, 500);
        } else {
            // Ap√≥s 10 tentativas, mostrar como indispon√≠vel e logar erro
            console.warn('‚ö†Ô∏è DASHBOARD: Push notification manager n√£o inicializou ap√≥s 10 tentativas');
            console.debug('DASHBOARD: NotificationsManager (drawer) continua funcional');
            badge.innerHTML = '<i class="fas fa-info-circle me-1"></i>Push Indispon√≠vel';
            badge.className = 'badge bg-secondary me-2';
            toggleBtn.style.display = 'none';
        }
        return;
    }
    
    // Reset contador de tentativas quando manager est√° dispon√≠vel
    updateNotificationStatus.retryCount = 0;
    
    // Usar guard defensivo para acessar permission - verificar exist√™ncia antes de usar
    if (!window.notificationManager || typeof window.notificationManager.permission === 'undefined') {
        console.warn('‚ö†Ô∏è DASHBOARD: NotificationManager existe mas permission n√£o est√° dispon√≠vel');
        badge.innerHTML = '<i class="fas fa-info-circle me-1"></i>Configurando...';
        badge.className = 'badge bg-secondary me-2';
        toggleBtn.disabled = true;
        return;
    }
    
    const permission = window.notificationManager.permission;
    
    // Limpar estilos inline antes de aplicar novo estado
    badge.style.backgroundColor = '';
    badge.style.color = '';
    
    // Habilitar bot√£o agora que o manager est√° dispon√≠vel
    toggleBtn.disabled = false;
    
    if (permission === 'granted') {
        badge.innerHTML = '<i class="fas fa-check me-1"></i>Ativo';
        badge.className = 'badge bg-success me-2';
        toggleText.textContent = 'Desativar';
        toggleBtn.className = 'btn btn-outline-warning btn-sm';
        
        // Mostrar status de localiza√ß√£o
        showLocationStatus();
        
    } else if (permission === 'denied') {
        badge.innerHTML = '<i class="fas fa-ban me-1"></i>Bloqueado';
        badge.className = 'badge me-2';
        badge.style.backgroundColor = '#f8d7da';
        badge.style.color = '#721c24';
        toggleText.textContent = 'Reativar';
        toggleBtn.className = 'btn btn-reativar btn-sm';
        
    } else {
        badge.innerHTML = '<i class="fas fa-bell-slash me-1"></i>Inativo';
        badge.className = 'badge bg-warning me-2';
        toggleText.textContent = 'Ativar';
        toggleBtn.className = 'btn btn-outline-primary btn-sm';
    }
}

function showLocationStatus() {
    const details = document.getElementById('notification-details');
    const locationText = document.getElementById('location-text');
    
    if (navigator.geolocation) {
        details.style.display = 'block';
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const precision = Math.round(position.coords.accuracy);
                locationText.textContent = `Localiza√ß√£o ativa (precis√£o: ${precision}m)`;
                
                // Buscar obras pr√≥ximas
                loadNearbyProjects(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
                locationText.textContent = `Erro de localiza√ß√£o: ${error.message}`;
            }
        );
    }
}

async function loadNearbyProjects(lat, lon) {
    try {
        const response = await fetch(`/api/nearby-projects?lat=${lat}&lon=${lon}&radius=1`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayNearbyProjects(data.projects || []);
        }
    } catch (error) {
        console.error('Erro ao buscar obras pr√≥ximas:', error);
    }
}

function displayNearbyProjects(projects) {
    const nearbyList = document.getElementById('nearby-list');
    
    if (projects.length === 0) {
        nearbyList.innerHTML = '<span class="text-muted">Nenhuma obra num raio de 1km</span>';
    } else {
        const nearProjects = projects.filter(p => p.distance < 500);
        if (nearProjects.length > 0) {
            nearbyList.innerHTML = `<span class="text-success">
                <i class="fas fa-map-marker-alt me-1"></i>
                ${nearProjects.length} obra(s) pr√≥xima(s)
            </span>`;
        } else {
            nearbyList.innerHTML = `<span class="text-info">
                ${projects.length} obra(s) na regi√£o
            </span>`;
        }
    }
}

async function toggleNotifications() {
    // Verificar se notifica√ß√µes s√£o suportadas
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        alert('Notifica√ß√µes n√£o s√£o suportadas neste navegador');
        return;
    }
    
    // Guard defensivo: verificar se manager existe e tem o m√©todo requestPermission
    if (!window.notificationManager) {
        console.warn('‚ö†Ô∏è TOGGLE: NotificationManager n√£o est√° dispon√≠vel');
        alert('Sistema de notifica√ß√µes ainda est√° carregando. Tente novamente em instantes.');
        return;
    }
    
    if (typeof window.notificationManager.requestPermission !== 'function') {
        console.error('‚ùå TOGGLE: NotificationManager.requestPermission n√£o √© uma fun√ß√£o');
        alert('Sistema de notifica√ß√µes n√£o est√° completamente inicializado. Recarregue a p√°gina.');
        return;
    }
    
    try {
        console.log('üîî TOGGLE: Solicitando permiss√£o de notifica√ß√µes push...');
        const result = await window.notificationManager.requestPermission();
        console.log('‚úÖ TOGGLE: Permiss√£o solicitada, resultado:', result);
        
        updateNotificationStatus();
        
        if (result) {
            // Mostrar notifica√ß√£o de teste
            setTimeout(() => {
                new Notification('ELP Relat√≥rios', {
                    body: 'Notifica√ß√µes ativadas com sucesso!',
                    icon: '/static/icons/icon-192x192.png'
                });
            }, 1000);
        }
    } catch (error) {
        console.error('‚ùå TOGGLE: Erro ao ativar notifica√ß√µes:', error);
        alert('Erro ao ativar notifica√ß√µes. Verifique as configura√ß√µes do navegador.');
    }
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar carregamento do notification manager
    updateNotificationStatus();
    setTimeout(updateNotificationStatus, 500);
    setTimeout(updateNotificationStatus, 2000);
    
    // Atualizar status periodicamente (a cada 30 segundos)
    setInterval(() => {
        updateNotificationStatus();
        // Atualizar notifica√ß√µes do sistema (drawer) se dispon√≠vel
        if (window.notificationsManager && typeof window.notificationsManager.carregarNotificacoes === 'function') {
            window.notificationsManager.carregarNotificacoes(true); // silent mode
        }
    }, 30000);
});
</script>

<style>
/* Bot√£o Reativar - Verde destacado */
.btn-reativar {
    background-color: #28a745 !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    font-weight: 500 !important;
    padding: 8px 14px !important;
    transition: all 0.2s ease;
}

.btn-reativar:hover {
    background-color: #218838 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.btn-reativar:active {
    transform: translateY(0);
}

/* Alerta bloqueado com tom mais suave */
.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert-danger i {
    vertical-align: middle;
}
</style>