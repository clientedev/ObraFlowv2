<!-- Sistema de Notificações (Discreto) -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="alert alert-light border" style="padding: 0.75rem 1rem;">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <span id="notification-badge" class="badge bg-secondary me-2">
                        <i class="fas fa-spinner fa-spin me-1"></i>
                        Verificando...
                    </span>
                    <small class="text-muted">
                        <i class="fas fa-bell me-1"></i>
                        Notificações de proximidade e novidades
                    </small>
                </div>
                <button class="btn btn-outline-primary btn-sm" id="notification-toggle" onclick="toggleNotifications()">
                    <i class="fas fa-bell me-1"></i>
                    <span id="toggle-text">Ativar</span>
                </button>
            </div>
                
            <!-- Status Expandido (Opcional) -->
            <div class="mt-2" id="notification-details" style="display: none;">
                <small class="text-muted d-block mb-2">
                    <i class="fas fa-map-marker-alt me-1"></i>
                    <span id="location-text">Detectando localização...</span>
                </small>
                <div id="nearby-list" class="small">
                    <!-- Lista de obras próximas -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Controle de Notificações no Dashboard
function updateNotificationStatus() {
    const badge = document.getElementById('notification-badge');
    const toggleBtn = document.getElementById('notification-toggle');
    const toggleText = document.getElementById('toggle-text');
    
    // Verificar se notificações são suportadas
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        badge.innerHTML = '<i class="fas fa-info-circle me-1"></i>Não Disponível';
        badge.className = 'badge bg-secondary me-2';
        toggleBtn.style.display = 'none';
        return;
    }
    
    // Se ainda não há notification manager, aguardar
    if (!window.notificationManager) {
        badge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Carregando...';
        badge.className = 'badge bg-info me-2';
        toggleBtn.disabled = true;
        return;
    }
    
    const permission = window.notificationManager.permission;
    
    if (permission === 'granted') {
        badge.innerHTML = '<i class="fas fa-check me-1"></i>Ativo';
        badge.className = 'badge bg-success me-2';
        toggleText.textContent = 'Desativar';
        toggleBtn.className = 'btn btn-outline-warning btn-sm';
        
        // Mostrar status de localização
        showLocationStatus();
        
    } else if (permission === 'denied') {
        badge.innerHTML = '<i class="fas fa-ban me-1"></i>Bloqueado';
        badge.className = 'badge me-2';
        badge.style.backgroundColor = '#f8d7da';
        badge.style.color = '#721c24';
        toggleText.textContent = 'Reativar';
        toggleBtn.className = 'btn btn-reativar btn-sm';
        
    } else {
        badge.innerHTML = '<i class="fas fa-bell-slash me-1"></i>Inativo';
        badge.className = 'badge bg-warning me-2';
        toggleText.textContent = 'Ativar';
        toggleBtn.className = 'btn btn-outline-primary btn-sm';
    }
}

function showLocationStatus() {
    const details = document.getElementById('notification-details');
    const locationText = document.getElementById('location-text');
    
    if (navigator.geolocation) {
        details.style.display = 'block';
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const precision = Math.round(position.coords.accuracy);
                locationText.textContent = `Localização ativa (precisão: ${precision}m)`;
                
                // Buscar obras próximas
                loadNearbyProjects(position.coords.latitude, position.coords.longitude);
            },
            (error) => {
                locationText.textContent = `Erro de localização: ${error.message}`;
            }
        );
    }
}

async function loadNearbyProjects(lat, lon) {
    try {
        const response = await fetch(`/api/nearby-projects?lat=${lat}&lon=${lon}&radius=1`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayNearbyProjects(data.projects || []);
        }
    } catch (error) {
        console.error('Erro ao buscar obras próximas:', error);
    }
}

function displayNearbyProjects(projects) {
    const nearbyList = document.getElementById('nearby-list');
    
    if (projects.length === 0) {
        nearbyList.innerHTML = '<span class="text-muted">Nenhuma obra num raio de 1km</span>';
    } else {
        const nearProjects = projects.filter(p => p.distance < 500);
        if (nearProjects.length > 0) {
            nearbyList.innerHTML = `<span class="text-success">
                <i class="fas fa-map-marker-alt me-1"></i>
                ${nearProjects.length} obra(s) próxima(s)
            </span>`;
        } else {
            nearbyList.innerHTML = `<span class="text-info">
                ${projects.length} obra(s) na região
            </span>`;
        }
    }
}

async function toggleNotifications() {
    // Verificar se notificações são suportadas
    if (!('Notification' in window) || !('serviceWorker' in navigator)) {
        alert('Notificações não são suportadas neste navegador');
        return;
    }
    
    if (!window.notificationManager) {
        alert('Sistema de notificações ainda está carregando. Tente novamente em instantes.');
        return;
    }
    
    try {
        const result = await window.notificationManager.requestPermission();
        updateNotificationStatus();
        
        if (result) {
            // Mostrar notificação de teste
            setTimeout(() => {
                new Notification('ELP Relatórios', {
                    body: 'Notificações ativadas com sucesso!',
                    icon: '/static/icons/icon-192x192.png'
                });
            }, 1000);
        }
    } catch (error) {
        console.error('Erro ao ativar notificações:', error);
        alert('Erro ao ativar notificações. Verifique as configurações do navegador.');
    }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
    // Aguardar carregamento do notification manager
    updateNotificationStatus();
    setTimeout(updateNotificationStatus, 500);
    setTimeout(updateNotificationStatus, 2000);
    
    // Atualizar status periodicamente (menos frequente)
    setInterval(updateNotificationStatus, 10000);
});
</script>

<style>
/* Botão Reativar - Verde destacado */
.btn-reativar {
    background-color: #28a745 !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    font-weight: 500 !important;
    padding: 8px 14px !important;
    transition: all 0.2s ease;
}

.btn-reativar:hover {
    background-color: #218838 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.btn-reativar:active {
    transform: translateY(0);
}

/* Alerta bloqueado com tom mais suave */
.alert-danger {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

.alert-danger i {
    vertical-align: middle;
}
</style>