{% extends "base.html" %}

{% block title %}Enviar Relatório por E-mail{% endblock %}

{% block extra_css %}
<style>
.email-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}
.destinatario-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}
.destinatario-item:hover {
    background-color: #f8f9fa;
}
.destinatario-item input[type="checkbox"] {
    margin-right: 10px;
}
.preview-section {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}
.email-template {
    background: white;
    border: 1px solid #ddd;
    padding: 20px;
    border-radius: 8px;
    font-family: Arial, sans-serif;
}
@media (max-width: 768px) {
    .email-header {
        padding: 1.5rem;
        text-align: center;
    }
    .btn-group-mobile {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .btn-group-mobile .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Header da página -->
<div class="email-header">
    <div class="d-flex align-items-center justify-content-between">
        <div>
            <h2><i class="fas fa-paper-plane me-2"></i>Enviar Relatório por E-mail</h2>
            <p class="mb-0">Projeto: <strong>{{ relatorio.projeto.nome }}</strong></p>
            <p class="mb-0">Relatório: <strong>{{ relatorio.numero }}</strong> - {{ relatorio.data_visita.strftime('%d/%m/%Y') if relatorio.data_visita }}</p>
        </div>
        <div>
            <a href="{{ url_for('report_detail', report_id=relatorio.id) }}" class="btn btn-light">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>
</div>

<form method="POST" id="emailForm">
    {{ form.hidden_tag() }}
    
    <div class="row">
        <div class="col-lg-8">
            <!-- Seleção de Destinatários -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-users me-2"></i>Destinatários</h5>
                    <small class="text-muted">Selecione os clientes que receberão o relatório</small>
                </div>
                <div class="card-body">
                    {% if form.destinatarios.choices %}
                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAll(true)">
                                <i class="fas fa-check-square me-1"></i>Selecionar Todos
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAll(false)">
                                <i class="fas fa-square me-1"></i>Desmarcar Todos
                            </button>
                        </div>
                        
                        {% for subfield in form.destinatarios %}
                            <div class="destinatario-item">
                                {{ subfield() }}
                                {{ subfield.label() }}
                            </div>
                        {% endfor %}
                        
                        {% if form.destinatarios.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.destinatarios.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Nenhum e-mail cadastrado para este projeto. 
                            <a href="{{ url_for('admin_emails') }}">Cadastrar e-mails</a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- E-mails CC e BCC -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-envelope-open me-2"></i>E-mails Adicionais</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.cc_emails.label(class="form-label") }}
                            {{ form.cc_emails(class="form-control", rows="3", placeholder="email1@exemplo.com\nemail2@exemplo.com") }}
                            <small class="form-text text-muted">{{ form.cc_emails.description }}</small>
                        </div>
                        <div class="col-md-6">
                            {{ form.bcc_emails.label(class="form-label") }}
                            {{ form.bcc_emails(class="form-control", rows="3", placeholder="supervisor@empresa.com") }}
                            <small class="form-text text-muted">{{ form.bcc_emails.description }}</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personalização do E-mail -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-edit me-2"></i>Personalizar Mensagem</h5>
                    <small class="text-muted">Deixe em branco para usar o template padrão</small>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {{ form.assunto_personalizado.label(class="form-label") }}
                        {{ form.assunto_personalizado(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.corpo_personalizado.label(class="form-label") }}
                        {{ form.corpo_personalizado(class="form-control", rows="6") }}
                        <small class="form-text text-muted">{{ form.corpo_personalizado.description }}</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Configuração Ativa -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h6><i class="fas fa-cog me-2"></i>Configuração de E-mail</h6>
                </div>
                <div class="card-body">
                    <strong>Nome:</strong> {{ config_ativa.nome_configuracao }}<br>
                    <strong>Servidor:</strong> {{ config_ativa.servidor_smtp }}<br>
                    <strong>Remetente:</strong> {{ config_ativa.nome_remetente }}<br>
                    <small class="text-muted">{{ config_ativa.email_remetente }}</small>
                </div>
            </div>

            <!-- Preview do E-mail -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6><i class="fas fa-eye me-2"></i>Pré-visualização</h6>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-outline-info btn-sm w-100" onclick="loadPreview()">
                        <i class="fas fa-refresh me-2"></i>Visualizar E-mail
                    </button>
                    <div id="preview-content" class="mt-3" style="display: none;">
                        <!-- Preview será carregado via JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Ações -->
            <div class="card">
                <div class="card-body">
                    <div class="btn-group-mobile">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>Enviar E-mails
                        </button>
                        <a href="{{ url_for('report_detail', report_id=relatorio.id) }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
function selectAll(checked) {
    const checkboxes = document.querySelectorAll('input[name="destinatarios"]');
    checkboxes.forEach(cb => cb.checked = checked);
}

function loadPreview() {
    const previewBtn = document.querySelector('button[onclick="loadPreview()"]');
    const previewContent = document.getElementById('preview-content');
    
    previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Carregando...';
    previewBtn.disabled = true;
    
    fetch(`/relatorio/{{ relatorio.id }}/preview-email`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            previewContent.innerHTML = `
                <div class="email-template">
                    <strong>Assunto:</strong> ${data.assunto}<br><br>
                    <div class="border-top pt-3">
                        ${data.corpo_html}
                    </div>
                    <div class="border-top mt-3 pt-2">
                        <small class="text-muted">
                            <i class="fas fa-paperclip me-1"></i>
                            Anexo: Relatório em PDF
                        </small>
                    </div>
                </div>
            `;
            previewContent.style.display = 'block';
        })
        .catch(error => {
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar preview: ${error.message}
                </div>
            `;
            previewContent.style.display = 'block';
        })
        .finally(() => {
            previewBtn.innerHTML = '<i class="fas fa-refresh me-2"></i>Atualizar Preview';
            previewBtn.disabled = false;
        });
}

// Validação do formulário
document.getElementById('emailForm').addEventListener('submit', function(e) {
    const destinatarios = document.querySelectorAll('input[name="destinatarios"]:checked');
    
    if (destinatarios.length === 0) {
        e.preventDefault();
        alert('Selecione pelo menos um destinatário.');
        return false;
    }
    
    // Confirmação antes de enviar
    const count = destinatarios.length;
    const confirmed = confirm(`Enviar relatório para ${count} destinatário${count > 1 ? 's' : ''}?`);
    
    if (!confirmed) {
        e.preventDefault();
        return false;
    }
});

// Carregar preview automaticamente ao abrir a página
document.addEventListener('DOMContentLoaded', function() {
    loadPreview();
});
</script>
{% endblock %}