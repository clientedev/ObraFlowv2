{% extends "base.html" %}

{% block title %}Visitas - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h1 class="mb-0">
                <i class="fas fa-calendar-check me-2"></i>
                Visitas
            </h1>
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
                <a href="{{ url_for('visits_calendar') }}" class="btn btn-outline-info">
                    <i class="fas fa-calendar-alt me-2"></i>Calendário
                </a>
                <a href="{{ url_for('visit_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Agendar Visita
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Melhorados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-3">
                <!-- Busca Simples -->
                <div class="card-body border-bottom">
                    <form method="GET" action="{{ url_for('visits_list') }}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">🔍 Busca Rápida</label>
                                <input type="text" class="form-control" name="q" value="{{ request.args.get('q', '') }}"
                                       placeholder="Digite projeto, objetivo ou responsável..." style="min-height: 44px; font-size: 16px;">
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" style="min-height: 44px;">
                                        <i class="fas fa-search me-1"></i>Buscar
                                    </button>
                                    {% if request.args.get('q') %}
                                    <a href="{{ url_for('visits_list') }}" class="btn btn-outline-secondary" style="min-height: 44px;">
                                        <i class="fas fa-times me-1"></i>Limpar
                                    </a>
                                    {% endif %}
                                    <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#filtrosAvancadosVisit" style="min-height: 44px;">
                                        <i class="fas fa-filter me-1"></i>Filtros Avançados
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Filtros Avançados (Colapsáveis) -->
                <div class="collapse" id="filtrosAvancadosVisit">
                    <div class="card-body border-bottom">
                        <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Filtros Avançados</h6>

                        <!-- Filtros Desktop -->
                        <div class="row g-3 d-none d-md-flex">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Status:</label>
                                <select class="form-select form-select-sm" id="filterStatusVisit" style="min-height: 38px;">
                                    <option value="">Todos os Status</option>
                                    <option value="Agendada">Agendadas</option>
                                    <option value="Realizada">Realizadas</option>
                                    <option value="Cancelada">Canceladas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Projeto:</label>
                                <select class="form-select form-select-sm" id="filterProjetoVisit" style="min-height: 38px;">
                                    <option value="">Todos os Projetos</option>
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold">Responsável:</label>
                                <select class="form-select form-select-sm" id="filterResponsavelVisit" style="min-height: 38px;">
                                    <option value="">Todos Responsáveis</option>
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>

                        <!-- Filtros Mobile -->
                        <div class="d-md-none mb-3">
                            <label class="form-label small fw-bold d-block mb-2">Filtrar por Status:</label>
                            <div class="d-flex gap-2 overflow-x-auto pb-2" style="scrollbar-width: thin;">
                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAllMobile" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary flex-shrink-0" for="filterAllMobile" style="min-height: 44px; min-width: 80px;">Todas</label>

                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAgendadaMobile" autocomplete="off">
                                <label class="btn btn-outline-warning flex-shrink-0" for="filterAgendadaMobile" style="min-height: 44px; min-width: 100px;">Agendadas</label>

                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterRealizadaMobile" autocomplete="off">
                                <label class="btn btn-outline-success flex-shrink-0" for="filterRealizadaMobile" style="min-height: 44px; min-width: 100px;">Realizadas</label>

                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterCanceladaMobile" autocomplete="off">
                                <label class="btn btn-outline-danger flex-shrink-0" for="filterCanceladaMobile" style="min-height: 44px; min-width: 110px;">Canceladas</label>
                            </div>
                        </div>

                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                                    <button type="button" class="btn btn-outline-secondary" onclick="clearVisitFilters()" style="min-height: 44px;">
                                        <i class="fas fa-times"></i> Limpar Filtros
                                    </button>
                                    <small class="text-muted">
                                        <span id="visitFilteredCount">{{ visits|length if visits else 0 }}</span> visita(s) encontrada(s)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if visits %}
                    <!-- Layout de cards mobile-first sem rolagem horizontal -->
                    <div class="mobile-visits-list" id="visitsTable">
                        {% for visit in visits %}
                        <div class="visit-card mb-2"
                             data-status="{{ visit.status }}"
                             data-projeto="{{ visit.projeto.numero }} {{ visit.projeto.nome }}"
                             data-responsavel="{{ visit.responsavel.nome_completo }}"
                             data-search="{{ (visit.projeto.numero + ' ' + visit.projeto.nome + ' ' + (visit.objetivo or ''))|lower }}">

                            <div class="card border-0 shadow-sm h-100" style="background: #f8f9fa;">
                                <div class="card-body p-3">
                                    <div class="row align-items-center">
                                        <!-- Coluna principal com informações -->
                                        <div class="col-8">
                                            <!-- Projeto -->
                                            <div class="fw-bold text-primary mb-1" style="font-size: 0.9rem;">
                                                <i class="fas fa-calendar-check me-1"></i>{{ visit.projeto.numero }}
                                            </div>

                                            <!-- Nome do projeto -->
                                            <div class="fw-semibold text-dark mb-1" style="font-size: 0.95rem; line-height: 1.2;">
                                                {{ visit.projeto.nome }}
                                            </div>

                                            <!-- Datas -->
                                            <div class="text-muted mb-1" style="font-size: 0.8rem;">
                                                <i class="fas fa-clock me-1"></i>Agendada: {{ visit.data_agendada.strftime('%d/%m/%Y às %H:%M') }}
                                            </div>

                                            {% if visit.data_realizada %}
                                            <div class="text-success mb-1" style="font-size: 0.8rem;">
                                                <i class="fas fa-check me-1"></i>Realizada: {{ visit.data_realizada.strftime('%d/%m/%Y às %H:%M') }}
                                            </div>
                                            {% endif %}

                                            <!-- Objetivo (truncado) -->
                                            {% if visit.objetivo %}
                                            <div class="text-muted" style="font-size: 0.75rem;">
                                                <i class="fas fa-target me-1"></i>{{ visit.objetivo[:50] }}{{ '...' if visit.objetivo|length > 50 else '' }}
                                            </div>
                                            {% endif %}

                                            <!-- Responsável -->
                                            <div class="text-muted" style="font-size: 0.75rem;">
                                                <i class="fas fa-user me-1"></i>{{ visit.responsavel.nome_completo }}
                                            </div>
                                        </div>

                                        <!-- Coluna lateral com status e ações -->
                                        <div class="col-4 text-end">
                                            <!-- Status -->
                                            <div class="mb-2">
                                                {% if visit.status == 'Realizada' %}
                                                    <span class="badge bg-success" style="font-size: 0.7rem;">{{ visit.status }}</span>
                                                {% elif visit.status == 'Agendada' %}
                                                    <span class="badge bg-warning" style="font-size: 0.7rem;">{{ visit.status }}</span>
                                                {% elif visit.status == 'Cancelada' %}
                                                    <span class="badge bg-danger" style="font-size: 0.7rem;">{{ visit.status }}</span>
                                                {% else %}
                                                    <span class="badge bg-secondary" style="font-size: 0.7rem;">{{ visit.status }}</span>
                                                {% endif %}
                                            </div>

                                            <!-- Localização -->
                                            {% if visit.latitude and visit.longitude %}
                                            <div class="mb-2">
                                                <a href="https://www.google.com/maps?q={{ visit.latitude }},{{ visit.longitude }}" target="_blank"
                                                   class="btn btn-sm btn-outline-info" title="Ver no mapa">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </a>
                                            </div>
                                            {% endif %}

                                            <!-- Ações -->
                                            <div class="d-flex flex-column gap-1">
                                                <!-- Botão Realizar (apenas agendadas) -->
                                                {% if visit.status == 'Agendada' %}
                                                <a href="{{ url_for('visit_realize', visit_id=visit.id) }}"
                                                   class="btn btn-sm btn-success"
                                                   title="Realizar Visita">
                                                    <i class="fas fa-check me-1"></i>Realizar
                                                </a>
                                                {% endif %}

                                                <!-- Botão Comunicação -->
                                                <a href="{{ url_for('visit_communication', visit_id=visit.id) }}"
                                                   class="btn btn-sm btn-primary"
                                                   title="Comunicação">
                                                    <i class="fas fa-comments me-1"></i>Chat
                                                </a>

                                                <div class="d-flex gap-1">
                                                    <!-- Botão Checklist -->
                                                    <a href="{{ url_for('visit_checklist', visit_id=visit.id) }}"
                                                       class="btn btn-sm btn-outline-info flex-fill"
                                                       title="Ver Checklist">
                                                        <i class="fas fa-list-check"></i>
                                                    </a>

                                                    <!-- Botão Projeto -->
                                                    <a href="{{ url_for('project_view', project_id=visit.projeto.id) }}"
                                                       class="btn btn-sm btn-outline-secondary flex-fill"
                                                       title="Ver Projeto">
                                                        <i class="fas fa-building"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma visita agendada</h5>
                        <p class="text-muted">Comece agendando a primeira visita.</p>
                        <a href="{{ url_for('visit_new') }}" class="btn btn-primary" style="min-height: 44px;">
                            <i class="fas fa-plus me-2"></i>Agendar Primeira Visita
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('visitsTable');
    if (!table) return;

    const rows = table.querySelectorAll('tbody tr');

    const visitCards = table.querySelectorAll('.visit-card');
    console.log('Visitas: encontrados', visitCards.length, 'cards');

    // Preencher filtros dinamicamente
    fillVisitFilterOptions();
    setupVisitFilters();

    function fillVisitFilterOptions() {
        const projetoSet = new Set();
        const responsavelSet = new Set();

        visitCards.forEach(card => {
            const projeto = card.getAttribute('data-projeto');
            const responsavel = card.getAttribute('data-responsavel');

            if (projeto) projetoSet.add(projeto);
            if (responsavel) responsavelSet.add(responsavel);
        });

        console.log('Projetos encontrados:', Array.from(projetoSet));
        console.log('Responsáveis encontrados:', Array.from(responsavelSet));

        // Preencher select de projetos
        const projetoSelect = document.getElementById('filterProjetoVisit');
        if (projetoSelect) {
            projetoSet.forEach(projeto => {
                const option = document.createElement('option');
                option.value = projeto;
                option.textContent = projeto;
                projetoSelect.appendChild(option);
            });
        }

        // Preencher select de responsáveis
        const responsavelSelect = document.getElementById('filterResponsavelVisit');
        if (responsavelSelect) {
            responsavelSet.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                responsavelSelect.appendChild(option);
            });
        }
    }

    function setupVisitFilters() {
        // Filtros desktop
        const filterStatus = document.getElementById('filterStatusVisit');
        const filterProjeto = document.getElementById('filterProjetoVisit');
        const filterResponsavel = document.getElementById('filterResponsavelVisit');
        const searchInput = document.getElementById('searchVisit');

        [filterStatus, filterProjeto, filterResponsavel].forEach(filter => {
            if (filter) filter.addEventListener('change', applyVisitFilters);
        });

        if (searchInput) searchInput.addEventListener('input', applyVisitFilters);

        // Filtros mobile (botões de status)
        const mobileButtons = document.querySelectorAll('input[name="statusFilterMobile"]');
        mobileButtons.forEach(button => {
            button.addEventListener('change', function() {
                if (this.checked) {
                    const statusValue = this.id.replace('filter', '').replace('Mobile', '');
                    const statusSelect = document.getElementById('filterStatusVisit');
                    if (statusSelect) {
                        statusSelect.value = statusValue === 'All' ? '' : statusValue;
                        applyVisitFilters();
                    }
                }
            });
        });
    }

    function applyVisitFilters() {
        const statusFilter = document.getElementById('filterStatusVisit')?.value || '';
        const projetoFilter = document.getElementById('filterProjetoVisit')?.value || '';
        const responsavelFilter = document.getElementById('filterResponsavelVisit')?.value || '';
        const searchText = (document.getElementById('searchVisit')?.value || '').toLowerCase();

        let visibleCount = 0;

        visitCards.forEach(card => {
            const status = card.getAttribute('data-status') || '';
            const projeto = card.getAttribute('data-projeto') || '';
            const responsavel = card.getAttribute('data-responsavel') || '';
            const searchData = card.getAttribute('data-search') || '';

            const statusMatch = !statusFilter || status === statusFilter;
            const projetoMatch = !projetoFilter || projeto.includes(projetoFilter);
            const responsavelMatch = !responsavelFilter || responsavel === responsavelFilter;
            const searchMatch = !searchText || searchData.includes(searchText);

            if (statusMatch && projetoMatch && responsavelMatch && searchMatch) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = visibleCount;
    }

    // Expor função global para o botão de limpar
    window.clearVisitFilters = function() {
        // Limpar filtros desktop
        const filters = ['filterStatusVisit', 'filterProjetoVisit', 'filterResponsavelVisit', 'searchVisit'];
        filters.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });

        // Limpar filtros mobile
        const allButton = document.getElementById('filterAllMobile');
        if (allButton) allButton.checked = true;

        visitCards.forEach(card => {
            card.style.display = '';
        });

        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = visitCards.length;
    };
});
</script>
{% endblock %}