{% extends "base.html" %}

{% block title %}Visitas - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-calendar-check me-2"></i>
                Visitas
            </h1>
            <div>
                <a href="{{ url_for('visits_calendar') }}" class="btn btn-outline-info me-2">
                    <i class="fas fa-calendar-alt me-2"></i>Calendário
                </a>
                <a href="{{ url_for('visit_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Agendar Visita
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Melhorados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-3">
                <div class="row g-3">
                    <div class="col-md-3 col-sm-6">
                        <label class="form-label small fw-bold">Status:</label>
                        <select class="form-select form-select-sm" id="filterStatusVisit">
                            <option value="">Todos os Status</option>
                            <option value="Agendada">Agendadas</option>
                            <option value="Realizada">Realizadas</option>
                            <option value="Cancelada">Canceladas</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label class="form-label small fw-bold">Projeto:</label>
                        <select class="form-select form-select-sm" id="filterProjetoVisit">
                            <option value="">Todos os Projetos</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label class="form-label small fw-bold">Responsável:</label>
                        <select class="form-select form-select-sm" id="filterResponsavelVisit">
                            <option value="">Todos Responsáveis</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <label class="form-label small fw-bold">Pesquisar:</label>
                        <input type="text" class="form-control form-control-sm" id="searchVisit" placeholder="Projeto ou objetivo">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <!-- Status buttons for mobile -->
                        <div class="btn-group d-md-none mb-2" role="group" aria-label="Status Filter Mobile">
                            <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAllMobile" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="filterAllMobile">Todas</label>
                            
                            <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAgendadaMobile" autocomplete="off">
                            <label class="btn btn-outline-warning btn-sm" for="filterAgendadaMobile">Agendadas</label>
                            
                            <input type="radio" class="btn-check" name="statusFilterMobile" id="filterRealizadaMobile" autocomplete="off">
                            <label class="btn btn-outline-success btn-sm" for="filterRealizadaMobile">Realizadas</label>
                            
                            <input type="radio" class="btn-check" name="statusFilterMobile" id="filterCanceladaMobile" autocomplete="off">
                            <label class="btn btn-outline-danger btn-sm" for="filterCanceladaMobile">Canceladas</label>
                        </div>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="clearVisitFilters()">
                            <i class="fas fa-times"></i> Limpar Filtros
                        </button>
                        <small class="text-muted">
                            <span id="visitFilteredCount">{{ visits|length if visits else 0 }}</span> visita(s) encontrada(s)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if visits %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="visitsTable">
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Data Agendada</th>
                                    <th>Data Realizada</th>
                                    <th>Responsável</th>
                                    <th>Status</th>
                                    <th>Objetivo</th>
                                    <th>Localização</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visit in visits %}
                                <tr data-status="{{ visit.status }}">
                                    <td>
                                        <strong>{{ visit.projeto.numero }}</strong><br>
                                        <small class="text-muted">{{ visit.projeto.nome }}</small>
                                    </td>
                                    <td>{{ visit.data_agendada.strftime('%d/%m/%Y às %H:%M') }}</td>
                                    <td>{{ visit.data_realizada.strftime('%d/%m/%Y às %H:%M') if visit.data_realizada else '-' }}</td>
                                    <td>{{ visit.responsavel.nome_completo }}</td>
                                    <td>
                                        {% if visit.status == 'Realizada' %}
                                            <span class="badge bg-success">{{ visit.status }}</span>
                                        {% elif visit.status == 'Agendada' %}
                                            <span class="badge bg-warning">{{ visit.status }}</span>
                                        {% elif visit.status == 'Cancelada' %}
                                            <span class="badge bg-danger">{{ visit.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ visit.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="max-width: 200px;">
                                            {{ visit.objetivo[:80] }}{{ '...' if visit.objetivo and visit.objetivo|length > 80 else '' }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if visit.latitude and visit.longitude %}
                                            <a href="https://www.google.com/maps?q={{ visit.latitude }},{{ visit.longitude }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </a>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if visit.status == 'Agendada' %}
                                                <a href="{{ url_for('visit_realize', visit_id=visit.id) }}" class="btn btn-sm btn-success" title="Realizar Visita">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            {% endif %}
                                            <a href="{{ url_for('visit_communication', visit_id=visit.id) }}" class="btn btn-sm btn-primary" title="Comunicação">
                                                <i class="fas fa-comments"></i>
                                            </a>
                                            <a href="{{ url_for('visit_checklist', visit_id=visit.id) }}" class="btn btn-sm btn-outline-info" title="Ver Checklist">
                                                <i class="fas fa-list-check"></i>
                                            </a>
                                            <a href="{{ url_for('project_view', project_id=visit.projeto.id) }}" class="btn btn-sm btn-outline-secondary" title="Ver Projeto">
                                                <i class="fas fa-building"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma visita agendada</h5>
                        <p class="text-muted">Comece agendando a primeira visita.</p>
                        <a href="{{ url_for('visit_new') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>Agendar Primeira Visita
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('visitsTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    
    // Adicionar atributos de dados adicionais
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const projetoText = cells[0].textContent.trim();
            const responsavelText = cells[3].textContent.trim();
            const objetivoText = cells[5] ? cells[5].textContent.trim() : '';
            
            row.setAttribute('data-projeto', projetoText);
            row.setAttribute('data-responsavel', responsavelText);
            row.setAttribute('data-search', (projetoText + ' ' + objetivoText).toLowerCase());
        }
    });
    
    // Preencher filtros dinamicamente
    fillVisitFilterOptions();
    setupVisitFilters();
    
    function fillVisitFilterOptions() {
        const projetoSet = new Set();
        const responsavelSet = new Set();
        
        rows.forEach(row => {
            const projeto = row.getAttribute('data-projeto');
            const responsavel = row.getAttribute('data-responsavel');
            
            if (projeto) projetoSet.add(projeto);
            if (responsavel) responsavelSet.add(responsavel);
        });
        
        // Preencher select de projetos
        const projetoSelect = document.getElementById('filterProjetoVisit');
        if (projetoSelect) {
            projetoSet.forEach(projeto => {
                const option = document.createElement('option');
                option.value = projeto;
                option.textContent = projeto;
                projetoSelect.appendChild(option);
            });
        }
        
        // Preencher select de responsáveis
        const responsavelSelect = document.getElementById('filterResponsavelVisit');
        if (responsavelSelect) {
            responsavelSet.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                responsavelSelect.appendChild(option);
            });
        }
    }
    
    function setupVisitFilters() {
        // Filtros desktop
        const filterStatus = document.getElementById('filterStatusVisit');
        const filterProjeto = document.getElementById('filterProjetoVisit');
        const filterResponsavel = document.getElementById('filterResponsavelVisit');
        const searchInput = document.getElementById('searchVisit');
        
        [filterStatus, filterProjeto, filterResponsavel].forEach(filter => {
            if (filter) filter.addEventListener('change', applyVisitFilters);
        });
        
        if (searchInput) searchInput.addEventListener('input', applyVisitFilters);
        
        // Filtros mobile (botões de status)
        const mobileButtons = document.querySelectorAll('input[name="statusFilterMobile"]');
        mobileButtons.forEach(button => {
            button.addEventListener('change', function() {
                if (this.checked) {
                    const statusValue = this.id.replace('filter', '').replace('Mobile', '');
                    const statusSelect = document.getElementById('filterStatusVisit');
                    if (statusSelect) {
                        statusSelect.value = statusValue === 'All' ? '' : statusValue;
                        applyVisitFilters();
                    }
                }
            });
        });
    }
    
    function applyVisitFilters() {
        const statusFilter = document.getElementById('filterStatusVisit')?.value || '';
        const projetoFilter = document.getElementById('filterProjetoVisit')?.value || '';
        const responsavelFilter = document.getElementById('filterResponsavelVisit')?.value || '';
        const searchText = (document.getElementById('searchVisit')?.value || '').toLowerCase();
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status') || '';
            const projeto = row.getAttribute('data-projeto') || '';
            const responsavel = row.getAttribute('data-responsavel') || '';
            const searchData = row.getAttribute('data-search') || '';
            
            const statusMatch = !statusFilter || status === statusFilter;
            const projetoMatch = !projetoFilter || projeto.includes(projetoFilter);
            const responsavelMatch = !responsavelFilter || responsavel === responsavelFilter;
            const searchMatch = !searchText || searchData.includes(searchText);
            
            if (statusMatch && projetoMatch && responsavelMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = visibleCount;
    }
    
    // Expor função global para o botão de limpar
    window.clearVisitFilters = function() {
        // Limpar filtros desktop
        const filters = ['filterStatusVisit', 'filterProjetoVisit', 'filterResponsavelVisit', 'searchVisit'];
        filters.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        // Limpar filtros mobile
        const allButton = document.getElementById('filterAllMobile');
        if (allButton) allButton.checked = true;
        
        rows.forEach(row => {
            row.style.display = '';
        });
        
        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = rows.length;
    };
});
</script>
{% endblock %}
