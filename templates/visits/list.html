{% extends "base.html" %}

{% block title %}Visitas - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h1 class="mb-0">
                <i class="fas fa-calendar-check me-2"></i>
                Visitas
            </h1>
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
                <a href="{{ url_for('visits_calendar') }}" class="btn btn-outline-info">
                    <i class="fas fa-calendar-alt me-2"></i>Calendário
                </a>
                <a href="{{ url_for('visit_new') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Agendar Visita
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Filtros Melhorados -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-3">
                <!-- Campo de pesquisa principal - 100% em mobile -->
                <div class="row g-2 mb-3">
                    <div class="col-12">
                        <label class="form-label small fw-bold">Pesquisar:</label>
                        <input type="text" class="form-control" id="searchVisit" placeholder="Pesquisar por projeto ou objetivo..." style="min-height: 44px; font-size: 16px;">
                    </div>
                </div>
                
                <!-- Filtros em linha para desktop, ocultos em mobile -->
                <div class="row g-2 d-none d-md-flex">
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Status:</label>
                        <select class="form-select form-select-sm" id="filterStatusVisit" style="min-height: 38px;">
                            <option value="">Todos os Status</option>
                            <option value="Agendada">Agendadas</option>
                            <option value="Realizada">Realizadas</option>
                            <option value="Cancelada">Canceladas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Projeto:</label>
                        <select class="form-select form-select-sm" id="filterProjetoVisit" style="min-height: 38px;">
                            <option value="">Todos os Projetos</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">Responsável:</label>
                        <select class="form-select form-select-sm" id="filterResponsavelVisit" style="min-height: 38px;">
                            <option value="">Todos Responsáveis</option>
                            <!-- Será preenchido dinamicamente -->
                        </select>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <!-- Botões de status para mobile - responsivos com rolagem horizontal -->
                        <div class="d-md-none mb-3">
                            <label class="form-label small fw-bold d-block mb-2">Filtrar por Status:</label>
                            <div class="d-flex gap-2 overflow-x-auto pb-2" style="scrollbar-width: thin;">
                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAllMobile" autocomplete="off" checked>
                                <label class="btn btn-outline-secondary flex-shrink-0" for="filterAllMobile" style="min-height: 44px; min-width: 80px;">Todas</label>
                                
                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterAgendadaMobile" autocomplete="off">
                                <label class="btn btn-outline-warning flex-shrink-0" for="filterAgendadaMobile" style="min-height: 44px; min-width: 100px;">Agendadas</label>
                                
                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterRealizadaMobile" autocomplete="off">
                                <label class="btn btn-outline-success flex-shrink-0" for="filterRealizadaMobile" style="min-height: 44px; min-width: 100px;">Realizadas</label>
                                
                                <input type="radio" class="btn-check" name="statusFilterMobile" id="filterCanceladaMobile" autocomplete="off">
                                <label class="btn btn-outline-danger flex-shrink-0" for="filterCanceladaMobile" style="min-height: 44px; min-width: 110px;">Canceladas</label>
                            </div>
                        </div>
                        
                        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearVisitFilters()" style="min-height: 44px;">
                                <i class="fas fa-times"></i> Limpar Filtros
                            </button>
                            <small class="text-muted">
                                <span id="visitFilteredCount">{{ visits|length if visits else 0 }}</span> visita(s) encontrada(s)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if visits %}
                    <div class="table-responsive">
                        <table class="table table-striped" id="visitsTable">
                            <thead>
                                <tr>
                                    <th>Projeto</th>
                                    <th>Data Agendada</th>
                                    <th>Data Realizada</th>
                                    <th>Responsável</th>
                                    <th>Status</th>
                                    <th>Objetivo</th>
                                    <th>Localização</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visit in visits %}
                                <tr data-status="{{ visit.status }}">
                                    <td>
                                        <strong>{{ visit.projeto.numero }}</strong><br>
                                        <small class="text-muted">{{ visit.projeto.nome }}</small>
                                    </td>
                                    <td>{{ visit.data_agendada.strftime('%d/%m/%Y às %H:%M') }}</td>
                                    <td>{{ visit.data_realizada.strftime('%d/%m/%Y às %H:%M') if visit.data_realizada else '-' }}</td>
                                    <td>{{ visit.responsavel.nome_completo }}</td>
                                    <td>
                                        {% if visit.status == 'Realizada' %}
                                            <span class="badge bg-success">{{ visit.status }}</span>
                                        {% elif visit.status == 'Agendada' %}
                                            <span class="badge bg-warning">{{ visit.status }}</span>
                                        {% elif visit.status == 'Cancelada' %}
                                            <span class="badge bg-danger">{{ visit.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ visit.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div style="max-width: 200px;">
                                            {{ visit.objetivo[:80] }}{{ '...' if visit.objetivo and visit.objetivo|length > 80 else '' }}
                                        </div>
                                    </td>
                                    <td>
                                        {% if visit.latitude and visit.longitude %}
                                            <a href="https://www.google.com/maps?q={{ visit.latitude }},{{ visit.longitude }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </a>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group d-flex flex-wrap gap-1" role="group">
                                            {% if visit.status == 'Agendada' %}
                                                <a href="{{ url_for('visit_realize', visit_id=visit.id) }}" class="btn btn-sm btn-success flex-shrink-0" title="Realizar Visita" style="min-height: 38px; min-width: 38px;">
                                                    <i class="fas fa-check"></i>
                                                </a>
                                            {% endif %}
                                            <a href="{{ url_for('visit_communication', visit_id=visit.id) }}" class="btn btn-sm btn-primary flex-shrink-0" title="Comunicação" style="min-height: 38px; min-width: 38px;">
                                                <i class="fas fa-comments"></i>
                                            </a>
                                            <a href="{{ url_for('visit_checklist', visit_id=visit.id) }}" class="btn btn-sm btn-outline-info flex-shrink-0" title="Ver Checklist" style="min-height: 38px; min-width: 38px;">
                                                <i class="fas fa-list-check"></i>
                                            </a>
                                            <a href="{{ url_for('project_view', project_id=visit.projeto.id) }}" class="btn btn-sm btn-outline-secondary flex-shrink-0" title="Ver Projeto" style="min-height: 38px; min-width: 38px;">
                                                <i class="fas fa-building"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma visita agendada</h5>
                        <p class="text-muted">Comece agendando a primeira visita.</p>
                        <a href="{{ url_for('visit_new') }}" class="btn btn-primary" style="min-height: 44px;">
                            <i class="fas fa-plus me-2"></i>Agendar Primeira Visita
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
/* Responsividade para tabela de visitas */
@media (max-width: 768px) {
    .table-responsive {
        border: none;
    }
    
    #visitsTable {
        font-size: 14px;
    }
    
    #visitsTable th,
    #visitsTable td {
        padding: 8px 4px;
        vertical-align: middle;
    }
    
    #visitsTable th {
        font-size: 12px;
        font-weight: 600;
    }
    
    /* Ocultar colunas menos importantes em mobile */
    #visitsTable th:nth-child(3), /* Data Realizada */
    #visitsTable td:nth-child(3),
    #visitsTable th:nth-child(6), /* Objetivo - parte */
    #visitsTable td:nth-child(6) {
        display: none;
    }
    
    /* Reduzir largura de colunas específicas */
    #visitsTable th:nth-child(7), /* Localização */
    #visitsTable td:nth-child(7) {
        width: 60px;
        text-align: center;
    }
    
    /* Ajustar botões de ação */
    .btn-group {
        gap: 2px !important;
    }
    
    .btn-sm {
        padding: 4px 6px !important;
        font-size: 12px !important;
        min-height: 32px !important;
        min-width: 32px !important;
    }
}

@media (max-width: 576px) {
    /* Ocultar mais colunas em telas muito pequenas */
    #visitsTable th:nth-child(4), /* Responsável */
    #visitsTable td:nth-child(4) {
        display: none;
    }
    
    #visitsTable {
        font-size: 12px;
    }
    
    #visitsTable th,
    #visitsTable td {
        padding: 6px 2px;
    }
    
    /* Melhorar badges de status */
    .badge {
        font-size: 10px;
        padding: 4px 6px;
    }
}

/* Melhorias gerais de UX */
.btn-group .btn {
    transition: all 0.2s ease-in-out;
}

.btn-group .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Ajustes para botões de filtro mobile */
.overflow-x-auto {
    -webkit-overflow-scrolling: touch;
}

.overflow-x-auto::-webkit-scrollbar {
    height: 4px;
}

.overflow-x-auto::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 2px;
}

.overflow-x-auto::-webkit-scrollbar-thumb:hover {
    background: #a1a1a1;
}

/* Garantir altura mínima adequada para toque */
.btn, .form-control, .form-select {
    min-height: 44px;
}

@media (max-width: 768px) {
    .btn:not(.btn-sm) {
        min-height: 44px;
        font-size: 16px; /* Previne zoom no iOS */
    }
    
    .form-control, .form-select {
        font-size: 16px; /* Previne zoom no iOS */
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('visitsTable');
    if (!table) return;
    
    const rows = table.querySelectorAll('tbody tr');
    
    // Adicionar atributos de dados adicionais
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            const projetoText = cells[0].textContent.trim();
            const responsavelText = cells[3].textContent.trim();
            const objetivoText = cells[5] ? cells[5].textContent.trim() : '';
            
            row.setAttribute('data-projeto', projetoText);
            row.setAttribute('data-responsavel', responsavelText);
            row.setAttribute('data-search', (projetoText + ' ' + objetivoText).toLowerCase());
        }
    });
    
    // Preencher filtros dinamicamente
    fillVisitFilterOptions();
    setupVisitFilters();
    
    function fillVisitFilterOptions() {
        const projetoSet = new Set();
        const responsavelSet = new Set();
        
        rows.forEach(row => {
            const projeto = row.getAttribute('data-projeto');
            const responsavel = row.getAttribute('data-responsavel');
            
            if (projeto) projetoSet.add(projeto);
            if (responsavel) responsavelSet.add(responsavel);
        });
        
        // Preencher select de projetos
        const projetoSelect = document.getElementById('filterProjetoVisit');
        if (projetoSelect) {
            projetoSet.forEach(projeto => {
                const option = document.createElement('option');
                option.value = projeto;
                option.textContent = projeto;
                projetoSelect.appendChild(option);
            });
        }
        
        // Preencher select de responsáveis
        const responsavelSelect = document.getElementById('filterResponsavelVisit');
        if (responsavelSelect) {
            responsavelSet.forEach(responsavel => {
                const option = document.createElement('option');
                option.value = responsavel;
                option.textContent = responsavel;
                responsavelSelect.appendChild(option);
            });
        }
    }
    
    function setupVisitFilters() {
        // Filtros desktop
        const filterStatus = document.getElementById('filterStatusVisit');
        const filterProjeto = document.getElementById('filterProjetoVisit');
        const filterResponsavel = document.getElementById('filterResponsavelVisit');
        const searchInput = document.getElementById('searchVisit');
        
        [filterStatus, filterProjeto, filterResponsavel].forEach(filter => {
            if (filter) filter.addEventListener('change', applyVisitFilters);
        });
        
        if (searchInput) searchInput.addEventListener('input', applyVisitFilters);
        
        // Filtros mobile (botões de status)
        const mobileButtons = document.querySelectorAll('input[name="statusFilterMobile"]');
        mobileButtons.forEach(button => {
            button.addEventListener('change', function() {
                if (this.checked) {
                    const statusValue = this.id.replace('filter', '').replace('Mobile', '');
                    const statusSelect = document.getElementById('filterStatusVisit');
                    if (statusSelect) {
                        statusSelect.value = statusValue === 'All' ? '' : statusValue;
                        applyVisitFilters();
                    }
                }
            });
        });
    }
    
    function applyVisitFilters() {
        const statusFilter = document.getElementById('filterStatusVisit')?.value || '';
        const projetoFilter = document.getElementById('filterProjetoVisit')?.value || '';
        const responsavelFilter = document.getElementById('filterResponsavelVisit')?.value || '';
        const searchText = (document.getElementById('searchVisit')?.value || '').toLowerCase();
        
        let visibleCount = 0;
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status') || '';
            const projeto = row.getAttribute('data-projeto') || '';
            const responsavel = row.getAttribute('data-responsavel') || '';
            const searchData = row.getAttribute('data-search') || '';
            
            const statusMatch = !statusFilter || status === statusFilter;
            const projetoMatch = !projetoFilter || projeto.includes(projetoFilter);
            const responsavelMatch = !responsavelFilter || responsavel === responsavelFilter;
            const searchMatch = !searchText || searchData.includes(searchText);
            
            if (statusMatch && projetoMatch && responsavelMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = visibleCount;
    }
    
    // Expor função global para o botão de limpar
    window.clearVisitFilters = function() {
        // Limpar filtros desktop
        const filters = ['filterStatusVisit', 'filterProjetoVisit', 'filterResponsavelVisit', 'searchVisit'];
        filters.forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        // Limpar filtros mobile
        const allButton = document.getElementById('filterAllMobile');
        if (allButton) allButton.checked = true;
        
        rows.forEach(row => {
            row.style.display = '';
        });
        
        const countElement = document.getElementById('visitFilteredCount');
        if (countElement) countElement.textContent = rows.length;
    };
});
</script>
{% endblock %}
