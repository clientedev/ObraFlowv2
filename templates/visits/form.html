{% extends "base.html" %}

{% block title %}{{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
            {{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                {% if visit and action == 'realize' %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Informações da Visita</h6>
                        <p class="mb-1"><strong>Projeto:</strong> {{ visit.projeto.nome }} ({{ visit.projeto.numero }})</p>
                        <p class="mb-1"><strong>Data Agendada:</strong> {{ visit.data_agendada.strftime('%d/%m/%Y às %H:%M') }}</p>
                        <p class="mb-0"><strong>Objetivo:</strong> {{ visit.objetivo }}</p>
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('visit_new') if action != 'realize' else url_for('visit_realize', visit_id=visit.id) }}" id="visitForm">
                    {{ form.hidden_tag() }}
                    
                    {% if action != 'realize' %}
                        <!-- Seleção de Projeto -->
                        <div class="mb-3">
                            {{ form.projeto_id.label(class="form-label") }}
                            {{ form.projeto_id(class="form-select" + (" is-invalid" if form.projeto_id.errors else ""), id="projeto_id") }}
                            {% for error in form.projeto_id.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Campo 'Outros' (aparece quando 'Outros' é selecionado) -->
                        <div class="mb-3" id="projeto_outros_div" style="display: none;">
                            {{ form.projeto_outros.label(class="form-label") }}
                            {{ form.projeto_outros(class="form-control" + (" is-invalid" if form.projeto_outros.errors else ""), placeholder="Digite o nome do projeto") }}
                            {% for error in form.projeto_outros.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de Início -->
                        <div class="mb-3">
                            {{ form.data_inicio.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_inicio" 
                                   name="data_inicio" 
                                   class="form-control{{ ' is-invalid' if form.data_inicio.errors else '' }}" 
                                   value="{{ form_data.get('data_inicio') if form_data else (form.data_inicio.data.strftime('%Y-%m-%dT%H:%M') if form.data_inicio.data else '') }}"
                                   required>
                            {% for error in form.data_inicio.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de Fim -->
                        <div class="mb-3">
                            {{ form.data_fim.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_fim" 
                                   name="data_fim" 
                                   class="form-control{{ ' is-invalid' if form.data_fim.errors else '' }}" 
                                   value="{{ form_data.get('data_fim') if form_data else (form.data_fim.data.strftime('%Y-%m-%dT%H:%M') if form.data_fim.data else '') }}"
                                   required>
                            {% for error in form.data_fim.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Observações (não obrigatório) -->
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control" + (" is-invalid" if form.observacoes.errors else ""), rows="3", placeholder="Observações sobre a visita (opcional)") }}
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Seleção de Participantes -->
                        <div class="mb-3">
                            {{ form.participantes.label(class="form-label") }}
                            
                            <!-- Contador de selecionados -->
                            <div id="participants-count" class="mb-2 text-muted fw-bold">
                                0 participante(s) selecionado(s)
                            </div>
                            
                            <!-- Hidden input para enviar IDs selecionados -->
                            <input type="hidden" name="participants_ids" id="participants_ids" value="">
                            
                            <!-- Container de participantes -->
                            <div class="participant-container">
                                {% for subfield in form.participantes %}
                                    {% set label_text = subfield.label.text %}
                                    {% if '(' in label_text and ')' in label_text %}
                                        {% set participant_name = label_text.split('(')[0].strip() %}
                                        {% set participant_role = label_text.split('(')[1].split(')')[0].strip() %}
                                    {% else %}
                                        {% set participant_name = label_text %}
                                        {% set participant_role = 'Outros' %}
                                    {% endif %}
                                    
                                    <label class="participant-card" data-user-id="{{ subfield.data }}" tabindex="0">
                                        {{ subfield(class="participant-checkbox", name="participants") }}
                                        <div class="participant-content">
                                            <i class="bi bi-person-circle text-primary"></i>
                                            <div class="participant-info">
                                                <div class="participant-name">{{ participant_name }}</div>
                                                <div class="participant-role text-muted">{{ participant_role }}</div>
                                            </div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                            {% for error in form.participantes.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Item 31: Compromisso Pessoal -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_pessoal(class="form-check-input") }}
                                {{ form.is_pessoal.label(class="form-check-label") }}
                                <div class="form-text text-muted">
                                    Marque se este é um compromisso pessoal (outros usuários verão apenas "Confidencial")
                                </div>
                            </div>
                            {% for error in form.is_pessoal.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Realize visit form -->
                        <div class="mb-3">
                            {{ form.atividades_realizadas.label(class="form-label") }}
                            {{ form.atividades_realizadas(class="form-control" + (" is-invalid" if form.atividades_realizadas.errors else ""), rows="4") }}
                            {% for error in form.atividades_realizadas.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control", rows="3") }}
                        </div>
                        
                        <!-- GPS Location -->
                        <div class="mb-3">
                            <label class="form-label">Localização GPS</label>
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Capturar localização atual</span>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="getLocationBtn">
                                            <i class="fas fa-map-marker-alt me-1"></i>Obter Localização
                                        </button>
                                    </div>
                                    
                                    {{ form.latitude() }}
                                    {{ form.longitude() }}
                                    
                                    <div id="locationInfo" class="text-muted" style="display: none;">
                                        <small>
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            Localização capturada com sucesso
                                        </small>
                                    </div>
                                    
                                    <div class="mt-2">
                                        {{ form.endereco_gps.label(class="form-label") }}
                                        {{ form.endereco_gps(class="form-control", readonly=True) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('visits_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
                            {{ 'Confirmar Realização' if action == 'realize' else 'Agendar Visita' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* =================================
   TEMÁTICA ELP - PARTICIPANTES
   ================================= */

.participant-container {
  max-height: 400px;
  overflow-y: auto;
  padding: 8px;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border: 2px solid #e5e7eb;
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.participant-card {
  display: block;
  position: relative;
  background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
  border: 2px solid #d1d5db;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  user-select: none;
  overflow: hidden;
}

.participant-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(180deg, #374151, #6b7280);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.participant-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
  border-color: #9ca3af;
}

.participant-card:hover::before {
  opacity: 1;
}

/* Estado Selecionado - Temática ELP */
.participant-card.selected {
  background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
  border-color: #0891b2;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(8, 145, 178, 0.3);
}

.participant-card.selected::before {
  background: linear-gradient(180deg, #fbbf24, #f59e0b);
  opacity: 1;
  width: 6px;
}

.participant-card.selected .participant-content {
  color: white;
}

.participant-card.selected .text-muted {
  color: rgba(255, 255, 255, 0.8) !important;
}

.participant-card.selected .text-primary {
  color: #fbbf24 !important;
}

/* Conteúdo do Card */
.participant-content {
  display: flex;
  align-items: center;
  gap: 16px;
  position: relative;
  z-index: 1;
}

.participant-content .bi-person-circle {
  font-size: 2.5rem;
  color: #374151;
  transition: all 0.3s ease;
}

.participant-card.selected .participant-content .bi-person-circle {
  color: #fbbf24;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.participant-info {
  flex: 1;
  min-width: 0;
}

.participant-name {
  font-weight: 600;
  font-size: 1.1rem;
  color: #111827;
  margin-bottom: 4px;
  transition: color 0.3s ease;
}

.participant-card.selected .participant-name {
  color: white;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.participant-role {
  font-size: 0.9rem;
  color: #6b7280;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: color 0.3s ease;
}

.participant-card.selected .participant-role {
  color: rgba(255, 255, 255, 0.9);
}

/* Indicador de Seleção */
.participant-card::after {
  content: '✓';
  position: absolute;
  top: 12px;
  right: 16px;
  width: 24px;
  height: 24px;
  background: #0891b2;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: bold;
  opacity: 0;
  transform: scale(0) rotate(180deg);
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.participant-card.selected::after {
  opacity: 1;
  transform: scale(1) rotate(0deg);
  background: #fbbf24;
}

/* Contador de Participantes */
#participants-count {
  font-size: 1rem;
  font-weight: 600;
  color: #374151;
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
  background-clip: text;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-align: center;
  padding: 12px;
  background-color: rgba(251, 191, 36, 0.1);
  border: 2px solid rgba(251, 191, 36, 0.2);
  border-radius: 8px;
  margin-bottom: 16px;
}

/* Scrollbar Personalizada */
.participant-container::-webkit-scrollbar {
  width: 8px;
}

.participant-container::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.participant-container::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #0891b2, #0e7490);
  border-radius: 4px;
}

.participant-container::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #0e7490, #155e75);
}

/* Responsividade Mobile */
@media (max-width: 768px) {
  .participant-card {
    padding: 18px 16px;
    margin-bottom: 10px;
    min-height: 72px;
    border-radius: 10px;
  }
  
  .participant-content {
    gap: 14px;
  }
  
  .participant-content .bi-person-circle {
    font-size: 2.2rem;
  }
  
  .participant-name {
    font-size: 1.05rem;
  }
  
  .participant-role {
    font-size: 0.85rem;
  }
  
  #participants-count {
    font-size: 1.1rem;
    padding: 14px;
    margin-bottom: 14px;
  }
  
  .participant-container {
    max-height: 350px;
    padding: 6px;
  }
  
  .participant-card::after {
    width: 26px;
    height: 26px;
    font-size: 1rem;
  }
}

/* Animações de Entrada */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.participant-card {
  animation: fadeInUp 0.3s ease forwards;
}

.participant-card:nth-child(1) { animation-delay: 0.1s; }
.participant-card:nth-child(2) { animation-delay: 0.15s; }
.participant-card:nth-child(3) { animation-delay: 0.2s; }
.participant-card:nth-child(4) { animation-delay: 0.25s; }
.participant-card:nth-child(5) { animation-delay: 0.3s; }

/* Estados de Foco para Acessibilidade */
.participant-card:focus {
  outline: 3px solid rgba(8, 145, 178, 0.5);
  outline-offset: 2px;
}

/* Checkbox Oculto */
.participant-checkbox {
  position: absolute;
  opacity: 0;
  pointer-events: none;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle 'Outros' project selection
document.addEventListener('DOMContentLoaded', function() {
    const projetoSelect = document.getElementById('projeto_id');
    const projetoOutrosDiv = document.getElementById('projeto_outros_div');
    
    function toggleProjetoOutros() {
        if (projetoSelect.value === '-1') {
            projetoOutrosDiv.style.display = 'block';
        } else {
            projetoOutrosDiv.style.display = 'none';
        }
    }
    
    // Initial check
    toggleProjetoOutros();
    
    // Listen for changes
    projetoSelect.addEventListener('change', toggleProjetoOutros);
    
    // ========================================
    // SELEÇÃO DE PARTICIPANTES - ELP SYSTEM
    // ========================================
    
    function updateParticipantSelection() {
        const checkedBoxes = document.querySelectorAll('.participant-checkbox:checked');
        const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
        const count = selectedIds.length;
        
        // Atualizar contador visual
        const countElement = document.querySelector('#participants-count');
        if (count === 0) {
            countElement.textContent = 'Nenhum participante selecionado';
        } else if (count === 1) {
            countElement.textContent = '1 participante selecionado';
        } else {
            countElement.textContent = `${count} participantes selecionados`;
        }
        
        // Atualizar campo hidden para submissão
        const hiddenInput = document.querySelector('input[name="participants_ids"]');
        if (hiddenInput) {
            hiddenInput.value = selectedIds.join(',');
        }
        
        // Atualizar estados visuais dos cards
        document.querySelectorAll('.participant-card').forEach(card => {
            const checkbox = card.querySelector('.participant-checkbox');
            if (checkbox) {
                if (checkbox.checked) {
                    card.classList.add('selected');
                    card.setAttribute('aria-selected', 'true');
                } else {
                    card.classList.remove('selected');
                    card.setAttribute('aria-selected', 'false');
                }
            }
        });
    }
    
    function initializeParticipantSelection() {
        const participantCards = document.querySelectorAll('.participant-card');
        
        participantCards.forEach(card => {
            const checkbox = card.querySelector('.participant-checkbox');
            if (!checkbox) return;
            
            // Evento de mudança do checkbox
            checkbox.addEventListener('change', function() {
                updateParticipantSelection();
            });
            
            // Evento de clique no card
            card.addEventListener('click', function(e) {
                // Evitar duplo toggle se clicou no checkbox
                if (e.target === checkbox) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                // Toggle do checkbox
                checkbox.checked = !checkbox.checked;
                
                // Trigger change event
                const changeEvent = new Event('change', { bubbles: true });
                checkbox.dispatchEvent(changeEvent);
            });
            
            // Suporte para tecla Enter/Space
            card.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    checkbox.checked = !checkbox.checked;
                    const changeEvent = new Event('change', { bubbles: true });
                    checkbox.dispatchEvent(changeEvent);
                }
            });
        });
        
        // Atualização inicial
        updateParticipantSelection();
    }
    
    // Inicializar após carregamento do DOM
    initializeParticipantSelection();
});
</script>

{% if action == 'realize' %}
<script>
// GPS Location functionality
document.addEventListener('DOMContentLoaded', function() {
    const getLocationBtn = document.getElementById('getLocationBtn');
    const latitudeField = document.querySelector('input[name="latitude"]');
    const longitudeField = document.querySelector('input[name="longitude"]');
    const enderecoField = document.querySelector('input[name="endereco_gps"]');
    const locationInfo = document.getElementById('locationInfo');
    
    getLocationBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Obtendo...';
            getLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latitudeField.value = lat;
                    longitudeField.value = lng;
                    enderecoField.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                    
                    locationInfo.style.display = 'block';
                    getLocationBtn.innerHTML = '<i class="fas fa-check me-1"></i>Localização Obtida';
                    getLocationBtn.classList.remove('btn-outline-primary');
                    getLocationBtn.classList.add('btn-success');
                },
                function(error) {
                    console.error('Erro ao obter localização:', error);
                    alert('Erro ao obter localização. Verifique se o GPS está habilitado.');
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i>Tentar Novamente';
                    getLocationBtn.disabled = false;
                }
            );
        } else {
            alert('Geolocalização não é suportada neste navegador.');
        }
    });
});
</script>
{% endif %}
{% endblock %}
