{% extends "base.html" %}

{% block title %}{{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
            {{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                {% if visit and action == 'realize' %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Informações da Visita</h6>
                        <p class="mb-1"><strong>Projeto:</strong> {{ visit.projeto.nome }} ({{ visit.projeto.numero }})</p>
                        <p class="mb-1"><strong>Data Agendada:</strong> {{ visit.data_agendada.strftime('%d/%m/%Y às %H:%M') }}</p>
                        <p class="mb-0"><strong>Objetivo:</strong> {{ visit.objetivo }}</p>
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('visit_new') if action != 'realize' else url_for('visit_realize', visit_id=visit.id) }}" id="visitForm">
                    {{ form.hidden_tag() }}
                    
                    {% if action != 'realize' %}
                        <!-- Seleção de Projeto -->
                        <div class="mb-3">
                            {{ form.projeto_id.label(class="form-label") }}
                            {{ form.projeto_id(class="form-select" + (" is-invalid" if form.projeto_id.errors else ""), id="projeto_id") }}
                            {% for error in form.projeto_id.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Campo 'Outros' (aparece quando 'Outros' é selecionado) -->
                        <div class="mb-3" id="projeto_outros_div" style="display: none;">
                            {{ form.projeto_outros.label(class="form-label") }}
                            {{ form.projeto_outros(class="form-control" + (" is-invalid" if form.projeto_outros.errors else ""), placeholder="Digite o nome do projeto") }}
                            {% for error in form.projeto_outros.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de Início -->
                        <div class="mb-3">
                            {{ form.data_inicio.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_inicio" 
                                   name="data_inicio" 
                                   class="form-control{{ ' is-invalid' if form.data_inicio.errors else '' }}" 
                                   value="{{ form_data.get('data_inicio') if form_data else (form.data_inicio.data.strftime('%Y-%m-%dT%H:%M') if form.data_inicio.data else '') }}"
                                   required>
                            {% for error in form.data_inicio.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de Fim -->
                        <div class="mb-3">
                            {{ form.data_fim.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_fim" 
                                   name="data_fim" 
                                   class="form-control{{ ' is-invalid' if form.data_fim.errors else '' }}" 
                                   value="{{ form_data.get('data_fim') if form_data else (form.data_fim.data.strftime('%Y-%m-%dT%H:%M') if form.data_fim.data else '') }}"
                                   required>
                            {% for error in form.data_fim.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Observações (não obrigatório) -->
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control" + (" is-invalid" if form.observacoes.errors else ""), rows="3", placeholder="Observações sobre a visita (opcional)") }}
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Seleção de Participantes -->
                        <div class="mb-3">
                            {{ form.participantes.label(class="form-label") }}
                            
                            <!-- Contador de selecionados -->
                            <div id="participants-count" class="mb-2 text-muted">
                                0 participante(s) selecionado(s)
                            </div>
                            
                            <!-- Hidden input para enviar IDs selecionados -->
                            <input type="hidden" name="participants_ids" id="participants_ids" value="">
                            
                            <!-- Container de participantes -->
                            <div class="participant-container">
                                {% for subfield in form.participantes %}
                                    {% set label_text = subfield.label.text %}
                                    {% if '(' in label_text and ')' in label_text %}
                                        {% set participant_name = label_text.split('(')[0].strip() %}
                                        {% set participant_role = label_text.split('(')[1].split(')')[0].strip() %}
                                    {% else %}
                                        {% set participant_name = label_text %}
                                        {% set participant_role = 'Outros' %}
                                    {% endif %}
                                    
                                    <label class="participant-card" data-user-id="{{ subfield.data }}">
                                        {{ subfield(class="participant-checkbox d-none", name="participants") }}
                                        <div class="participant-main d-flex align-items-start gap-2">
                                            <div class="participant-avatar">
                                                <i class="bi bi-person-circle fs-3"></i>
                                            </div>
                                            <div class="participant-text">
                                                <div class="participant-name">{{ participant_name }}</div>
                                                <small class="text-muted">{{ participant_role }}</small>
                                            </div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                            {% for error in form.participantes.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Item 31: Compromisso Pessoal -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_pessoal(class="form-check-input") }}
                                {{ form.is_pessoal.label(class="form-check-label") }}
                                <div class="form-text text-muted">
                                    Marque se este é um compromisso pessoal (outros usuários verão apenas "Confidencial")
                                </div>
                            </div>
                            {% for error in form.is_pessoal.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Realize visit form -->
                        <div class="mb-3">
                            {{ form.atividades_realizadas.label(class="form-label") }}
                            {{ form.atividades_realizadas(class="form-control" + (" is-invalid" if form.atividades_realizadas.errors else ""), rows="4") }}
                            {% for error in form.atividades_realizadas.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control", rows="3") }}
                        </div>
                        
                        <!-- GPS Location -->
                        <div class="mb-3">
                            <label class="form-label">Localização GPS</label>
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Capturar localização atual</span>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="getLocationBtn">
                                            <i class="fas fa-map-marker-alt me-1"></i>Obter Localização
                                        </button>
                                    </div>
                                    
                                    {{ form.latitude() }}
                                    {{ form.longitude() }}
                                    
                                    <div id="locationInfo" class="text-muted" style="display: none;">
                                        <small>
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            Localização capturada com sucesso
                                        </small>
                                    </div>
                                    
                                    <div class="mt-2">
                                        {{ form.endereco_gps.label(class="form-label") }}
                                        {{ form.endereco_gps(class="form-control", readonly=True) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('visits_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
                            {{ 'Confirmar Realização' if action == 'realize' else 'Agendar Visita' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.participant-card {
  display: block;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}

.participant-card .participant-main {
  display: flex;
  align-items: center;
  gap: 10px;
}

.participant-card .participant-name {
  font-weight: 600;
}

.participant-card.selected {
  background: rgba(14,165,233,0.08);
  border-color: #0ea5e9;
}

.participant-container {
  max-height: 320px;
  overflow-y: auto;
  padding-right: 6px;
}

@media (max-width: 768px) {
  .participant-card {
    padding: 14px;
    min-height: 56px;
  }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle 'Outros' project selection
document.addEventListener('DOMContentLoaded', function() {
    const projetoSelect = document.getElementById('projeto_id');
    const projetoOutrosDiv = document.getElementById('projeto_outros_div');
    
    function toggleProjetoOutros() {
        if (projetoSelect.value === '-1') {
            projetoOutrosDiv.style.display = 'block';
        } else {
            projetoOutrosDiv.style.display = 'none';
        }
    }
    
    // Initial check
    toggleProjetoOutros();
    
    // Listen for changes
    projetoSelect.addEventListener('change', toggleProjetoOutros);
    
    // Participant Selection Functionality
    function updateSelectedList() {
        const checked = Array.from(document.querySelectorAll('.participant-checkbox:checked')).map(i => i.value);
        document.querySelector('#participants-count').textContent = `${checked.length} participante(s) selecionado(s)`;
        document.querySelector('input[name="participants_ids"]').value = checked.join(',');
        
        // Update card visual states
        document.querySelectorAll('.participant-card').forEach(card => {
            const checkbox = card.querySelector('.participant-checkbox');
            card.classList.toggle('selected', checkbox.checked);
        });
    }

    // Handle checkbox changes and card clicks properly
    document.querySelectorAll('.participant-card').forEach(card => {
        const checkbox = card.querySelector('.participant-checkbox');
        
        // Listen to checkbox changes (from any source)
        checkbox.addEventListener('change', updateSelectedList);
        
        // Handle card clicks without double-toggling
        card.addEventListener('click', (e) => {
            if (e.target.tagName === 'INPUT') return;
            e.preventDefault(); // Prevent label default behavior
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change')); // Trigger change event
        });
    });
    
    // Initial update and sync visual state
    updateSelectedList();
});
</script>

{% if action == 'realize' %}
<script>
// GPS Location functionality
document.addEventListener('DOMContentLoaded', function() {
    const getLocationBtn = document.getElementById('getLocationBtn');
    const latitudeField = document.querySelector('input[name="latitude"]');
    const longitudeField = document.querySelector('input[name="longitude"]');
    const enderecoField = document.querySelector('input[name="endereco_gps"]');
    const locationInfo = document.getElementById('locationInfo');
    
    getLocationBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Obtendo...';
            getLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latitudeField.value = lat;
                    longitudeField.value = lng;
                    enderecoField.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                    
                    locationInfo.style.display = 'block';
                    getLocationBtn.innerHTML = '<i class="fas fa-check me-1"></i>Localização Obtida';
                    getLocationBtn.classList.remove('btn-outline-primary');
                    getLocationBtn.classList.add('btn-success');
                },
                function(error) {
                    console.error('Erro ao obter localização:', error);
                    alert('Erro ao obter localização. Verifique se o GPS está habilitado.');
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i>Tentar Novamente';
                    getLocationBtn.disabled = false;
                }
            );
        } else {
            alert('Geolocalização não é suportada neste navegador.');
        }
    });
});
</script>
{% endif %}
{% endblock %}
