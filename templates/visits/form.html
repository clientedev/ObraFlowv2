{% extends "base.html" %}

{% block title %}{{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita - Sistema de Acompanhamento de Visitas em Obras{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
            {{ 'Realizar' if action == 'realize' else 'Agendar' }} Visita
        </h1>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                {% if visit and action == 'realize' %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Informa√ß√µes da Visita</h6>
                        <p class="mb-1"><strong>Projeto:</strong> {{ visit.projeto.nome }} ({{ visit.projeto.numero }})</p>
                        <p class="mb-1"><strong>Data Agendada:</strong> {{ visit.data_agendada.strftime('%d/%m/%Y √†s %H:%M') }}</p>
                        <p class="mb-0"><strong>Objetivo:</strong> {{ visit.objetivo }}</p>
                    </div>
                {% endif %}
                
                <form method="POST" action="{{ url_for('visit_new') if action != 'realize' else url_for('visit_realize', visit_id=visit.id) }}" id="visitForm">
                    {{ form.hidden_tag() }}
                    
                    {% if action != 'realize' %}
                        <!-- Sele√ß√£o de Projeto -->
                        <div class="mb-3">
                            {{ form.projeto_id.label(class="form-label") }}
                            {{ form.projeto_id(class="form-select" + (" is-invalid" if form.projeto_id.errors else ""), id="projeto_id") }}
                            {% for error in form.projeto_id.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Campo 'Outros' (aparece quando 'Outros' √© selecionado) -->
                        <div class="mb-3" id="projeto_outros_div" style="display: none;">
                            {{ form.projeto_outros.label(class="form-label") }}
                            {{ form.projeto_outros(class="form-control" + (" is-invalid" if form.projeto_outros.errors else ""), placeholder="Digite o nome do projeto") }}
                            {% for error in form.projeto_outros.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de In√≠cio -->
                        <div class="mb-3">
                            {{ form.data_inicio.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_inicio" 
                                   name="data_inicio" 
                                   class="form-control{{ ' is-invalid' if form.data_inicio.errors else '' }}" 
                                   value="{{ form_data.get('data_inicio') if form_data else (form.data_inicio.data.strftime('%Y-%m-%dT%H:%M') if form.data_inicio.data else '') }}"
                                   required>
                            {% for error in form.data_inicio.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Data e Hora de Fim -->
                        <div class="mb-3">
                            {{ form.data_fim.label(class="form-label") }}
                            <input type="datetime-local" 
                                   id="data_fim" 
                                   name="data_fim" 
                                   class="form-control{{ ' is-invalid' if form.data_fim.errors else '' }}" 
                                   value="{{ form_data.get('data_fim') if form_data else (form.data_fim.data.strftime('%Y-%m-%dT%H:%M') if form.data_fim.data else '') }}"
                                   required>
                            {% for error in form.data_fim.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Observa√ß√µes (n√£o obrigat√≥rio) -->
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control" + (" is-invalid" if form.observacoes.errors else ""), rows="3", placeholder="Observa√ß√µes sobre a visita (opcional)") }}
                            {% for error in form.observacoes.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Sele√ß√£o de Participantes Melhorada -->
                        <div class="mb-3">
                            {{ form.participantes.label(class="form-label") }}
                            <div class="participant-selector-container">
                                <!-- Barra de busca e controles -->
                                <div class="participant-search-bar d-flex align-items-center mb-3">
                                    <div class="flex-grow-1 me-2">
                                        <input type="text" 
                                               class="form-control" 
                                               id="participantSearch" 
                                               placeholder="üîç Buscar participantes..." 
                                               autocomplete="off">
                                    </div>
                                    <div class="participant-controls d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllParticipants">
                                            <i class="fas fa-check-double"></i> Todos
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearAllParticipants">
                                            <i class="fas fa-times"></i> Limpar
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Contador de selecionados -->
                                <div class="participant-counter mb-2">
                                    <small class="text-muted">
                                        <span id="selectedCount">0</span> participante(s) selecionado(s)
                                    </small>
                                </div>
                                
                                <!-- Lista de participantes organizados -->
                                <div class="participant-list border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                                    {% set participants_by_role = {} %}
                                    {% for subfield in form.participantes %}
                                        {% set participant_data = subfield.label.text.split('(') %}
                                        {% set participant_name = participant_data[0].strip() %}
                                        {% set participant_role = participant_data[1].rstrip(')') if participant_data|length > 1 else 'Outros' %}
                                        {% if participant_role not in participants_by_role %}
                                            {% set _ = participants_by_role.update({participant_role: []}) %}
                                        {% endif %}
                                        {% set _ = participants_by_role[participant_role].append((subfield, participant_name, participant_role)) %}
                                    {% endfor %}
                                    
                                    {% for role, participants in participants_by_role.items() %}
                                        <div class="participant-role-group mb-3">
                                            <h6 class="participant-role-header text-muted border-bottom pb-1 mb-2">
                                                <i class="fas fa-users me-1"></i>
                                                {{ role }} ({{ participants|length }})
                                            </h6>
                                            <div class="participant-role-items">
                                                {% for subfield, name, role in participants %}
                                                    <div class="participant-item form-check mb-2" 
                                                         data-name="{{ name.lower() }}" 
                                                         data-role="{{ role.lower() }}">
                                                        {{ subfield(class="form-check-input participant-checkbox") }}
                                                        <label class="form-check-label participant-label" for="{{ subfield.id }}">
                                                            <div class="d-flex align-items-center">
                                                                <div class="participant-avatar me-2">
                                                                    <i class="fas fa-user-circle text-primary"></i>
                                                                </div>
                                                                <div class="participant-info">
                                                                    <div class="participant-name fw-medium">{{ name }}</div>
                                                                    <small class="participant-role text-muted">{{ role }}</small>
                                                                </div>
                                                            </div>
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% for error in form.participantes.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <!-- Item 31: Compromisso Pessoal -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_pessoal(class="form-check-input") }}
                                {{ form.is_pessoal.label(class="form-check-label") }}
                                <div class="form-text text-muted">
                                    Marque se este √© um compromisso pessoal (outros usu√°rios ver√£o apenas "Confidencial")
                                </div>
                            </div>
                            {% for error in form.is_pessoal.errors %}
                                <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Realize visit form -->
                        <div class="mb-3">
                            {{ form.atividades_realizadas.label(class="form-label") }}
                            {{ form.atividades_realizadas(class="form-control" + (" is-invalid" if form.atividades_realizadas.errors else ""), rows="4") }}
                            {% for error in form.atividades_realizadas.errors %}
                                <div class="invalid-feedback">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.observacoes.label(class="form-label") }}
                            {{ form.observacoes(class="form-control", rows="3") }}
                        </div>
                        
                        <!-- GPS Location -->
                        <div class="mb-3">
                            <label class="form-label">Localiza√ß√£o GPS</label>
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span>Capturar localiza√ß√£o atual</span>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="getLocationBtn">
                                            <i class="fas fa-map-marker-alt me-1"></i>Obter Localiza√ß√£o
                                        </button>
                                    </div>
                                    
                                    {{ form.latitude() }}
                                    {{ form.longitude() }}
                                    
                                    <div id="locationInfo" class="text-muted" style="display: none;">
                                        <small>
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            Localiza√ß√£o capturada com sucesso
                                        </small>
                                    </div>
                                    
                                    <div class="mt-2">
                                        {{ form.endereco_gps.label(class="form-label") }}
                                        {{ form.endereco_gps(class="form-control", readonly=True) }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('visits_list') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Voltar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-{{ 'check' if action == 'realize' else 'calendar-plus' }} me-2"></i>
                            {{ 'Confirmar Realiza√ß√£o' if action == 'realize' else 'Agendar Visita' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* PATCH 3: Corrigir sobreposi√ß√£o do campo Participantes - Mobile First */
.participant-selector-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background: #fff;
}

.participant-list {
    background: #f8f9fa;
    min-height: 150px;
    max-height: 350px;
    overflow-y: auto;
    border-radius: 0.375rem;
}

/* Fix overlapping participant items */
.participant-item {
    display: block !important;
    width: 100%;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    background: #fff;
    transition: all 0.2s ease;
    cursor: pointer;
}

.participant-item:hover {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.1);
}

.participant-item.selected {
    border-color: #0d6efd;
    background: #e7f3ff;
}

/* Ensure proper spacing for participant labels */
.participant-label {
    display: block;
    width: 100%;
    line-height: 1.5 !important;
    margin: 0;
    cursor: pointer;
    font-size: 0.95rem;
}

/* Fix participant info layout */
.participant-info {
    flex: 1;
    min-width: 0; /* Allow text truncation */
}

.participant-name {
    font-size: 0.95rem;
    line-height: 1.4;
    margin-bottom: 0.2rem;
    word-wrap: break-word;
}

.participant-role {
    font-size: 0.8rem;
    line-height: 1.2;
    color: #6c757d !important;
}

/* Role group headers */
.participant-role-group {
    margin-bottom: 1rem;
}

.participant-role-header {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
}

/* Checkbox styling */
.participant-checkbox {
    margin-top: 0.1rem;
    margin-right: 0.5rem;
    flex-shrink: 0;
}

/* Avatar styling */
.participant-avatar {
    flex-shrink: 0;
    font-size: 1.2rem;
}

/* Mobile responsive improvements - FIX OVERLAPPING ISSUE */
@media (max-width: 768px) {
    .participant-selector-container {
        margin-bottom: 1rem;
    }
    
    .participant-list {
        padding: 0.5rem !important;
        background: #f8f9fa;
        max-height: 400px;
    }
    
    .participant-item {
        display: block !important;
        width: 100% !important;
        padding: 1rem !important;
        margin-bottom: 1.25rem !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        border: 2px solid #e9ecef !important;
        border-radius: 0.5rem !important;
        background: #fff !important;
        min-height: 70px !important;
        box-sizing: border-box !important;
        touch-action: manipulation;
        position: relative;
        clear: both;
        overflow: hidden;
    }
    
    .participant-item:hover,
    .participant-item:focus {
        border-color: #0d6efd !important;
        background: #f8f9fa !important;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15) !important;
        transform: translateY(-1px);
    }
    
    .participant-item.selected {
        border-color: #0d6efd !important;
        background: #e7f3ff !important;
        box-shadow: 0 3px 12px rgba(13, 110, 253, 0.2) !important;
    }
    
    .participant-label {
        display: block !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        cursor: pointer;
        line-height: 1.4 !important;
    }
    
    .participant-name {
        font-size: 1.1rem !important;
        line-height: 1.4 !important;
        margin-bottom: 0.3rem !important;
        font-weight: 500 !important;
        color: #212529 !important;
        word-wrap: break-word;
    }
    
    .participant-role {
        font-size: 0.9rem !important;
        line-height: 1.2 !important;
        color: #6c757d !important;
        margin: 0 !important;
    }
    
    .participant-checkbox {
        width: 20px !important;
        height: 20px !important;
        margin-top: 0.2rem !important;
        margin-right: 0.75rem !important;
        flex-shrink: 0;
        border: 2px solid #dee2e6;
    }
    
    .participant-avatar {
        flex-shrink: 0;
        font-size: 1.4rem !important;
        margin-right: 0.75rem !important;
        color: #0d6efd;
    }
    
    .participant-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    
    .participant-search-bar {
        margin-bottom: 1rem !important;
        flex-direction: column !important;
        gap: 0.75rem !important;
    }
    
    .participant-search-bar .participant-controls {
        display: flex !important;
        justify-content: center !important;
        flex-wrap: wrap;
        gap: 0.5rem;
        width: 100% !important;
    }
    
    .participant-search-bar .btn-sm {
        padding: 0.6rem 1rem !important;
        font-size: 0.95rem !important;
        min-width: 80px;
        touch-action: manipulation;
    }
    
    .participant-counter {
        text-align: center !important;
        padding: 0.75rem !important;
        font-size: 1rem !important;
        margin-bottom: 1rem !important;
        background: #e7f3ff !important;
        border: 1px solid #b6d7ff !important;
        color: #0d6efd !important;
        font-weight: 500;
    }
    
    .participant-role-group {
        margin-bottom: 1.5rem !important;
    }
    
    .participant-role-header {
        font-size: 1rem !important;
        font-weight: 600 !important;
        color: #495057 !important;
        margin-bottom: 0.75rem !important;
        padding: 0.5rem 0.75rem !important;
        background: #e9ecef !important;
        border-radius: 0.375rem !important;
        border-left: 4px solid #0d6efd;
    }
    
    /* Prevent any form-check Bootstrap conflicts */
    .participant-item .form-check {
        margin-bottom: 0 !important;
        padding-left: 0 !important;
        min-height: auto !important;
    }
    
    .participant-item .form-check-input {
        position: static !important;
        margin-left: 0 !important;
        margin-top: 0 !important;
    }
    
    /* Ensure proper layout for checkbox and content */
    .participant-item .d-flex {
        align-items: flex-start !important;
        gap: 0.75rem !important;
    }
}

/* Hide functionality for search */
.participant-item.hidden {
    display: none !important;
}

/* Ensure Bootstrap form-check styling doesn't interfere */
.participant-item .form-check {
    margin-bottom: 0;
    min-height: auto;
}

.participant-item .form-check-input {
    margin-top: 0.125rem;
}

/* Counter styling */
.participant-counter {
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem;
    background: #e9ecef;
    border-radius: 0.25rem;
    text-align: center;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// Handle 'Outros' project selection
document.addEventListener('DOMContentLoaded', function() {
    const projetoSelect = document.getElementById('projeto_id');
    const projetoOutrosDiv = document.getElementById('projeto_outros_div');
    
    function toggleProjetoOutros() {
        if (projetoSelect.value === '-1') {
            projetoOutrosDiv.style.display = 'block';
        } else {
            projetoOutrosDiv.style.display = 'none';
        }
    }
    
    // Initial check
    toggleProjetoOutros();
    
    // Listen for changes
    projetoSelect.addEventListener('change', toggleProjetoOutros);
    
    // Participant Selector Functionality
    initParticipantSelector();
});

function initParticipantSelector() {
    const searchInput = document.getElementById('participantSearch');
    const selectAllBtn = document.getElementById('selectAllParticipants');
    const clearAllBtn = document.getElementById('clearAllParticipants');
    const selectedCountElement = document.getElementById('selectedCount');
    const participantItems = document.querySelectorAll('.participant-item');
    const participantCheckboxes = document.querySelectorAll('.participant-checkbox');
    
    if (!searchInput || !selectAllBtn || !clearAllBtn || !selectedCountElement) {
        return; // Exit if participant selector elements not found
    }
    
    // Update selected counter
    function updateSelectedCounter() {
        const selectedCount = document.querySelectorAll('.participant-checkbox:checked').length;
        selectedCountElement.textContent = selectedCount;
        
        // Update visual state of items
        participantItems.forEach(item => {
            const checkbox = item.querySelector('.participant-checkbox');
            if (checkbox && checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }
    
    // Search functionality
    function filterParticipants() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let hasVisibleItems = false;
        
        participantItems.forEach(item => {
            const name = item.getAttribute('data-name') || '';
            const role = item.getAttribute('data-role') || '';
            const matchesSearch = name.includes(searchTerm) || role.includes(searchTerm);
            
            if (matchesSearch) {
                item.classList.remove('hidden');
                hasVisibleItems = true;
            } else {
                item.classList.add('hidden');
            }
        });
        
        // Show/hide role groups based on visible items
        document.querySelectorAll('.participant-role-group').forEach(group => {
            const hasVisibleParticipants = group.querySelectorAll('.participant-item:not(.hidden)').length > 0;
            group.style.display = hasVisibleParticipants ? 'block' : 'none';
        });
    }
    
    // Select all visible participants
    function selectAllVisible() {
        participantItems.forEach(item => {
            if (!item.classList.contains('hidden')) {
                const checkbox = item.querySelector('.participant-checkbox');
                if (checkbox) {
                    checkbox.checked = true;
                }
            }
        });
        updateSelectedCounter();
    }
    
    // Clear all selections
    function clearAllSelections() {
        participantCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedCounter();
    }
    
    // Add click handlers to participant items
    participantItems.forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't trigger if clicking on the checkbox directly
            if (e.target.type === 'checkbox') return;
            
            const checkbox = this.querySelector('.participant-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectedCounter();
            }
        });
    });
    
    // Event listeners
    searchInput.addEventListener('input', filterParticipants);
    selectAllBtn.addEventListener('click', selectAllVisible);
    clearAllBtn.addEventListener('click', clearAllSelections);
    
    // Listen for checkbox changes
    participantCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCounter);
    });
    
    // Initial counter update
    updateSelectedCounter();
}
</script>

{% if action == 'realize' %}
<script>
// GPS Location functionality
document.addEventListener('DOMContentLoaded', function() {
    const getLocationBtn = document.getElementById('getLocationBtn');
    const latitudeField = document.querySelector('input[name="latitude"]');
    const longitudeField = document.querySelector('input[name="longitude"]');
    const enderecoField = document.querySelector('input[name="endereco_gps"]');
    const locationInfo = document.getElementById('locationInfo');
    
    getLocationBtn.addEventListener('click', function() {
        if (navigator.geolocation) {
            getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Obtendo...';
            getLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latitudeField.value = lat;
                    longitudeField.value = lng;
                    enderecoField.value = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
                    
                    locationInfo.style.display = 'block';
                    getLocationBtn.innerHTML = '<i class="fas fa-check me-1"></i>Localiza√ß√£o Obtida';
                    getLocationBtn.classList.remove('btn-outline-primary');
                    getLocationBtn.classList.add('btn-success');
                },
                function(error) {
                    console.error('Erro ao obter localiza√ß√£o:', error);
                    alert('Erro ao obter localiza√ß√£o. Verifique se o GPS est√° habilitado.');
                    getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt me-1"></i>Tentar Novamente';
                    getLocationBtn.disabled = false;
                }
            );
        } else {
            alert('Geolocaliza√ß√£o n√£o √© suportada neste navegador.');
        }
    });
});
</script>
{% endif %}
{% endblock %}
