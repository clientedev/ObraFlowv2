{% extends "base.html" %}

{% block title %}Calendário de Visitas - Sistema ELP{% endblock %}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />
<style>
    .fc-event {
        border-radius: 3px;
        border: none;
    }
    .fc-event-agendada {
        background-color: #007bff;
        color: white;
    }
    .fc-event-realizada {
        background-color: #28a745;
        color: white;
    }
    .fc-event-cancelada {
        background-color: #dc3545;
        color: white;
    }
    .calendar-controls {
        margin-bottom: 20px;
    }
    .export-buttons {
        margin-top: 15px;
    }
    .visit-tooltip {
        max-width: 300px;
        z-index: 9999;
    }
    .calendar-legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 15px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
    }
    .fc-toolbar {
        margin-bottom: 20px !important;
        flex-wrap: wrap !important;
        gap: 10px !important;
    }
    
    /* Responsividade para mobile */
    @media (max-width: 768px) {
        .fc-toolbar {
            flex-direction: column !important;
            align-items: stretch !important;
        }
        .fc-toolbar-chunk {
            display: flex !important;
            justify-content: center !important;
            margin-bottom: 10px !important;
        }
        .fc-button-group {
            display: flex !important;
            width: 100% !important;
        }
        .fc-button {
            min-height: 44px !important;
            font-size: 14px !important;
            flex: 1 !important;
        }
        .fc-toolbar-title {
            font-size: 1.2rem !important;
            text-align: center !important;
            margin: 10px 0 !important;
        }
        .fc-dayGridMonth-view .fc-daygrid-day-number {
            font-size: 14px !important;
            padding: 8px !important;
        }
        .fc-event {
            font-size: 12px !important;
            padding: 2px 4px !important;
        }
        .fc-col-header-cell {
            padding: 8px 4px !important;
            font-size: 12px !important;
        }
    }
    
    /* Melhorias para telas pequenas */
    @media (max-width: 576px) {
        .fc-toolbar-title {
            font-size: 1rem !important;
        }
        .fc-button {
            font-size: 12px !important;
            padding: 8px 12px !important;
        }
        .fc-dayGridMonth-view .fc-daygrid-day-number {
            font-size: 12px !important;
        }
        .calendar-legend {
            justify-content: center !important;
        }
        .legend-item {
            font-size: 12px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
            <h1 class="mb-0"><i class="fas fa-calendar-alt me-2 text-primary"></i>Calendário de Visitas</h1>
            <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-md-auto">
                <a href="{{ url_for('visit_new') }}" class="btn btn-primary" style="min-height: 44px;">
                    <i class="fas fa-plus me-2"></i>Nova Visita
                </a>
                <a href="{{ url_for('visits_list') }}" class="btn btn-outline-secondary" style="min-height: 44px;">
                    <i class="fas fa-list me-2"></i>Lista
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <!-- Legenda de Status -->
                <div class="calendar-legend mb-3">
                    <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Status das Visitas</h6>
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #007bff;"></div>
                            <span>Agendada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #28a745;"></div>
                            <span>Realizada</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #dc3545;"></div>
                            <span>Cancelada</span>
                        </div>
                    </div>
                </div>

                <!-- Legenda de Cores dos Funcionários -->
                <div class="calendar-legend mb-3" id="employeeColorsLegend" style="display: none;">
                    <h6 class="mb-2"><i class="fas fa-users me-2"></i>Cores dos Funcionários</h6>
                    <div class="d-flex gap-2 flex-wrap" id="employeeColorsContainer">
                        <!-- Cores dos funcionários carregadas dinamicamente -->
                    </div>
                </div>

                <!-- Calendário -->
                <div id='calendar'></div>

                <!-- Botões de Export -->
                <div class="export-buttons">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-download me-2"></i>Exportar Calendário</h6>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" onclick="exportToGoogleCalendar()">
                                    <i class="fab fa-google me-2"></i>Google Calendar
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="exportToOutlook()">
                                    <i class="fab fa-microsoft me-2"></i>Outlook
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="exportToICS()">
                                    <i class="fas fa-calendar-download me-2"></i>Arquivo ICS
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-filter me-2"></i>Filtros</h6>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="filterAgendada" checked>
                                <label class="form-check-label" for="filterAgendada">Agendadas</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="filterRealizada" checked>
                                <label class="form-check-label" for="filterRealizada">Realizadas</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="filterCancelada" checked>
                                <label class="form-check-label" for="filterCancelada">Canceladas</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para detalhes da visita -->
<div class="modal fade" id="visitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visitModalTitle">Detalhes da Visita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="visitModalBody">
                <!-- Conteúdo carregado via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <div id="visitModalActions">
                    <!-- Ações específicas da visita -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let calendar;
    let allEvents = [];

    // Inicializar calendário
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 'auto',
        // Item 28: Implementar clique em eventos para redirecionamento
        eventClick: function(info) {
            // Redirecionar para a página do agendamento
            window.location.href = "/visits/" + info.event.extendedProps.visitId;
        },
        // Item 28: Implementar clique em datas para novo agendamento
        dateClick: function(info) {
            // No modo mês: abrir nova visita com data preenchida
            // No modo semana/dia: abrir com data e horário preenchidos
            const dateStr = info.dateStr;
            const timeStr = info.date.toTimeString().substring(0, 5); // HH:MM
            
            // Construir URL com data e horário
            let url = "/visits/new?data=" + dateStr;
            if (info.view.type !== 'dayGridMonth') {
                // Em modo semana/dia, incluir horário
                url += "&hora=" + timeStr;
            }
            
            window.location.href = url;
        },
        eventDidMount: function(info) {
            // Adicionar tooltip
            info.el.setAttribute('title', info.event.extendedProps.tooltip);
            info.el.setAttribute('data-bs-toggle', 'tooltip');
        },
        eventClassNames: function(info) {
            return 'fc-event-' + info.event.extendedProps.status.toLowerCase();
        }
    });

    // Carregar eventos e cores dos funcionários
    loadVisits();
    loadEmployeeColors();

    // Configurar filtros
    document.querySelectorAll('input[id^="filter"]').forEach(checkbox => {
        checkbox.addEventListener('change', applyFilters);
    });

    // Criar tooltip detalhado com cores dos participantes
    function createDetailedTooltip(visit, participantesNomes) {
        let tooltip = `${visit.title || visit.numero}\n`;
        tooltip += `Projeto: ${visit.projeto_nome}\n`;
        tooltip += `Responsável: ${visit.responsavel_nome}\n`;
        tooltip += `Status: ${visit.status}`;
        
        if (visit.participantes && visit.participantes.length > 0 && !visit.is_pessoal) {
            tooltip += `\n\nParticipantes (${visit.participantes.length}):`;
            visit.participantes.forEach(p => {
                const roleIndicator = p.is_responsavel ? ' (Responsável)' : '';
                tooltip += `\n• ${p.nome}${roleIndicator}`;
            });
        }
        
        if (visit.observacoes) {
            tooltip += `\n\nObservações: ${visit.observacoes}`;
        }
        
        return tooltip;
    }
    
    // Carregar e exibir cores dos funcionários na legenda
    function loadEmployeeColors() {
        fetch('/api/visits/calendar')
            .then(response => {
                if (!response.ok) {
                    console.error('Employee colors error', response.status);
                    return;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return;
                
                const employeeColors = new Map();
                
                // Ensure data is array before processing - defensive check
                const visits = Array.isArray(data) ? data : (data.visits || []);
                
                // Extrair cores únicas dos funcionários das visitas
                visits.forEach(visit => {
                    // Adicionar responsável
                    if (visit.responsavel_nome && visit.responsavel_cor) {
                        employeeColors.set(visit.responsavel_nome, visit.responsavel_cor);
                    }
                    
                    // Adicionar participantes
                    if (visit.participantes && visit.participantes.length > 0) {
                        visit.participantes.forEach(participante => {
                            if (participante.nome && participante.cor_agenda) {
                                employeeColors.set(participante.nome, participante.cor_agenda);
                            }
                        });
                    }
                });
                
                // Exibir legenda se houver funcionários com cores
                if (employeeColors.size > 0) {
                    const container = document.getElementById('employeeColorsContainer');
                    const legend = document.getElementById('employeeColorsLegend');
                    
                    container.innerHTML = '';
                    
                    // Converter para array e ordenar por nome
                    const sortedEmployees = Array.from(employeeColors.entries()).sort((a, b) => a[0].localeCompare(b[0]));
                    
                    sortedEmployees.forEach(([name, color]) => {
                        const legendItem = document.createElement('div');
                        legendItem.className = 'legend-item';
                        legendItem.innerHTML = `
                            <div class="legend-color" style="background-color: ${color}; border: 1px solid #dee2e6;"></div>
                            <small class="text-muted">${name}</small>
                        `;
                        container.appendChild(legendItem);
                    });
                    
                    legend.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erro ao carregar cores dos funcionários:', error);
            });
    }

    function loadVisits() {
        fetch('/api/visits/calendar')
            .then(response => {
                // Check response.ok before response.json() - defensive programming
                if (!response.ok) {
                    console.error('Calendar error', response.status);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // Ensure that code only executes .map() on arrays - defensive check
                if (!data) {
                    console.warn('Calendar API returned null/undefined data');
                    allEvents = [];
                    applyFilters();
                    return;
                }
                
                const visits = Array.isArray(data) ? data : (data.visits || []);
                
                if (!Array.isArray(visits)) {
                    console.warn('Calendar API did not return array data:', data);
                    allEvents = [];
                    applyFilters();
                    return;
                }
                
                allEvents = visits.map(visit => {
                    // Item 29: Criar título com participantes e cores melhorado
                    let participantesNomes = visit.participantes ? visit.participantes.map(p => p.nome).join(', ') : '';
                    let titleWithParticipants = visit.title || visit.numero;
                    
                    // Adicionar indicador de múltiplos participantes
                    if (visit.participantes && visit.participantes.length > 1 && !visit.is_pessoal) {
                        titleWithParticipants += ` 👥${visit.participantes.length}`;
                    } else if (participantesNomes && !visit.is_pessoal) {
                        titleWithParticipants += ` (${participantesNomes})`;
                    }
                    
                    // Item 29: Definir cor do evento baseada no responsável/participantes
                    let eventColor = visit.responsavel_cor || '#0EA5E9';
                    if (visit.participantes && visit.participantes.length > 0) {
                        // Usar cor do responsável se estiver nos participantes
                        const responsavel = visit.participantes.find(p => p.is_responsavel);
                        if (responsavel) {
                            eventColor = responsavel.cor_agenda || eventColor;
                        } else {
                            // Se responsável não está nos participantes, usar primeira cor
                            eventColor = visit.participantes[0].cor_agenda || eventColor;
                        }
                    }

                    return {
                        id: visit.id,
                        title: titleWithParticipants,
                        start: visit.data_inicio,
                        end: visit.data_fim || visit.data_realizada,
                        backgroundColor: eventColor,
                        borderColor: eventColor,
                        extendedProps: {
                            visitId: visit.id,
                            status: visit.status,
                            projeto: visit.projeto_nome,
                            responsavel: visit.responsavel_nome,
                            observacoes: visit.observacoes,
                            participantes: visit.participantes,
                            is_pessoal: visit.is_pessoal,
                            tooltip: createDetailedTooltip(visit, participantesNomes)
                        }
                    };
                });
                
                applyFilters();
            })
            .catch(error => {
                console.error('Erro ao carregar visitas:', error);
                // Set empty array to prevent undefined.map() errors
                allEvents = [];
                applyFilters();
                
                // Show user-friendly error message instead of technical alert
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                const errorMsg = error.message.includes('500') 
                    ? '⚠️ Erro no servidor. Por favor, tente novamente em alguns instantes.'
                    : '⚠️ Erro ao carregar lista de visitas. Verifique sua conexão e tente novamente.';
                errorDiv.innerHTML = errorMsg;
                const container = document.querySelector('.container-fluid');
                if (container) container.prepend(errorDiv);
                
                // Initialize empty events to prevent further errors
                allEvents = [];
                applyFilters();
            });
    }

    function applyFilters() {
        const showAgendada = document.getElementById('filterAgendada').checked;
        const showRealizada = document.getElementById('filterRealizada').checked;
        const showCancelada = document.getElementById('filterCancelada').checked;

        const filteredEvents = allEvents.filter(event => {
            const status = event.extendedProps.status.toLowerCase();
            return (showAgendada && status === 'agendada') ||
                   (showRealizada && status === 'realizada') ||
                   (showCancelada && status === 'cancelada');
        });

        calendar.removeAllEvents();
        calendar.addEventSource(filteredEvents);
    }

    function showVisitDetails(visitId) {
        fetch(`/api/visits/${visitId}/details`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const visit = data.visit;
                    const modalTitle = document.getElementById('visitModalTitle');
                    const modalBody = document.getElementById('visitModalBody');
                    const modalActions = document.getElementById('visitModalActions');

                    modalTitle.textContent = `Visita ${visit.numero}`;
                    
                    modalBody.innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-project-diagram me-2"></i>Projeto</h6>
                                <p>${visit.projeto_nome} (${visit.projeto_numero})</p>
                                
                                <h6><i class="fas fa-user me-2"></i>Responsável</h6>
                                <p>${visit.responsavel_nome}</p>
                                
                                <h6><i class="fas fa-calendar me-2"></i>Data Agendada</h6>
                                <p>${new Date(visit.data_agendada).toLocaleString('pt-BR')}</p>
                                
                                ${visit.data_realizada ? `
                                <h6><i class="fas fa-check me-2"></i>Data Realizada</h6>
                                <p>${new Date(visit.data_realizada).toLocaleString('pt-BR')}</p>
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-flag me-2"></i>Status</h6>
                                <p><span class="badge bg-${visit.status === 'Realizada' ? 'success' : visit.status === 'Agendada' ? 'primary' : 'danger'}">${visit.status}</span></p>
                                
                                <h6><i class="fas fa-target me-2"></i>Objetivo</h6>
                                <p>${visit.objetivo}</p>
                                
                                ${visit.atividades_realizadas ? `
                                <h6><i class="fas fa-tasks me-2"></i>Atividades Realizadas</h6>
                                <p>${visit.atividades_realizadas}</p>
                                ` : ''}
                                
                                ${visit.observacoes ? `
                                <h6><i class="fas fa-sticky-note me-2"></i>Observações</h6>
                                <p>${visit.observacoes}</p>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    // Ações do modal
                    let actions = '';
                    if (visit.status === 'Agendada') {
                        actions += `<a href="/visits/${visit.id}/realize" class="btn btn-success me-2"><i class="fas fa-check me-2"></i>Realizar</a>`;
                    }
                    actions += `<a href="/visits/${visit.id}/checklist" class="btn btn-primary me-2"><i class="fas fa-list-check me-2"></i>Checklist</a>`;
                    actions += `<button onclick="exportSingleVisit(${visit.id})" class="btn btn-outline-success"><i class="fab fa-google me-2"></i>Exportar</button>`;
                    
                    modalActions.innerHTML = actions;

                    // Mostrar modal
                    const modal = new bootstrap.Modal(document.getElementById('visitModal'));
                    modal.show();
                } else {
                    alert('Erro ao carregar detalhes da visita.');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar detalhes:', error);
                alert('Erro ao carregar detalhes da visita.');
            });
    }

    // Inicializar tooltips
    calendar.render();
    
    // Inicializar tooltips do Bootstrap após renderizar o calendário
    setTimeout(() => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }, 100);
});

// Funções de exportação
function exportToGoogleCalendar() {
    fetch('/api/visits/export/google')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.open(data.url, '_blank');
            } else {
                alert('Erro ao gerar link do Google Calendar.');
            }
        })
        .catch(error => {
            console.error('Erro na exportação:', error);
            alert('Erro ao exportar para Google Calendar.');
        });
}

function exportToOutlook() {
    window.open('/api/visits/export/ics', '_blank');
}

function exportToICS() {
    window.location.href = '/api/visits/export/ics';
}

function exportSingleVisit(visitId) {
    fetch(`/api/visits/${visitId}/export/google`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.open(data.url, '_blank');
            } else {
                alert('Erro ao gerar link do Google Calendar.');
            }
        })
        .catch(error => {
            console.error('Erro na exportação:', error);
            alert('Erro ao exportar visita.');
        });
}
</script>
{% endblock %}